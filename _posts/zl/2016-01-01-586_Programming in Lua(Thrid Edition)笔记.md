---
layout: post
title: Programming in Lua(Thrid Edition)笔记 
tags: [lua文章]
categories: [topic]
---
<h3 id="14-The-Environment"><a href="#14-The-Environment" class="headerlink" title="14 The Environment"></a>14 The Environment</h3><p>这章有点难理解，有些段落反复看了好多遍才感觉好像是看懂了。<br/></p>
<ul>
<li><p>Lua将所有全局变量存储在一个叫做global environment的table中</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">_G</span>) <span class="keyword">do</span> <span class="built_in">print</span>(n) <span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>对于动态变量名，可动态创建chunk并编译：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">x = <span class="number">1</span></span><br/><span class="line">varname = <span class="string">&#34;x&#34;</span></span><br/><span class="line">value = loadstring(<span class="string">&#34;return &#34;</span> .. varname)</span><br/><span class="line"><span class="built_in">print</span>(value()) </span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>这样的消耗较多，可用global environment：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">val = <span class="built_in">_G</span>[varname]</span><br/><span class="line"><span class="built_in">print</span>(val) </span><br/></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><p><code>_G[&#34;a&#34;] = _G[&#34;var1&#34;]</code>写法繁琐，应简写为<code>a = var1</code></p>
</li>
<li><p><code>_G[&#34;io.read&#34;]</code>无法获得<code>io</code>table的<code>read</code>域，可用以下<code>getfield()</code>实现：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(f)</span></span></span><br/><span class="line">	<span class="keyword">local</span> v = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br/><span class="line">	<span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gmatch</span>(f, <span class="string">&#34;[%w_]+&#34;</span>) <span class="keyword">do</span></span><br/><span class="line">		v = v[w]</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">return</span> v</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">getfield(<span class="string">&#34;io.write&#34;</span>)(<span class="string">&#34;1n&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>通过<code>_G</code>设置多级全局变量：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setfield</span><span class="params">(f, v)</span></span></span><br/><span class="line">	<span class="keyword">local</span> t = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br/><span class="line">	<span class="keyword">for</span> w, d <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gmatch</span>(f, <span class="string">&#34;([%w_]+)(%.?)&#34;</span>) <span class="keyword">do</span></span><br/><span class="line">		<span class="keyword">if</span> d == <span class="string">&#34;.&#34;</span> <span class="keyword">then</span> <span class="comment">-- not last name?</span></span><br/><span class="line">			t[w] = t[w] <span class="keyword">or</span> {} <span class="comment">-- create table if absent</span></span><br/><span class="line">			t = t[w] <span class="comment">-- get the table</span></span><br/><span class="line">		<span class="keyword">else</span> <span class="comment">-- last name</span></span><br/><span class="line">			t[w] = v <span class="comment">-- do the assignment</span></span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">setfield(<span class="string">&#34;t.x.y&#34;</span>, <span class="number">1</span>)</span><br/><span class="line"><span class="built_in">print</span>(t.x.y) </span><br/><span class="line"><span class="built_in">print</span>(getfield(<span class="string">&#34;t.x.y&#34;</span>)) </span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>全局变量声明，因为全局变量存储在table<code>_G</code>中，所以可以通过metatable处理未定义元素的操作：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">_G</span>, {</span><br/><span class="line">	<span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br/><span class="line">		<span class="built_in">error</span>(<span class="string">&#34;attempt to write to undeclared variable &#34;</span> .. n, <span class="number">2</span>)</span><br/><span class="line">	<span class="keyword">end</span>,</span><br/><span class="line">	<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_, n)</span></span></span><br/><span class="line">		<span class="built_in">error</span>(<span class="string">&#34;attemp to read undeclared variable &#34;</span> .. n, <span class="number">2</span>)</span><br/><span class="line">	<span class="keyword">end</span>,</span><br/><span class="line">})</span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; stdin:1: attempt to read undeclared variable a</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>用<code>rawset()</code>声明新变量，<code>initval or false</code>是为了使新的全局变量总会得到一个不同与nil的值：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">declare</span><span class="params">(name, initval)</span></span></span><br/><span class="line">	<span class="built_in">rawset</span>(<span class="built_in">_G</span>, name, initval <span class="keyword">or</span> <span class="literal">false</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>用debug库限制新的全局变量的声明只能在main chunk中，<code>debug.getinfo(2, &#34;S&#34;)</code>返回一个table，其<code>what</code>域说明metamethd调用是在main chunk、普通Lua函数和C函数其中之一<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br/><span class="line">	<span class="keyword">local</span> w = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&#34;S&#34;</span>).what</span><br/><span class="line">	<span class="keyword">if</span> w ~= <span class="string">&#34;main&#34;</span> <span class="keyword">and</span> w ~= <span class="string">&#34;C&#34;</span> <span class="keyword">then</span></span><br/><span class="line">		<span class="built_in">error</span>(<span class="string">&#34;attemp to write to undeclared variable &#34;</span> .. n, <span class="number">2</span>)</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="built_in">rawset</span>(t, n, v)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">a = <span class="number">1</span></span><br/><span class="line"><span class="built_in">print</span>(a) </span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span><span class="params">()</span></span></span><br/><span class="line">	c = <span class="number">2</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">b() <span class="comment">--&gt; stdin:1: attemp to write to undeclared variable c</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>判断一个变量是否存在，不能通过与nil比较，因为<code>__index</code>会报错，取而代之，我们可以用<code>rawget()</code><br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">rawget</span>(<span class="built_in">_G</span>, var) == <span class="literal">nil</span> <span class="keyword">then</span></span><br/><span class="line">	<span class="comment">-- &#39;var&#39; is undeclared</span></span><br/><span class="line">	...</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>为了使声明为nil的变量不被Lua认为是未声明的，可以用一个table保存声明的变量的名字，每次调用metamethod时都检查一下变量是否在该table中<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> declaredNames = {}</span><br/><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">_G</span>, {</span><br/><span class="line">	<span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br/><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br/><span class="line">			<span class="keyword">local</span> w = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&#34;S&#34;</span>).what</span><br/><span class="line">			<span class="keyword">if</span> w ~= <span class="string">&#34;main&#34;</span> <span class="keyword">and</span> w ~= <span class="string">&#34;C&#34;</span> <span class="keyword">then</span></span><br/><span class="line">				<span class="built_in">error</span>(<span class="string">&#34;attempt to write to undeclared variable &#34;</span> .. n, <span class="number">2</span>)</span><br/><span class="line">			<span class="keyword">end</span></span><br/><span class="line">			declaredNames[n] = <span class="literal">true</span></span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">		<span class="built_in">rawset</span>(t, n, v) <span class="comment">-- do the actual set</span></span><br/><span class="line">	<span class="keyword">end</span>,</span><br/><span class="line">	<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_, n)</span></span></span><br/><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br/><span class="line">			<span class="built_in">error</span>(<span class="string">&#34;attempt to read undeclared variable &#34;</span> .. n, <span class="number">2</span>)</span><br/><span class="line">		<span class="keyword">else</span></span><br/><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">end</span>,</span><br/><span class="line">})</span><br/><span class="line">a = <span class="literal">nil</span></span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br/><span class="line"><span class="built_in">print</span>(b) <span class="comment">--&gt; stdin:1 attempt to read undeclared variable b</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><p>非全局环境，所谓非全局环境，就是指之前所说的全局环境并非真正的全局环境，是Lua实现的伪全局环境，是为了操作全局变量更方便。</p>
</li>
<li><p>free name是并非绑定在一个特定声明的名字，即并非出现在有这些名字的局部变量所在的域（可以简单理解为全局变量的名字），例如<code>var1 = var2 + 3</code>这个chunk里的<code>var1</code>和<code>var2</code>就是free name，Lua会将该chunk编译为：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">_ENV</span> = &lt;some code&gt;</span><br/><span class="line"><span class="keyword">return</span> funtion (...)</span><br/><span class="line">	<span class="built_in">_ENV</span>.var1 = <span class="built_in">_ENV</span>.var2 + <span class="number">3</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>也就是说Lua会把chunk编译在一个预定义的upvalue<code>_ENV</code>的域中。<code>load()</code>则会把<code>_ENV</code>初始化global environment<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">_ENV</span> = &lt;the global environment&gt;</span><br/><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(...)</span></span></span><br/><span class="line">	<span class="built_in">_ENV</span>.var1 = <span class="built_in">_ENV</span>.var2 + <span class="number">3</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><p>总结一下Lua处理全局变量的方式：</p>
<ul>
<li>将任何chunk编译在一个upvalue<code>_ENV</code>的域中</li>
<li>将任何free name<code>var</code>变为<code>_ENV.var</code>（简单来说，就是<code>_ENV</code>只会记录全局变量，而不记录局部变量）</li>
<li><code>load()</code>和<code>loadfile()</code>将一个chunk的第一个upvalue初始化为global environment</li>
</ul>
</li>
<li><p>通过<code>_ENV = nil</code>阻止在之后的chunk中获取全局变量，可以用来控制代码可以使用什么变量</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">print</span>, <span class="built_in">sin</span> = <span class="built_in">print</span>, <span class="built_in">math</span>.<span class="built_in">sin</span></span><br/><span class="line"><span class="built_in">_ENV</span> = <span class="literal">nil</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="number">13</span>) <span class="comment">--&gt; 13</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">sin</span>(<span class="number">13</span>)) <span class="comment">--&gt; 0.42016703682664</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">math</span>.<span class="built_in">cos</span>(<span class="number">13</span>)) <span class="comment">-- eror!</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>用<code>_ENV</code>绕过局部变量</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">a = <span class="number">13</span> <span class="comment">-- global</span></span><br/><span class="line"><span class="keyword">local</span> a = <span class="number">12</span></span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; 12 (local)</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">_ENV</span>.a) <span class="comment">--&gt; 13 (global)</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>用<code>_ENV</code>改变环境</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- change current environment to a new empty table</span></span><br/><span class="line"><span class="built_in">_ENV</span> = {}</span><br/><span class="line">a = <span class="number">1</span> <span class="comment">-- create a field in _ENV</span></span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; stdin:4: attempt to call global &#39;print&#39; (a nil value)</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>用旧环境填充新环境：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">a = <span class="number">15</span> <span class="comment">-- create a global variable</span></span><br/><span class="line"><span class="built_in">_ENV</span> = {g = <span class="built_in">_G</span>} <span class="comment">-- change current environment</span></span><br/><span class="line">a = <span class="number">1</span> <span class="comment">-- create a field in _ENV</span></span><br/><span class="line">g.<span class="built_in">print</span>(a) </span><br/><span class="line">g.<span class="built_in">print</span>(g.a) <span class="comment">--&gt; 15</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>用<code>_G</code>代替<code>g</code>：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">a = <span class="number">15</span> <span class="comment">-- create a global variable</span></span><br/><span class="line"><span class="built_in">_ENV</span> = {<span class="built_in">_G</span> = <span class="built_in">_G</span>} <span class="comment">-- change current environment</span></span><br/><span class="line">a = <span class="number">1</span> <span class="comment">-- create a field in _ENV</span></span><br/><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) </span><br/><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 15</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>用继承来填充新环境：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br/><span class="line"><span class="keyword">local</span> newgt = {} <span class="comment">-- create new environment</span></span><br/><span class="line"><span class="built_in">setmetatable</span>(newgt, {<span class="built_in">__index</span> = <span class="built_in">_G</span>})</span><br/><span class="line"><span class="built_in">_ENV</span> = newgt <span class="comment">-- set it</span></span><br/><span class="line"><span class="built_in">print</span>(a) </span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>这里只设置了<code>__index</code>，所以任何赋值操作都发生在新环境中，所以错误地改变了全局环境的一个变量没有危险，仍可以通过<code>_G</code>来活取原值<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- continuing previous code</span></span><br/><span class="line">a = <span class="number">10</span></span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; 10</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">_G</span>.a) </span><br/><span class="line"><span class="built_in">_G</span>.a = <span class="number">20</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 20</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><p><code>_ENV</code>符合通常的域规则，一个chunk中的函数可以像获取其他外部变量那样活取<code>_ENV</code></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">_ENV</span> = {<span class="built_in">_G</span> = <span class="built_in">_G</span>}</span><br/><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br/><span class="line">	<span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">-- compiled as &#39;_ENV._G.print(_ENV.a)&#39;</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">a = <span class="number">10</span> <span class="comment">-- _ENV.a</span></span><br/><span class="line">foo() <span class="comment">--&gt; 10</span></span><br/><span class="line"><span class="built_in">_ENV</span> = {<span class="built_in">_G</span> = <span class="built_in">_G</span>, a = <span class="number">20</span>}</span><br/><span class="line">foo() <span class="comment">--&gt; 20</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>用局部的<code>_ENV</code>生成一个局部环境：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">a = <span class="number">2</span></span><br/><span class="line"><span class="keyword">do</span></span><br/><span class="line">	<span class="keyword">local</span> <span class="built_in">_ENV</span> = {<span class="built_in">print</span> = <span class="built_in">print</span>, a = <span class="number">14</span>}</span><br/><span class="line">	<span class="built_in">print</span>(a) <span class="comment">--&gt; 14</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; 2 (back to the original _ENV)</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>定义一个有私有环境的函数：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(_ENV)</span></span></span><br/><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br/><span class="line">		<span class="keyword">return</span> a <span class="comment">-- &#34;global&#34; a</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">f1 = factory{a = <span class="number">6</span>}</span><br/><span class="line">f2 = factory{a = <span class="number">7</span>}</span><br/><span class="line"><span class="built_in">print</span>(f1()) <span class="comment">--&gt; 6</span></span><br/><span class="line"><span class="built_in">print</span>(f2()) <span class="comment">--&gt; 7</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>这里<code>factory()</code>返回一个闭包，其upvalue为<code>_ENV</code>。用这种方法可以让一些函数共享一个公共的环境，或者让一个函数专门用于改变这些函数共享的这个环境</p>
<ul>
<li><p><code>load()</code>的可选的第四个参数用来设定<code>_ENV</code>的值，<code>loadfile()</code>则为第三个参数</p>
</li>
<li><p>使用配置文件：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- file &#39;config.lua&#39;</span></span><br/><span class="line">width = <span class="number">200</span></span><br/><span class="line">height = <span class="number">300</span></span><br/><span class="line">...</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>可用一下代码加载：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">env = {}</span><br/><span class="line">f = <span class="built_in">loadfile</span>(<span class="string">&#34;config.lua&#34;</span>, <span class="string">&#34;t&#34;</span>, env)</span><br/><span class="line">f() <span class="comment">-- only after executing will env be populated</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>配置文件中的代码会运行在一个空环境中，并且所有配置都会存储在该环境中，对其他代码无影响，有一定安全性</p>
<ul>
<li><p><code>load()</code>和<code>loadfile()</code>返回的函数可多次调用，为了使每次调用时的环境不同，可用以下两种方法：</p>
</li>
<li><p>法一：<code>debug.setupvalue()</code>可以改变一个函数的任何upvalue</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">loadfile</span>(filename)</span><br/><span class="line">...</span><br/><span class="line">env = {}</span><br/><span class="line"><span class="built_in">debug</span>.<span class="built_in">setupvalue</span>(f, <span class="number">1</span>, env)</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><code>debug.setupvalue()</code>的第一个参数是一个函数，第二个参数是upvalue索引，第三个参数是新的upvalue，此处第二个参数总为1，因为Lua保证<code>load()</code>和<code>loadfile()</code>返回的函数只有一个upvalue，即<code>_ENV</code>。此法破坏了Lua的可见性规则：一个局部变量不能被外部获取</p>
<ul>
<li>法二：用可变参数，用<code>Exercise 8.1</code>的<code>loadwithprefix()</code>在加载的chunk之前加上<code>local _ENV = ...;</code><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">f = loadwithprefix(<span class="string">&#34;local _ENV = ...;&#34;</span>, <span class="built_in">io</span>.<span class="built_in">lines</span>(filename, <span class="string">&#34;*L&#34;</span>))</span><br/><span class="line">...</span><br/><span class="line">env = {}</span><br/><span class="line">f(env)</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>