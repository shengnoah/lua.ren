---
layout: post
title: Nginx 使用 lua 
tags: [lua文章]
categories: [topic]
---

        <ul id="markdown-toc">
  <li><a href="https://lework.github.io/#1-%E8%BD%AF%E4%BB%B6%E7%89%88%E6%9C%AC" id="markdown-toc-1-软件版本">1. 软件版本</a></li>
  <li><a href="https://lework.github.io/#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" id="markdown-toc-2-环境准备">2. 环境准备</a></li>
  <li><a href="https://lework.github.io/#3-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85" id="markdown-toc-3-软件安装">3. 软件安装</a></li>
  <li><a href="https://lework.github.io/#4--%E9%85%8D%E7%BD%AElua%E8%84%9A%E6%9C%AC" id="markdown-toc-4--配置lua脚本">4.  配置lua脚本</a></li>
  <li><a href="https://lework.github.io/#5-%E9%85%8D%E7%BD%AEphp" id="markdown-toc-5-配置php">5. 配置php</a></li>
  <li><a href="https://lework.github.io/#6-%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95post%E8%AF%B7%E6%B1%82%E7%9A%84request_body-%E5%92%8Cresponse_body" id="markdown-toc-6-配置日志记录post请求的request_body-和response_body">6. 配置日志，记录post请求的request_body 和response_body</a></li>
</ul>

<h2 id="1-软件版本">1. 软件版本</h2>

<ul>
  <li>系统  <code class="highlighter-rouge">centos6.7X86_64</code>
</li>
  <li>nginx   <code class="highlighter-rouge">1.11.5</code>
</li>
  <li>lua-nginx-module  <code class="highlighter-rouge">0.10.7</code>
</li>
  <li>PHP   <code class="highlighter-rouge">5.6.27</code>
</li>
</ul>

<h2 id="2-环境准备">2. 环境准备</h2>

<p>配置yum仓库</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget -O /etc/yum.repos.d/CentOS-Base.repo[https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/centos?codeblock=2](https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/centos?codeblock=2)
wget -O /etc/yum.repos.d/epel.repo[https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=0](https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=0)
wget -O /etc/yum.repos.d/epel-testing.repo[https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=1](https://lug.ustc.edu.cn/wiki/_export/code/mirrors/help/epel?codeblock=1)
/usr/sbin/ntpdate  asia.pool.ntp.org
</code></pre></div></div>

<p>安装编译所需的依赖</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum -y install gcc gcc-c++ make libtool zlib zlib-devel openssl openssl-devel pcre  pcre-devel
</code></pre></div></div>

<h2 id="3-软件安装">3. 软件安装</h2>

<p>安装php5.6</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm -Uvh https://mirror.webtatic.com/yum/el6/latest.rpm
yum -y install php56w-cli php56w-mysql php56w-xml php56w-mbstring php56w-pdo php56w-bcmath php56w-mcrypt php56w-fpm 
</code></pre></div></div>

<p>编译安装nginx</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/software/
wget https://codeload.github.com/openresty/lua-nginx-module/tar.gz/v0.10.7
wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz
wget https://nginx.org/download/nginx-1.11.5.tar.gz

groupadd nginx
useradd -g nginx -s /sbin/nologin nginx
mkdir -p /var/tmp/nginx/client/
mkdir -p /usr/local/nginx

tar zxf v0.10.7
tar zxf LuaJIT-2.0.4.tar.gz 
tar zxf nginx-1.11.5.tar.gz 

cd LuaJIT-2.0.4/
make &amp;&amp; make install

cat &gt;&gt; /etc/profile &lt;&lt;EOF
export LUAJIT_LIB=/usr/local/lib
export LUAJIT_INC=/usr/local/include/luajit-2.0
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
EOF
source /etc/profile

cd ../nginx-1.11.5/
 ./configure   --prefix=/usr/local/nginx   --user=nginx   --group=nginx   --with-http_ssl_module   --with-http_flv_module   --with-http_stub_status_module   --with-http_gzip_static_module   --with-http_realip_module   --http-client-body-temp-path=/var/tmp/nginx/client/   --http-proxy-temp-path=/var/tmp/nginx/proxy/   --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/   --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi   --http-scgi-temp-path=/var/tmp/nginx/scgi   --with-pcre --add-module=../lua-nginx-module-0.10.7

make -j2
make install
</code></pre></div></div>
<h2 id="4--配置lua脚本">4.  配置lua脚本</h2>

<p>在nginx配置文档中添加下列location</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /usr/local/nginx/conf/nginx.conf
        location ~* ^/lua(/.*) {
                default_type 'text/plain';
                content_by_lua 'ngx.say("hello, lua")';
        }
</code></pre></div></div>

<p>启动nginx</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/nginx/sbin/nginx
</code></pre></div></div>

<p>测试lua脚本执行</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://127.0.0.1/lua/
</code></pre></div></div>
<p>返回 hello, lua 为正常</p>

<h2 id="5-配置php">5. 配置php</h2>

<p>启用如下选项</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#/usr/local/nginx/conf/nginx.conf
location / {
            root   /web;
            index  index.php index.html index.htm;
        }

location ~ .php$ {
            root           /web/;
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;
            include        fastcgi_params;
        }
</code></pre></div></div>

<p>在/web/目录下 新建index.php的测试页面，测试php是否能正常工作</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /web/
cat &gt; /web/info.php &lt;&lt; EOF
&lt;?php
phpinfo();
?&gt;
EOF
chown nginx.nginx -R /web/
</code></pre></div></div>

<p>启动php-fpm和nginx</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/php-fpm start
/usr/local/nginx/sbin/nginx  -s reload
</code></pre></div></div>

<p>测试</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://127.0.0.1/info.php   
</code></pre></div></div>

<p>显示phpinfo页面，极为正常</p>

<h2 id="6-配置日志记录post请求的request_body-和response_body">6. 配置日志，记录post请求的request_body 和response_body</h2>

<p>使用下列配置</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># /usr/local/nginx/conf/nginx.conf
user  nginx;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format postdata '$remote_addr | $request_body | $resp_body';

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;
        charset utf-8;
        set $resp_body "";
        location / {
            root   /web/;
            index  index.php index.html index.htm;
        }

        location ~* ^/lua(/.*) {
                default_type 'text/plain';
                content_by_lua 'ngx.say("hello, lua")';
        }

        location ~ .php$ {
                    root           /web/;
                    fastcgi_pass   127.0.0.1:9000;
                    fastcgi_index  index.php;
                    fastcgi_param  SCRIPT_FILENAME  /$document_root$fastcgi_script_name;
                    include        fastcgi_params;
                    access_log /tmp/nginx_access.log postdata;
                    lua_need_request_body on;
                    body_filter_by_lua '
                        local resp_body = string.sub(ngx.arg[1], 1, 1000)
                        ngx.ctx.buffered = (ngx.ctx.buffered or"") .. resp_body
                        if ngx.arg[2] then
                                ngx.var.resp_body = ngx.ctx.buffered
                        end
                  ';
        }
    }
}
</code></pre></div></div>

<p>创建php文档，用来接收post请求，并返回数据</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;&gt; /web/index.php  &lt;&lt;EOF
&lt;?php
  header("Content-type:text/html;charset=utf-8"); 
  print_r(file_get_contents('php://input'));
?&gt;
EOF
chown nginx.nginx /web/index.php
</code></pre></div></div>

<p>重启nginx</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/nginx/sbin/nginx  -s reload
</code></pre></div></div>

<p>使用postman工具来发送post请求</p>

<p><img src="https://img.dazhuanlan.com/2019/11/28/5ddf8f774c294.png!v1" alt="Paste_Image.png"></p>

<p>查看日志</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat  /tmp/nginx_access.log
</code></pre></div></div>

<p><img src="https://img.dazhuanlan.com/2019/11/28/5ddf8f77e9c70.png!v1" alt="Paste_Image.png"></p>

<p>已经记录post请求的request 和response数据了。</p>

<p>第二行是因为post数据有中文字符，所以变成了16进制。解决方法见 <a href="http://www.jianshu.com/p/8f8c2b5ca2d1">解决nginx在记录post数据时 中文字符转成16进制的问题</a></p>