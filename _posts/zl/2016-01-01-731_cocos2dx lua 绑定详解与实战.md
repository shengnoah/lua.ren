---
layout: post
title: cocos2dx lua 绑定详解与实战 
tags: [lua文章]
categories: [topic]
---
<p>我们平时在开发cocos2dx lua游戏的时候的，会遇到这样的情况：</p>
<ul>
<li>在c++层定义了一些类，我们需要将这些类导出给Lua来使用，从而完成在c++层实现起来容易的需求，这个时候就需要将整个类作为模块导出。</li>
</ul>
<p>而Cocos2d-x正是采用的这种思想，将Cocos中的类导出供用户使用，而不是再写一套Lua代码，用户使用Cocos导出的这套接口，在Lua脚本层写游戏代码。</p>

<blockquote>
<p>为了更好的理解这部分的内容，可以先了解c++中调用Lua的机制。</p>
</blockquote>
<h6 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h6><ul>
<li><a href="https://www.cnblogs.com/chevin/p/5954948.html" target="_blank" rel="noopener noreferrer">手动绑定自定义类中的函数</a></li>
<li><a href="https://www.cnblogs.com/chevin/p/5899516.html" target="_blank" rel="noopener noreferrer">自动绑定自定义类中的函数</a></li>
</ul>
<p>前面文章中，我们说到了，Lua的本质是C，不是C++，Lua提供给C用的API也都是基于面向过程的C函数来用的，要把C++类注册进Lua形成一个一个的table环境是不太容易一下子办到的事。</p>
<p>为了实现我们的需求，同样也是官方的需求，在Cocos 2.x版本的时候，使用的是tolua++这个工具，但是这个工具用起来相当的麻烦，耗费体力，所以现在使用的是<a href="https://github.com/cocos2d/bindings-generator" target="_blank" rel="noopener noreferrer">bindings-generator</a>工具（官方用Python写的一个工具），这个东西底层使用的也应该是tolua++。</p>
<blockquote>
<p>这里只针对iOS平台，Android和其他平台在tolua中README.mdown中有具体介绍，其他步骤基本上一样！</p>
</blockquote>
<p>在项目跟目录framework/cocos2d-x/cocos中创建mybinding文件夹，里面创建一个MyBinding.h文件(mybinding, MyBinding自定义)，输入如下测试代码</p>
<pre><code>#include &#34;cocos2d.h&#34;

namespace cocos2d {
class MyBinding: public Ref {
public:

virtual bool init() {
return true;
}

void sayBinding() {
log(&#34;Hello Binding Lua&#34;);
}

MyBinding();
~MyBinding();
}
}
</code></pre><p>在framework/cocos2d-x/tools/tolua，新建一个配置文件，这里命名cocos2dx_binding.ini</p>
<p>输入下面代码：（处理标记修改处其他所有都一样）</p>
<pre><code>[cocos2dx_binding] # 标记修改
# the prefix to be added to the generated functions. You might or might not use this in your own
# templates
prefix = cocos2dx_binding # 标记修改

# create a target namespace (in javascript, this would create some code like the equiv. to `ns = ns || {}`)
# all classes will be embedded in that namespace
target_namespace = cc # 标记修改

# --------- ?
#android_headers = -I%(androidndkdir)s/platforms/android-19/arch-arm/usr/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.7/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.7/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.8/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.8/include
android_headers = -I%(androidndkdir)s/platforms/android-19/arch-arm/usr/lib -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/include

# --------- ?
android_flags = -D_SIZE_T_DEFINED_

#clang_headers = -I%(clangllvmdir)s/lib/clang/%(clang_version)s/include
clang_headers = -I%(clangllvmdir)s/lib64/clang/5.0/include
clang_flags = -nostdinc -x c++ -std=c++11 -U __SSE__

# --------- ?
# -I%(cocosdir)s/jsext -I%(cocosdir)s/jsext/system -I%(cocosdir)s/jsext/alipay  -I%(cocosdir)s/jsext/video -I%(cocosdir)s/jsext/webview -I%(cocosdir)s/jsext/umeng
cocos_headers = -I%(cocosdir)s -I%(cocosdir)s/cocos -I%(cocosdir)s/cocos/base -I%(cocosdir)s/cocos/platform/android -I%(cocosdir)s/extensions -I%(cocosdir)s/external -I%(cocosdir)s/cocos/editor-support -I%(cocosdir)s/cocos/network -I%(cocosdir)s/cocos/ui/UIEditBox -I%(cocosdir)s/cocos/ui
#cocos_headers = -I%(cocosdir)s -I%(cocosdir)s/cocos -I%(cocosdir)s/cocos/platform/android

cocos_flags = -DANDROID

cxxgenerator_headers =

# extra arguments for clang
extra_arguments = %(android_headers)s %(clang_headers)s %(cxxgenerator_headers)s %(cocos_headers)s %(android_flags)s %(clang_flags)s %(cocos_flags)s %(extra_flags)s

# what headers to parse 头文件路径
headers = %(cocosdir)s/cocos/mybinding/MyBinding.h # 标记修改

# what classes to produce code for. You can use regular expressions here. When testing the regular
# expression, it will be enclosed in &#34;^$&#34;, like this: &#34;^Menu*$&#34;.
#包含的类，新添加文件需要修改
classes = MyBinding.* # 标记修改

#需要在js里面派生的类
#classes_need_extend = MyBinding # 标记修改

# what should we skip? in the format ClassName::[function function]
# ClassName is a regular expression, but will be used like this: &#34;^ClassName$&#34; functions are also
# regular expressions, they will not be surrounded by &#34;^$&#34;. If you want to skip a whole class, just
# add a single &#34;*&#34; as functions. See bellow for several examples. A special class name is &#34;*&#34;, which
# will apply to all class names. This is a convenience wildcard to be able to skip similar named
# functions from all classes.

skip =

rename_functions =

rename_classes =

# for all class names, should we remove something when registering in the target VM?
remove_prefix =

# classes for which there will be no &#34;parent&#34; lookup
classes_have_no_parents =

# base classes which will be skipped when their sub-classes found them.
base_classes_to_skip = Ref

# classes that create no constructor
# Set is special and we will use a hand-written constructor
abstract_classes =

# Determining whether to use script object(js object) to control the lifecycle of native(cpp) object or the other way around. Supported values are &#39;yes&#39; or &#39;no&#39;.
script_control_cpp = no
</code></pre><p>注意检查一下三个头文件对应的路径及文件问题</p>
<ul>
<li>android_headers</li>
<li>clang_headers</li>
<li>cocos_headers</li>
</ul>
<h5 id="说明内容："><a href="#说明内容：" class="headerlink" title="说明内容："></a>说明内容：</h5><pre><code>+ •[title]：要配置将被使用的工具/ tolua的/ gengindings.py脚本的称号。一般来说，标题可以是文件名。
+ •prefix：要配置一个函数名的前缀，通常，我们还可以使用文件名作为前缀。
+ •target_namespace：要配置在脚本层模块的名字。在这里，我们使用cc作为模块名，当你想在脚本层REF的名称，您必须将一个名为前缀，CC在名称的前面。例如，CustomClass可以参考作为cc.CustomClass。
+ •headers：要配置所有需要解析的头文件和％（cocosdir）s是的Cocos2d-x的引擎的根路径。
+ •classes：要配置所有绑定所需的类。在这里，它支持正则表达式。因此，我们可以设置MyCustomClass。*在这里，用于查找多个特定的用法，你可以对照到tools/tolua/cocos2dx.ini。
+ •skip：要配置需要被忽略的功能。现在绑定发电机无法解析的void *类型，并委托类型，所以这些类型的需要进行手动绑定。而在这种情况下，你应该忽略所有这些类型，然后再手动将它们绑定。你可以对照到配置文件路径下的cocos/scripting/lua-bindings/auto 。
+ •rename_functions：要配置的功能需要在脚本层进行重命名。由于某些原因，开发者希望更多的脚本友好的API，所以配置选项就是为了这个目的。
+ •rename_classes：不在使用。
+ •remove_prefix：不在使用。
+ •classes_have_no_parents：要配置是过滤器所需要的父类。这个选项是很少修改。
+ •abstract_classes：要配置的公共构造并不需要导出的类。
+ •script_control_cpp：是的。要配置脚本层是否管理对象的生命周期。如果没有，那么C++层关心他们的生命周期。现在，它是不完善的，以控制原生对象的续航时间在脚本层。所以，你可以简单地把它设置为no
</code></pre><p>修改framework/cocos2d-x/tools/tolua里面的genbindings.py。有个cmd_args键值对的配置，增加下面代码，作为自定义绑定配置</p>
<pre><code>&#39;cocos2dx_binding.ini&#39; : (&#39;cocos2dx_binding&#39;, &#39;lua_cocos2dx_binding_auto&#39;), 
</code></pre><blockquote>
<p>注：python注释为#，这里将cmd_args其他的元素注释掉是因为这些文件都是生成过得，没必要再生成浪费时间<br/>这行代码表示在cocos2dx_custom中找到cocos2dx_custom的模块，然后生成lua_cocos2dx_custom_auto文件</p>
</blockquote>
<p>这里要确保NDK_ROOT，和PYTHON_BIN安装切配置好了,然后在framework/cocos2d-x/tools/tolua执行</p>
<pre><code>./genbindings.py
</code></pre><p>之前./genbindings.py之前，请先查看官方tolua中README文件，按照对应的流程，安装好需要的依赖，和相应的库，下面是我这边3.17最新的README</p>
<pre><code>* The OSX 10.1&lt;!--0 has a built-in python2.7 and if your os don&#39;t have python2.7 then use [Homebrew](http://brew.sh/) to install the python and use pip install the python dependencies.
&lt;pre&gt;
brew install python
&lt;/pre&gt;

* Install python dependices by pip.
&lt;pre&gt;
sudo easy_install pip
sudo pip install PyYAML
sudo pip install Cheetah
&lt;/pre&gt;

* Download NDK 64bit r10c or later from [Android Ndk](https://developer.android.com/ndk/downloads/index.html)
* Run
&lt;pre&gt;
export NDK_ROOT=/path/to/android-ndk-10c
./genbindings.py
&lt;/pre&gt;--&gt;
</code></pre><p>大概意思就是下载r10c之后版的NDK本，然后安装python(这一步一般Mac都有，但是最好安装到2.x)。</p>
<p>大概意思就是安装，pip， PyYAML， Cheetah</p>
<p>…….</p>
<p>执行./genbindings.py之后生成在</p>
<pre><code>工程目录frameworkscocos2d-xcocosscriptinglua-bindingsauto
</code></pre><p>下便有了两个生成的文件</p>
<pre><code>lua_cocos2dx_custom_auto.cpp
lua_cocos2dx_custom_auto.hpp
</code></pre><p>进入到文件夹</p>
<pre><code>C:UsersuserDocumentsCocosLinkframeworkscocos2d-xcocosscriptinglua-bindingsmanual

打开CCLuaStack.cpp，添加

#include &#34;lua_cocos2dx_custom_auto.hpp&#34;
register_all_cocos2dx_custom(_state);
</code></pre><h3 id="期间遇到的错误"><a href="#期间遇到的错误" class="headerlink" title="期间遇到的错误"></a>期间遇到的错误</h3><h5 id="错误一"><a href="#错误一" class="headerlink" title="错误一"></a>错误一</h5><pre><code>Traceback (most recent call last):
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1799, in &lt;module&gt;
main()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1772, in main
&#39;clang_args&#39;: (config.get(s, &#39;extra_arguments&#39;, 0, dict(userconfig.items(&#39;DEFAULT&#39;))) or &#34;&#34;).split(&#34; &#34;),
File &#34;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ConfigParser.py&#34;, line 623, in get
return self._interpolate(section, option, value, d)
File &#34;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ConfigParser.py&#34;, line 691, in _interpolate
self._interpolate_some(option, L, rawval, section, vars, 1)
File &#34;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ConfigParser.py&#34;, line 726, in _interpolate_some
section, map, depth + 1)
File &#34;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/ConfigParser.py&#34;, line 723, in _interpolate_some
option, section, rest, var)
InterpolationMissingOptionError: Bad value substitution:
section: [cocos2dx_custom]
option : extra_arguments
key    : clang_version
rawval : /include
</code></pre><p>路径错误</p>
<pre><code>#clang_headers = -I%(clangllvmdir)s/lib/clang/%(clang_version)s/include
clang_headers = -I%(clangllvmdir)s/lib64/clang/5.0/include  # --------- ?
</code></pre><h5 id="错误二"><a href="#错误二" class="headerlink" title="错误二"></a>错误二</h5><pre><code>Traceback (most recent call last):
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1799, in &lt;module&gt;
main()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1795, in main
generator.generate_code()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1444, in generate_code
self._parse_headers()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1487, in _parse_headers
raise Exception(&#34;Fatal error in parsing headers&#34;)
Exception: Fatal error in parsing headers
---------------------------------
Generating lua bindings fails.
---------------------------------
</code></pre><p>C++语法错误</p>
<h5 id="错误三"><a href="#错误三" class="headerlink" title="错误三"></a>错误三</h5><pre><code>Generating bindings for cocos2dx_custom...
Using userconfig
[(&#39;androidndkdir&#39;, &#39;/Users/iCocos/tools/android-ndk-r16b&#39;), (&#39;clangllvmdir&#39;, &#39;/Users/iCocos/tools/android-ndk-r16b/toolchains/llvm/prebuilt/darwin-x86_64&#39;), (&#39;gcc_toolchain_dir&#39;, &#39;/Users/iCocos/tools/android-ndk-r16b/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64&#39;), (&#39;cocosdir&#39;, &#39;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x&#39;), (&#39;cxxgeneratordir&#39;, &#39;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator&#39;), (&#39;extra_flags&#39;, &#39;&#39;)]

.... Generating bindings for target lua

.... .... Processing section cocos2dx_custom

Traceback (most recent call last):
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1799, in &lt;module&gt;
main()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1795, in main
generator.generate_code()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1444, in generate_code
self._parse_headers()
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/generator.py&#34;, line 1478, in _parse_headers
tu = self.index.parse(header, self.clang_args)
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/clang/cindex.py&#34;, line 2602, in parse
self)
File &#34;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/tools/bindings-generator/clang/cindex.py&#34;, line 2714, in from_source
raise TranslationUnitLoadError(&#34;Error parsing translation unit.&#34;)
TranslationUnitLoadError: Error parsing translation unit.
---------------------------------
Generating lua bindings fails.
---------------------------------
</code></pre><p>路径错误</p>
<pre><code>#android_headers = -I%(androidndkdir)s/platforms/android-19/arch-arm/usr/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.7/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.7/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.8/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.8/include
android_headers = -I%(androidndkdir)s/platforms/android-19/arch-arm/usr/lib -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi-v7a/include -I%(androidndkdir)s/sources/cxx-stl/gnu-libstdc++/4.9/include
</code></pre><h5 id="错误四"><a href="#错误四" class="headerlink" title="错误四"></a>错误四</h5><pre><code>====
Errors in parsing headers:
1. &lt;severity = Fatal,
location = &lt;SourceLocation file &#39;/Users/iCocos/Desktop/cocos2d/Products/cocos2dx-demo/SingleLua/frameworks/cocos2d-x/cocos/platform/android/CCPlatformDefine-android.h&#39;, line 33, column 10&gt;,
details = &#34;&#39;android/log.h&#39; file not found&#34;&gt;
====
</code></pre><p>…..</p>
<h3 id="提示成功"><a href="#提示成功" class="headerlink" title="提示成功"></a>提示成功</h3><pre><code>---------------------------------
Generating lua bindings succeeds.
---------------------------------
</code></pre><h4 id="拓展推荐"><a href="#拓展推荐" class="headerlink" title="拓展推荐"></a>拓展推荐</h4><ul>
<li><p>lua： <a href="http://www.lua.org/" target="_blank" rel="noopener noreferrer">http://www.lua.org/</a></p>
<ul>
<li>lua是个脚本语言，脚本语言！！就是脚本文件加解释器。之后你就可以看效果了。可是呢，lua如果正是靠自己独立完成点事情，那就是大材小用，需要和其他东西结合起来，比如C/C++.貌似主要也就是C/C++。</li>
</ul>
</li>
<li><p>tolua++： <a href="http://www.codenix.com/~tolua/#news" target="_blank" rel="noopener noreferrer">http://www.codenix.com/~tolua/#news</a></p>
<ul>
<li>tolua++：首先看名字“到、lua、++”，就是把其他语言（C/C++函数对象转化为lua能调用形式，++这里理解为增强版），有了这个工具，我们就可以快速的将我们现成的C/C++代码封装成Lua接口形式。</li>
</ul>
</li>
<li><p>luajit： <a href="http://luajit.org/luajit.html" target="_blank" rel="noopener noreferrer">http://luajit.org/luajit.html</a></p>
<ul>
<li>LuaJIT：LuaJIT is a Just-In-Time Compiler (JIT) for the  Lua programming language. 。。。。。。说了半天就一个lua的高效率版本。</li>
</ul>
</li>
<li><p>lua for windows： <a href="http://luaforge.net/projects/luaforwindows/" target="_blank" rel="noopener noreferrer">http://luaforge.net/projects/luaforwindows/</a></p>
<ul>
<li>lua for windows：lua在windows下的打包版本，除了最基本的lua解释器，还包括了可用于和C/C++集成开发的【动态链接库、静态链接库、头文件】、文本编辑器、常用的lua module，帮助说明文档。</li>
</ul>
</li>
</ul>
<h6 id="致谢："><a href="#致谢：" class="headerlink" title="致谢："></a>致谢：</h6><ul>
<li><a href="https://blog.csdn.net/never_QH/article/details/45148835" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/never_QH/article/details/45148835</a></li>
<li><a href="http://geekgaoyang.herokuapp.com/blog/2015/02/11/cocos2d-x-tutorial-of-binding-c-plus-plus-class-to-lua-usage/" target="_blank" rel="noopener noreferrer">http://geekgaoyang.herokuapp.com/blog/2015/02/11/cocos2d-x-tutorial-of-binding-c-plus-plus-class-to-lua-usage/</a></li>
<li><a href="https://www.cnblogs.com/ZhYQ-Note/p/5939783.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/ZhYQ-Note/p/5939783.html</a></li>
<li><a href="http://www.bubuko.com/infodetail-1210197.html" target="_blank" rel="noopener noreferrer">http://www.bubuko.com/infodetail-1210197.html</a></li>
<li><a href="https://www.jianshu.com/p/9bd4d5518d53" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/9bd4d5518d53</a></li>
</ul>