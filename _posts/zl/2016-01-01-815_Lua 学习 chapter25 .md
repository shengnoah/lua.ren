---
layout: post
title: Lua 学习 chapter25  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>自省机制</li>
  <li>访问变量</li>
  <li>钩子</li>
  <li>调优</li>
  <li>沙盒</li>
</ol>

<blockquote>
  <p>只有疯狂过，你才知道自己究竟能不能成功。</p>
</blockquote>

<h2 id="自省机制">自省机制</h2>
<p>通过debug.getinfo(foo)，函数就会返回一个包含该函数有关的一些数据的表。</p>

<ul>
  <li>source: 该字段用于说明函数定义的位置。如果函数定义在一个字符串中（通过调用load），那么source就是这个字符串：如果函数定义在一个文件中，那么source就是使用@作为前缀的文件名。</li>
  <li>short_src:source精简版</li>
  <li>linedefined:源代码中第一行</li>
  <li>lastlinedefined：最后一行</li>
  <li>what:该字段用于说明函数的类型。lua函数就是lua，c函数就是c，位于主函数就是main</li>
  <li>name:函数的适当名字，例如保存该函数的全局变量名称</li>
  <li>namewhat：说明一个字段的含义，可能是”global”,”local”,”method”,”field”或”“（空字符串）</li>
  <li>nups：函数的上值个数</li>
  <li>nparams：函数参数个数</li>
  <li>isvararg:该字段表明该函数是否为可变长函数</li>
  <li>activelines:该字段是一个包含该函数所有活跃行的集合。活跃行（active line)是指除空行和只包含注释的行外的其他行。</li>
  <li>func:该字段是该函数本身</li>
</ul>

<p>当时用数字n作为参数调用函数getinfo(2)时，可以得到有关相应栈层次上活跃函数的数据。栈层次是一个数字，代表某个时刻上活跃的的顶函数。调用getinfo的函数A的层次是1，而调用A的函数的层次是2，以此类推。</p>

<p>getinfo效率不高，所以这里可以通过第二个参数提高效率：</p>

<ul>
  <li>n  选择name和namewhat</li>
  <li>f  选择func</li>
  <li>S  选择source，short_src，what，linedefined和lastlinedefined</li>
  <li>l  选择currentline</li>
  <li>L  选择activelines</li>
  <li>u  选择nup、nparams和isvararg</li>
</ul>

<p>debug.getinfo(foo,”SL”)</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">traceback</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">math.huge</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">info</span> <span class="o">=</span> <span class="nb">debug.getinfo</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="s2">&#34;Sl&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span> <span class="k">then</span>
            <span class="k">break</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">.</span><span class="n">what</span> <span class="o">==</span> <span class="s2">&#34;C&#34;</span> <span class="k">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%dtC fucntion&#34;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">else</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%dt[%s]:%d&#34;</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">info</span><span class="p">.</span><span class="n">short_src</span><span class="p">,</span><span class="n">info</span><span class="p">.</span><span class="n">currentline</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">traceback</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="访问变量">访问变量</h2>
<p>通过debug.getlocal来检查任意活跃函数的局部变量。还可以通过函数getupvalue来访问一个被lua函数所使用的的非局部变量。</p>

<p>我们还可以通过traceback函数来打印堆栈信息。</p>

<h2 id="钩子">钩子</h2>

<p>调试库中的钩子机制允许用户注册一个钩子函数，这个钩子函数会在程序运行中某个特定事件发生时被调用：</p>

<ul>
  <li>每当调用一个函数时产生的call事件</li>
  <li>每当函数返回时产生的return事件</li>
  <li>每当开始执行一行新代码产生的line事件</li>
  <li>执行完指定数量的指令后产生的count事件</li>
</ul>

<p>钩子函数的注册：通过debug.sethook：第一个参数是钩子函数，第二个参数是描述要监控事件掩码字符串，第三个参数是一个用于描述以何种频度获取count事件的可选参数。</p>

<p>要监控call、return、line事件，把这几个事件的首字母放入掩码字符串。要监控count事件，则需要在第三个参数中指定一个计数器。如果要关闭钩子，不带参数的调用sethook函数即可。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">hello</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">debug.sethook</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span><span class="s2">&#34;c&#34;</span><span class="p">)</span>
<span class="n">hello</span><span class="p">()</span>
<span class="cm">--[[输出
hello	call
hello	call
hello	call
hellohello	call
	nil
]]</span><span class="c1">--</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="调优">调优</h2>

<p>可以用来分析程序使用资源的行为，但对于时间方面的调优最好还是使用c，因为钩子函数的调用开销有点大。在这里我们来测试程序执行的每个函数的调用次数。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">Counters</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">Names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">hook</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">debug.getinfo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&#34;f&#34;</span><span class="p">).</span><span class="n">func</span>
    <span class="kd">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Counters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="n">Counters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">Names</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">debug.getinfo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">&#34;Sn&#34;</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">Counters</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="c1">-- lua profiler main-prog</span>
<span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="nb">loadfile</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">debug</span><span class="p">.</span><span class="n">sethool</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span><span class="s2">&#34;c&#34;</span><span class="p">)</span>
<span class="n">f</span><span class="p">()</span>
<span class="nb">debug.sethook</span><span class="p">()</span>


</pre></td></tr></tbody></table></code></pre></div></div>



                <hr style="visibility: hidden;"/>
                
                <hr style="visibility: hidden;"/>