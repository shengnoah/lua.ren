---
layout: post
title: Suricata + Lua实现本地情报对接 
tags: [lua文章]
categories: [topic]
---
<p>​        由于近期网站遭受恶意攻击, 通过对于登录接口的审计与分析, 现已确定了一批可疑账号。既然之前写过一个登录接口的审计脚本, 那么完全可以通过扩展这个脚本来实现对于可疑账号的比对。主要思路: 通过将可疑账号存进Redis中, 再利用Lua脚本调用Redis接口进行账号的比对。</p>
<p>先说一下<strong>Suricata</strong>默认是存在黑名单机制的, 如下:</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="comment">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span></span><br/><span class="line"><span class="comment">#default-reputation-path: /etc/suricata/iprep</span></span><br/><span class="line"><span class="comment">#reputation-files:</span></span><br/><span class="line"><span class="comment"># - reputation.list</span></span><br/></pre></td></tr></tbody></table></figure>

<p>在<strong>Suricata 5.0</strong> 版本中更是增加了新的功能<strong><a href="https://suricata.readthedocs.io/en/suricata-5.0.0/rules/datasets.html" target="_blank" rel="noopener noreferrer">Datasets</a></strong>。大概看了一下, 可以通过在规则中使用<code>dataset</code>和<code>datarep</code>关键字将大量数据与<code>sticky buffer</code>进行匹配。确实是个很赞的功能!</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">alert http any any -&gt; any any (http.user_agent; dataset:<span class="built_in">set</span>, ua-seen, <span class="built_in">type</span> string, save ua-seen.lst; sid:1;)</span><br/><span class="line"></span><br/><span class="line">alert dns any any -&gt; any any (dns.query; to_sha256; dataset:<span class="built_in">set</span>, dns-sha256-seen, <span class="built_in">type</span> sha256, save dns-sha256-seen.lst; sid:2;)</span><br/><span class="line"></span><br/><span class="line">alert http any any -&gt; any any (http.uri; to_md5; dataset:isset, http-uri-md5-seen, <span class="built_in">type</span> md5, load http-uri-md5-seen.lst; sid:3;)</span><br/></pre></td></tr></tbody></table></figure>

<p><strong>但是</strong>… 这并不适用我现在的场景, 因为在我的场景中, 用户的登录请求存在于POST请求中, 默认的Suricata方法并不能准确定位到我们需要的账号。这个时候我们就只能依赖于<strong>Lua</strong>脚本来扩展。当然这些需求<strong>Zeek</strong>也可以满足, 只是…<strong>Zeek</strong>的脚本真是难写…不忍吐槽~</p>
<h1 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h1><p><strong>安装环境</strong> </p>
<p>​    <strong>OS</strong>: <em>Ubuntu 18.04</em></p>
<p>​    <strong>Suricata</strong>: <em>Suricata 5.0.0 RELEASE</em>        </p>
<ol>
<li>由于Ubuntu默认没有安装<strong><a href="https://luarocks.org/" target="_blank" rel="noopener noreferrer">LuaRocks</a></strong> (<em>LuaRocks is the package manager for Lua modules</em>), 这里需要我们手动安装。</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过apt直接安装, 简单省事儿。</span></span><br/><span class="line">$ apt-get install luarocks</span><br/></pre></td></tr></tbody></table></figure>

<hr/>
<ol start="2">
<li>通过<code>luarocks</code>安装我们所需要的<code>lua</code>模块, 这里我们需要用到<code>redis-lua</code>、<code>luasocket</code>这两个模块。</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Modules</span></span><br/><span class="line">$ luarocks install luasocket</span><br/><span class="line">$ luarocks install redis-lua</span><br/><span class="line"></span><br/><span class="line">$ ll /usr/<span class="built_in">local</span>/share/lua/5.1/</span><br/><span class="line">total 72</span><br/><span class="line">drwxr-xr-x 3 root root  4096 Oct 25 03:35 ./</span><br/><span class="line">drwxr-xr-x 3 root root  4096 Sep 17 14:14 ../</span><br/><span class="line">-rw-r--r-- 1 root root  8331 Oct 25 03:34 ltn12.lua</span><br/><span class="line">-rw-r--r-- 1 root root  2487 Oct 25 03:34 mime.lua</span><br/><span class="line">-rw-r--r-- 1 root root 35599 Oct 25 03:35 redis.lua</span><br/><span class="line">drwxr-xr-x 2 root root  4096 Oct 25 03:34 socket/</span><br/><span class="line">-rw-r--r-- 1 root root  4451 Oct 25 03:34 socket.lua</span><br/></pre></td></tr></tbody></table></figure>

<hr/>
<ol start="3">
<li>安装成功后,  可以简单的测试一下。</li>
</ol>
<ul>
<li>利用<strong>Docker</strong>启动<strong>Redis</strong>容器</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">$ docker run -ti -d -p 6379:6379 redis</span><br/></pre></td></tr></tbody></table></figure>

<ul>
<li>测试脚本<code>hello_redis.lua</code></li>
</ul>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&#34;redis&#34;</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">&#34;127.0.0.1&#34;</span>, <span class="number">6379</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> response = client:ping()</span><br/><span class="line"><span class="keyword">if</span> response == <span class="literal">false</span> <span class="keyword">then</span></span><br/><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">client:set(<span class="string">&#34;hello&#34;</span>, <span class="string">&#34;world&#34;</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> var = client:get(<span class="string">&#34;hello&#34;</span>)</span><br/><span class="line"><span class="built_in">print</span>(var)</span><br/></pre></td></tr></tbody></table></figure>

<ul>
<li>可能会存在环境变量不对导致的报错</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br/><span class="line">	luajit: /usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: module <span class="string">&#39;socket&#39;</span> not found:</span><br/><span class="line">	no field package.preload[<span class="string">&#39;socket&#39;</span>]</span><br/><span class="line">	no file <span class="string">&#39;./socket.lua&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;/usr/local/share/luajit-2.0.5/socket.lua&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;/usr/local/share/lua/5.1/socket.lua&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;/usr/local/share/lua/5.1/socket/init.lua&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;./socket.so&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;/usr/local/lib/lua/5.1/socket.so&#39;</span></span><br/><span class="line">	no file <span class="string">&#39;/usr/local/lib/lua/5.1/loadall.so&#39;</span></span><br/><span class="line">stack traceback:</span><br/><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#39;require&#39;</span></span><br/><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#39;create_connection&#39;</span></span><br/><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:836: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#39;connect&#39;</span></span><br/><span class="line">	a.lua:3: <span class="keyword">in</span> main chunk</span><br/><span class="line">	[C]: at 0x56508049e440</span><br/></pre></td></tr></tbody></table></figure>

<ul>
<li>执行<code>luarocks path --bin</code> 并将结果输入</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">$ luarocks path --bin</span><br/><span class="line">Warning: The directory <span class="string">&#39;/home/canon/.cache/luarocks&#39;</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing /usr/<span class="built_in">local</span>/bin/luarocks with sudo, you may want sudo<span class="string">&#39;s -H flag.</span></span><br/><span class="line"><span class="string">export LUA_PATH=&#39;</span>/home/canon/.luarocks/share/lua/5.1/?.lua;/home/canon/.luarocks/share/lua/5.1/?/init.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?/init.lua;./?.lua;/usr/<span class="built_in">local</span>/share/luajit-2.0.5/?.lua<span class="string">&#39;</span></span><br/><span class="line"><span class="string">export LUA_CPATH=&#39;</span>/home/canon/.luarocks/lib/lua/5.1/?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/?.so;./?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/loadall.so<span class="string">&#39;</span></span><br/><span class="line"><span class="string">export PATH=&#39;</span>/home/canon/.luarocks/bin:/usr/<span class="built_in">local</span>/bin:/home/canon/anaconda3/bin:/home/canon/anaconda3/condabin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin<span class="string">&#39;</span></span><br/></pre></td></tr></tbody></table></figure>

<ul>
<li>执行脚本, 将会看到如下输出:</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br/><span class="line">world</span><br/></pre></td></tr></tbody></table></figure>

<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><p>扩展登录接口审计脚本: <code>http_audit.lua</code></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/><span class="line">78</span><br/><span class="line">79</span><br/><span class="line">80</span><br/><span class="line">81</span><br/><span class="line">82</span><br/><span class="line">83</span><br/><span class="line">84</span><br/><span class="line">85</span><br/><span class="line">86</span><br/><span class="line">87</span><br/><span class="line">88</span><br/><span class="line">89</span><br/><span class="line">90</span><br/><span class="line">91</span><br/><span class="line">92</span><br/><span class="line">93</span><br/><span class="line">94</span><br/><span class="line">95</span><br/><span class="line">96</span><br/><span class="line">97</span><br/><span class="line">98</span><br/><span class="line">99</span><br/><span class="line">100</span><br/><span class="line">101</span><br/><span class="line">102</span><br/><span class="line">103</span><br/><span class="line">104</span><br/><span class="line">105</span><br/><span class="line">106</span><br/><span class="line">107</span><br/><span class="line">108</span><br/><span class="line">109</span><br/><span class="line">110</span><br/><span class="line">111</span><br/><span class="line">112</span><br/><span class="line">113</span><br/><span class="line">114</span><br/><span class="line">115</span><br/><span class="line">116</span><br/><span class="line">117</span><br/><span class="line">118</span><br/><span class="line">119</span><br/><span class="line">120</span><br/><span class="line">121</span><br/><span class="line">122</span><br/><span class="line">123</span><br/><span class="line">124</span><br/><span class="line">125</span><br/><span class="line">126</span><br/><span class="line">127</span><br/><span class="line">128</span><br/><span class="line">129</span><br/><span class="line">130</span><br/><span class="line">131</span><br/><span class="line">132</span><br/><span class="line">133</span><br/><span class="line">134</span><br/><span class="line">135</span><br/><span class="line">136</span><br/><span class="line">137</span><br/><span class="line">138</span><br/><span class="line">139</span><br/><span class="line">140</span><br/><span class="line">141</span><br/><span class="line">142</span><br/><span class="line">143</span><br/><span class="line">144</span><br/><span class="line">145</span><br/><span class="line">146</span><br/><span class="line">147</span><br/><span class="line">148</span><br/><span class="line">149</span><br/><span class="line">150</span><br/><span class="line">151</span><br/><span class="line">152</span><br/><span class="line">153</span><br/><span class="line">154</span><br/><span class="line">155</span><br/><span class="line">156</span><br/><span class="line">157</span><br/><span class="line">158</span><br/><span class="line">159</span><br/><span class="line">160</span><br/><span class="line">161</span><br/><span class="line">162</span><br/><span class="line">163</span><br/><span class="line">164</span><br/><span class="line">165</span><br/><span class="line">166</span><br/><span class="line">167</span><br/><span class="line">168</span><br/><span class="line">169</span><br/><span class="line">170</span><br/><span class="line">171</span><br/><span class="line">172</span><br/><span class="line">173</span><br/><span class="line">174</span><br/><span class="line">175</span><br/><span class="line">176</span><br/><span class="line">177</span><br/><span class="line">178</span><br/><span class="line">179</span><br/><span class="line">180</span><br/><span class="line">181</span><br/><span class="line">182</span><br/><span class="line">183</span><br/><span class="line">184</span><br/><span class="line">185</span><br/><span class="line">186</span><br/><span class="line">187</span><br/><span class="line">188</span><br/><span class="line">189</span><br/><span class="line">190</span><br/><span class="line">191</span><br/><span class="line">192</span><br/><span class="line">193</span><br/><span class="line">194</span><br/><span class="line">195</span><br/><span class="line">196</span><br/><span class="line">197</span><br/><span class="line">198</span><br/><span class="line">199</span><br/><span class="line">200</span><br/><span class="line">201</span><br/><span class="line">202</span><br/><span class="line">203</span><br/><span class="line">204</span><br/><span class="line">205</span><br/><span class="line">206</span><br/><span class="line">207</span><br/><span class="line">208</span><br/><span class="line">209</span><br/><span class="line">210</span><br/><span class="line">211</span><br/><span class="line">212</span><br/><span class="line">213</span><br/><span class="line">214</span><br/><span class="line">215</span><br/><span class="line">216</span><br/><span class="line">217</span><br/><span class="line">218</span><br/><span class="line">219</span><br/><span class="line">220</span><br/><span class="line">221</span><br/><span class="line">222</span><br/><span class="line">223</span><br/><span class="line">224</span><br/><span class="line">225</span><br/><span class="line">226</span><br/><span class="line">227</span><br/><span class="line">228</span><br/><span class="line">229</span><br/><span class="line">230</span><br/><span class="line">231</span><br/><span class="line">232</span><br/><span class="line">233</span><br/><span class="line">234</span><br/><span class="line">235</span><br/><span class="line">236</span><br/><span class="line">237</span><br/><span class="line">238</span><br/><span class="line">239</span><br/><span class="line">240</span><br/><span class="line">241</span><br/><span class="line">242</span><br/><span class="line">243</span><br/><span class="line">244</span><br/><span class="line">245</span><br/><span class="line">246</span><br/><span class="line">247</span><br/><span class="line">248</span><br/><span class="line">249</span><br/></pre></td><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">&#34;json&#34;</span></span><br/><span class="line">md5 = <span class="built_in">require</span> <span class="string">&#34;md5&#34;</span></span><br/><span class="line">redis = <span class="built_in">require</span> <span class="string">&#34;redis&#34;</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 登录接口</span></span><br/><span class="line">login_url = <span class="string">&#34;/login&#34;</span></span><br/><span class="line"><span class="comment">-- 登录错误提示</span></span><br/><span class="line">success_code = <span class="number">0</span></span><br/><span class="line"><span class="comment">-- event_name</span></span><br/><span class="line">event_name = <span class="string">&#34;login_audit&#34;</span></span><br/><span class="line"><span class="comment">-- event_type</span></span><br/><span class="line">event_type = <span class="string">&#34;lua&#34;</span></span><br/><span class="line"><span class="comment">-- logs</span></span><br/><span class="line">name = <span class="string">&#34;login_audit.json&#34;</span></span><br/><span class="line"><span class="comment">-- 协议</span></span><br/><span class="line">proto = <span class="string">&#34;TCP&#34;</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- redis_config</span></span><br/><span class="line">host = <span class="string">&#34;127.0.0.1&#34;</span></span><br/><span class="line">port = <span class="number">6379</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- common_mapping</span></span><br/><span class="line">http_common_mapping = <span class="string">&#39;{&#34;accept&#34;:&#34;accept&#34;,&#34;accept-charset&#34;:&#34;accept_charset&#34;,&#34;accept-encoding&#34;:&#34;accept_encoding&#34;,&#34;accept-language&#34;:&#34;accept_language&#34;,&#34;user-agent&#34;:&#34;user_agent&#34;}&#39;</span></span><br/><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- defind functioin</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(args)</span></span></span><br/><span class="line">    m = md5.new()</span><br/><span class="line">    m:update(args)</span><br/><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br/><span class="line">    t = {}</span><br/><span class="line">    ios = <span class="built_in">string</span>.<span class="built_in">match</span>(args, <span class="string">&#39;canon&#39;</span>)</span><br/><span class="line">    <span class="keyword">if</span> ios ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br/><span class="line">        mail = <span class="string">&#39;email&#34;%s+(.-)%s&#39;</span></span><br/><span class="line">        t[<span class="string">&#39;email&#39;</span>] = <span class="built_in">string</span>.<span class="built_in">match</span>(args, mail)</span><br/><span class="line">    <span class="keyword">else</span></span><br/><span class="line">        data = <span class="built_in">string</span>.split(args, <span class="string">&#39;&amp;&#39;</span>)</span><br/><span class="line">        <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br/><span class="line">            d = <span class="built_in">string</span>.split(v, <span class="string">&#39;=&#39;</span>)</span><br/><span class="line">            t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> t</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br/><span class="line">    rt = {}</span><br/><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">&#39;[^&#39;</span>..p..<span class="string">&#39;]+&#39;</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br/><span class="line">    <span class="keyword">return</span> rt</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- default function</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br/><span class="line">    <span class="keyword">local</span> needs = {}</span><br/><span class="line">    needs[<span class="string">&#34;protocol&#34;</span>] = <span class="string">&#34;http&#34;</span></span><br/><span class="line">    <span class="keyword">return</span> needs</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br/><span class="line">    filename = SCLogPath() .. <span class="string">&#34;/&#34;</span> .. name</span><br/><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&#34;a&#34;</span>))</span><br/><span class="line">    SCLogInfo(<span class="string">&#34;app_login_audit filename: &#34;</span> .. filename)</span><br/><span class="line">    http = <span class="number">0</span></span><br/><span class="line">  </span><br/><span class="line">    <span class="comment">-- Connect Redis Server</span></span><br/><span class="line">    SCLogInfo(<span class="string">&#34;Connect Redis Server...&#34;</span>)</span><br/><span class="line">    client = redis.connect(host, port)</span><br/><span class="line">    response = client:ping()</span><br/><span class="line">    <span class="keyword">if</span> response <span class="keyword">then</span></span><br/><span class="line">        SCLogInfo(<span class="string">&#34;Redis Server connection succeeded.&#34;</span>)</span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br/><span class="line">    <span class="comment">-- init tables</span></span><br/><span class="line">    http_table = {</span><br/><span class="line">        hostname = <span class="literal">nil</span>,</span><br/><span class="line">        url = <span class="literal">nil</span>,</span><br/><span class="line">        url_path = <span class="literal">nil</span>,</span><br/><span class="line">        method = <span class="literal">nil</span>,</span><br/><span class="line">        <span class="built_in">status</span> = <span class="literal">nil</span>,</span><br/><span class="line">        protocol = <span class="literal">nil</span>,</span><br/><span class="line">        email = <span class="literal">nil</span>,</span><br/><span class="line">        results = <span class="literal">nil</span>,</span><br/><span class="line">        results_code = <span class="literal">nil</span></span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">-- ti tables</span></span><br/><span class="line">    ti = {</span><br/><span class="line">        tags = {},</span><br/><span class="line">        provider = <span class="literal">nil</span>,</span><br/><span class="line">        producer = <span class="literal">nil</span></span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">-- init score</span></span><br/><span class="line">    score = <span class="number">50</span></span><br/><span class="line"></span><br/><span class="line">    <span class="comment">-- http_hostname &amp; http_url</span></span><br/><span class="line">    http_hostname = HttpGetRequestHost()</span><br/><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment">-- http_method</span></span><br/><span class="line">    rl = HttpGetRequestLine()</span><br/><span class="line">    <span class="keyword">if</span> rl <span class="keyword">then</span></span><br/><span class="line">        http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">&#34;%w+&#34;</span>)</span><br/><span class="line">        <span class="keyword">if</span> http_method <span class="keyword">then</span></span><br/><span class="line">            http_table[<span class="string">&#34;method&#34;</span>] = http_method</span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">	</span><br/><span class="line">	  <span class="comment">-- 为了保证 Suricata 的性能不受影响, 严格控制过滤条件</span></span><br/><span class="line">    <span class="keyword">if</span> http_url == login_url <span class="keyword">and</span> http_method == <span class="string">&#34;POST&#34;</span> <span class="keyword">then</span></span><br/><span class="line">        http_table[<span class="string">&#34;hostname&#34;</span>] = http_hostname</span><br/><span class="line">        http_table[<span class="string">&#34;url&#34;</span>] = http_url</span><br/><span class="line">        http_table[<span class="string">&#34;url_path&#34;</span>] = http_url</span><br/><span class="line">        </span><br/><span class="line">        <span class="comment">-- http_status &amp; http_protocol</span></span><br/><span class="line">        rsl = HttpGetResponseLine()</span><br/><span class="line">        <span class="keyword">if</span> rsl <span class="keyword">then</span></span><br/><span class="line">            status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&#34;%s(%d+)%s&#34;</span>)</span><br/><span class="line">            <span class="keyword">if</span> status_code <span class="keyword">then</span></span><br/><span class="line">                http_table[<span class="string">&#34;status&#34;</span>] = <span class="built_in">tonumber</span>(status_code)</span><br/><span class="line">            <span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">            http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&#34;(.-)%s&#34;</span>)</span><br/><span class="line">            <span class="keyword">if</span> http_protocol <span class="keyword">then</span></span><br/><span class="line">                http_table[<span class="string">&#34;protocol&#34;</span>] = http_protocol</span><br/><span class="line">            <span class="keyword">end</span></span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">        <span class="comment">-- login_results</span></span><br/><span class="line">        a, o, e = HttpGetResponseBody()</span><br/><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br/><span class="line">            <spa