---
layout: post
title: LuCI的uci使用（lua） 
tags: [lua文章]
categories: [topic]
---
<h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line"><span class="symbol">uci:</span><span class="keyword">add</span>(<span class="string">&#34;wireless&#34;</span>, <span class="string">&#34;wifi-iface&#34;</span>)</span><br/><span class="line"><span class="symbol">uci:</span>commit(<span class="string">&#34;wireless&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<p>actual result：</p>
<p><code>config wifi-iface</code> 一句会添加至 <code>/etc/config/wireless</code> 的末尾。</p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p>sample <code>cat /etc/config/network</code>:</p>
<figure class="highlight vbnet"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">config <span class="keyword">interface</span> </span><br/><span class="line">    <span class="keyword">option</span> ipaddr <span class="comment">&#39;192.168.1.1&#39;</span></span><br/></pre></td></tr></tbody></table></figure>
<p>codes:</p>
<figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).<span class="built_in">cursor</span>()</span><br/><span class="line">uci:<span class="keyword">delete</span>(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;lan&#34;</span>, <span class="string">&#34;ipaddr&#34;</span>) -- 如果不加第三个参数（ipaddr），则会<span class="keyword">delete</span>掉<span class="keyword">lan</span>的所有<span class="keyword">options</span>，包括config interface <span class="string">&#39;lan&#39;</span>一句。</span><br/><span class="line">uci:commit(<span class="string">&#34;network&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="delete-all"><a href="#delete-all" class="headerlink" title="delete_all"></a>delete_all</h2><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line"><span class="symbol">uci:</span>delete_all(<span class="string">&#34;firewall&#34;</span>, <span class="string">&#34;redirect&#34;</span>)</span><br/><span class="line"><span class="symbol">uci:</span>commit(<span class="string">&#34;firewall&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h2><p>sample <code>cat /etc/config/wireless</code>:</p>
<figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">config wifi-device <span class="string">&#39;radio0&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> country <span class="string">&#39;CN&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> disabled <span class="string">&#39;0&#39;</span></span><br/><span class="line"></span><br/><span class="line">config wifi-iface</span><br/><span class="line">    <span class="keyword">option</span> ssid <span class="string">&#39;aaa&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> hidden <span class="string">&#39;0&#39;</span></span><br/><span class="line"></span><br/><span class="line">config wifi-iface</span><br/><span class="line">    <span class="keyword">option</span> ssid <span class="string">&#39;bbb&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> hidden <span class="string">&#39;0&#39;</span></span><br/></pre></td></tr></tbody></table></figure>
<p>codes:</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> uci = <span class="built_in">require</span>(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line">uci:<span class="built_in">foreach</span>(<span class="string">&#34;wireless&#34;</span>, <span class="string">&#34;wifi-iface&#34;</span>, <span class="function"><span class="keyword">function</span><span class="params">(s)</span></span></span><br/><span class="line">    <span class="built_in">print</span>(s[<span class="string">&#34;.type&#34;</span>], s[<span class="string">&#34;.name&#34;</span>], s[<span class="string">&#34;.index&#34;</span>]) <span class="comment">-- 三个是默认自带有的</span></span><br/><span class="line">    <span class="built_in">print</span>(s.ssid)</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">-- 注意此处set之后不能commit，必须在遍历外面commit</span></span><br/><span class="line">    uci:set(<span class="string">&#34;wireless&#34;</span>, s[<span class="string">&#34;.name&#34;</span>], <span class="string">&#34;hidden&#34;</span>, <span class="string">&#34;1&#34;</span>)</span><br/><span class="line"><span class="keyword">end</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 没有set则无需commit。</span></span><br/><span class="line">uci:commit(<span class="string">&#34;wireless&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).<span class="attribute">cursor</span>()</span><br/><span class="line">local <span class="selector-tag">p</span> = uci:get(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;lan&#34;</span>, <span class="string">&#34;ipaddr&#34;</span>)</span><br/><span class="line"><span class="function"><span class="params">(p)</span></span></span><br/></pre></td></tr></tbody></table></figure>
<h2 id="get-all"><a href="#get-all" class="headerlink" title="get_all"></a>get_all</h2><figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> LuciUtil = <span class="keyword">require</span>(<span class="string">&#34;luci.util&#34;</span>)</span><br/><span class="line"><span class="built_in">local</span> uci = <span class="keyword">require</span>(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line"><span class="built_in">local</span> p = uci:get_all(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;lan&#34;</span>)</span><br/><span class="line">LuciUtil.dumptable(p)</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="get-list"><a href="#get-list" class="headerlink" title="get_list"></a>get_list</h2><p>sample <code>cat /etc/config/network</code>:</p>
<figure class="highlight lsl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">config interface &#39;wan&#39;</span><br/><span class="line">    option proto &#39;static&#39;</span><br/><span class="line">    option ipaddr &#39;<span class="number">10.1</span><span class="number">.1</span><span class="number">.2</span>&#39;</span><br/><span class="line">    option netmask &#39;<span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>&#39;</span><br/><span class="line">    option gateway &#39;<span class="number">10.1</span><span class="number">.1</span><span class="number">.1</span>&#39;</span><br/><span class="line">    <span class="type">list</span> dns &#39;<span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span>&#39;</span><br/><span class="line">    <span class="type">list</span> dns &#39;<span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>&#39;</span><br/></pre></td></tr></tbody></table></figure>
<p>codes:</p>
<figure class="highlight lasso"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> uci = <span class="keyword">require</span>(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line"><span class="built_in">local</span> LuciUtil = <span class="keyword">require</span>(<span class="string">&#34;luci.util&#34;</span>)</span><br/><span class="line"><span class="built_in">local</span> p = uci:get_list(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;wan&#34;</span>, <span class="string">&#34;dns&#34;</span>)</span><br/><span class="line">LuciUtil.dumptable(p)</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="section"><a href="#section" class="headerlink" title="section"></a>section</h2><figure class="highlight cs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line">local options = {</span><br/><span class="line">    []       = <span class="string">&#34;wan&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;src_dport&#34;</span></span>] = <span class="string">&#34;8080&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;proto&#34;</span></span>]     = <span class="string">&#34;tcpudp&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;target&#34;</span></span>]    = <span class="string">&#34;DNAT&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;dest&#34;</span></span>]      = <span class="string">&#34;lan&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;dest_port&#34;</span></span>] = <span class="string">&#34;80&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;dest_ip&#34;</span></span>]   = <span class="string">&#34;192.168.1.100&#34;</span>,</span><br/><span class="line">    [<span class="meta"><span class="meta-string">&#34;name&#34;</span></span>]      = <span class="string">&#34;aaa&#34;</span></span><br/><span class="line">}</span><br/><span class="line">uci:section(<span class="string">&#34;firewall&#34;</span>, <span class="string">&#34;redirect&#34;</span>, sectionName, options)</span><br/><span class="line">uci:commit(<span class="string">&#34;firewall&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<p>actual result（端口转发的例子）：</p>
<figure class="highlight gams"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"># <span class="string">&#39;abc&#39;</span>取决于sectionName，sectionName = nil则没有。</span><br/><span class="line">config redirect <span class="string">&#39;abc&#39;</span></span><br/><span class="line">    # <span class="keyword">options</span> = nil则下面部分都没有</span><br/><span class="line">    <span class="keyword">option</span> src <span class="string">&#39;wan&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> src_dport <span class="string">&#39;8080&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> proto <span class="string">&#39;tcpudp&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> target <span class="string">&#39;DNAT&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> dest <span class="string">&#39;lan&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> dest_port <span class="string">&#39;80&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> dest_ip <span class="string">&#39;192.168.1.100&#39;</span></span><br/><span class="line">    <span class="keyword">option</span> name <span class="string">&#39;aaa&#39;</span></span><br/></pre></td></tr></tbody></table></figure>
<h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line"><span class="symbol">uci:</span><span class="keyword">set</span>(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;lan&#34;</span>, <span class="string">&#34;ipaddr&#34;</span>, <span class="string">&#34;value_u_wanna_set&#34;</span>)</span><br/><span class="line"><span class="symbol">uci:</span>commit(<span class="string">&#34;network&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<blockquote>
<p>set有个特点，如果要设置的值跟目标文件中的值一样，则uci不会修改配置文件，相当于没改。<br/>可查看文件修改日期发现：<code>ls -le /etc/config/network</code></p>
</blockquote>
<h2 id="set-confdir"><a href="#set-confdir" class="headerlink" title="set_confdir"></a>set_confdir</h2><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br/><span class="line">    <span class="keyword">local</span> uci = <span class="built_in">require</span>(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line">    uci:set_confdir(<span class="string">&#34;/tmp/etc/config&#34;</span>)</span><br/><span class="line">    <span class="comment">-- set_confdir之后，此uci都会去操作/tmp/etc/config目录</span></span><br/><span class="line">    <span class="comment">-- 作用域为本函数内</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<h2 id="set-list"><a href="#set-list" class="headerlink" title="set_list"></a>set_list</h2><figure class="highlight avrasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">local uci = require(<span class="string">&#34;luci.model.uci&#34;</span>).cursor()</span><br/><span class="line">local tbl = {</span><br/><span class="line">    [<span class="number">1</span>] = <span class="string">&#34;3.3.3.3&#34;</span>,</span><br/><span class="line">    [<span class="number">2</span>] = <span class="string">&#34;4.4.4.4&#34;</span></span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="symbol">uci:</span>set_list(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;wan&#34;</span>, <span class="string">&#34;dns&#34;</span>, tbl)</span><br/><span class="line">或者</span><br/><span class="line"><span class="symbol">uci:</span>set_list(<span class="string">&#34;network&#34;</span>, <span class="string">&#34;wan&#34;</span>, <span class="string">&#34;dns&#34;</span>, <span class="string">&#34;5.5.5.5&#34;</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="symbol">uci:</span>commit(<span class="string">&#34;network&#34;</span>)</span><br/></pre></td></tr></tbody></table></figure>
<blockquote>
<p>注意<code>set_list</code>会先删掉文件中的list项再添加进去。</p>
</blockquote>
<p>更多LuCI API在此：<a href="https://github.com/openwrt/luci/tree/master/documentation/api" title="https://github.com/openwrt/luci/tree/master/documentation/api" target="_blank" rel="noopener noreferrer">https://github.com/openwrt/luci/tree/master/documentation/api</a></p>