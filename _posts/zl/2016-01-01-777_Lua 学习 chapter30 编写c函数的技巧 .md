---
layout: post
title: Lua 学习 chapter30 编写c函数的技巧  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>数组操作</li>
  <li>字符串操作</li>
  <li>在c函数中保存状态</li>
</ol>

<blockquote>
  <p>生活总需要一点仪式感，然后慢慢的像那个趋向完美的自己靠近。</p>
</blockquote>

<h2 id="数组操作">数组操作</h2>

<p>Lua中的数组就是以特殊的方式使用边。像lua_setttable and lua_gettable这种用来操作的通用函数，也可以用于操作数组，不过C API为使用整数索引的表访问和更新提供了专门的函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">lua_geti</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">lua_seti</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>lua_geti相当于：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="n">lua_gettable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">t</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>lua_seti相当于：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="n">lua_insert</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="n">lua_settable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">t</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>eg:函数map，该函数对数组中的所有元素调用一个指定的函数，然后用此函数返回的结果替换掉对应的数组元素。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">l_map</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">LUA_TTABLE</span><span class="p">);</span> <span class="c1">//确保指定的参数具有指定的类型</span>
	<span class="n">luaL_checktype</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LUA_TFUNCTION</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">luaL_len</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//类似长度运算符</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">lua_pushvalue</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">lua_geti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">lua_call</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//类似以pcall但是会传播错误，而不是返回错误码</span>
		<span class="n">lua_seti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="字符串操作">字符串操作</h2>

<p>当c函数接收到一个lua字符串为参数是，必须遵守两条规则，在使用字符串期间不能从栈中将其弹出，而且不应该修改字符串。</p>

<p>标准API为两种最用的字符串操作提供了支持，即字符串提取和字符串连接。要提取子串，那么基本的操作lua_pushlstring可以获取字符串长度作为额外的参数。因此，如果要把字符串s从i到j(include)的子串传递给lua：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">lua_pushlstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>eg:函数根据分隔符来分隔字符串：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="n">static</span> <span class="n">int</span> <span class="n">l_split</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="n">luaL_checkstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">luaL_checkstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">const</span> <span class="n">char</span><span class="o">*</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">sep</span><span class="p">))</span> <span class="err">!</span><span class="o">=</span> <span class="n">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">lua_pushlstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">);</span>
		<span class="n">lua_rawseti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="n">lua_rawseti</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="在c函数中保存状态">在c函数中保存状态</h2>

<p>C API提供了两个类似的地方来存储非局部数据，即注册表(registry)和上值(upvalue).</p>

<p><strong>注册表</strong></p>

<p>注册表是一张只能被C代码访问的全局表。通常情况下，我们使用注册表来存储多个模块间的共享数据。</p>

<p>注册表总是位于伪索引LUA_REGISTRYINDEX中。伪索引就像是一个栈中的索引，但是它所关联的值不在栈中。lua API中大多数接受索引作为参数的函数也能将伪索引作为参数，像lua_remove和lua_insert这种操作栈本身的函数除外。eg:获取注册表中键为“key”的值，可以使用如下的调用。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">lua_getfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_REGISTRYINDEX</span><span class="p">,</span> <span class="s">&#34;Key&#34;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">key</span> <span class="o">=</span> <span class="sc">&#39;k&#39;</span>
<span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">mystr</span><span class="p">);</span>
<span class="n">lua_rawsetp</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">LUA_REGISTRYINDEX</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span><span class="c1">//设置值到注册表中</span>

<span class="n">lua_rawgetp</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">LUA_REGISTRYINDEX</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span><span class="c1">//从注册表中取值</span>
<span class="n">mystr</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>



                <hr style="visibility: hidden;"/>
                
                <hr style="visibility: hidden;"/>