---
layout: post
title: Centos7安装Nginx整合Lua 
tags: [lua文章]
categories: [topic]
---
<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。现在通常把lua迁入nginx中，根据lua脚本规则，强化nginx的能力。本文介绍在centos7中安装nginx整合lua。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><strong>centos7</strong></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service </span><br/><span class="line">systemctl <span class="built_in">disable</span> firewalld.service <span class="comment">#禁止firewall开机启动</span></span><br/></pre></td></tr></tbody></table></figure><h4 id="安装依赖环境"><a href="#安装依赖环境" class="headerlink" title="安装依赖环境"></a>安装依赖环境</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils gcc zlib zlib-devel pcre-devel openssl openssl-devel wget</span><br/></pre></td></tr></tbody></table></figure><h4 id="安装LuaJIT"><a href="#安装LuaJIT" class="headerlink" title="安装LuaJIT"></a>安装LuaJIT</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">wget http://luajit.org/download/LuaJIT-2.0.2.tar.gz</span><br/><span class="line">tar -xvf LuaJIT-2.0.2.tar.gz</span><br/><span class="line"><span class="built_in">cd</span> LuaJIT-2.0.2</span><br/><span class="line">make install</span><br/></pre></td></tr></tbody></table></figure><h4 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h4><p><strong>下载ngx_devel_kit、lua-nginx-module、nginx</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">wget https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz</span><br/><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.9rc7.tar.gz</span><br/><span class="line">wget http://nginx.org/download/nginx-1.12.1.tar.gz </span><br/><span class="line"><span class="comment">#注意下载后的压缩包没有文件名称，但是根据版本号能区分是哪个文件</span></span><br/><span class="line">tar -xvf v0.3.0.tar.gz</span><br/><span class="line">tar -xvf v0.10.9rc7.tar.gz</span><br/><span class="line">tar -xvf nginx-1.12.1.tar.gz</span><br/></pre></td></tr></tbody></table></figure><h4 id="编译Nginx"><a href="#编译Nginx" class="headerlink" title="编译Nginx"></a>编译Nginx</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> nginx-1.12.1</span><br/><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=../ngx_devel_kit-0.3.0 --add-module=../lua-nginx-module-0.10.9rc7  --with-http_ssl_module  --with-http_stub_status_module  --with-http_gzip_static_module</span><br/></pre></td></tr></tbody></table></figure><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure><h4 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h4><p>启动时会nginx可能会报错</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">./nginx: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file:</span><br/></pre></td></tr></tbody></table></figure><p>原因是：找不到libluajit-5.1.so.2这个文件</p><p><strong>解决办法</strong></p><p>找到 libluajit-5.1.so.2,libluajit-5.1.so.2.0.2这两个文件复制到 对应的lib下<br/>64位是 /usr/lib64<br/>32位是 /usr/lib</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">find / -name libluajit-5.1.so.2</span><br/></pre></td></tr></tbody></table></figure><p><img src="https://wandouduoduo.github.io//articles/c745ae1a/1.png" alt=""/></p><p>文件默认是安装在 /usr/local/lib/libluajit-5.1.so.2下</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/lib/libluajit-5.1.so.2 /usr/lib64/</span><br/><span class="line">cp /usr/<span class="built_in">local</span>/lib/libluajit-5.1.so.2.0.2 /usr/lib64</span><br/></pre></td></tr></tbody></table></figure><p><strong>然后启动</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br/></pre></td></tr></tbody></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>在nginx安装目录下，修改nginx.conf文件</p><p>在Server代码块下添加如下代码</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">location /hello{</span><br/><span class="line">        default_type <span class="string">&#39;text/plain&#39;</span>;</span><br/><span class="line">        content_by_lua <span class="string">&#39;ngx.say(&#34;hello,lua&#34;)&#39;</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p><img src="https://wandouduoduo.github.io//articles/c745ae1a/2.png" alt=""/></p><p><strong>配置生效</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span><br/><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span><br/></pre></td></tr></tbody></table></figure><p><strong>浏览器访问</strong></p><p>访问地址： <a href="http://xxx.xxx.xxx/hello" target="_blank" rel="noopener noreferrer">http://xxx.xxx.xxx/hello</a></p><p><img src="https://wandouduoduo.github.io//articles/c745ae1a/3.png" alt=""/></p><p>到此就成功了。</p><h2 id="添加服务"><a href="#添加服务" class="headerlink" title="添加服务"></a>添加服务</h2><p>这时nginx只能用绝对路径启动，测试和重载，非常不方便。那需要把nginx添加到linux的服务管理中。</p><p><strong>编写nginx.service文件</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line">[Unit]</span><br/><span class="line">Description=nginx</span><br/><span class="line">After=network.target</span><br/><span class="line"></span><br/><span class="line">[Service]</span><br/><span class="line">Type=forking</span><br/><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br/><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br/><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span><br/><span class="line">PrivateTmp=true</span><br/><span class="line"></span><br/><span class="line">[Install]</span><br/><span class="line">WantedBy=multi-user.target</span><br/></pre></td></tr></tbody></table></figure><p><strong>添加</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">cp ./nginx.service /lib/systemd/system/</span><br/></pre></td></tr></tbody></table></figure><p><strong>重新加载</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br/></pre></td></tr></tbody></table></figure><p><strong>验证</strong></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">systemctl start nginx.service</span><br/><span class="line">systemctl status nginx.service</span><br/><span class="line">systemctl <span class="built_in">enable</span> nginx.service</span><br/></pre></td></tr></tbody></table></figure>