---
layout: post
title: Lua string.find 中的 “坑”  
tags: [lua文章]
categories: [topic]
---
<p>我们的线上环境，ngx_lua api 都是以模块形式加载到 lua 级别的 vm 中，已达到最大性能。而且我们并没有使用传统的 “包” 的形式来加载(也就是 <code class="highlighter-rouge">require &#34;xx.xx.xx&#34;</code> )，而是直接以模块名为加载( <code class="highlighter-rouge">require &#34;xx&#34;</code> )，这就意味着我们需要不断的来动态设置 <code class="highlighter-rouge">package.path</code> 来配合 <code class="highlighter-rouge">require</code> 的机制。于是我们写了下面这个方法，来实现我们的需求：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">tools</span><span class="p">:</span><span class="n">loadluapath</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root_path</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="kd">local</span> <span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">..</span> <span class="s2">&#34;/?.lua;&#34;</span>
    <span class="k">if</span> <span class="nb">string.find</span><span class="p">(</span><span class="nb">package.path</span><span class="p">,</span><span class="n">root_path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="nb">package.path</span> <span class="o">=</span> <span class="nb">package.path</span> <span class="o">..</span> <span class="n">root_path</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>但近期我却发现 <code class="highlighter-rouge">package.path</code> 好像存在泄漏点，有将近 60K 的大小，而且还在一直持续增长。这并不符合我们的预期，其应该是在启动阶段过后，在一段时间内不断增长，之后应该是趋于稳定，到最后完全是一个常数级的大小。所以说，上面的 <code class="highlighter-rouge">loadluapath</code> 方法一定是出了问题，那么肯定就是 <code class="highlighter-rouge">string.find(package.path,root_path) == nil</code> 这条语句喽，继续测试：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Lua</span> <span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">4</span>  <span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">1994</span><span class="o">-</span><span class="mi">2008</span> <span class="n">Lua</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">PUC</span><span class="o">-</span><span class="n">Rio</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="k">do</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">package.path</span><span class="p">)</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">string.rep</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">string.find</span><span class="p">(</span><span class="nb">package.path</span><span class="p">,</span><span class="s2">&#34;/test/yyyy-mm-dd/?.lua&#34;</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="k">end</span>
<span class="p">.</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="kd">local</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">yyyy</span><span class="o">-</span><span class="n">mm</span><span class="o">-</span><span class="n">dd</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span>
<span class="o">====================</span>
<span class="kc">nil</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span>
</code></pre></div></div>

<p>貌似不对，为什么 string.find 返回 nil，又是万能的 SO 上找到了解释：</p>

<blockquote>
  <p>string.find(), by default, does not find strings in strings, it finds patterns in strings. str:find(pattern, init, plain) which allows you to pass in true as a last argument and search for plain strings.</p>
</blockquote>

<p>原来 <code class="highlighter-rouge">string.find</code> 是当做 pattern 来查找的。修改一下，继续测试：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="k">do</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">package.path</span><span class="p">)</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">string.rep</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="o">&gt;&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="nb">string.find</span><span class="p">(</span><span class="nb">package.path</span><span class="p">,</span><span class="s2">&#34;/test/yyyy-mm-dd/?.lua&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="kc">true</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="k">end</span>
<span class="p">.</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="kd">local</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="err">?</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">lua</span><span class="p">;</span>
<span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">yyyy</span><span class="o">-</span><span class="n">mm</span><span class="o">-</span><span class="n">dd</span><span class="o">/</span><span class="err">?</span><span class="p">.</span><span class="n">lua</span>
<span class="o">====================</span>
<span class="mi">162</span> <span class="mi">183</span>
</code></pre></div></div>

<p>Bingo ! 这下看到预期效果了。</p>

<p>如果你也不确定 <code class="highlighter-rouge">find</code> 的字符串会不会包含元字符，靠谱的方式，还是加个 true 参数比较好！</p>


                <hr style="visibility: hidden;"/>