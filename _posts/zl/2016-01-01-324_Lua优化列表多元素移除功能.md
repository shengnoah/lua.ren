---
layout: post
title: Lua优化列表多元素移除功能 
tags: [lua文章]
categories: [topic]
---
<p>在 Lua 的内置库中，table 提供了 <em>table.remove(t,[num])</em> 来删除列表中的元素，因为在该函数的执行过程涉及到了内存的移动，所以在删除多个元素的时候，如果每次都调用该函数，就会造成多次内存移动。</p>
<p>针对这一点，对 table 进行一些删除操作上的性能优化，代码基本上是从 C# 源码中抄过来的:-D，介绍在<a href="https://blog.csdn.net/salvare/article/details/81584827" target="_blank" rel="noopener noreferrer">这里</a>，下面直接附上代码，里面注释比较清楚，有什么问题，希望能够留言指出。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/></pre></td><td class="code"><pre><span class="line">local TableUtil = {}</span><br/><span class="line"></span><br/><span class="line">---从列表 t 中删除从 pos 开始的 num 个元素。</span><br/><span class="line">---@t 删除元素的列表</span><br/><span class="line">---@pos 开始删除索引</span><br/><span class="line">---@num 要删除元素的数量，如果没有指定，则删除 pos 之后的所有元素</span><br/><span class="line">function TableUtil.ClearArray(t,pos,num)</span><br/><span class="line">    assert(t ~= nil,<span class="string">&#34;The array:t is nil&#34;</span>)</span><br/><span class="line">    assert(pos &gt; <span class="number">0</span> <span class="keyword">and</span> pos&lt;=#t,<span class="string">&#34;The pos is out range&#34;</span>)</span><br/><span class="line"></span><br/><span class="line">    --如果没有指定 num 值，则默认 pos 之后全部删除</span><br/><span class="line">    num = num <span class="keyword">or</span> #t</span><br/><span class="line"></span><br/><span class="line">    --需要删除的最后一个元素的索引</span><br/><span class="line">    local index = <span class="number">0</span></span><br/><span class="line">    <span class="keyword">if</span> num &gt;= <span class="number">0</span> then</span><br/><span class="line">        index = pos + num - <span class="number">1</span></span><br/><span class="line">    <span class="keyword">else</span></span><br/><span class="line">        --为了保持从尾往头删，调换头尾索引</span><br/><span class="line">        pos,index = pos + num + <span class="number">1</span>,pos</span><br/><span class="line">    end</span><br/><span class="line"></span><br/><span class="line">    --对头尾索引进行限制，避免超界</span><br/><span class="line">    index = index &gt; #t <span class="keyword">and</span> #t <span class="keyword">or</span> index</span><br/><span class="line">    index = index &lt; <span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> index</span><br/><span class="line">    pos = pos &lt; <span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span> <span class="keyword">or</span> pos</span><br/><span class="line"></span><br/><span class="line">    local maxn = #t - index + pos - <span class="number">1</span></span><br/><span class="line"></span><br/><span class="line">    table.move(t,index+<span class="number">1</span>,#t,pos)</span><br/><span class="line"></span><br/><span class="line">    local temp = #t</span><br/><span class="line">    <span class="keyword">while</span> temp &gt; maxn  <span class="keyword">do</span></span><br/><span class="line">        table.remove(t,temp)</span><br/><span class="line">        temp = temp - <span class="number">1</span></span><br/><span class="line">    end</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line">---从列表 t 中删除，所有满足 match 条件的元素</span><br/><span class="line">---@t 列表</span><br/><span class="line">---@match 筛选列表</span><br/><span class="line">function TableUtil.RemoveAll(t,match)</span><br/><span class="line">    assert(match ~= nil,<span class="string">&#34;Then match argument cannot be nil&#34;</span>)</span><br/><span class="line"></span><br/><span class="line">    --找到第一个需要删除的元素的索引 num</span><br/><span class="line">    local num = <span class="number">1</span></span><br/><span class="line">    <span class="keyword">while</span>(num &lt; #t <span class="keyword">and</span> <span class="keyword">not</span> match(t[num])) <span class="keyword">do</span></span><br/><span class="line">        num = num + <span class="number">1</span></span><br/><span class="line">    end</span><br/><span class="line"></span><br/><span class="line">    --如果需要删除的索引超过列表最大索引，则表明没有满足删除条件的元素</span><br/><span class="line">    <span class="keyword">if</span> num &gt; #t then</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br/><span class="line">    end</span><br/><span class="line"></span><br/><span class="line">    --将 num 之后不需要删除的元素，移动到需要删除的元素之前，这样可以避免拷贝</span><br/><span class="line">    local i = num + <span class="number">1</span></span><br/><span class="line">    <span class="keyword">while</span>(i &lt;= #t) <span class="keyword">do</span></span><br/><span class="line"></span><br/><span class="line">        <span class="keyword">while</span>(i &lt;= #t <span class="keyword">and</span> match(t[i])) <span class="keyword">do</span></span><br/><span class="line">            i = i + <span class="number">1</span></span><br/><span class="line">        end</span><br/><span class="line"></span><br/><span class="line">        <span class="keyword">if</span> i &lt;= #t then</span><br/><span class="line">            t[num] = t[i]</span><br/><span class="line">            num = num + <span class="number">1</span></span><br/><span class="line">            i = i + <span class="number">1</span></span><br/><span class="line">        end</span><br/><span class="line">    end</span><br/><span class="line">    local result = #t - num + <span class="number">1</span></span><br/><span class="line"></span><br/><span class="line">    --清楚需要删除的元素</span><br/><span class="line">    ClearArray(t,num,result)</span><br/><span class="line">    <span class="keyword">return</span> result</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> TableUtil</span><br/></pre></td></tr></tbody></table></figure>