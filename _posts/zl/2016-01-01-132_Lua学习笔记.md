---
layout: post
title: Lua学习笔记 
tags: [lua文章]
categories: [topic]
---
> Lua 学习笔记

## 1.1、 Lua源码学习

### 1.1.1、C语言函数名与宏定义冲突问题

所望的语言函数名与宏定义冲突问题，就是指宏定义与函数相同时编译器不知道标识符该怎么处理。如下代码：

    
    
    #pragma once
    
    #include <stdio.h>
    #define f() printf("this is define ");
    void f();
    

上述代码在VS2010会检测出`Error:不允许使用不完整定义`。解决方案很简单，如下：

    
    
    #pragma once
    
    #include <stdio.h>
    #define f() printf("this is define ");
    void (f)();
    

在函数名上添加小括号即可解决问题。这也就是为什么lua.h头文件里为什么那么函数名都带括号的原因:

    
    
    /*
    ** access functions (stack -> C)
    */
    
    LUA_API int             (lua_isnumber) (lua_State *L, int idx);
    LUA_API int             (lua_isstring) (lua_State *L, int idx);
    LUA_API int             (lua_iscfunction) (lua_State *L, int idx);
    LUA_API int             (lua_isinteger) (lua_State *L, int idx);
    LUA_API int             (lua_isuserdata) (lua_State *L, int idx);
    LUA_API int             (lua_type) (lua_State *L, int idx);
    LUA_API const char     *(lua_typename) (lua_State *L, int tp);
    
    LUA_API lua_Number      (lua_tonumberx) (lua_State *L, int idx, int *isnum);
    LUA_API lua_Integer     (lua_tointegerx) (lua_State *L, int idx, int *isnum);
    LUA_API int             (lua_toboolean) (lua_State *L, int idx);
    LUA_API const char     *(lua_tolstring) (lua_State *L, int idx, size_t *len);
    LUA_API size_t          (lua_rawlen) (lua_State *L, int idx);
    LUA_API lua_CFunction   (lua_tocfunction) (lua_State *L, int idx);
    LUA_API void           *(lua_touserdata) (lua_State *L, int idx);
    LUA_API lua_State      *(lua_tothread) (lua_State *L, int idx);
    LUA_API const void     *(lua_topointer) (lua_State *L, int idx);
    ....
    

### 1.1.2、C语言大量使用宏定义

  * 宏定义函数，减少函数调用开销
  * 宏定义方便 

### 1.1.3、VS编译lua源码

  * 参考： <https://www.kancloud.cn/digest/luanote/119932>
  * 注意要把你的测试project设置成启动项目，否则会出现错误：无法启动程序：xxxx.lib 指定文件格式无法识别或不支持二进制 

## 2、Lua语法

### 2.1、Lua函数调用方法`.`与`:`区别

  * `.`:是一般的调用 
  * `:`:自带第一个参数`self`
  * `s.xxx(s,arg) == s:xxx(arg)`

### 2.2、lua在查找一个表元素的时候，其步如下

  1. 在表中查找，如果找到的话，则返回该元素，找不到则继续。 
  2. 判断该表是否有metatable表，如果没有metatable表，返回nil，有元表则继续。 
  3. **判断metatable是否有 **index方法，如果** index方法为nil，则返回nil;如果 **index方法是一个表，则重复1、2、3步骤;如果** index方法是一个函数，则返回该函数的返回值。**
  4. **__index中的function会增加一个默认入参，而且是第一个参数**  
例如调用 foo.bar 时，如果在 foo 中没有找到名为 bar 的域时，则会调用 Metatable：__index(foo, bar)。于是：

### 2.3、__newindex元方法

 **newindex元方法用来对表更新，而**
index则用来对表进行访问。当你给表的一个缺少的索引赋值的时，解释器就会查找__newindex元方法；如果存在则调用这个函数而不进行赋值操作。

## 3、实战

### C++ 类导入lua

    
    
    1  
    2  
    3  
    4  
    5  
    6  
    7  
    8  
    9  
    10  
    11  
    12  
    13  
    14  
    15  
    16  
    17  
    18  
    19  
    20  
    21  
    22  
    23  
    24  
    25  
    26  
    27  
    28  
    29  
    30  
    31  
    32  
    33  
    34  
    35  
    36  
    37  
    38  
    39  
    40  
    41  
    42  
    43  
    44  
    45  
    46  
    47  
    48  
    49  
    50  
    51  
    52  
    53  
    54  
    55  
    56  
    57  
    58  
    59  
    60  
    61  
    62  
    63  
    64  
    65  
    66  
    67  
    68  
    69  
    70  
    71  
    72  
    73  
    74  
    75  
    76  
    77  
    78  
    79  
    80  
    81  
    82  
    83  
    84  
    85  
    86  
    87  
    88  
    89  
    90  
    91  
    

|

    
    
    /***********C++ Class to Lua*********************/  
    class Account {  
    public:   
    	Account(double balance){ m_balance = balance;}  
    	void deposit(double amount){m_balance += amount;}  
    	void withdraw(double amount){m_balance -= amount;}  
    	double balance(){return m_balance;}  
    private:  
    	double m_balance;  
    };  
      
    //class WrapperAccount {  
      
      
    Account* checkaccount(lua_State *L, int narg)  
    {  
    	luaL_checktype(L,narg, LUA_TUSERDATA);  
    	void *ud = luaL_checkudata(L,narg,"Account");  
    	luaL_argcheck(L,ud!= NULL,1,"user data error");  
    	return *(Account**)ud;  
    }  
      
    int create_account(lua_State *L)  
    {  
    	  
    	double balance = luaL_checknumber(L,1);  
    	Account **a = (Account**)lua_newuserdata(L,sizeof(Account));  
    	*a = new Account(balance);  
    	printf("construct! balance is: %lfn",balance);  
    	luaL_getmetatable(L,"Account");  
    	lua_setmetatable(L,-2);  
    	return 1;  
    }  
    int deposit(lua_State *L)  
    {  
    	Account *a = checkaccount(L,1);//(Account**)lua_touserdata(L,1);  
    	double amount = luaL_checknumber(L,-1);  
    	(a)->deposit(amount);  
    	return 0;  
    }  
    int withdraw(lua_State *L)  
    {  
    	Account *a = checkaccount(L,1);//(Account**)lua_touserdata(L,1);  
    	double amount = luaL_checknumber(L,-1);  
    	(a)->withdraw(amount);  
    	return 0;  
    }  
    int balance(lua_State *L)  
    {  
    	Account *a = checkaccount(L,1);//(Account**)lua_touserdata(L,1);  
    	double balance = (a)->balance();  
    	printf("balance is: %lfn",balance);  
    	lua_pushnumber(L,balance);  
    	return 0;  
    }  
    //public:  
      
    const char className[10] = "Account";  
    static const luaL_Reg methods[]= {  
    	//{"Account",create_account},  
    	{"deposit",deposit},  
    	{"withdraw",withdraw},  
    	{"balance",balance},  
    	{NULL,NULL}  
    };  
      
    int luaopen_Account(lua_State *L)  
    {  
    	luaL_newmetatable(L,"Account");  
    	lua_pushvalue(L,-1);  
    	lua_setfield(L,-2,"__index");//AAccount.__index = AAccount  
    	luaL_setfuncs(L,methods,0);//register the methods to the table that is on the top  
    	//luaL_newlib(L,methods);  
    	printf("xxxxxxxxxxn");  
    	return 1;  
    }  
      
    static const luaL_Reg libs [] = {{"Account",luaopen_Account},{NULL,NULL}};  
    void Register(lua_State* L)  
    {  
    	const luaL_Reg *lib = libs;  
    	for (;lib->func; lib++)   
    	{  
    		luaL_requiref(L, lib->name, lib->func, 1);  
    		lua_pop(L, 1);  /* remove lib */  
    	}  
    	lua_register(L,"Account",create_account);  
    }  
      
    +++++++++ lua中使用++++++++  
    print("start");
    local a  = Account(100);
    print(a);
    print(a:balance());
    a:deposit(399);
    print("start");
    print(a:balance());
    print("end");  
      
  
---|---