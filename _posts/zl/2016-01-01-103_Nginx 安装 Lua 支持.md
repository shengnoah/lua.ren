---
layout: post
title: Nginx 安装 Lua 支持 
tags: [lua文章]
categories: [topic]
---
<p>Nginx 支持 Lua 需要安装 lua-nginx-module 模块，一般常用有 2 种方法: </p>
<ul>
<li><p>编译 Nginx 的时候带上 lua-nginx-module 模块一起编译</p>
</li>
<li><p>使用 OpenResty: Nginx + 一些模块，默认启用了 Lua 支持(推荐使用此方式)</p>
<blockquote>
<p><a href="https://openresty.org/cn/openresty.html" target="_blank" rel="noopener noreferrer">OpenResty</a> is just an enhanced version of <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> by means of addon modules anyway. You can take advantage of all the exisitng goodies in the <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> world.</p>
<p>​</p>
<p>OpenResty® 是一个基于 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p>
<p>OpenResty® 通过汇聚各种设计精良的 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 模块（主要由 OpenResty 团队自主开发），从而将 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p>
<p>OpenResty® 的目标是让你的Web服务直接跑在 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 服务内部，充分利用 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noopener noreferrer">Nginx</a> 的非阻塞 I/O 模型，不仅仅对 HTTP 客户端请求,甚至于对远程后端诸如 MySQL、PostgreSQL、Memcached 以及 Redis 等都进行一致的高性能响应。</p>
</blockquote>
</li>
</ul>
<h2 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h2><p>OpenResty 的安装很方便，Mac 里使用 brew 安装，对于一些常见的 Linux 发行版本，OpenResty® 提供 <a href="https://openresty.org/cn/linux-packages.html" target="_blank" rel="noopener noreferrer">官方预编译包</a>，CentOS 使用 yum，Ubuntu 使用 apt-get，具体请参考 <a href="https://openresty.org/cn/installation.html" target="_blank" rel="noopener noreferrer">https://openresty.org/cn/installation.html</a>，以下以 Mac 和 CentOS 7 中安装 OpenResty 为例。</p>
<h3 id="Mac-使用-OpenResty"><a href="#Mac-使用-OpenResty" class="headerlink" title="Mac 使用 OpenResty"></a>Mac 使用 OpenResty</h3><ul>
<li><p>终端执行 <code>brew install homebrew/nginx/openresty</code> 把 OpenResty 安装到 <strong>/usr/local/Cellar/openresty</strong></p>
</li>
<li><p>配置文件位于 <strong>/usr/local/etc/openresty/nginx.conf</strong> (可执行 <code>openresty -V</code> 从输出中找到)</p>
</li>
<li><p>启动 Nginx，2 种启动方式都可以</p>
<ul>
<li><code>sudo openresty</code> (openresty 其实就是 nginx 的软连接)</li>
<li><code>sudo nginx</code> (把 /usr/local/Cellar/openresty/1.11.2.5/nginx/sbin 添加到 PATH 里，注意不同版本时的路径不同)</li>
<li>查看是否启动了 nginx: <code>ps aux | grep nginx</code></li>
</ul>
</li>
<li><p>测试是否支持 Lua</p>
<ol>
<li><p><strong>/usr/local/etc/openresty/nginx.conf</strong> 中添加</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">location /lua {</span><br/><span class="line">    default_type &#39;text/html&#39;;</span><br/><span class="line">    content_by_lua &#39;ngx.say(&#34;hello world&#34;);&#39;;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>sudo nginx -t</code> 测试配置没问题，然后 <code>sudo nginx -s reload</code> 重新加载配置 (<code>sudo nginx -s stop</code> 关闭 Nginx)</p>
</li>
<li><p><code>curl http://localhost/lua</code> 输出 <strong>hello world</strong> 则说明 Nginx 支持 Lua</p>
</li>
</ol>
</li>
</ul>
<h3 id="CentOS-7-使用-OpenResty"><a href="#CentOS-7-使用-OpenResty" class="headerlink" title="CentOS 7 使用 OpenResty"></a>CentOS 7 使用 OpenResty</h3><ul>
<li><p>终端执行下面 3 条命令把 OpenResty 安装到 <strong>/usr/local/openresty</strong></p>
<p><code>sudo yum install yum-utils</code></p>
<p><code>sudo yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</code></p>
<p><code>sudo yum install openresty</code></p>
</li>
<li><p>Nginx 的配置文件位于 <strong>/usr/local/openresty/nginx/conf/nginx.conf</strong> (openresty -V 中没有指定)</p>
</li>
<li><p>启动 Nginx，2 种启动方式都可以</p>
<ul>
<li><code>sudo openresty</code></li>
<li><code>sudo nginx</code></li>
<li>查看是否启动了 nginx: <code>ps -ef | grep nginx</code></li>
</ul>
</li>
<li><p>测试是否支持 Lua: 参考上面的方法</p>
</li>
</ul>
<h2 id="编译-Nginx-Lua"><a href="#编译-Nginx-Lua" class="headerlink" title="编译 Nginx + Lua"></a>编译 Nginx + Lua</h2><blockquote>
<p>编译 Nginx 需要先准备好下面的这些工具，如果不确定是否已安装，可以在编译的时候根据出现的错误提示再进行安装</p>
<ul>
<li><code>yum install -y gcc g++ gcc-c++</code></li>
<li><code>yum -y install zlib zlib-devel openssl openssl--devel pcre pcre-devel</code></li>
</ul>
</blockquote>
<p>Nginx 支持 Lua 需要依赖 LuaJIT-2.0.4.tar.gz，ngx_devel_kit，lua-nginx-module，下面介绍具体的编译过程 (都下载到 /root 目录)</p>
<ol>
<li><p>下载安装 <strong>LuaJIT-2.0.4.tar.gz</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line">wget -c http://luajit.org/download/LuaJIT-2.0.4.tar.gz</span><br/><span class="line">tar xzvf LuaJIT-2.0.4.tar.gz</span><br/><span class="line">cd LuaJIT-2.0.4</span><br/><span class="line">make install PREFIX=/usr/local/luajit</span><br/><span class="line"></span><br/><span class="line"># 添加环境变量</span><br/><span class="line">export LUAJIT_LIB=/usr/local/luajit/lib</span><br/><span class="line">export LUAJIT_INC=/usr/local/luajit/include/luajit-2.0</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>下载解压 <strong>ngx_devel_kit</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">wget https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz</span><br/><span class="line">tar -xzvf v0.3.0.tar.gz</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>下载解压 <strong>lua-nginx-module</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.8.tar.gz</span><br/><span class="line">tar -xzvf v0.10.8.tar.gz</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>下载安装 <strong>nginx-1.10.3.tar.gz</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.10.3.tar.gz</span><br/><span class="line">tar -xzvf nginx-1.10.3.tar.gz</span><br/><span class="line">cd nginx-1.10.3</span><br/><span class="line"></span><br/><span class="line"># 注意ngx_devel_kit和lua-nginx-module 以实际解压路径为准</span><br/><span class="line">./configure --add-module=/root/ngx_devel_kit-0.3.0 --add-module=/root/lua-nginx-module-0.10.8</span><br/><span class="line"></span><br/><span class="line">make -j2</span><br/><span class="line">make install</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>支持 Nginx 被安装到了 <strong>/usr/local/nginx</strong>，配置文件为 <strong>/usr/local/nginx/conf/nginx.conf</strong></p>
</li>
<li><p>验证</p>
<ul>
<li><p>将 nginx 做成命令: <code>ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</code></p>
</li>
<li><p><strong>/usr/local/nginx/conf/nginx.conf</strong> 中添加 Lua 测试代码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">location /lua {</span><br/><span class="line">    default_type &#39;text/html&#39;;</span><br/><span class="line">    content_by_lua &#39;ngx.say(&#34;hello world&#34;);&#39;;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动 Nginx: <code>sudo nginx</code></p>
</li>
<li><p><code>curl http://localhost/lua</code> 输出 <strong>hello world</strong> 则说明 Nginx 支持 Lua</p>
</li>
</ul>
</li>
</ol>
<p>上面编译 Nginx 的内容来源于 <a href="http://www.cnblogs.com/aoeiuv/p/6856056.html" target="_blank" rel="noopener noreferrer">http://www.cnblogs.com/aoeiuv/p/6856056.html</a>，编译 Nginx 相对使用 OpenResty 麻烦一些，不过也不难，根据自己的喜好选择即可。</p>