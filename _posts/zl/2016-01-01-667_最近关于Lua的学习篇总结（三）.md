---
layout: post
title: 最近关于Lua的学习篇总结（三） 
tags: [lua文章]
categories: [topic]
---
**Contents**

## lua和.Net的相互调用

由于我们公司主要是用ulua进行热更新，所以不可避免的就是luainterface呢

### luainterface

luainterface包括两个核心库，一个是luainterface.dll,一个是luanet.dll  
可以通过luainterface完成lua和C#的相互调用

### 在C#中执行访问lua代码

Lua lua = new Lua(); //创建Lua解析器  
lua[“num”]=2; //定义一个num  
lua[“str”]=”a string”; //定义一个字符串  
lua.newTable(“tab”); //创建一个表 tab={}

### 取得lua环境中的变量

double num = (double)lua[“num”];

string str = (string)lua[“str”];

### 在C#中执行Lua脚本文件,或者脚本字符串

在C#中执行Lua脚本文件,或者脚本字符串  
lua.DoFile(“script.lua”);//执行script.lua脚本

    
    
    lua.DoString("num=2");
    
    lua.DoString("str='a string'");
    
    object[] retVals = lua.DoString("return num,str");
    

在热更新中，只需要写好解析lua脚本的代码，然后c#代码不需要变动，只需要修改lua脚本就好，通过lua脚本控制游戏逻辑。

# lua和C#中类型的对应

lnil null

    
    
    string      System.String
    
    number      System.Double
    
    boolean         System.Boolean
    
    table       LuaInterface.LuaTable
    
    function        LuaInterface.LuaFunction
    

# 把一个C#方法注册进Lua的一个全局方法

//把一个类中的普通方法注册进去  
lua.RegisterFunction(“NormalMethod”,obj,obj.GetType().GetMethod(“NormalMethod”))  
lua.DoString(“ NormalMethod()”);

//把一个类的静态方法注册进去  
lua.RegisterFunction(“StaticMethod”,null,typeof(ClassName).GetMethod(“StaticMethod”))  
lua.DoString(“ StaticMethod()”)

# 在Lua中使用c#中的类

require “luanet”  
–加载CLR的类型、实例化CLR对象  
luanet.load_assembly(“System.Windows.Forms”)  
luanet.load_assembly(“System.Drawing”)  
Form = luanet.import_type(“System.Windows.Forms.Form”)  
StartPosition = luanet.import_type(“System.Windows.Forms.FormStartPosition”)

print(Form)  
print(StartPosition)  
在Lua中使用C#中的类创建对象的时候，会自动匹配最合适的构造方法

# 在Lua中访问C#中的属性和方法

Lua代码中，访问C#对象的属性的方式和访问table的键索引一样，比如obj.name 或者 obj[“name”]

Lua代码中，访问C#对象的普通函数的方式和调用table的函数一样，比如obj:method1()

# 在Lua中访问C#中的方法-特殊情况

当函数中有out或ref参数时，out参数和ref参数和函数的返回值一起返回，并且调用的时候，out参数不需要传入  
C#函数定义  
class Obj{  
int OutMethod1(int parameter1,out parameter2,out parameter3){  
parameter2=34;parameter3=213;  
return parameter1;  
}  
int OutMethod2(int parameter1,ref parameter2){  
parameter2=parameter2+2;  
return parameter1+parameter2;  
}  
}  
Lua中的调用和返回值  
obj:OutMethod1(34)  
–out参数不需要参数，这个返回一个table，里面的值为parameter1,parameter2,parameter3  
(34,34,213)

obj:OutMethod2(10,10)  
–ref参数需要传入，返回一个table有两个值(value1,value2)

# 在Lua中访问C#中的方法-特殊情况

当有重载函数的时候，调用函数会自动匹配第一个能匹配的函数

可以使用get_method_bysig函数得到C#中指定类的指定参数的函数用法  
luaMethod = get_method_bysig(Obj,”CSharpMethod”,”System.String”)  
luaMethod(“siki”)

# 在Lua中注册C#中的事件委托（event delegate）

在Lua中通过Add方法或者Remove方法把一个Lua的函数注册或者注销从C#中的事件委托中  
function method()  
end  
obj.SomeEvent:Add(methodname(不用带引号))  
私人学习笔记而已。