---
layout: post
title: Lua数据结构的实现 
tags: [lua文章]
categories: [topic]
---
<blockquote>
<p>《Lua程序设计》笔记：高效地使用table来实现一些传统的数据结构</p>
</blockquote>
<h4 id="1-数组"><a href="#1-数组" class="headerlink" title="1 数组"></a>1 数组</h4><p>Lua库和长度操作符都遵循索引从1开始的约定。</p>
<h4 id="2-多维数组"><a href="#2-多维数组" class="headerlink" title="2 多维数组"></a>2 多维数组</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line">mt = {}</span><br/><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>, N <span class="keyword">do</span></span><br/><span class="line">    mt[i] = {}</span><br/><span class="line">    <span class="keyword">for</span> j=<span class="number">1</span>, M <span class="keyword">do</span></span><br/><span class="line">        mt[i][j] = <span class="number">0</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="comment">--合并索引（i*常量 + j）</span></span><br/><span class="line">mt = {}</span><br/><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>, N <span class="keyword">do</span></span><br/><span class="line">    <span class="keyword">for</span> j=<span class="number">1</span>, M <span class="keyword">do</span></span><br/><span class="line">        mt[(i<span class="number">-1</span>)*M+j] = <span class="number">0</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="3-链表、队列"><a href="#3-链表、队列" class="headerlink" title="3 链表、队列"></a>3 链表、队列</h4><p>table是动态实体，所以实现链表很方便；实现队列的话，使用table库的insert、remove。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--主要是new/pushlast/popfirst</span></span><br/><span class="line">List = {}</span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br/><span class="line">    <span class="keyword">return</span> {first=<span class="number">0</span>, last=<span class="number">-1</span>}</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List.pushfirst</span><span class="params">(list, value)</span></span></span><br/><span class="line">    <span class="keyword">local</span> first = list.first<span class="number">-1</span></span><br/><span class="line">    list.first = first</span><br/><span class="line">    list[first] = value</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List.pushlast</span><span class="params">(list, value)</span></span></span><br/><span class="line">    <span class="keyword">local</span> last = list.last+<span class="number">1</span></span><br/><span class="line">    list.last = last</span><br/><span class="line">    list[last] = value</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List.popfirst</span><span class="params">(list)</span></span></span><br/><span class="line">    <span class="keyword">local</span> first = list.first</span><br/><span class="line">    <span class="keyword">if</span> first&gt;list.last <span class="keyword">then</span> <span class="built_in">error</span>(<span class="string">&#39;list is empty&#39;</span>) <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">local</span> value = list[first]</span><br/><span class="line">    <span class="comment">--允许垃圾收集</span></span><br/><span class="line">    list[first] = <span class="literal">nil</span></span><br/><span class="line">    list.first = first+<span class="number">1</span></span><br/><span class="line">    <span class="keyword">return</span> value</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">List.poplast</span><span class="params">(list)</span></span></span><br/><span class="line">    <span class="keyword">local</span> last = list.last</span><br/><span class="line">    <span class="keyword">if</span> list.first&gt;last <span class="keyword">then</span> <span class="built_in">error</span>(<span class="string">&#39;list is empty&#39;</span>) <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">local</span> value = list[last]</span><br/><span class="line">    list[last] = <span class="literal">nil</span></span><br/><span class="line">    list.last = last<span class="number">-1</span></span><br/><span class="line">    <span class="keyword">return</span> value</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h4 id="4-集合、包"><a href="#4-集合、包" class="headerlink" title="4 集合、包"></a>4 集合、包</h4><p>将集合元素作为索引放入table中；则对任意值都无需搜索table，直接索引即可。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set</span><span class="params">(list)</span></span></span><br/><span class="line">    <span class="keyword">local</span> set = {}</span><br/><span class="line">    <span class="keyword">for</span> _, l <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span> set[l] = <span class="literal">true</span> <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> set</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Bag</span><span class="params">(list)</span></span></span><br/><span class="line">    <span class="keyword">local</span> bag = {}</span><br/><span class="line">    <span class="keyword">for</span> _, l <span class="keyword">in</span> <span class="built_in">ipairs</span>(list) <span class="keyword">do</span> bag[l] = <span class="number">1</span> <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> bag</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">(bag, element)</span></span></span><br/><span class="line">    bag[element] = (bag[element] <span class="keyword">or</span> <span class="number">0</span>)+<span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">(bag, element)</span></span></span><br/><span class="line">    <span class="keyword">local</span> count = bag[element]</span><br/><span class="line">    <span class="comment">--递减其计数器</span></span><br/><span class="line">    bag[element] = (count <span class="keyword">and</span> count&gt;<span class="number">1</span>) <span class="keyword">and</span> (count<span class="number">-1</span>) <span class="keyword">or</span> <span class="literal">nil</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h4 id="5-字符串缓冲"><a href="#5-字符串缓冲" class="headerlink" title="5 字符串缓冲"></a>5 字符串缓冲</h4><p>只要字符串是immutable值，不断的连接就会造成性能浪费。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--读文件的正确姿势</span></span><br/><span class="line"><span class="keyword">local</span> t = {}</span><br/><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span> <span class="keyword">do</span></span><br/><span class="line">    t[#t+<span class="number">1</span>] = line</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="comment">--欺骗concat，在结尾处添加换行</span></span><br/><span class="line">t[#t+<span class="number">1</span>] = <span class="string">&#39;&#39;</span></span><br/><span class="line"><span class="keyword">local</span> s = <span class="built_in">table</span>.<span class="built_in">concat</span>(t, <span class="string">&#39;n&#39;</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">--“汉诺塔”实现</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addString</span><span class="params">(stack, s)</span></span></span><br/><span class="line">    stack[#stack+<span class="number">1</span>] = s</span><br/><span class="line">    <span class="keyword">for</span> i = #stack<span class="number">-1</span>, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></span><br/><span class="line">        <span class="keyword">if</span> #stack[i] &gt; #stack[i+<span class="number">1</span>] <span class="keyword">then</span></span><br/><span class="line">            <span class="keyword">break</span></span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">        <span class="comment">--如果新字符串更大，则连接、压缩栈</span></span><br/><span class="line">        stack[i] = stack[i] .. stack[i+<span class="number">1</span>]</span><br/><span class="line">        stack[i+<span class="number">1</span>] = <span class="literal">nil</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>