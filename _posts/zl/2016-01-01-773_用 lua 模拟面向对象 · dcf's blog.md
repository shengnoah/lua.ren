---
layout: post
title: 用 lua 模拟面向对象 · dcf's blog 
tags: [lua文章]
categories: [topic]
---
<div class="post">
  
  
  <div>
    <span class="post-date">
      categories: 
      
      programming
      
      |
      tags:
      
      lua
      
      oo
      
    </span>
  </div>
  <hr/>
  <p>一些语言本身是没有面向对象这一说的，类似 lua, js。但是平时使用时，往往会利用语言上的特性来模拟 OO。 初学lua，也看了很多网上的资料、博客，一直不是很理解，只是照猫画虎。现在理解地差不多了，记录一下。</p>

<p>lua 用的是其强大的 table，可以简单地理解为 hash + array。作为 OO，我们需要模仿的有类和对象，每个对象有属性和方法。</p>

<p>首先我们用 table 模拟一个类，这个类有一个 new 的方法，可以生成一个对象，这个对象我们依然使用 table 进行模拟。这里的 new 并不像 c++ 中有特殊的含义，这是一个函数名，可以叫做任何名字，例如 create</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Student</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nc">Student</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span> 
  <span class="kd">local</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1">-- 创建一个对象 (table)</span>
  <span class="n">obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>    <span class="c1">-- 添加属性并赋值</span>
  <span class="n">obj</span><span class="p">.</span><span class="n">age</span>  <span class="o">=</span> <span class="n">age</span>  <span class="ow">or</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">obj</span>         
<span class="k">end</span>

<span class="n">stu</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;fcnaud&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stu</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>            <span class="c1">-- 使用属性</span>
</code></pre></div></div>

<p>除过属性，一个对象还应该拥有方法。</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Student</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nc">Student</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span> 
  <span class="kd">local</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>           <span class="c1">-- 创建一个对象 (table)</span>

  <span class="n">obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>    <span class="c1">-- 添加属性并赋值</span>
  <span class="n">obj</span><span class="p">.</span><span class="n">age</span>  <span class="o">=</span> <span class="n">age</span>  <span class="ow">or</span> <span class="mi">0</span>

  <span class="n">obj</span><span class="p">.</span><span class="n">sayHi</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">obj</span><span class="p">.</span><span class="n">showInfo</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1">-- 这里能够访问到正确的 obj，是由于闭包。你可以认为这个函数捕获到了上边那个局部变量。在 lua 里这种局部变量叫做 upvalue。</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">obj</span>         
<span class="k">end</span>

<span class="n">stu</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;fcnaud&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">stu</span><span class="p">.</span><span class="n">sayHi</span><span class="p">()</span>
<span class="n">stu1</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;dcf&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">stu1</span><span class="p">.</span><span class="n">sayHi</span><span class="p">()</span>
</code></pre></div></div>

<p>功能已经基本实现了，但是又出现了另一个问题，那就是所有的函数对每个对象来说都有一份，这实际上是很浪费的。学过 c++ 大家都知道，c++ 中的类函数实际上只有在类中有一份，所有的对象调用的都是这一个函数，然后通过一个隐式的 this 指针来进行数据的调用。</p>

<p>在 lua 里，我们可以利用 metatable（元表）来进行模拟。不清楚 metatable 的可以先去看一下教程。这里，我们让‘类’作为所有‘对象’的 metatable，将函数定义在‘类’中，这样所有对象在调用函数时，都会前往‘类’中调用。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Student</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nc">Student</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">class</span><span class="p">)</span> <span class="c1">-- 设置元表</span>
    <span class="n">class</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">class</span>    <span class="c1">-- 这里让 __index 指向自己，一是方便操作，二是节省空间</span>

    <span class="n">obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">obj</span><span class="p">.</span><span class="n">age</span>  <span class="o">=</span> <span class="n">age</span>  <span class="ow">or</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">obj</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">Student</span><span class="p">.</span><span class="nf">sayHi</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nc">Student</span><span class="p">.</span><span class="nf">show</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>   <span class="c1">-- 调用函数是也要知道是那个对象调用的</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">stu</span> <span class="o">=</span> <span class="n">Student</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">Student</span><span class="p">,</span> <span class="s1">&#39;fcnaud&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1">-- 生成对象时要制定class</span>
<span class="n">stu</span><span class="p">.</span><span class="n">sayHi</span><span class="p">()</span>
<span class="n">stu</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">stu</span><span class="p">)</span>  <span class="c1">-- 调用函数时要指定对象</span>
</code></pre></div></div>

<p>这里我们就基本地模拟了面向对象。不过每次都要显式指定十分麻烦，lua 中有一个语法糖可以提供我们使用。</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">obj</span><span class="p">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&lt;=&gt;</span> <span class="n">obj</span><span class="p">:</span><span class="n">func</span><span class="p">()</span>
</code></pre></div></div>
<p>使用冒号时，会隐式地将调用者传递进去（体现为 self，类似于 c++ 中的 this)，我们修正一下</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Student</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nf">Student</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>   <span class="c1">-- 使用冒号</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>       <span class="c1">-- 这里的 self 指的是 Student‘类’</span>
    <span class="n">self</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">self</span>

    <span class="n">obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">obj</span><span class="p">.</span><span class="n">age</span>  <span class="o">=</span> <span class="n">age</span>  <span class="ow">or</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">obj</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">Student</span><span class="p">:</span><span class="n">sayHi</span><span class="p">()</span>           <span class="c1">-- 虽然有的函数并不需要数据</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">Student</span><span class="p">:</span><span class="n">show</span><span class="p">()</span>            <span class="c1">-- 这个函数通常是 obj ‘对象’调用的，所以这个 self 指的是对象</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">stu</span> <span class="o">=</span> <span class="n">Student</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;fcnaud&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>     <span class="c1">-- 函数调用时也要使用冒号</span>
<span class="n">stu</span><span class="p">:</span><span class="n">sayHi</span><span class="p">()</span>
<span class="n">stu</span><span class="p">:</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>这里我以前最疑惑的就是上边那个 self 了，这个 self 在两个函数里边实际上是不同的。</p>

<p>最后，这里是我的一个记录，如果可能的话，希望能帮到一些人。如果有人发现文章中的错误，还望指出。</p>

<hr/>

<p><strong>参考</strong>:</p>
<ul>
  <li><a href="http://www.jellythink.com/archives/529" target="_blank" rel="noopener noreferrer">http://www.jellythink.com/archives/529 果冻想</a></li>
</ul>


</div>

<div class="related">
  <h2>Related Posts</h2>
  
</div>

<div>
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
    </a>
    除非特别声明，作品均采用<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>进行许可。
</div>