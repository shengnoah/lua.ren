---
layout: post
title: lua 迭代器和泛型for 
tags: [lua文章]
categories: [topic]
---

              <h2 id="迭代器和闭包">迭代器和闭包</h2>

<ol>
  <li>迭代器可以遍历集合的每一个元素，在lua中常常使用函数来描述迭代器，每次调用该函数就返回集合的下一个元素。</li>
  <li>迭代器需要保留上一次成功调用的状态和下一次成功调用的状态，也就是它知道来自于哪里和将要前往哪里。闭包可以实现这个任务。</li>
  <li>闭包是一个内部函数，它可以访问一个或者多个外部函数的局部变量。每次闭包成功调用后这些局部变量都保存他们的值(状态)。</li>
  <li>所以一个典型的闭包结构包含两个函数：一个是闭包自己，另一个是工厂（创建闭包的函数）</li>
</ol>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--一个简单的迭代器输出table的元素</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">list_iter</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
    <span class="c1">--list_iter是工厂函数</span>
	<span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">getn</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1">--在这里，t、i、n 都属于闭包外部的局部变量</span>
    <span class="c1">--返回闭包函数</span>
	<span class="k">return</span> <span class="k">function</span> <span class="p">(</span>  <span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="k">then</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="k">end</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">}</span>
<span class="kd">local</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">list_iter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">true</span> <span class="k">do</span> 
	<span class="kd">local</span> <span class="n">m</span> <span class="o">=</span> <span class="n">iter</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
		<span class="k">break</span>
	<span class="k">end</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1">--输出 10 20 30</span>
</code></pre></div></div>

<h2 id="泛型for">泛型for</h2>

<p>泛型for在自己内部保存迭代函数，实际上它保存三个值：<strong>迭代函数、状态常量、控制变量</strong>。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="o">&lt;</span><span class="n">var</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span> <span class="k">in</span> <span class="o">&lt;</span><span class="n">exp</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span> <span class="k">do</span>
    <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="k">end</span>
<span class="o">&lt;</span><span class="n">var</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span><span class="err">是以一个或多个逗号分隔的变量名列表，</span><span class="o">&lt;</span><span class="n">exp</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span><span class="err">是以一个或多个逗号分隔的表达式列表，通常情况下</span><span class="n">exp</span><span class="o">-</span><span class="n">list</span><span class="err">只有一个值：迭代工厂的调用</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">k</span><span class="err">，</span><span class="n">v</span> <span class="err">为变量列表，</span><span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="err">为表达式列表</span>
</code></pre></div></div>

<h3 id="泛型for的执行过程">泛型for的执行过程</h3>

<ul>
  <li>初始化，计算in后面表达式的值，表达式应该返回泛型for需要的三个值：迭代函数、状态常量、控制变量；如果返回值不够三个用nil补齐，多出则忽略。</li>
  <li>将状态变量和控制变量作为参数调用迭代函数（注意：对于for结构来说，状态常量没有用处，仅仅在初始化的时候获取值并传递给迭代函数）。</li>
  <li>将迭代函数返回的值赋给变量列表。</li>
  <li>如果返回的第一个值为nil，循环结束，否则执行循环体。</li>
  <li>回到第二步再次调用迭代函数。</li>
</ul>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">var1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">varn</span> <span class="k">in</span> <span class="n">exp</span><span class="o">-</span><span class="n">list</span> <span class="k">do</span>
    <span class="n">block</span>
<span class="k">end</span>
<span class="err">等价于</span>
<span class="k">do</span>
    <span class="kd">local</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_var</span> <span class="o">=</span> <span class="n">exp</span><span class="o">-</span><span class="n">list</span>
    <span class="c1">--_f 是迭代函数，_s 是状态常量，_var 控制变量</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">var1</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">varn</span> <span class="o">=</span> <span class="n">_f</span><span class="p">(</span><span class="n">_s</span><span class="p">,</span> <span class="n">_var</span><span class="p">)</span>
        <span class="n">_var</span> <span class="o">=</span> <span class="n">var1</span>
        <span class="k">if</span> <span class="n">_var</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="k">break</span>
        <span class="k">end</span>
        <span class="n">block</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="c1">--简单例子</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">square</span><span class="p">(</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span> <span class="p">)</span>
	<span class="k">if</span> <span class="n">state</span> <span class="o">&lt;=</span> <span class="n">control</span> <span class="k">then</span>
		<span class="k">return</span>
	<span class="k">end</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">control</span> <span class="o">+</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="n">control</span><span class="p">,</span> <span class="n">control</span><span class="o">*</span><span class="n">control</span>
<span class="k">end</span>
<span class="c1">-- 一开始 state = 9， control = 0，</span>
<span class="c1">-- state不变，而控制变量 control 等于square的第一个返回值，不断累加 1</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="n">square</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span> <span class="k">do</span>
	<span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
		<span class="k">break</span>
	<span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="pairs">pairs</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">k</span> <span class="p">)</span>
    	<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    	<span class="nb">print</span><span class="p">(</span><span class="s2">"iter "</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">v</span> <span class="k">then</span>
    		<span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
    	<span class="k">end</span>
    <span class="k">end</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="kc">nil</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">tt</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1">--for k,v in pairs(tt) do</span>
<span class="c1">--	print(k,v)</span>
<span class="c1">--end</span>

<span class="k">do</span>
	<span class="kd">local</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_var</span> <span class="o">=</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="c1">-- _f 是迭代函数，_s 是状态变量，要迭代的对象，即传入的tt，_var 是控制变量</span>
	<span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
		<span class="kd">local</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">_f</span><span class="p">(</span><span class="n">_s</span><span class="p">,</span> <span class="n">_var</span><span class="p">)</span>  <span class="c1">--执行迭代函数，返回 k,v，迭代结束时两个都是nil</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">"call iter :"</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="n">_var</span> <span class="o">=</span> <span class="n">k</span>	<span class="c1">--刷新控制变量</span>
		<span class="k">if</span> <span class="n">_var</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
			<span class="k">break</span>
		<span class="k">end</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">"call block :"</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="c1">--输出</span>
<span class="cm">--[[
iterator :      1       1
call iter :     1       1
call block :    1       1
iterator :      2       2
call iter :     2       2
call block :    2       2
iterator :      4       4
call iter :     4       4
call block :    4       4
iterator :      nil     nil
call iter :     nil     nil
]]</span>
</code></pre></div></div>

<h3 id="ipairs">ipairs</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">tt</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="n">tt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">function</span> <span class="nf">ipairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">then</span>
            <span class="c1">--从这里可以看出，tt[4]不会被输出了，某个下标的元素不存在就会中断</span>
        	<span class="nb">print</span><span class="p">(</span><span class="s2">"iterator : "</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">end</span>
    <span class="k">end</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="c1">-- for i,v in ipairs(tt) do</span>
<span class="c1">-- 	print(i,v)</span>
<span class="c1">-- end</span>

<span class="k">do</span>
	<span class="kd">local</span> <span class="n">_f</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">_var</span> <span class="o">=</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>	<span class="c1">--_f 是迭代函数，_s 是状态变量，要迭代的对象，即传入的tt，_var 是控制变量</span>
	<span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
		<span class="kd">local</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">_f</span><span class="p">(</span><span class="n">_s</span><span class="p">,</span> <span class="n">_var</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">"call iter : "</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="n">_var</span> <span class="o">=</span> <span class="n">i</span>
		<span class="k">if</span> <span class="n">_var</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
			<span class="k">break</span>
		<span class="k">end</span>
		<span class="nb">print</span><span class="p">(</span><span class="s2">"call block : "</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="c1">--输出</span>
<span class="cm">--[[
iterator :      1       1
call iter :     1       1
call block :    1       1
iterator :      2       2
call iter :     2       2
call block :    2       2
call iter :     nil     nil
]]</span>
</code></pre></div></div>

<h3 id="next">next</h3>

<p>next 函数原型是 <strong>next( table [ , index] )</strong></p>

<p>table 是要遍历的表</p>

<p>index ：next返回的值即是index索引的下一个值，当index为nil时，将返回第一个索引的值，当索引号为最后一个索引或者表为空时返回nil</p>

<p>常用 <strong>next(table)</strong> 是否返回nil来判断表是否是空表</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="o">=</span> <span class="s2">"a"</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">"b"</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s2">"c"</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="s2">"d"</span><span class="p">}</span>
<span class="kd">local</span> <span class="n">value</span>
<span class="k">while</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">--输出</span>
<span class="cm">--[[
a       a
d       d
c       c
b       b
]]</span>
</code></pre></div></div>