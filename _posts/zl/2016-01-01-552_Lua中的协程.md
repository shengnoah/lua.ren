---
layout: post
title: Lua中的协程 
tags: [lua文章]
categories: [topic]
---
<p>Lua中的协程和其他变量一样，都是第一类值（first-class alue），可以被保存在变量中，可以被作为参数传递，可以被函数返回。<br/>
协程有4种状态：挂起（suspended），运行（running），死亡（dead）和正常（normal）。
Lua为协程提供了3个基础接口：create，resume和yield。</p>

<p>#coroutine.create</p>

<ul>
  <li>创建一个新的协程，并为它的运行分配一个独立的栈</li>
  <li>协程处于挂起状态（suspended）</li>
  <li>接受一个函数作为参数，这个函数就是协程的主程序块</li>
  <li>返回这个协程</li>
  <li>挂起点被设置为主程序块的第一句</li>
</ul>

<p>#coroutine.resume</p>

<ul>
  <li>启动一个协程（第一次启动或从暂停状态启动）</li>
  <li>自身（如果是协程的话）处于正常状态，被启动的协程处于运行状态</li>
  <li>第一个参数为所要启动的协程</li>
  <li>协程从它的挂起点开始执行</li>
  <li>一直执行到被挂起或终止</li>
  <li>导致协程终止的情况有两种：它的主程序块正常返回、运行过程中出错</li>
  <li>执行结束后，控制权递交给此协程被激活的地方</li>
</ul>

<p>#coroutine.yield</p>

<ul>
  <li>挂起一个协程</li>
  <li>协程处于挂起状态</li>
  <li>协程的运行状态被记录</li>
  <li>激活它的那个coroutine.resume返回</li>
</ul>

<hr/>

<p>#协程间通信</p>

<ul>
  <li>协程第一次被启动时，传递给coroutine.resume的参数将传递给协程的主程序</li>
  <li>协程挂起时，传递给coroutine.yield的参数将作为上次启动它的coroutine.resume的返回值返回</li>
  <li>协程被再次启动时，传递给coroutine.resume的参数将作为上次挂起它的coroutine.yield的返回值返回</li>
  <li>协程死亡时，主程序返回的值将作为上次启动它的coroutine.resume的返回值返回</li>
</ul>

<hr/>

<p>#实验</p>

<p>##状态</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="k">function</span> <span class="nf">status</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">coroutine.status</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">c1</span><span class="p">,</span><span class="n">c2</span>
<span class="n">c1</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c2&gt;&#34;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;before c1 yield&#34;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;after c1 yield&#34;</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
    <span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c2&gt;&#34;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;before c2 resume c1&#34;</span><span class="p">)</span>
    <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;after c2 resume c1&#34;</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>

<span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c2&gt;&#34;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
<span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c1&gt;&#34;</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
<span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c2&gt;&#34;</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
<span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
<span class="n">status</span><span class="p">(</span><span class="s2">&#34;&lt;c1&gt;&#34;</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span></code></pre></figure>

<p>输出：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>outsky@x201:~/tmp$ lua test.lua 
&lt;c2&gt;	suspended
&lt;c2&gt;	running
before c2 resume c1
&lt;c2&gt;	normal
before c1 yield
after c2 resume c1
&lt;c1&gt;	suspended
&lt;c2&gt;	dead
after c1 yield
&lt;c1&gt;	dead
</code></pre></div></div>

<hr/>

<p>##通信</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;c start:&#34;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;c yield return:&#34;</span><span class="p">,</span> <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&#34;c yield&#34;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&#34;c dead&#34;</span>
<span class="k">end</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;main start c&#34;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">_</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&#34;main start c&#34;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;main resume return:&#34;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;--------&#34;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;main resume c&#34;</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&#34;main resume c&#34;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;main resume return again:&#34;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></code></pre></figure>

<p>输出：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>outsky@x201:~/tmp$ lua test.lua 
main start c
c start:	main start c
main resume return:	c yield
--------
main resume c
c yield return:	main resume c
main resume return again:	c dead
</code></pre></div></div>