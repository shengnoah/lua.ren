---
layout: post
title: C++与Lua本质原始交互API 
tags: [lua文章]
categories: [topic]
---
<div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/11/10/kmp/" rel="next" title="KMP查找子字符串">
                <i class="fa fa-chevron-left"></i> 
                <p class="post-nav-pre-next-title">
                  KMP查找子字符串
                </p> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/11/11/lua_cpp_toluapp_tutorial/" rel="prev" title="tolua++安装">
              <p class="post-nav-pre-next-title">
                  tolua++安装
              </p> 
              <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
      

      
        <p>我们用一个例子来说明.</p>
<p><strong>. . .</strong></p>
<p>首先, 我们需要创建一个 C++ 的主程序，以便同 Lua 进行通信. 如下 : </p>
<figure class="highlight c++"><figcaption><span>lua_test.cpp</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&#34;C&#34;</span> { </span><br/><span class="line">    </span><br/><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lualib.h&#34;</span></span></span><br/><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lauxlib.h&#34;</span></span></span><br/><span class="line">};  </span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua.hpp&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">extern</span> <span class="string">&#34;C&#34;</span> {</span><br/><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="params">(lua_State *L)</span> </span>{</span><br/><span class="line">        <span class="keyword">double</span> arg = luaL_checknumber(L,<span class="number">1</span>);</span><br/><span class="line">        lua_pushnumber(L, arg * <span class="number">0.5</span>);</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    lua_State *L;</span><br/><span class="line">    L = luaL_newstate();</span><br/><span class="line">    </span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 载入（可选）标准库，以便使用打印功能&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    luaL_openlibs(L);</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 载入文件，暂不执行&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    <span class="keyword">if</span> (luaL_loadfile(L, <span class="string">&#34;luascript.lua&#34;</span>)) {</span><br/><span class="line">        <span class="built_in">cerr</span> &lt;&lt; <span class="string">&#34;载入文件出现错误&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        <span class="built_in">cerr</span> &lt;&lt; lua_tostring(L, <span class="number">-1</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        lua_pop(L,<span class="number">1</span>);</span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 从 C++ 写入数据 cppvar&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_pushnumber(L, <span class="number">1.1</span>);</span><br/><span class="line">    lua_setglobal(L, <span class="string">&#34;cppvar&#34;</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 执行 lua 文件&#34;</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    <span class="keyword">if</span> (lua_pcall(L,<span class="number">0</span>, LUA_MULTRET, <span class="number">0</span>)) {</span><br/><span class="line">        <span class="built_in">cerr</span> &lt;&lt; <span class="string">&#34;执行过程中出现错误&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        <span class="built_in">cerr</span> &lt;&lt; lua_tostring(L, <span class="number">-1</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        lua_pop(L,<span class="number">1</span>);</span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 从 Lua 读取全局变量 luavar 到 C++&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_getglobal(L, <span class="string">&#34;luavar&#34;</span>);</span><br/><span class="line">    <span class="keyword">double</span> luavar = lua_tonumber(L,<span class="number">-1</span>);</span><br/><span class="line">    lua_pop(L,<span class="number">1</span>);</span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;C++ 从 Lua 读取到的 luavar = &#34;</span> &lt;&lt; luavar &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 从 C++ 执行 Lua 的方法 myfunction&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_getglobal(L, <span class="string">&#34;myluafunction&#34;</span>);</span><br/><span class="line">    lua_pushnumber(L, <span class="number">5</span>);</span><br/><span class="line">    lua_pcall(L, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;函数返回值是：&#34;</span> &lt;&lt; lua_tostring(L, <span class="number">-1</span>) &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_pop(L,<span class="number">1</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 从 Lua 执行 C++ 的方法&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt;&gt;&gt; 首先在 Lua 中注册 C++ 方法&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_pushcfunction(L,l_cppfunction);</span><br/><span class="line">    lua_setglobal(L, <span class="string">&#34;cppfunction&#34;</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt;&gt;&gt; 调用 Lua 函数以执行 C++ 函数&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_getglobal(L, <span class="string">&#34;myfunction&#34;</span>);</span><br/><span class="line">    lua_pushnumber(L, <span class="number">5</span>);</span><br/><span class="line">    lua_pcall(L, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;函数返回值是：&#34;</span> &lt;&lt; lua_tonumber(L, <span class="number">-1</span>) &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_pop(L,<span class="number">1</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;&gt;&gt; 释放 Lua 资源&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    lua_close(L);</span><br/><span class="line"></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>

<p>编译命令 : <code>g++ lua_test.cpp -o ltest -llua -ldl</code></p>
<h1 id="创建Lua文件"><a href="#创建Lua文件" class="headerlink" title="创建Lua文件"></a>创建Lua文件</h1><p>其次，是 lua 文件，我们将它命名为 luascript.lua</p>
<figure class="highlight lua"><figcaption><span>luascript.lua</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#34;Hello from Lua&#34;</span>)</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#34;Lua code is capable of reading the value set from C++&#34;</span>, cppvar)</span><br/><span class="line">luavar = cppvar * <span class="number">3</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myluafunction</span><span class="params">(times)</span></span></span><br/><span class="line">  <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">rep</span>(<span class="string">&#34;(-)&#34;</span>, times)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myfunction</span><span class="params">(arg)</span></span></span><br/><span class="line">  <span class="keyword">return</span> cppfunction(<span class="built_in">arg</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>

<h1 id="打印结果"><a href="#打印结果" class="headerlink" title="打印结果"></a>打印结果</h1><p>运行 cpp 文件，结果如下：</p>
<pre><code>&gt;&gt; 载入（可选）标准库，以便使用打印功能
&gt;&gt; 载入文件，暂不执行
&gt;&gt; 从 C++ 写入数据 cppvar
&gt;&gt; 执行 lua 文件

Hello from Lua
Lua code is capable of reading the value set from C++   1.1
&gt;&gt; 从 Lua 读取全局变量 luavar 到 C++
C++ 从 Lua 读取到的 luavar = 3.3

&gt;&gt; 从 C++ 执行 Lua 的方法 myfunction
函数返回值是：(-)(-)(-)(-)(-)

&gt;&gt; 从 Lua 执行 C++ 的方法
&gt;&gt;&gt;&gt; 首先在 Lua 中注册 C++ 方法
&gt;&gt;&gt;&gt; 调用 Lua 函数以执行 C++ 函数
函数返回值是：2.5

&gt;&gt; 释放 Lua 资源</code></pre><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://indienova.com/indie-game-development/lua-as-script-with-cpp-development/" target="_blank" rel="noopener noreferrer">参考</a></p>