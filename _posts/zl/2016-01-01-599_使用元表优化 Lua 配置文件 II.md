---
layout: post
title: 使用元表优化 Lua 配置文件 II 
tags: [lua文章]
categories: [topic]
---
<div class="main-content-wrap">
<p>上回提到<a href="https://www.orztu.com/post/lua-table-minify/" target="_blank" rel="noopener noreferrer">元表优化 Lua 配置文件</a>，以减少重复字段，节省内存开销。</p>
<p>除了这种直接地减少内存开销的方法，使用元表还能实现数据的延迟加载，从另一个角度节约内存。</p>
<h2 id="延迟加载">延迟加载</h2>
<div class="highlight"><pre class="chroma"><code class="language-Lua" data-lang="Lua"><span class="c1">-- PropModel.lua</span>
<span class="n">PropModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="mi">1001</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>   <span class="o">=</span> <span class="mi">1001</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;道具1001&#34;</span><span class="p">,</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&#34;道具1001描述&#34;</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="mi">1002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>   <span class="o">=</span> <span class="mi">1002</span><span class="p">,</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;道具1002&#34;</span><span class="p">,</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&#34;道具1002描述&#34;</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span></code></pre></div>
<p>上面依然是最常见的道具表，所有道具都配置在同一个表中，初始化时会全部加载进内存。
然而大多数道具是玩家并不拥有的，在内存中长期停留浪费空间。</p>
<p>通过使用元表，我们能做到每个道具按需（延迟）加载。</p>
<ol>
<li><p>首先清空表数据，使用元表的<code>__index</code>方法实现延迟加载：
</p><div class="highlight"><pre class="chroma"><code class="language-Lua" data-lang="Lua"><span class="c1">-- PropModel.lua</span>
<span class="n">PropModel</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">-- 道具表不再直接存放数据</span>

<span class="c1">-- 使用元表延迟加载数据</span>
<span class="n">setmetatable</span><span class="p">(</span><span class="n">PropModel</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">item</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="n">string.format</span><span class="p">(</span><span class="s2">&#34;PropModel_%s&#34;</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">PropModel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="kr">return</span> <span class="n">item</span>
    <span class="kr">end</span><span class="p">,</span>
<span class="p">})</span></code></pre></div><p></p></li>
<li><p>将各道具数据另外存放——将<code>道具1001</code>单独存放：
</p><div class="highlight"><pre class="chroma"><code class="language-Lua" data-lang="Lua"><span class="c1">-- PropModel_1001.lua</span>
<span class="kd">local</span> <span class="n">PropModel_1001</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ID</span>   <span class="o">=</span> <span class="mi">1001</span><span class="p">,</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;道具1001&#34;</span><span class="p">,</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="s2">&#34;道具1002描述&#34;</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="kr">return</span> <span class="n">PropModel_1001</span></code></pre></div><p></p></li>
</ol>
<h2 id="最后">最后</h2>
<p>上面的代码是每个<code>item</code>单独拆分到一个文件中。
如果有必要，也可以按照<code>ID</code>进行区间拆分，将多个<code>item</code>放在一个文件中。
在<code>__index</code>方法中判断<code>ID</code>落在哪个区间，将该区间数据全部加载。</p>
<p>同时，拆分后的数据依然可以结合<a href="https://www.orztu.com/post/lua-table-minify/" target="_blank" rel="noopener noreferrer">上一篇</a>
的“默认字段”的方法使用。</p>
</div>