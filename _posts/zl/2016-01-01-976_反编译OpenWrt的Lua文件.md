---
layout: post
title: 反编译OpenWrt的Lua文件 
tags: [lua文章]
categories: [topic]
---
<div id="md_content_2" class="md_content" style="min-height: 50px;"><textarea id="append-test" style="display:none;">![](https://xiaokou.top/usr/uploads/md/1569651126274.png)
先是今天的主角，极路由。

获取root权限然后拿到web源码，找到对应文件

![](https://xiaokou.top/usr/uploads/md/1569651204062.png)

![](https://xiaokou.top/usr/uploads/md/1569651262766.png)
![](https://xiaokou.top/usr/uploads/md/1569651242403.png)

![](https://xiaokou.top/usr/uploads/md/1569651287367.png)
确认了是lua 5.1以后，google找到了[文章](http://ju.outofmemory.cn/entry/356320)，根据内容操作发现了一些问题，最后也都解决了，在这里做一个记录。
首先
1. Lua有一种预编译机制，能够把文本代码预编译成Bytecode/Opcode 提高解析、执行速度，降低内存占用
2. 原版Lua（Vanilla Lua）默认的Bytecode的字节结构和OpenWrt的并不相同，因为OpenWrt为了一系列需要，在截止我写此文时候， 在Lua5.1.5的版本主线上 ， 对原版的LUA引擎打了补丁 ， 导致其产生的字节码和原版的Lua产生的并不一样 ，（ http://lua-users.org/lists/lua-l/2012-06/msg00065.html ），因此也不能使用原版的Lua引擎解释，会报类似 bad header in precompiled chunk 的错误
3. 本机尝试逆向原版的Lua产生的LuaC， 使用这个 luadec 项目 无任何问题   ，但是逆向Openwrt上的luaC失败， 所以需要在Openwrt的Patch过的Lua lib的基础上 ，编译luadec

如果是常规的lua文件 使用Unluac就可以。
但是我们的这个luac文件是openwrt处理后的，也就不能使用常规的unluac，需要手动打补丁。

4. 过程
```
 #安装依赖
sudo apt install libncurses-dev libreadline-dev
#获得luadec源码
git clone https://github.com/viruscamp/luadec
cd luadec
git submodule update --init lua-5.1
#下面开始不同
ref=master
patch_dir=patches.$ref
mkdir $patch_dir &amp;&amp; cd $patch_dir
#如下命令需要grep支持pcre正则，如果不支持，请自己手动处理把。 
patchs=$(curl -sSL -H &#39;Accept: application/vnd.github.v3+json&#39; &#39;https://api.github.com/repos/openwrt/openwrt/contents/package/utils/lua/patches?ref=&#39;&#34;$ref&#34; |grep -oP &#39;name&#34;s*:s*&#34;.*.patch&#39; |grep -oP &#39;d+.*.patch&#39;)
#下载补丁文件
#这里的补丁如果下载不成功，可以访问https://github.com/openwrt/openwrt/tree/master/package/utils/lua/patches-host
手动下载替换。
for p in $patchs;do  
wget &#39;https://github.com/openwrt-mirror/openwrt/raw/&#39;&#34;$ref&#34;&#39;/package/utils/lua/patches/&#39;${p}  -O $p; 
done
cd ../lua-5.1
#打上补丁
for i in ../${patch_dir}/*.patch; do patch -p1 &lt;$i ; done
make linux
```
根据原文内的提示：
`需要修改Makefile 给CFLAGS加上 -fPIC 选项 另外，为了使得Patch过后生成的so文件带版本号，还需要加上版本，最终生成的是如下的lua-5.1/src/Makefile的补丁 `


这里修改的是lua-5.1/src下的Makefile


```
--- Makefile.bak	2018-05-29 18:04:44.979014076 +0800
+++ Makefile	2018-05-29 18:21:35.110112120 +0800
@@ -8,7 +8,7 @@
 PLAT= none
 
 CC= gcc
-CFLAGS= -O2 -Wall $(MYCFLAGS)
+CFLAGS=  -fPIC -O2 -Wall $(MYCFLAGS)
 AR= ar rcu
 RANLIB= ranlib
 RM= rm -f
@@ -18,7 +18,7 @@
 MYLDFLAGS=
 MYLIBS=
 # USE_READLINE=1
-
+PKG_VERSION = 5.1.5
 # == END OF USER SETTINGS. NO NEED TO CHANGE ANYTHING BELOW THIS LINE =========
 
 PLATS= aix ansi bsd freebsd generic linux macosx mingw posix solaris
 #由于openwrt中的lua默认情况下是通过动态链接库进行编译，会出现找不到函数体的错误，参考源码中的设置，将对lua库的连接改为静态：
 
  $(LUA_T): $(LUA_O) $(LUA_A)
	$(CC) -o $@ -L. -llua $(MYLDFLAGS) $(LUA_O) $(LUA_A) $(LIBS)

$(LUAC_T): $(LUAC_O) $(LUA_A)
	$(CC) -o $@ -L. -llua $(MYLDFLAGS) $(LUAC_O) $(LUA_A) $(LIBS)

```


做完这些以后，执行一下操作完成编译
make linux
export LD_LIBRARY_PATH=`pwd`/src/
cd ../luadec
make LUAVER=5.1

5. 反编译luci-indexcache
![](https://xiaokou.top/usr/uploads/md/1569652208101.png)


</textarea></div>