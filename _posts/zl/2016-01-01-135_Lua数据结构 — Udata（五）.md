---
layout: post
title: Lua数据结构 — Udata（五） 
tags: [lua文章]
categories: [topic]
---
<div id="toc" class="toc-article">
            <strong class="toc-title">文章目录</strong>
            
			        
		        
          </div>
        
        <p><strong>Udata负责存储userdata的数据</strong>，这部分其实很简单，但是为了保证系列文章的完整性，还是写一篇出来补全。</p>

<p>下面是Udata的数据结构：</p>
<p><img src="https://keepmovingxin.github.io//images/luaUdata/lua-udata-01.png" alt=""/></p>
<p>意义：</p>
<ol>
<li>CommonHeader：和与TValue中的GCHeader能对应起来的部分</li>
<li>metatable：userdata的元表，和table的元表一样的</li>
<li>env：创建userdata时，会把当前执行语句的curenv赋给userdata的env，可修改</li>
<li>len：使用userdata的时候绑定对象申请的空间大小</li>
</ol>
<p>和TString类似，用户绑定的C对象或数据内存紧跟在Udata后面，在luaS_newudata中（lstring.c 96 – 110）有如下代码：</p>
<p><img src="https://keepmovingxin.github.io//images/luaUdata/lua-udata-02.png" alt=""/></p>
<p><img src="https://keepmovingxin.github.io//images/luaUdata/lua-udata-03.png" alt=""/></p>
<h4 id="Udata元表-metable-的作用"><a href="#Udata元表-metable-的作用" class="headerlink" title="Udata元表(metable)的作用"></a>Udata元表(metable)的作用</h4><p>如果userdata没有元表，那是使用起来将会很麻烦，有元表，可以在脚本这样写：</p>
<p><img src="https://keepmovingxin.github.io//images/luaUdata/lua-udata-04.png" alt=""/></p>
<p>从C语言层面来看，myuserdata这个变量其实只是个指针，不像table那样有子元素。但是因为有metatable，由此可以把成员函数放到这个metatable中，在脚本中可以利用它来实现这个类似table的访问方法。</p>
<h4 id="Udata环境-env-的作用"><a href="#Udata环境-env-的作用" class="headerlink" title="Udata环境(env)的作用"></a>Udata环境(env)的作用</h4><p>env这个成员，默认是存储创建userdata时的环境table，而参考Lua官方的文档后，其实这个env成员在Lua中并没有使用，它的值时什么并不影响Lua的运行。</p>
<p>这就说明这个成员目前来说是一个用户可以自由操作的table，在<a href="http://lua-users.org/wiki/UserDataRefinement" target="_blank" rel="external noopener noreferrer">UserDataRefinement</a>文章中，告诉了我们一些使用的手段。另外一篇文章<a href="http://lua-users.org/lists/lua-l/2005-08/msg00709.html" target="_blank" rel="external noopener noreferrer">http://lua-users.org/lists/lua-l/2005-08/msg00709.html</a>也对它的使用方法提出了一些建议。</p>
<p>我比较赞成后一篇文章的看法，对于Udata来说，metatable是一种静态的类型数据(type-common data)，而env则是实例相关的数据(instance-local data)。当然了，怎么用取决于使用者。</p>
<p><strong>Lua数据结构</strong>系列转自阿里云博客，作者是<strong>罗日健</strong>。<br/>原文链接：<a href="http://blog.aliyun.com/789" target="_blank" rel="external noopener noreferrer">http://blog.aliyun.com/789</a></p>
<hr/>
<p>扫描二维码或在微信中搜索 KeepMovingXin<br/><img src="https://keepmovingxin.github.io//images/qrcode.jpg" alt="欢迎关注微信公众号！"/></p>