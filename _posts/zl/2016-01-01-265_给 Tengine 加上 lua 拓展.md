---
layout: post
title: 给 Tengine 加上 lua 拓展 
tags: [lua文章]
categories: [topic]
---


      
      

      
        <p>Tengine 能动态加载第三方模块，成为我们青睐的选择，我们可以编译动态链接文档，而不需要重新安装 Nginx, 这对在线增强 webservice 很有帮助.<br>感谢 agentzh, <a href="https://github.com/openresty/lua-nginx-module" target="_blank" rel="noopener noreferrer">lua-nginx-module</a>, 可以让我们使用 lua 增强nginx的功能, 不言而喻，我们必须现有 Lua 的环境，才能运行 ngx_lua;</p>
<h2 id="编译-nginx-lua"><a href="https://zheng-ji.github.io/#%E7%BC%96%E8%AF%91-nginx-lua" class="headerlink" title="编译 nginx_lua"></a>编译 nginx_lua</h2><p>官方推荐使用LuaJit,虽然也可以使用Lua，但是即时编译(Just-In-Time Compiler)混合了动态编译和静态编译，一句一句编译源代码，但是会将翻译过的代码缓存起来以降低性能损耗。</p>
<ul>
<li>下载安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz</span><br><span class="line">tar zxvf LuaJIT-2.0.4.tar.gz</span><br><span class="line">cd LuaJIT-2.0.4</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ul>
<li>设置环境变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LUAJIT_LIB=/usr/local/lib</span><br><span class="line">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br></pre></td></tr></table></figure>
<ul>
<li>然后编译ngx-lua-module.so</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/share/dso_tool/ --path=/Path/To/Lua-Nginx-module</span><br></pre></td></tr></table></figure>
<ul>
<li>设置动态库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; echo "/usr/local/lib" &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">&gt; ldconfig</span><br></pre></td></tr></table></figure>
<h3 id="在-Tengine-中启用"><a href="https://zheng-ji.github.io/#%E5%9C%A8-Tengine-%E4%B8%AD%E5%90%AF%E7%94%A8" class="headerlink" title="在 Tengine 中启用"></a>在 Tengine 中启用</h3><p><code>nginx.conf</code> 中先加载动态库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dso {</span><br><span class="line">    load ngx_load_module;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>在 nginx.conf 中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_code_cache on/off;</span><br></pre></td></tr></table></figure>
<p>来开启是否将代码缓存，所以每次变更 “*.lua” 文档时，必须重启 nginx 才可生效.</p>
<h3 id="使用-ngx-lua-waf"><a href="https://zheng-ji.github.io/#%E4%BD%BF%E7%94%A8-ngx-lua-waf" class="headerlink" title="使用 ngx_lua_waf"></a>使用 ngx_lua_waf</h3><p>有了基础环境，我们要开始发挥 ngx lua 的优点了, 我用他安装了 waf (web application firework)<br><a href="https://github.com/loveshell/ngx_lua_waf" target="_blank" rel="noopener noreferrer">ngx_lua_waf</a>，这是一个通过 ngx_lua 编写的 web 应用防火墙, 在使用过程中也发现了 ngx_lua_waf 一个bug，给他提了一个<a href="https://github.com/loveshell/ngx_lua_waf/pull/70" target="_blank" rel="noopener noreferrer">Pull Request</a>, 码农生涯第一个 PR.</p>

<p>注：<br>静态编译的进程在执行前全部被翻译为机器码，而动态直译执行的则是一句一句边运行边翻译。</p>