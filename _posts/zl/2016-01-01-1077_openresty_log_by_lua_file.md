---
layout: post
title: openresty_log_by_lua_file 
tags: [lua文章]
categories: [topic]
---
<h3 id="set-the-log-in-nginx-conf"><a href="#set-the-log-in-nginx-conf" class="headerlink" title="set the log in nginx.conf"></a>set the log in nginx.conf</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line">location /docs {</span><br/><span class="line">	keepalive_timeout 0;</span><br/><span class="line">	default_type <span class="string">&#39;text/html&#39;</span>;</span><br/><span class="line">	<span class="built_in">set</span> <span class="variable">$res</span> <span class="string">&#34;&#34;</span>;</span><br/><span class="line">	set_by_lua_file <span class="variable">$res</span> /opt/openresty/set_by.lua;</span><br/><span class="line">	rewrite_by_lua_file /opt/openresty/rewrite.lua;</span><br/><span class="line">	access_by_lua_file /opt/openresty/access.lua;</span><br/><span class="line">	content_by_lua_file /opt/openresty/content.lua;</span><br/><span class="line">	header_filter_by_lua_file /opt/openresty/header_filter.lua;</span><br/><span class="line">	body_filter_by_lua_file /opt/openresty/body_filter.lua;</span><br/><span class="line">	log_by_lua_file /opt/openresty/base/log.lua;</span><br/><span class="line">	proxy_pass http://default_doc_upstream;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="log-by-lua-file"><a href="#log-by-lua-file" class="headerlink" title="log_by_lua_file"></a>log_by_lua_file</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span>(<span class="string">&#34;cjson&#34;</span>);</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> upstream_addr = <span class="literal">nil</span>;</span><br/><span class="line"><span class="keyword">if</span> <span class="literal">nil</span> ~= ngx.var.upstream_addr <span class="keyword">then</span></span><br/><span class="line">    upstream_addr = ngx.var.upstream_addr;</span><br/><span class="line"><span class="keyword">else</span></span><br/><span class="line">    upstream_addr = <span class="literal">nil</span>;</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">ngx.<span class="built_in">log</span>(ngx.INFO, <span class="string">&#34;upstream_addr=&#34;</span>..upstream_addr);</span><br/><span class="line"></span><br/><span class="line"><span class="comment">--</span></span><br/><span class="line"><span class="keyword">if</span> <span class="literal">nil</span> ~= ngx.var.upstream_response_time <span class="keyword">and</span> <span class="string">&#39;number&#39;</span> == <span class="built_in">type</span>(ngx.var.upstream_response_time) <span class="keyword">then</span></span><br/><span class="line">    <span class="keyword">local</span> resp_time_so_far = ngx.now() - <span class="built_in">tonumber</span>(ngx.var.upstream_response_time);</span><br/><span class="line">    <span class="comment">-- 1s</span></span><br/><span class="line">    <span class="keyword">if</span> <span class="built_in">tonumber</span>(ngx.var.upstream_response_time) &gt;= <span class="number">1</span> <span class="keyword">then</span></span><br/><span class="line">        ngx.<span class="built_in">log</span>(ngx.WARN, <span class="string">&#34;[SLOW] request_time=&#34;</span>..ngx.var.request_time..<span class="string">&#34; upstream_response_time=&#34;</span>..ngx.var.upstream_response_time..<span class="string">&#34;, upstream_addr=&#34;</span>..upstream_addr);</span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>