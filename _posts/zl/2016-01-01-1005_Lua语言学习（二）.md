---
layout: post
title: Lua语言学习（二） 
tags: [lua文章]
categories: [topic]
---
<article class="entry-body">
	  	
	  		<p><strong>接下来的几篇是根据<a href="http://lua-users.org/wiki/TutorialDirectory"> Lua-Users wiki </a>梳理的一些细节</strong></p>

<hr/>

<h3 id="赋值">赋值</h3>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">7</span>
<span class="o">&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span>
<span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="mi">8</span>   <span class="mi">7</span>
</code></pre></div></div>

<p>Lua 会先计算等号右侧的 i + 1 和 i 的值，然后第二行就变成了<code class="language-plaintext highlighter-rouge">i, x = 8, 7</code>，然后从右向左分配，x = 7，i = 8</p>

<p>关于从右向左分配可以看下面这个例子：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">1</span>
</code></pre></div></div>

<p>Lua 会从右向左，先执行 a = 2，再执行 a = 1，所以最终 a 的值是1</p>

<hr/>

<h3 id="number">Number</h3>

<p>Lua 不像其他高级语言有各种 Number 类型，默认只有<strong>双精度浮点型</strong></p>

<p>把字符串转换成数字可以用 tonumber() 函数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="s2">&#34;123&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
<span class="mi">127</span>
<span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="s2">&#34;123.456e5&#34;</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="mi">12345600</span>
</code></pre></div></div>

<p>另外也可以用算术运算符直接强制转换字符串，如果字符串不能转为 Number 类型，则报错：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="s2">&#34;7&#34;</span>
<span class="mi">107</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;12&#34;</span> <span class="o">*</span> <span class="mi">3</span>
<span class="mi">36</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span> <span class="o">+</span> <span class="s2">&#34;2&#34;</span> <span class="o">-</span> <span class="s2">&#34;3&#34;</span>
<span class="mi">0</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;hello&#34;</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">stdin</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">arithmetic</span> <span class="n">on</span> <span class="n">a</span> <span class="n">string</span> <span class="n">value</span>
</code></pre></div></div>

<p>Lua 中这种自动类型转换称为’Coercion’，翻译过来应该也就是强制吧。。</p>

<p>有一点要注意的是：比较运算符(==、~=、&lt;、&gt;、&lt;=、&gt;=)并不会强制转换字符串，如果使用了错误的类型，除 ==、~= 外，其他比较运算符还会抛出错误：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">==</span> <span class="s2">&#34;100&#34;</span>
<span class="kc">false</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">~=</span> <span class="s2">&#34;hello&#34;</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">~=</span> <span class="p">{}</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">==</span> <span class="nb">tonumber</span><span class="p">(</span><span class="s2">&#34;100&#34;</span><span class="p">)</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="s2">&#34;100&#34;</span>
<span class="n">stdin</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">compare</span> <span class="n">number</span> <span class="n">with</span> <span class="n">string</span>
</code></pre></div></div>

<hr/>

<h3 id="string">String</h3>

<p>Lua 中也可以使用转义序列，比如其他高级语言中常见的 n t 之类的，但在双方括号<code class="language-plaintext highlighter-rouge">[[]]</code>定义
的字符串中这样做是不行的：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="s1">&#39;hellonNew linetTab&#39;</span>
<span class="n">hello</span>
<span class="n">New</span> <span class="n">line</span>        <span class="n">Tab</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s">[[hellonNew linetTab]]</span>
<span class="n">hello</span><span class="err"></span><span class="n">nNew</span> <span class="n">line</span><span class="err"></span><span class="n">tTab</span>
</code></pre></div></div>

<p>双方括号同时还支持嵌套，但需要给最外层的方括号加上等号，等号的个数任意，只要求数量相同即可：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="s">[[one [[two]]</span> <span class="n">one</span><span class="p">]]</span>        <span class="c1">-- bad</span>
<span class="n">stdin</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">nesting</span> <span class="n">of</span> <span class="s">[[...]]</span> <span class="n">is</span> <span class="n">deprecated</span> <span class="n">near</span> <span class="s1">&#39;[&#39;</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s">[=[one [[two]] one]=]</span>      <span class="c1">-- ok</span>
<span class="n">one</span> <span class="s">[[two]]</span> <span class="n">one</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s">[===[one [[two]] one]===]</span>  <span class="c1">-- ok too</span>
<span class="n">one</span> <span class="s">[[two]]</span> <span class="n">one</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s">[=[one [ [==[ one]=]</span>       <span class="c1">-- ok. nothing special about the inner content.</span>
<span class="n">one</span> <span class="p">[</span> <span class="p">[</span><span class="o">==</span><span class="p">[</span> <span class="n">one</span>
</code></pre></div></div>

<p>使用 .. 符号可以拼接字符串，连接数字类型时，也可以强制自动转换成字符串类型，但在数字后面使用 .. 符号时，需要加一个空格，否则报错：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span> <span class="o">..</span> <span class="mi">123</span>
<span class="n">test123</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&#34;test&#34;</span> <span class="o">..</span> <span class="mi">123</span><span class="p">)</span>
<span class="n">string</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span><span class="o">..</span><span class="mi">1</span><span class="o">..</span><span class="s2">&#34;test&#34;</span>
<span class="n">stdin</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">malformed</span> <span class="n">number</span> <span class="n">near</span> <span class="s1">&#39;1..&#39;</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span> <span class="o">..</span> <span class="mi">1</span> <span class="o">..</span> <span class="s2">&#34;test&#34;</span>
<span class="n">test1test</span>
</code></pre></div></div>

<p>需要注意的是，使用 .. 符号做大量拼接时会很慢，因为每一次连接操作都会在内存中分配一个新的 string 对象，网站给了三个示例：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- slow</span>
<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span> <span class="k">do</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">..</span> <span class="nb">math.random</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39;,&#39;</span> <span class="k">end</span>
<span class="nb">io.stdout</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="c1">-- fast</span>
<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span> <span class="k">do</span> <span class="nb">io.stdout</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nb">tostring</span><span class="p">(</span><span class="nb">math.random</span><span class="p">()),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">end</span>

<span class="c1">-- fast, but uses more memory</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span> <span class="k">do</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="nb">math.random</span><span class="p">())</span> <span class="k">end</span>
<span class="nb">io.stdout</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nb">table.concat</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
</code></pre></div></div>

<hr/>

<h3 id="操作符">操作符</h3>

<p>关系运算符( ==、~=、&lt;、&gt;、&lt;=、&gt;=)用于返回 true 或 false</p>

<p>除了常见的数字比较、字符串比较，如果类型不同或指向不同的对象，那对象也就不相同：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{}</span> <span class="o">==</span> <span class="s2">&#34;table&#34;</span>
<span class="kc">false</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="p">{}</span> <span class="o">==</span> <span class="p">{}</span>      <span class="c1">--这里创建了两个不同的 table</span>
<span class="kc">false</span>
<span class="o">&gt;</span> <span class="n">test</span> <span class="o">=</span> <span class="p">{}</span>
<span class="o">&gt;</span> <span class="n">test2</span> <span class="o">=</span> <span class="n">test</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="n">test</span> <span class="o">==</span> <span class="n">test2</span> <span class="c1">--两个对象引用的是同一个 table</span>
<span class="kc">true</span>
</code></pre></div></div>

<p>在 Lua 中只有 nil 和 false 代表 false，其他都是 true，包括了0</p>

<p>Lua 提供三种逻辑运算符 and or not</p>

<h4 id="not">not</h4>

<p>not 比较容易理解，除 not nil、not false 为 true，其他全是 false</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="ow">not</span> <span class="kc">true</span><span class="p">,</span> <span class="ow">not</span> <span class="kc">false</span>
<span class="kc">true</span>    <span class="kc">false</span>   <span class="kc">false</span>   <span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="ow">not</span> <span class="kc">nil</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="ow">not</span> <span class="ow">not</span> <span class="kc">true</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="ow">not</span> <span class="s2">&#34;foo&#34;</span>
<span class="kc">false</span>
</code></pre></div></div>

<h4 id="and">and</h4>

<p>Lua 中的 and 操作符相比其他高级语言就有一点”奇怪”了，如果第一个参数是 false 或 nil，那就不会执行第二个参数，直接返回第一个参数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">false</span> <span class="ow">and</span> <span class="kc">true</span>
<span class="kc">false</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="kc">true</span>
<span class="kc">nil</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="kc">false</span>
<span class="kc">nil</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span> <span class="kc">false</span> <span class="ow">and</span> <span class="s2">&#34;hello&#34;</span>
<span class="kc">nil</span>     <span class="kc">false</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">false</span> <span class="ow">and</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="c1">--print方法没有执行</span>
<span class="kc">false</span>
</code></pre></div></div>

<p>当第一个参数为 true 时，就会返回第二个参数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">and</span> <span class="kc">false</span>
<span class="kc">false</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">and</span> <span class="kc">true</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span> <span class="s2">&#34;hello&#34;</span> <span class="ow">and</span> <span class="s2">&#34;there&#34;</span>
<span class="n">hello</span>   <span class="n">there</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">and</span> <span class="kc">nil</span>
<span class="kc">nil</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">and</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="c1">--print方法执行，并返回print(&#34;hello&#34;)</span>
<span class="n">hello</span>
<span class="kc">nil</span>
</code></pre></div></div>

<p>上个例子中执行 print(“hello”) 返回了 nil 感觉有点奇怪，就再多测试了一下：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="o">==</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span>
<span class="n">hello</span>
<span class="kc">true</span>
</code></pre></div></div>

<h4 id="or">or</h4>

<p>or 和 and 一样有点”奇怪”，当第一个参数为 true 时，就不会再执行第二个参数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">or</span> <span class="kc">false</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">or</span> <span class="kc">nil</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="s2">&#34;hello&#34;</span> <span class="ow">or</span> <span class="s2">&#34;there&#34;</span><span class="p">,</span> <span class="mi">1</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="n">hello</span>   <span class="mi">1</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">true</span> <span class="ow">or</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="c1">--print方法没有执行</span>
<span class="kc">true</span>
</code></pre></div></div>

<p>当第一个参数为 false 或 nil 时，会返回第二个参数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="o">=</span> <span class="kc">false</span> <span class="ow">or</span> <span class="kc">true</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="ow">or</span> <span class="kc">true</span>
<span class="kc">true</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">nil</span> <span class="ow">or</span> <span class="s2">&#34;hello&#34;</span>
<span class="n">hello</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="kc">false</span> <span class="ow">or</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span> <span class="c1">--print方法执行，并返回print(&#34;hello&#34;)</span>
<span class="n">hello</span>
<span class="kc">nil</span>
</code></pre></div></div>

<p>or 的这种特性可以用于设置默认值，这里有一个例子：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">function</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="o">&gt;&gt;</span>  <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">x</span> <span class="ow">or</span> <span class="s2">&#34;default&#34;</span>
<span class="o">&gt;&gt;</span>  <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="o">&gt;&gt;</span> <span class="k">end</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="n">foo</span><span class="p">()</span>
<span class="n">default</span> <span class="kc">nil</span>
<span class="o">&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>       <span class="mi">1</span>
<span class="o">&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="kc">true</span>    <span class="kc">true</span>
<span class="o">&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span>
<span class="n">hello</span>   <span class="n">hello</span>
</code></pre></div></div>

  		
	  </article>