---
layout: post
title: LUA 进阶 
tags: [lua文章]
categories: [topic]
---
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">lua -e <span class="string">&#34;for k,v in pairs(_G) do print(k,v) end&#34;</span> | <span class="built_in">sort</span></span><br/></pre></td></tr></tbody></table></figure>
<ul>
<li><p>lua全局环境变量保存在_G的table中,内容如下：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert</span>  <span class="function"><span class="keyword">function</span>: 0</span></span><br/><span class="line"><span class="function"><span class="title">collectgarbage</span>  <span class="title">function</span>: 0<span class="title">x99f5bd0</span></span></span><br/><span class="line"><span class="function"><span class="title">coroutine</span>       <span class="title">table</span>: 0<span class="title">x99f6718</span></span></span><br/><span class="line"><span class="function"><span class="title">debug</span>   <span class="title">table</span>: 0<span class="title">x99f97d0</span></span></span><br/><span class="line"><span class="function"><span class="title">dofile</span>  <span class="title">function</span>: 0<span class="title">x99f5c88</span></span></span><br/><span class="line"><span class="function"><span class="title">error</span>   <span class="title">function</span>: 0<span class="title">x99f5cc0</span></span></span><br/><span class="line"><span class="function"><span class="title">gcinfo</span>  <span class="title">function</span>: 0<span class="title">x99f5c10</span></span></span><br/><span class="line"><span class="function"><span class="title">getfenv</span> <span class="title">function</span>: 0<span class="title">x99f5c48</span></span></span><br/><span class="line"><span class="function"><span class="title">getmetatable</span>    <span class="title">function</span>: 0<span class="title">x99f5de0</span></span></span><br/><span class="line"><span class="function"><span class="title">_G</span>      <span class="title">table</span>: 0<span class="title">x99f5450</span></span></span><br/><span class="line"><span class="function"><span class="title">io</span>      <span class="title">table</span>: 0<span class="title">x99f79e8</span></span></span><br/><span class="line"><span class="function"><span class="title">ipairs</span>  <span class="title">function</span>: 0<span class="title">x99f59a0</span></span></span><br/><span class="line"><span class="function"><span class="title">loadfile</span>        <span class="title">function</span>: 0<span class="title">x99f5e20</span></span></span><br/><span class="line"><span class="function"><span class="title">load</span>    <span class="title">function</span>: 0<span class="title">x99f5cf8</span></span></span><br/><span class="line"><span class="function"><span class="title">loadstring</span>      <span class="title">function</span>: 0<span class="title">x99f5d30</span></span></span><br/><span class="line"><span class="function"><span class="title">math</span>    <span class="title">table</span>: 0<span class="title">x99f8dd0</span></span></span><br/><span class="line"><span class="function"><span class="title">module</span>  <span class="title">function</span>: 0<span class="title">x99f6ce0</span></span></span><br/><span class="line"><span class="function"><span class="title">newproxy</span>        <span class="title">function</span>: 0<span class="title">x99f66b0</span></span></span><br/><span class="line"><span class="function"><span class="title">next</span>    <span class="title">function</span>: 0<span class="title">x99f5d68</span></span></span><br/><span class="line"><span class="function"><span class="title">os</span>      <span class="title">table</span>: 0<span class="title">x99f81f0</span></span></span><br/><span class="line"><span class="function"><span class="title">package</span> <span class="title">table</span>: 0<span class="title">x99f6a50</span></span></span><br/><span class="line"><span class="function"><span class="title">pairs</span>   <span class="title">function</span>: 0<span class="title">x99f5a00</span></span></span><br/><span class="line"><span class="function"><span class="title">pcall</span>   <span class="title">function</span>: 0<span class="title">x99f5da0</span></span></span><br/><span class="line"><span class="function"><span class="title">print</span>   <span class="title">function</span>: 0<span class="title">x99f6020</span></span></span><br/><span class="line"><span class="function"><span class="title">rawequal</span>        <span class="title">function</span>: 0<span class="title">x99f6058</span></span></span><br/><span class="line"><span class="function"><span class="title">rawget</span>  <span class="title">function</span>: 0<span class="title">x99f6090</span></span></span><br/><span class="line"><span class="function"><span class="title">rawset</span>  <span class="title">function</span>: 0<span class="title">x99f60c8</span></span></span><br/><span class="line"><span class="function"><span class="title">require</span> <span class="title">function</span>: 0<span class="title">x99f6f88</span></span></span><br/><span class="line"><span class="function"><span class="title">select</span>  <span class="title">function</span>: 0<span class="title">x99f5478</span></span></span><br/><span class="line"><span class="function"><span class="title">setfenv</span> <span class="title">function</span>: 0<span class="title">x99f5e58</span></span></span><br/><span class="line"><span class="function"><span class="title">setmetatable</span>    <span class="title">function</span>: 0<span class="title">x99f5e90</span></span></span><br/><span class="line"><span class="function"><span class="title">string</span>  <span class="title">table</span>: 0<span class="title">x99f65b8</span></span></span><br/><span class="line"><span class="function"><span class="title">table</span>   <span class="title">table</span>: 0<span class="title">x99f6828</span></span></span><br/><span class="line"><span class="function"><span class="title">tonumber</span>        <span class="title">function</span>: 0<span class="title">x99f5ed0</span></span></span><br/><span class="line"><span class="function"><span class="title">tostring</span>        <span class="title">function</span>: 0<span class="title">x99f5f08</span></span></span><br/><span class="line"><span class="function"><span class="title">type</span>    <span class="title">function</span>: 0<span class="title">x99f5f40</span></span></span><br/><span class="line"><span class="function"><span class="title">unpack</span>  <span class="title">function</span>: 0<span class="title">x99f5f78</span></span></span><br/><span class="line"><span class="function"><span class="title">_VERSION</span>        <span class="title">Lua</span> 5.1</span></span><br/><span class="line"><span class="function"><span class="title">xpcall</span>  <span class="title">function</span>: 0<span class="title">x99f5fb0</span></span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>setfenv(set function environment)改变一个函数的环境，该环境参数是一个函数层级和一个table，函数层级1表示当前函数，2表示调用当前函数的函数，以此类推</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, {g = <span class="built_in">_G</span>})</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>由于函数继承创建其函数的环境，所以一个程序块改变了自己的环境，后续由它创建的函数都共享新环境</p>
</li>
</ul>
<h2 id="模块和包"><a href="#模块和包" class="headerlink" title="模块和包"></a>模块和包</h2><h3 id="require"><a href="#require" class="headerlink" title="require"></a>require</h3><ul>
<li>require调用返回一个模块函数组成的table，并且定义一个包含改table的全局变量</li>
<li><p>require采用一串路径模式，每个模式都包含一个可选的?, require用模块名替换?，来查找这个文件,如果不存在，将寻找下一项。假设路径为</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">?;?.lua;/usr/local/lib/?.lua?;</span><br/><span class="line">执行require &#34;sql&#34;将尝试打开如下文件</span><br/><span class="line">sql</span><br/><span class="line">sql.lua</span><br/><span class="line">/usr/loca/lib/sql.lua</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>require 搜索路径在_G.package.path中定义，如果无法找到将寻找c库，路径在_G.package.cpath中定义</p>
</li>
<li>如果模块没有返回值，require返回package.loaded[modename]的值 </li>
</ul>
<h3 id="module函数"><a href="#module函数" class="headerlink" title="module函数"></a>module函数</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">module(..., <span class="built_in">package</span>.<span class="built_in">seeall</span>) 等价于如下代码:</span><br/></pre></td></tr></tbody></table></figure>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">local modname = ...</span><br/><span class="line">local M = {}</span><br/><span class="line">_G[modename] = M</span><br/><span class="line">package.loaded[modename] = M</span><br/><span class="line">setmetatable(M, {__index = _G})</span><br/><span class="line">setfenv(1, M)</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="子模块与包"><a href="#子模块与包" class="headerlink" title="子模块与包"></a>子模块与包</h3><p>lua支持层级模块，中间使用.分割。比如mod.sub就是sub的子模块，require搜索路径时将.转换为系统路径(/或)</p>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><ul>
<li><p>lua使用冒号(:)隐藏self参数，函数内仍可以通过self参数访问成员</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">table</span>.<span class="built_in">sub</span>(<span class="built_in">table</span>, <span class="number">10</span>) =&gt; <span class="built_in">table</span>:<span class="built_in">sub</span>(<span class="number">10</span>)</span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>示例：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env lua</span><br/><span class="line"></span><br/><span class="line">Account = { balance = <span class="number">0</span>, withdraw = <span class="function"><span class="keyword">function</span><span class="params">(v)</span></span></span><br/><span class="line">    self.balance = self.balance - v</span><br/><span class="line"><span class="keyword">end</span> }</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:deposit</span><span class="params">(v)</span></span></span><br/><span class="line">    self.balance = self.balance + v</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span><span class="params">(o)</span></span></span><br/><span class="line">    o = o <span class="keyword">or</span> {}</span><br/><span class="line">    <span class="built_in">setmetatable</span>(o, self)</span><br/><span class="line">    self.<span class="built_in">__index</span> = self</span><br/><span class="line">    <span class="keyword">return</span> o</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">a = Account:new()</span><br/><span class="line"><span class="built_in">print</span> (a.balance)</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>