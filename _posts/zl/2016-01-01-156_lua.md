---
layout: post
title: lua 
tags: [lua文章]
categories: [topic]
---
<head>
  <meta charset="utf-8"/>
  
  <title>lua-coding-style | CloudKey Ocean</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

  
    <meta name="keywords" content="lua,"/>
  

  <meta name="description" content="命名规范：
文件名：  首字母大写驼峰型（第一个单词首字母也大写）
常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连
函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="lua-coding-style"/>
<meta property="og:url" content="http://cloudkey.github.io/2015/11/15/lua-coding-style/index.html"/>
<meta property="og:site_name" content="CloudKey Ocean"/>
<meta property="og:description" content="命名规范：
文件名：  首字母大写驼峰型（第一个单词首字母也大写）
常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连
函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用"/>
<meta property="og:updated_time" content="2017-01-21T12:16:32.000Z"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="lua-coding-style"/>
<meta name="twitter:description" content="命名规范：
文件名：  首字母大写驼峰型（第一个单词首字母也大写）
常量：    由字母、数字、 构成，字母全大写，首字母必须为字母，单词之间使用”“相连
函数名：  由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
局部变量：由字母、数字、 构成，字母全小写，首字母必须为字母，单词之间使用”“相连
全局变量：由字母、数字、 构成，字母全小写，必须为”g“开头，单词之间使用"/>

  

  
    <link rel="icon" href="/favicon.ico"/>
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet"/>


  
    <link rel="stylesheet" href="/css/personal-style.css"/>
  

  

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-56303271-1', 'auto');
ga('send', 'pageview');

</script>



  


  
    <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/archives/" rel="noopener noreferrer" target="_self">
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/category/" rel="noopener noreferrer" target="_self">
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/tag/" rel="noopener noreferrer" target="_self">
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/link/" rel="noopener noreferrer" target="_self">
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/about/" rel="noopener noreferrer" target="_self">
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/atom.xml" rel="noopener noreferrer" target="_blank">
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/search/" rel="noopener noreferrer" target="_self">
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
  </div>



<div class="content content-post CENTER">
   <article id="post-lua-coding-style" class="article article-type-post" itemprop="blogPost">
  

  <div class="article-content">
    
      <h2 id="命名规范："><a href="#命名规范：" class="headerlink" title="命名规范："></a>命名规范：</h2><ul>
<li>文件名：  首字母大写驼峰型（第一个单词首字母也大写）</li>
<li>常量：    由字母、数字、<em> 构成，字母全大写，首字母必须为字母，单词之间使用”</em>“相连</li>
<li>函数名：  由字母、数字、<em> 构成，字母全小写，首字母必须为字母，单词之间使用”</em>“相连</li>
<li>局部变量：由字母、数字、<em> 构成，字母全小写，首字母必须为字母，单词之间使用”</em>“相连</li>
<li>全局变量：由字母、数字、<em> 构成，字母全小写，必须为”g</em>“开头，单词之间使用”_”相连，最好不用全局变量</li>
<li>配置变量：由字母、数字、<em> 构成，由”Conf</em>“开头，单词首字母大写，单词之间使用”_”相连</li>
</ul>

<h2 id="代码组织："><a href="#代码组织：" class="headerlink" title="代码组织："></a>代码组织：</h2><ul>
<li><p>文件开头加上功能描述；每个文件都加module限定词；导入的模块都加local限定词</p>
</li>
<li><p>所有函数都加注释：</p>
<blockquote>
<p>函数功能： @brief xxx<br/>param描述：@param xxx<br/>return：   @return xxx </p>
</blockquote>
</li>
<li><p>合理的空行：函数之间、函数内部代码块之间</p>
</li>
<li><p>注释格式：单行注释使用”–”；多行注释使用–[[]]，其中在”]]”前面加”–”，如果要取消注释，只用在”–[[“前再加一个”-“就行</p>
</li>
<li><p>常量、消息号、枚举值行末都加上分号 ——？</p>
</li>
<li><p>函数内的临时变量、文件内的局部函数都加上 local 限定词</p>
</li>
<li><p>函数内部代码块尽量加注释</p>
</li>
<li><p>单个函数较长时（大于100行），尽量拆分成多个子函数</p>
</li>
<li><p>assert 函数开销不小，请慎用</p>
</li>
<li><p>lua类设计时，用元表来实现oop </p>
<blockquote>
<p>不要直接增加函数成员，因为直接增加函数成员会导致内存增加，并且在jit下执行效率和用元表方式无差异</p>
</blockquote>
</li>
<li><p>空格符：</p>
<blockquote>
<p>运算符之间，如 s = a + b<br/>参数列表或数组元素之间，如 fuction my_sum(a, b)，{1, 2, 3}<br/>注意：函数参数列表中，左括号与第一个参数之间、右括号与最后一个参数之间，都不要加空格</p>
</blockquote>
</li>
<li><p>单行超过80字符时，应该换行</p>
<blockquote>
<p>函数参数换行时，下一行与上一行的第一个参数对齐</p>
</blockquote>
</li>
<li><p>运算较复杂时，使用小括号分割每个运算逻辑，增加可读性，同时避免运算符优先级顺序问题</p>
</li>
<li><p>4字符缩进</p>
</li>
<li><p>日志：</p>
<blockquote>
<p>1.明确的日志级别<br/>2.每个异常处必须有日志（warning、error）说明异常原因<br/>3.日志必须传一个参数，可以是string和table，如果是string，最好为[key:value]形式；如果是table，日志库会自动转成[key:value]形式，且第一个key为message(如果存在) </p>
</blockquote>
</li>
<li><p>尽量减少表中的成员是另一个表的引用 ——？</p>
</li>
<li><p>取table的长度用#，不用table.getn</p>
</li>
<li><p>当table中的key是纯数字(不一定有序)的时候,求table长度不可以用#(错误),可以用Utils.tableCount(pairs遍历)函数;<br/>相同场景,打印table的内容,用Utils.simple_var_dump(table.concat实现);<br/>按照key大小顺序遍历的话,用pairsByKeys(this function get from [Programming In Lua])获取迭代器</p>
</li>
<li><p>尽量避免magic number</p>
</li>
</ul>
<h2 id="lua的全局变量问题"><a href="#lua的全局变量问题" class="headerlink" title="lua的全局变量问题"></a>lua的全局变量问题</h2><ul>
<li><p>之前使用ngx-lua实现一个类似proxy的项目时，发现使用长连接机制会导致 请求错乱(不同的连接数据发生混乱)的现象，经追查发现lua中全局变量使用如果不当会导致一些未可知的异常情况。</p>
<blockquote>
<p>类似的也有其他同学遇到过相似的困扰：</p>
  <figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">https://github.com/openresty/lua-nginx-<span class="built_in">module</span>/issues/<span class="number">150</span></div><div class="line">http://wiki.nginx.org/HttpLuaModule#Data_Sharing_within_an_Nginx_Worker</div><div class="line">http://zacharyhu.org/?p=<span class="number">373</span></div></pre></td></tr></tbody></table></figure>
<p>解决方案：<br/>  在用 ngx-releng 脚本check代码全量global变量之后，将所有global更改为local；同时对长连接建立失败或者读写超时的连接，进行close connection的处理。经验证上线之后数据错乱问题不再复现。</p>
</blockquote>
</li>
<li>所以建议对自己的代码用ngx-releng脚本进行check，尽量使用local变量。</li>
</ul>

    
  </div>
</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2015/11/10/saucony-feel/">
        
    </a>
    
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr/>
    
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    
  </section>

  <script>
    var disqus_shortname = 'cloudkey';
    
    var disqus_url = 'http://cloudkey.github.io/2015/11/15/lua-coding-style/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//cloudkey.disqus.com/count.js" async=""></script>



    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>



</body>