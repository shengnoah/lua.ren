---
layout: post
title: Lua C API 教程  
tags: [lua文章]
categories: [topic]
---
<p>前一篇文章介绍了怎么从 C 程序中调用 Lua 代码。但内容并没有深入，还有很多东西需要反复去尝试，并且需要通过 Lua 辅助来调用 C 程序。 本章将着重介绍如何继续扩展你的 Lua 程序 - 在Lua中调用C函数。</p>
<h2 id="剖析一个-Lua-程序对-C-的调用"><a href="#剖析一个-Lua-程序对-C-的调用" class="headerlink" title="剖析一个 Lua 程序对 C 的调用"></a>剖析一个 Lua 程序对 C 的调用</h2><p>从 Lua 的角度来看，调用 C 程序其实就是调用一个模块，在Lua中一个代码块称为chunk，一个chunk里面通常有若干函数，这些函数用table存储。而Lua的C扩展模块也是可以这样实现的，Lua调用C函数时，并不依赖于函数名、包的位置，而只依赖于注册函数时传入的函数地址。</p>
<p>一个简单的 Lua 程序，调用一个包含了 <code>foo</code> 和 <code>bar</code> 函数的 <code>mylib</code> 模块：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mylib = <span class="built_in">require</span> <span class="string">&#34;mylib&#34;</span></span><br/><span class="line"><span class="built_in">print</span>(mylib.foo())</span><br/><span class="line"><span class="built_in">print</span>(mylib.bar())</span><br/></pre></td></tr></tbody></table></figure>

<p>上面的代码 <code>require &#34;mylib&#34;</code> 语句加载了一个名为 <code>mylib</code> 的模块，显然模块具有函数 <code>foo</code> 和 <code>bar</code>。所以 C 程序不仅需要定义 <code>foo()</code> 和 <code>bar()</code> 函数，还需要将自己注册为一个模块，并将函数注入模块当中。</p>
<p><code>require &#34;mylib&#34;</code> 做了两件事：</p>
<ul>
<li>寻找一个叫做 <code>mylib.so</code> (windows 一个是 <code>mylib.dll</code>) 的动态库文件。</li>
<li>一旦发现 <code>mylib.so</code> , 就会去查找一个名为 <code>luaopen_mylib</code> 的函数来运行。</li>
</ul>
<p>通常，创建 C 模块时，函数都是私有的，都声明为static。一个模块函数定义大概是这样子：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    lua_pushstring(L, <span class="string">&#34;foo...&#34;</span>)</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bar</span><span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    lua_pushstring(L, <span class="string">&#34;bar...&#34;</span>);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>为了让模块函数注册到 Lua 中去，我们需要声明一个 <code>luaL_Reg</code> 的数组，来包含模块中的所有函数及名称。任何 <code>luaL_Reg</code> 数组都必须以一对为 <code>NULL</code> 的 name 与 func 结束：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">mylib</span>[] = {</span></span><br/><span class="line">    {<span class="string">&#34;foo&#34;</span>, foo},</span><br/><span class="line">    {<span class="string">&#34;bar&#34;</span>, bar},</span><br/><span class="line">    {<span class="literal">NULL</span>, <span class="literal">NULL</span>}</span><br/><span class="line">};</span><br/></pre></td></tr></tbody></table></figure>
<p>最后，声明一个打开模块的主函数，该函数名称必须以 <code>luaopen_</code> 开头，后面跟着的是你编写的模块名称，它唯一的参数就是 Lua 状态机。并使用 <code>luaL_newlib</code> 创建一张新表，并把 <code>luaL_Reg</code> 中的函数注册进去：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_mylib</span><span class="params">(lua_State *L)</span> </span>{</span><br/><span class="line">    luaL_newlib(L, mylib);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>最棘手的莫过于编译一个写好的新模块，它看起来是这样子：</p>
<p>在 Mac OS 中：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="bash"> cc -o mylib.so mylib.c -I /usr/<span class="built_in">local</span>/include -L /usr/<span class="built_in">local</span>/lib -bundle -undefined dynamic_lookup</span></span><br/></pre></td></tr></tbody></table></figure>
<p>在 Linux 中：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="bash"> gcc -o mylib.so mylib.c -I/usr/include/lua5.1 -llua5.1 -Wall -shared -fPIC</span></span><br/></pre></td></tr></tbody></table></figure>
<h2 id="做的更好一些"><a href="#做的更好一些" class="headerlink" title="做的更好一些"></a>做的更好一些</h2><p>下面我们模拟编写一个名为 <code>power</code> 的模块，并实现两个名为 <code>square</code> 和 <code>cube</code> 的函数来进行计算任务，并把计算结果返回 Lua。</p>
<p>首先，编写模块 C 程序：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lua.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lauxlib.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lualib.h&#34;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">square</span><span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="keyword">float</span> num = lua_tonumber(L, <span class="number">-1</span>);</span><br/><span class="line">    <span class="built_in">printf</span>(<span class="string">&#34;square(), num = %fn&#34;</span>, num);</span><br/><span class="line">    lua_pushnumber(L, num * num);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">cube</span><span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="keyword">float</span> num = lua_tonumber(L, <span class="number">-1</span>);</span><br/><span class="line">    <span class="built_in">printf</span>(<span class="string">&#34;cube(), num = %fn&#34;</span>, num);</span><br/><span class="line">    lua_pushnumber(L, num * num * num);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">libs</span> [] = {</span></span><br/><span class="line">    {<span class="string">&#34;square&#34;</span>, square},</span><br/><span class="line">    {<span class="string">&#34;cube&#34;</span>, cube},</span><br/><span class="line">    {<span class="literal">NULL</span>, <span class="literal">NULL</span>}</span><br/><span class="line">};</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_power</span><span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    luaL_newlib(L, libs);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>然后，把c程序编译成动态库 pwer.so。<br/>ps:MAC OSX中编译时需要加入-bundle -undefined dynamic_lookup 选项，不然会引起”multiple lua vms detected” 错误。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="bash"> cc -o power.so power.c -I /usr/<span class="built_in">local</span>/include -L /usr/<span class="built_in">local</span>/lib -bundle -undefined dynamic_lookup</span></span><br/></pre></td></tr></tbody></table></figure>
<p>别写测试 Lua 脚本：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">local power = require(&#34;power&#34;)</span><br/><span class="line">print(power.square(2.5))</span><br/><span class="line">print(power.cube(2.5))</span><br/></pre></td></tr></tbody></table></figure>
<p>运行：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="bash"> lua test_power.lua</span></span><br/><span class="line">square(), num = 2.500000</span><br/><span class="line">6.25</span><br/><span class="line">cube(), num = 2.500000</span><br/><span class="line">15.625</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h2><p>如果你已经和 Lua 一起工作过一段时间后，你一个会注意到 Lua 没有内置 <code>sleep()</code> 延迟函数。一种解决方案是调用 C 的 <code>sleep()</code> 函数。我们做的是需要实现两个名为 <code>sleep()</code> 和 <code>msleep</code> 和函数来让 Lua 代码延迟指定多少秒、多少毫秒。</p>