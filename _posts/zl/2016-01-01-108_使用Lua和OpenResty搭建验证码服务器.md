---
layout: post
title: 使用Lua和OpenResty搭建验证码服务器 
tags: [lua文章]
categories: [topic]
---
<p><a href="http://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua</a>下有个<a href="http://lua-gd.luaforge.net/" target="_blank" rel="noopener noreferrer">Lua-GD</a>图形库，通过简单的Lua语句就能控制、生成图片。</p>
<p><strong>环境说明：</strong></p>
<ul>
<li>操作系统：RHEL6.4</li>
<li>RHEL系统默认已安装RPM包的<a href="http://www.lua.org/ftp/lua-5.1.4.tar.gz" target="_blank" rel="noopener noreferrer">Lua-5.1.4</a>，但其只具有Lua基本功能，不提供 <code>lua.h</code> 等，但 Lua-GD 编译需要用到 <code>lua.h</code>，故 Lua 需要编译安装。</li>
<li>Lua-GD 版本号格式为<code>X.Y.XrW</code>，其中<code>X.Y.Z</code>代表gd版本，<code>W</code>代表效力版本，所以 lua-gd 版本：<code>lua-gd-2.0.33r2</code> 相对应 gd 版本为：<code>gd-2.0.33</code>，须注意保持一致。</li>
<li>因生成gif的lua脚本中用到md5加密，故需编译安装md5。</li>
<li>因为生成图片需要唯一命名，故依赖 UUID</li>
</ul>
<p><strong>另外：</strong></p>
<p>以下操作均以root用户运行，并且以下脚本的当前目录为<code>/opt</code>，即所有的下载的文件都会保存在<code>/opt</code>目录下。</p>
<p>需要安装的软件如下：</p>
<ul>
<li>OpenResty：WEB应用服务器，部署lua代码，提供URL供用户调用和访问</li>
<li>LuaJIT：LUA代码解释器，使用OpenResty中集成的版本</li>
<li>GD库：C图形库</li>
<li>Lua-GD库：Lua绑定的C图形库，使得lua可调用gd</li>
<li>Lua-Resty-UUID库：用于生成UUID，保证图片命名唯一性</li>
<li>LuaSocket：lua 的 socket 库</li>
</ul>
<p>安装编译所需软件包:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">$ yum install -y make gcc</span><br/></pre></td></tr></tbody></table></figure>
<p>下载并编译安装 lua-5.1：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">$ yum install -y readline-devel</span><br/><span class="line">$ wget http://www.lua.org/ftp/lua-5.1.4.tar.gz</span><br/><span class="line">$ tar lua-5.1.4.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> lua-5.1.4</span><br/><span class="line">$ make linux</span><br/><span class="line">$ make linux install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-gd"><a href="#安装-gd" class="headerlink" title="安装 gd"></a>安装 gd</h1><p>GD版本：gd-2.0.33</p>
<p>下载地址: <a href="http://www.boutell.com/gd/http/gd-2.0.33.tar.gz" target="_blank" rel="noopener noreferrer">http://www.boutell.com/gd/http/gd-2.0.33.tar.gz</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">$ yum install -y libjpeg-devel libpng-devel freetype-devel fontconfig-devel libXpm-devel</span><br/><span class="line"></span><br/><span class="line">$ wget http://www.boutell.com/gd/http/gd-2.0.33.tar.gz</span><br/><span class="line">$ tar zvxf gd-2.0.33.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> gd-2.0.33</span><br/><span class="line">$ ./configure</span><br/><span class="line">$ make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-Lua-gd-库"><a href="#安装-Lua-gd-库" class="headerlink" title="安装 Lua-gd 库"></a>安装 Lua-gd 库</h1><p>Lua-GD版本：lua-gd-2.0.33r2</p>
<p>下载地址: <a href="http://jaist.dl.sourceforge.net/project/lua-gd/lua-gd/lua-gd-2.0.33r2%20%28for%20Lua%205.1%29/lua-gd-2.0.33r2.tar.gz" target="_blank" rel="noopener noreferrer">http://jaist.dl.sourceforge.net/project/lua-gd/lua-gd/lua-gd-2.0.33r2%20%28for%20Lua%205.1%29/lua-gd-2.0.33r2.tar.gz</a></p>
<p>开发手册可参考: <a href="http://ittner.github.io/lua-gd/manual.html" target="_blank" rel="noopener noreferrer">http://ittner.github.io/lua-gd/manual.html</a></p>
<blockquote>
<p>说明：</p>
<p>须先完成gd的安装，且版本号必须为gd-2.0.33<br/>调用Lua-GD库的lua代码须由OpenResty中集成的LuaJIT解释执行</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">$ wget http://sourceforge.net/projects/lua-gd/files/lua-gd/lua-gd-2.0.33r2%20(<span class="keyword">for</span>%20Lua%205.1)/lua-gd-2.0.33r2.tar.gz/download?use_mirror=jaist</span><br/><span class="line">$ tar zvxf lua-gd-2.0.33r2.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> lua-gd-2.0.33r2</span><br/></pre></td></tr></tbody></table></figure>
<p>接写来修改Makefile文件：</p>
<ul>
<li>注释第36～42行</li>
<li>打开第48～52行注释，并做如下修改</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">OUTFILE=gd.so</span><br/><span class="line">CFLAGS=-Wall `gdlib-config --cflags` -I/usr/local/include/lua -O3    //第49行，修改 lua 的 C 库头文件所在路径</span><br/><span class="line">GDFEATURES=`gdlib-config --features |sed -e &#34;s/GD_/-DGD_/g&#34;`</span><br/><span class="line">LFLAGS=-shared `gdlib-config --ldflags` `gdlib-config --libs` -llua -lgd  //第51行，取消lua库版本号51</span><br/><span class="line">INSTALL_PATH=/usr/local/lib/lua/5.1    //第52行，设置 gd.so 的安装路径</span><br/><span class="line"></span><br/><span class="line">$(CC) -fPIC -o ...  //第70行，gcc 编译，添加 -fPIC 参数</span><br/></pre></td></tr></tbody></table></figure>
<p>然后编译：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">$ make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-md5"><a href="#安装-md5" class="headerlink" title="安装 md5"></a>安装 md5</h1><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">$ yum install unzip</span><br/><span class="line"></span><br/><span class="line">$ wget https://github.com/keplerproject/md5/archive/master.zip -O md5-master.zip</span><br/><span class="line">$ unzip md5-master.zip</span><br/><span class="line">$ <span class="built_in">cd</span> md5-master</span><br/><span class="line">$ make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-Lua-resty-UUID-库"><a href="#安装-Lua-resty-UUID-库" class="headerlink" title="安装 Lua-resty-UUID 库"></a>安装 Lua-resty-UUID 库</h1><p>调用系统的UUID模块生成的由32位16进制（0-f）数组成的的串，本模块进一步压缩为62进制。正如你所想，生成的UUID越长，理论冲突率就越小，请根据业务需要自行斟酌。 基本思想为把系统生成的16字节（128bit）的UUID转换为62进制（a-zA-Z0-9），同时根据业务需要进行截断。</p>
<p>下载地址: <a href="https://github.com/dcshi/lua-resty-UUID/archive/master.zip" target="_blank" rel="noopener noreferrer">https://github.com/dcshi/lua-resty-UUID/archive/master.zip</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">$ yum -y install libuuid-devel</span><br/><span class="line">$ wget https://github.com/dcshi/lua-resty-UUID/archive/master.zip -O lua-resty-UUID-master.zip</span><br/><span class="line">$ unzip lua-resty-UUID-master.zip</span><br/><span class="line">$ <span class="built_in">cd</span> lua-resty-UUID-master/clib</span><br/><span class="line">$ make</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="下载nginx-sysguard模块"><a href="#下载nginx-sysguard模块" class="headerlink" title="下载nginx sysguard模块"></a>下载nginx sysguard模块</h1><blockquote>
<p>如果nginx被攻击或者访问量突然变大，nginx会因为负载变高或者内存不够用导致服务器宕机，最终导致站点无法访问。<br/>今天要谈到的解决方法来自淘宝开发的模块nginx-http-sysguard，主要用于当负载和内存达到一定的阀值之时，会执行相应的动作，比如直接返回503,504或者其他的。一直等到内存或者负载回到阀值的范围内，站点恢复可用。简单的说，这几个模块是让nginx有个缓冲时间，缓缓。</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/alibaba/nginx-http-sysguard/archive/master.zip -O nginx-http-sysguard-master.zip</span><br/><span class="line">$ unzip nginx-http-sysguard-master.zip</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-OpenResty"><a href="#安装-OpenResty" class="headerlink" title="安装 OpenResty"></a>安装 OpenResty</h1><blockquote>
<p>OpenResty（也称为 ngx_openresty）是一个全功能的 Web 应用服务器。它打包了标准的 Nginx 核心，很多的常用的第三方模块，以及它们的大多数依赖项。<br/>OpenResty 中的 LuaJIT 组件默认未激活，需使用 <code>--with-luajit</code> 选项在编译 OpenResty 时激活,使用<code>--add-module</code>，添加上sysguard模块</p>
</blockquote>
<p>安装的版本：1.2.7.6</p>
<p>下载地址：</p>
<ul>
<li><a href="http://openresty.org/#Download" target="_blank" rel="noopener noreferrer">http://openresty.org/#Download</a></li>
<li><a href="http://openresty.org/download/ngx_openresty-1.2.7.6.tar.gz" target="_blank" rel="noopener noreferrer">http://openresty.org/download/ngx_openresty-1.2.7.6.tar.gz</a></li>
</ul>
<p>先安装依赖软件，然后在编译代码，编译时使用<code>--perfix</code>选项指定 OpenResty 的安装目录，<code>--with-luajit</code> 选项激活 LuaJIT 组件。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">$ yum -y install gcc make gmake openssl-devel pcre-devel readline-devel zlib-devel</span><br/><span class="line"></span><br/><span class="line">$ wget http://openresty.org/download/ngx_openresty-1.2.7.6.tar.gz</span><br/><span class="line">$ tar zvxf ngx_openresty-1.2.7.6.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> ngx_openresty-1.2.7.6</span><br/><span class="line">$ ./configure --with-luajit --with-http_stub_status_module --add-module=/opt/nginx-http-sysguard-master/</span><br/><span class="line">$ gmake &amp;&amp; gmake install</span><br/></pre></td></tr></tbody></table></figure>
<p>创建软连接：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">$ ln -s /usr/local/openresty/nginx/sbin/nginx /usr/sbin/nginx</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-Redis-Server"><a href="#安装-Redis-Server" class="headerlink" title="安装 Redis Server"></a>安装 Redis Server</h1><blockquote>
<p>Lua 脚本功能是 Reids 2.6 版本的最大亮点， 通过内嵌对 Lua 环境的支持， Redis 解决了长久以来不能高效地处理 CAS （check-and-set）命令的缺点， 并且可以通过组合使用多个命令， 轻松实现以前很难实现或者不能高效实现的模式。</p>
</blockquote>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line">$ wget http://redis.googlecode.com/files/redis-2.6.14.tar.gz</span><br/><span class="line">$ tar zvxf redis-2.6.14.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> redis-2.6.14</span><br/><span class="line">$ make &amp;&amp; make install</span><br/><span class="line"></span><br/><span class="line">$ mkdir -p /usr/<span class="built_in">local</span>/redis/conf</span><br/><span class="line">$ cp redis.conf /usr/<span class="built_in">local</span>/redis/conf/</span><br/><span class="line">~~~ </span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">&gt; LuaSocket是一个Lua扩展库，它能很方便地提供SMTP、HTTP、FTP等网络议访问操作。</span><br/><span class="line"></span><br/><span class="line">LuaSocket版本：luasocket-2.0-beta2</span><br/><span class="line"></span><br/><span class="line">下载地址: &lt;http://files.luaforge.net/releases/luasocket/luasocket/luasocket-2.0-beta2/luasocket-2.0-beta2.tar.gz&gt;</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">~~~bash</span><br/><span class="line">$ wget http://files.luaforge.net/releases/luasocket/luasocket/luasocket-2.0.2/luasocket-2.0.2.tar.gz</span><br/><span class="line">$ tar zvxf luasocket-2.0.2.tar.gz</span><br/><span class="line">$ <span class="built_in">cd</span> luasocket-2.0.2</span><br/><span class="line">$ make -f makefile.Linux</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-redis-lua-库"><a href="#安装-redis-lua-库" class="headerlink" title="安装 redis-lua 库"></a>安装 redis-lua 库</h1><p>Redis-Lua版本：2.0</p>
<p>下载地址: <a href="https://github.com/nrk/redis-lua/archive/version-2.0.zip" target="_blank" rel="noopener noreferrer">https://github.com/nrk/redis-lua/archive/version-2.0.zip</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/nrk/redis-lua/archive/version-2.0.zip</span><br/><span class="line">$ unzip redis-lua-version-2.0.zip</span><br/><span class="line">$ <span class="built_in">cd</span> redis-lua-version-2.0</span><br/></pre></td></tr></tbody></table></figure>
<p>然后，拷贝redis.lua至所需目录。</p>
<p>lua调用方式如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">local redis = require(“redis”)</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装-zklua"><a href="#安装-zklua" class="headerlink" title="安装 zklua"></a>安装 zklua</h1><blockquote>
<p>zklua 仅依赖 zookeeper c API 实现，一般存在于 <code>zookeeper-X.Y.Z/src/c</code>， 因此你需要首先安装 zookeeper c API。</p>
</blockquote>
<p>zookeeper c API 安装:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">$ wget http://mirrors.cnnic.cn/apache/zookeeper/zookeeper-3.4.5/</span><br/><span class="line">$ tar zvxf zookeeper-3.4.5</span><br/><span class="line">$ <span class="built_in">cd</span> zookeeper-3.4.5/src/c</span><br/><span class="line">$ ./configure</span><br/><span class="line">$ make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<p>然后安装zklua：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/forhappy/zklua/archive/master.zip -O zklua-master.zip</span><br/><span class="line">$ unzip zklua-master.zip</span><br/><span class="line">$ <span class="built_in">cd</span> zklua-master</span><br/><span class="line">$ make  &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h1><h2 id="配置openresty"><a href="#配置openresty" class="headerlink" title="配置openresty"></a>配置openresty</h2><p>openresty安装在<code>/usr/local/openresty</code>目录，在其目录下创建lualib，用于存放上面安装的一些动态连接库</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">mkdir -p  /usr/local/openresty/lualib/captcha</span><br/><span class="line">cp lua-resty-UUID-master/clib/libuuidx.so /usr/local/openresty/lualib/captcha/  #拷贝uuid的库文件</span><br/><span class="line">cp -r lua-resty-UUID-master/lib/* /usr/local/openresty/lualib/captcha/</span><br/><span class="line"></span><br/><span class="line">cp luasocket-2.0.2/luasocket.so.2.0 /usr/local/openresty/lualib/captcha/		#拷贝luasocket的库文件到/usr/local/openresty/lualib/captcha/</span><br/><span class="line">ln -s  /usr/local/openresty/lualib/captcha/luasocket.so.2.0 /usr/local/openresty/lualib/captcha/socket.so</span><br/><span class="line"></span><br/><span class="line">cp redis-lua-version-2.0/src/redis.lua /usr/local/openresty/lualib/captcha/     #拷贝reis.lua到/usr/local/openresty/lualib/captcha/</span><br/><span class="line"></span><br/><span class="line">mkdir -p /usr/local/openresty/lualib/zklua										#拷贝zklua文件到/usr/local/openresty/lualib/captcha/</span><br/><span class="line">cp cd zklua-master/zklua.so /usr/local/openresty/lualib/zklua/</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><p>创建www用户：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">useradd -M -s /sbin/nologin www</span><br/></pre></td></tr></tbody></table></figure>
<p>编辑ngnix.conf，内容如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/><span class="line">78</span><br/><span class="line">79</span><br/><span class="line">80</span><br/><span class="line">81</span><br/><span class="line">82</span><br/><span class="line">83</span><br/><span class="line">84</span><br/><span class="line">85</span><br/><span class="line">86</span><br/><span class="line">87</span><br/><span class="line">88</span><br/><span class="line">89</span><br/><span class="line">90</span><br/><span class="line">91</span><br/><span class="line">92</span><br/><span class="line">93</span><br/><span class="line">94</span><br/><span class="line">95</span><br/><span class="line">96</span><br/><span class="line">97</span><br/><span class="line">98</span><br/><span class="line">99</span><br/><span class="line">100</span><br/><span class="line">101</span><br/><span class="line">102</span><br/><span class="line">103</span><br/><span class="line">104</span><br/><span class="line">105</span><br/><span class="line">106</span><br/><span class="line">107</span><br/><span class="line">108</span><br/><span class="line">109</span><br/><span class="line">110</span><br/><span class="line">111</span><br/><span class="line">112</span><br/><span class="line">113</span><br/></pre></td><td class="code"><pre><span class="line">    user  www;</span><br/><span class="line">    worker_processes  31;</span><br/><span class="line">    error_log  logs/error.log;</span><br/><span class="line">    pid        logs/nginx.pid;</span><br/><span class="line">    worker_rlimit_nofile 65535;</span><br/><span class="line">    events {</span><br/><span class="line">    	worker_connections 1024;</span><br/><span class="line">    	use epoll;</span><br/><span class="line">	   }</span><br/><span class="line"></span><br/><span class="line">    http {</span><br/><span class="line">	include       	mime.types;</span><br/><span class="line">	default_type 	application/octet-stream;</span><br/><span class="line">	log_format  	main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span><br/><span class="line">			      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span><br/><span class="line">	               	      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;</span><br/><span class="line">	access_log  	logs/access.log  main;</span><br/><span class="line">	sendfile        on;</span><br/><span class="line">	tcp_nopush      on;</span><br/><span class="line">	tcp_nodelay     on;</span><br/><span class="line">	keepalive_timeout  65;</span><br/><span class="line">	gzip  		on;</span><br/><span class="line">	gzip_min_length 1K;</span><br/><span class="line">	gzip_buffers 4 	8k;</span><br/><span class="line">	gzip_comp_level 2;</span><br/><span class="line">	gzip_types 	text/plain image/gif image/png image/jpg application/x-javascript text/css application/xml text/javascript;</span><br/><span class="line">	gzip_vary 	on;</span><br/><span class="line">	</span><br/><span class="line">	upstream redis-pool{</span><br/><span class="line">	        server 127.0.0.1:10005;</span><br/><span class="line">		keepalive 1024;</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">    server {</span><br/><span class="line">        sysguard on;</span><br/><span class="line">        sysguard_load load=90 action=/50x.html;</span><br/><span class="line">        server_tokens off;</span><br/><span class="line">        listen       10002;</span><br/><span class="line">        server_name  localhost;</span><br/><span class="line">        charset utf-8;</span><br/><span class="line"></span><br/><span class="line">        location / {</span><br/><span class="line">        root   html;</span><br/><span class="line">        index  index.html index.htm;</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">	#-----------------------------------------------------------------------------------------</span><br/><span class="line">	</span><br/><span class="line">	# 验证码生成</span><br/><span class="line">	location /captcha {</span><br/><span class="line">		set $percent 0;</span><br/><span class="line">		set $modecount 1;</span><br/><span class="line">		content_by_lua_file /usr/local/openresty/nginx/luascripts/luajit/captcha.lua;</span><br/><span class="line">	}</span><br/><span class="line"></span><br/><span class="line">	#-----------------------------------------------------------------------------------------</span><br/><span class="line">	</span><br/><span class="line">	# 验证码校验	</span><br/><span class="line">	location /captcha-check {</span><br/><span class="line">	        content_by_lua_file /usr/local/openresty/nginx/luascripts/luajit/captcha-check.lua;</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">        # 验证码删除	</span><br/><span class="line">	location /captcha-delete {</span><br/><span class="line">		content_by_lua_file /usr/local/openresty/nginx/luascripts/luajit/captcha-delete.lua;</span><br/><span class="line">	}</span><br/><span class="line">	</span><br/><span class="line">	#-----------------------------------------------------------------------------------------</span><br/><span class="line"></span><br/><span class="line">	# 样式1-静态图片</span><br/><span class="line">	location /mode1 {</span><br/><span class="line">		content_by_lua_file /usr/local/openresty/nginx/luascripts/luajit/mode/mode1.lua;</span><br/><span class="line">	} </span><br/><span class="line">	</span><br/><span class="line">	#-----------------------------------------------------------------------------------------</span><br/><span class="line"></span><br/><span class="line">	# redis中添加key-value</span><br/><span class="line">	location /redisSetQueue {</span><br/><span class="line">		internal;</span><br/><span class="line">		set_unescape_uri $key $arg_key;</span><br/><span class="line">		set_unescape_uri $val $arg_val; </span><br/><span class="line">		redis2_query rpush $key $val;</span><br/><span class="line">		redis2_pass redis-pool;</span><br/><span class="line">	}</span><br/><span class="line">	# redis中获取captcha-string</span><br/><span class="line">	location /redisGetStr {</span><br/><span class="line">		internal;</span><br/><span class="line">		set_unescape_uri $key $arg_key;</span><br/><span class="line">		redis2_query lindex $key 0;</span><br/><span class="line">		redis2_pass redis-pool;</span><br/><span class="line">	}</span><br/><span class="line">	# redis中获取captcha-image</span><br/><span class="line">	location /redisGetImg {</span><br/><span class="line">		internal;</span><br/><span class="line">		set_unescape_uri $key $arg_key;</span><br/><span class="line">		redis2_query lindex $key 1;</span><br/><span class="line">		redis2_pass redis-pool;</span><br/><span class="line">	}</span><br/><span class="line">	</span><br/><span class="line">	#-----------------------------------------------------------------------------------------</span><br/><span class="line"></span><br/><span class="line">        location ~.*.(gif|jpg|png)$ {</span><br/><span class="line">        expires 10s;</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">        error_page  404              /404.html;</span><br/><span class="line">        error_page  500 502 503 504  /50x.html;</span><br/><span class="line">        location = /50x.html {</span><br/><span class="line">            root   html;</span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>上面将 ngnix 的端口修改为10002。</p>
<p>/usr/local/openresty/nginx/luascripts/luajit/captcha.lua 是用于生成验证码，内容如下：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--中控脚本</span></span><br/><span class="line"><span class="comment">--</span></span><br/><span class="line"><span class="comment">--部分应用预先生成</span></span><br/><span class="line"><span class="comment">--部分应用实时生成，并且随机选择生成样式</span></span><br/><span class="line"><span class="comment">--</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">----------------------------------------------------------------------------------------------</span></span><br/><span class="line"><span class="built_in">package</span>.<span class="built_in">path</span> = <span class="string">&#34;/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/captcha/?.lua;&#34;</span></span><br/><span class="line"><span class="built_in">package</span>.<span class="built_in">cpath</span> = <span class="string">&#34;/usr/local/openresty/lualib/?.so;/usr/local/openresty/lualib/captcha/?.so;&#34;</span></span><br/><span class="line"><span class="comment">----------------------------------------------------------------------------------------------</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">--设置随机种子</span></span><br/><span class="line"><span class="keyword">local</span> resty_uuid=<span class="built_in">require</span>(<span class="string">&#34;resty.uuid&#34;</span>)</span><br/><span class="line"><span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">tonumber</span>(resty_uuid.gennum20()))</span><br/><span class="line"></span><br/><span class="line"><span class="comment">-----------------------------------------------------------------------------------------</span></span><br/><span class="line"><span class="comment">--</span></span><br/><span class="line"><span class="comment">--[[ 预先生成 ]]</span></span><br/><span class="line"><span class="comment">--</span></span><br/><span class="line"><span class="keyword">if</span> <span class="built_in">math</span>.<span class="built_in">random</span>(<span class="number">1</span>,<span class="number">99</span>)&lt;<span class="built_in">tonumber</span>(ngx.var.percent) <span class="keyword">then</span></span><br/><sp