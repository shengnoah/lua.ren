---
layout: post
title: 使用Redis+Lua实现分布式限流 
tags: [lua文章]
categories: [topic]
---
<h2 id="分布式限流"><a href="#分布式限流" class="headerlink" title="分布式限流"></a>分布式限流</h2><p>分布式限流最关键的是要将限流服务做成原子化,而解决方案可以使用 Redis+Lua 或者 Nginx+Lua 技术实现,通过这两种技术可以实现高并发和高性能。本文使用 Redis+Lua 实现时间窗内某个接口的请求数限流，实现了该功能后可以改造为限流总并发/请求数和限制总资源数。</p>
<h2 id="Redis-Lua实现脚本"><a href="#Redis-Lua实现脚本" class="headerlink" title="Redis+Lua实现脚本"></a>Redis+Lua实现脚本</h2>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">local</span> key = KEYS[1] </div><div class="line"><span class="built_in">local</span> <span class="built_in">limit</span> = tonumber(ARGV[1]) <span class="comment">#限流大小</span></div><div class="line"><span class="built_in">local</span> current = tonumber(redis.call(<span class="string">&#39;get&#39;</span>,key) or <span class="string">&#34;0&#34;</span>) <span class="comment">#获取不到 默认为0</span></div><div class="line"><span class="keyword">if</span> current + 1 &gt; <span class="built_in">limit</span> <span class="keyword">then</span> <span class="comment">#如果超出限流大小</span></div><div class="line">   <span class="built_in">return</span> 0</div><div class="line"><span class="keyword">else</span>   <span class="comment">#请求数+1，并设置2秒过期</span></div><div class="line">	redis.call(<span class="string">&#34;INCRBY&#34;</span>,key,<span class="string">&#34;1&#34;</span>)</div><div class="line">	redis.call(<span class="string">&#34;expire&#34;</span>,key,<span class="string">&#34;2&#34;</span>)</div><div class="line">	<span class="built_in">return</span> 1</div><div class="line">end</div></pre></td></tr></tbody></table></figure>
<h2 id="Java中判断是否需要限流的代码"><a href="#Java中判断是否需要限流的代码" class="headerlink" title="Java中判断是否需要限流的代码"></a>Java中判断是否需要限流的代码</h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</div><div class="line">	<span class="comment">//redis lua 脚本</span></div><div class="line">	String luaScript = Files.toString(<span class="keyword">new</span> File(<span class="string">&#34;xxxxLimit.lua&#34;</span>)),Charset.defaultCharset());</div><div class="line">	<span class="comment">//将当前时间戳取秒数（极端情况下机器时钟不准时会存在一些小问题)</span></div><div class="line">	String key = <span class="string">&#34;ip:&#34;</span> + System.currentTimeMillis()/<span class="number">1000</span>;</div><div class="line">	<span class="comment">//限流大小</span></div><div class="line">	String limit = <span class="string">&#34;30&#34;</span>; </div><div class="line">	<span class="comment">//执行脚本</span></div><div class="line">	<span class="keyword">return</span> (Long)jedis.eval(luaScript,Lists.newArrayList(key),Lists.newArrayList(limit)) == <span class="number">1</span>;</div><div class="line"></div><div class="line">}</div></pre></td></tr></tbody></table></figure>