---
layout: post
title: lua-resty-mysql事务封装 
tags: [lua文章]
categories: [topic]
---
<p>lua-resty-mysql没有提供事务封装，下面提供一个事务的封装例子的主要代码部分。事务是基于session，主要将事务相关语句在同一个session上执行。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span> <span class="string">&#34;resty.mysql&#34;</span></div><div class="line"><span class="keyword">local</span> <span class="built_in">config</span> = <span class="built_in">require</span> <span class="string">&#34;config&#34;</span></div><div class="line"><span class="keyword">local</span> <span class="built_in">log</span> = <span class="built_in">require</span> <span class="string">&#34;utils.log&#34;</span></div><div class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">&#34;cjson&#34;</span></div><div class="line"><span class="keyword">local</span> u_string = <span class="built_in">require</span> <span class="string">&#34;utils.string&#34;</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> _M = {}</div><div class="line"></div><div class="line"><span class="keyword">local</span> mt = {<span class="built_in">__index</span> = _M}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> _M.new<span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> db, err = mysql:new()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;failed to instantiate mysql: &#34;</span>, err)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    </div><div class="line">    db:set_timeout(<span class="built_in">config</span>.get(<span class="string">&#39;mysql_conn_timeout&#39;</span>))</div><div class="line"></div><div class="line">    <span class="comment">-- 连接数据库</span></div><div class="line">    <span class="keyword">local</span> ok, err, errno, sqlstate = db:connect(<span class="built_in">config</span>.get(<span class="string">&#39;mysql_conn&#39;</span>))</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;failed to connect: &#34;</span>, err, <span class="string">&#34;: &#34;</span>, errno, <span class="string">&#34;: &#34;</span>, sqlstate)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">setmetatable</span>({ db = db }, mt)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 开启事务</span></div><div class="line"><span class="function"><span class="keyword">function</span> _M.transaction_start<span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> db = self.db</div><div class="line"></div><div class="line">    <span class="keyword">local</span> res, err, errno, sqlstate = db:query(<span class="string">&#34;START TRANSACTION&#34;</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;START TRANSACTION failed: &#34;</span>, err, <span class="string">&#34;: &#34;</span>, errno, <span class="string">&#34;: &#34;</span>, sqlstate)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 提交事务</span></div><div class="line"><span class="function"><span class="keyword">function</span> _M.transaction_commit<span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> db = self.db</div><div class="line"></div><div class="line">    <span class="keyword">local</span> res, err, errno, sqlstate = db:query(<span class="string">&#34;COMMIT&#34;</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;COMMIT failed: &#34;</span>, err, <span class="string">&#34;: &#34;</span>, errno, <span class="string">&#34;: &#34;</span>, sqlstate)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="comment">-- 连接池</span></div><div class="line">    <span class="keyword">local</span> pool = <span class="built_in">config</span>.get(<span class="string">&#39;mysql_pool&#39;</span>)</div><div class="line">    <span class="keyword">local</span> ok, err = db:set_keepalive(pool.timeout, pool.size)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;failed to set keepalive: &#34;</span> .. err)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 回滚事务</span></div><div class="line"><span class="function"><span class="keyword">function</span> _M.transaction_rollback<span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> db = self.db</div><div class="line"></div><div class="line">    <span class="keyword">local</span> res, err, errno, sqlstate = db:query(<span class="string">&#34;ROLLBACK&#34;</span>)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;ROLLBACK failed: &#34;</span>, err, <span class="string">&#34;: &#34;</span>, errno, <span class="string">&#34;: &#34;</span>, sqlstate)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="comment">-- 连接池</span></div><div class="line">    <span class="keyword">local</span> pool = <span class="built_in">config</span>.get(<span class="string">&#39;mysql_pool&#39;</span>)</div><div class="line">    <span class="keyword">local</span> ok, err = db:set_keepalive(pool.timeout, pool.size)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;failed to set keepalive: &#34;</span> .. err)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- 执行sql</span></div><div class="line"><span class="function"><span class="keyword">function</span> _M.execute<span class="params">(self, sql, params)</span></span></div><div class="line">    <span class="keyword">local</span> sql = u_string.parse_sql(sql, params)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sql <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;sql format error: &#34;</span>, sql, <span class="string">&#34;: &#34;</span>, cjson.encode(params))</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">local</span> db = self.db</div><div class="line"></div><div class="line">    <span class="keyword">local</span> res, err, errno, sqlstate = db:query(sql)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></div><div class="line">        <span class="built_in">log</span>.err(<span class="string">&#34;sql execute failed: &#34;</span>, err, <span class="string">&#34;: &#34;</span>, errno, <span class="string">&#34;: &#34;</span>, sqlstate)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, errno</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> res</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> _M.select<span class="params">(self, sql, params)</span></span></div><div class="line">    <span class="keyword">return</span> self:<span class="built_in">execute</span>(sql, params)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> _M.insert<span class="params">(self, sql, params)</span></span></div><div class="line">    <span class="keyword">local</span> res, errno = self:<span class="built_in">execute</span>(sql, params)</div><div class="line">    <span class="keyword">if</span> res <span class="keyword">and</span> res.affected_rows &gt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>, errno</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> _M.update<span class="params">(self, sql, params)</span></span></div><div class="line">    <span class="keyword">local</span> res, errno = self:<span class="built_in">execute</span>(sql, params)</div><div class="line">    <span class="keyword">if</span> res <span class="keyword">and</span> res.affected_rows &gt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>, errno</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> _M.delete<span class="params">(self, sql, params)</span></span></div><div class="line">    <span class="keyword">local</span> res, errno = self:<span class="built_in">execute</span>(sql, params)</div><div class="line">    <span class="keyword">if</span> res <span class="keyword">and</span> res.affected_rows &gt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>, errno</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> _M</div></pre></td></tr></tbody></table></figure><p></p>
<p>sql格式化代码：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- sql 格式化</span></div><div class="line"><span class="function"><span class="keyword">function</span> _M.parse_sql<span class="params">(sql, params)</span></span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> params <span class="keyword">or</span> <span class="keyword">not</span> u_table.is_array(params) <span class="keyword">or</span> #params == <span class="number">0</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> sql</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sql <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="keyword">local</span> new_params = {}</div><div class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(params) <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(v) == <span class="string">&#39;string&#39;</span> <span class="keyword">then</span></div><div class="line">            tab_insert(new_params, ngx_quote_sql_str(v))</div><div class="line">        <span class="keyword">else</span></div><div class="line">            tab_insert(new_params, v)</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    sql = str_format(sql, <span class="built_in">unpack</span>(new_params))</div><div class="line">    <span class="keyword">return</span> sql</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></tbody></table></figure><p></p>