---
layout: post
title: C# 与 Lua  
tags: [lua文章]
categories: [topic]
---
<h2 id="交互原理">交互原理</h2>

<h3 id="lua-call-c">Lua Call C#</h3>

<ul>
  <li>Wrap 方式:<br/>
 首先生成 C# 源文件所对应的Wrap文件，由 Lua 文件调用 Wrap 文件，再由 Wrap 文件调用 C# 文件</li>
  <li>反射方式：<br/>
当索引系统 API、dll 库或者第三方库时，如果无法将代码的具体实现进行代码生成，可采用此方式实现交互。<br/>
缺点:执行效率低。</li>
</ul>

<h4 id="过程">过程</h4>
<ul>
  <li>lua-&gt;wrap-&gt;C#<br/>
先生成 Wrap 文件（中间文件/适配文件）或者编写 C# 源文件所对应的 c 模块， wrap 文件把字段方法，然后将源文件内容通过 Wrap 文件或者 C 模块把字段方法注册到 lua 虚拟机中（解释器 luajit ），然后 lua 通过 wrap 去调用这个模块的函数。</li>
</ul>

<h3 id="c-call-lua">C# Call Lua</h3>
<ul>
  <li>虚拟栈操作方式<br/>
C# 把请求或数据放在栈顶，然后 lua 从栈顶取出该数据，在 lua 中做出相应处理（查询，改变），然后把处理结果放回栈顶，最后 C# 再从栈顶取出 lua 处理完的数据，完成交互。<br/>
或者在 config 文件中添加相应类型也可以</li>
</ul>

<h4 id="过程-1">过程</h4>
<ul>
  <li>C#-&gt;Bridge-&gt;dll-&gt;Lua  OR   C#-&gt;dll-&gt;Lua<br/>
C# 生成 Bridge 文件， Bridge 调 dll 文件（ dll 是用 C 写的库），先调用 lua 中 dll 文件，由 dll 文件执行lua代码</li>
</ul>

<h2 id="交互优化">交互优化</h2>
<ol>
  <li>尽量不要在 lua 中传递 Unity 中的类，尽量只传递int,float,double 类型
解决方法：在 C# 中封装方法 Unity 类型的赋值，使用 id（int） 代表对应 object 的传递</li>
  <li>调用的 C# 方法参数数量尽量少与4个</li>
  <li>C# 方法尽量为静态方法（减少 lua gc ）</li>
  <li>在 lua 中调用 C# 方法获取数据时，其方法参数尽量使用 out 关键字（将表查找转换为对栈访问）</li>
</ol>

<h2 id="资料">资料</h2>
<p>原理：
https://blog.csdn.net/Pan_mouren/article/details/81000303<br/>
性能优化：https://blog.csdn.net/swj524152416/article/details/71125478?tdsourcetag=s_pctim_aiomsg</p>


                <hr style="visibility: hidden;"/>