---
layout: post
title: Ngx_lua一键截流系统 
tags: [lua文章]
categories: [topic]
---


      
      

      
        <h3 id="背景"><a href="https://fankeke.github.io/#%E8%83%8C%E6%99%AF" class="headerlink" title="背景"></a>背景</h3><p>由于某些服务的流量过大，为保护其后端服务，需要在接入层Nginx对某些服务流量进行截流。本系统可以提供按照百分比对指定域名的制定URI进行截流的功能</p>
<h3 id="接口"><a href="https://fankeke.github.io/#%E7%95%8C%E9%9D%A2" class="headerlink" title="接口"></a>接口</h3><p>管理员可以轻松在管理接口进行配置，接口接口大致如下</p>
<p><img src="https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/1.png" alt=""></p>
<h3 id="实现"><a href="https://fankeke.github.io/#%E5%AE%9E%E7%8E%B0" class="headerlink" title="实现"></a>实现</h3><p>采用nginx＋Lua的实现整个系统的截流功能，大致架构图如下：</p>
<p><img src="https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/2.png" alt=""></p>
<p>管理员在接口上写入数据，管理端服务会将数据放入redis集群，各个nginx节点，会定时从redis集群拉取截流数据。</p>
<h3 id="服务接入"><a href="https://fankeke.github.io/#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5" class="headerlink" title="服务接入"></a>服务接入</h3><p>为了对达到快速方便的截流目的，默认是每个服务都接入截流系统，而不需要进行nginx配置文档的修改。</p>
<p>access_by_lua_file    “/etc/nginx/hlb-lua/access_lua/online_access.lua”;                （1）<br>server {</p>
<pre><code>server_name        server1;
</code></pre><p>}<br>server {<br>    server_name        server2;<br>}<br>server {</p>
<pre><code>server_name        server3;
</code></pre><p>}</p>
<p>server {<br>    server_name        server4;<br>}</p>
<p>这样能够到达全自动化的截流：<br>1 不需要在每个服务配置中做添加任何字段，也就意味着完全不用reload Nginx<br>2 针对某个服务下的某个路径进行截流，只需在管理端接口上输入数据即可完成</p>
<h3 id="性能测试"><a href="https://fankeke.github.io/#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95" class="headerlink" title="性能测试"></a>性能测试</h3><p>由于默认所有流量经过截流检测系统，需要比较造成的性能影响。计算截流逻辑的耗时。每组数据共采集5000条请求的日志，用ab实现压测，计算其在截流逻辑处的平均耗时。共测试10组数据</p>
<p><img src="https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/3.png" alt=""></p>
<p>由压测结果来看，截流逻辑耗时稳定在20us以下。</p>
<h3 id="灾难测试"><a href="https://fankeke.github.io/#%E7%81%BE%E9%9A%BE%E6%B5%8B%E8%AF%95" class="headerlink" title="灾难测试"></a>灾难测试</h3><p>截流系统依赖redis集群，考虑到集群的挂掉后对整改系统的影响，需要进行灾难测试。灾难测试分为两部分，分别是对管理端的影响和对Nginx节点的影响。<br>说明：由于所有截流数据缓存在集群的一个分片上，故灾难测试在该分片上进行。下面说的分片特指存放截流数据的分片</p>
<p><img src="https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/4.png" alt=""><br>结论：从结论看出，截流系统对于redis集群的故障能够做到有损提供服务，做到高可用。</p>
<h3 id="接口设计"><a href="https://fankeke.github.io/#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1" class="headerlink" title="接口设计"></a>接口设计</h3><h4 id="设置-修改）降级策略"><a href="https://fankeke.github.io/#%E8%AE%BE%E7%BD%AE-%E4%BF%AE%E6%94%B9%EF%BC%89%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5" class="headerlink" title="设置(修改）降级策略"></a>设置(修改）降级策略</h4><p>curl  www.admin.com/degrade/admin/?action=set -d ‘{“deg_servername”:”xx”,”deg_location”:”yy”,”deg_percent”:”100”}’</p>
<h4 id="删除降级策略"><a href="https://fankeke.github.io/#%E5%88%A0%E9%99%A4%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5" class="headerlink" title="删除降级策略"></a>删除降级策略</h4><p>curl www.admin.com/degrade/admin/?action=del -d ‘{“deg_servername”:”xx”,”deg_location”:”yy”}’</p>
<h4 id="查看查看降级策略"><a href="https://fankeke.github.io/#%E6%9F%A5%E7%9C%8B%E6%9F%A5%E7%9C%8B%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5" class="headerlink" title="查看查看降级策略"></a>查看查看降级策略</h4><p>curl www.admin.com/degrade/admin/?action=get -d ‘{“deg_servername”:”xx”,”deg_location”:”yy”}’</p>