---
layout: post
title: Lua的require机制 
tags: [lua文章]
categories: [topic]
---
<p>今天仔细读了文档，弄清楚了Lua的模块require机制。<br/>
Lua是通过require函数来加载模块的，只需提供模块的名字，即可通过require(modname)来加载模块。<br/>
Lua是如何通过modname来载入.lua或.so的呢？</p>

<h3 id="默认加载过程">默认加载过程</h3>
<ol>
  <li>package.loaded[modname]中存了模块的数据，有则直接返回</li>
  <li>顺序遍历package.searchers，获取loader
    <blockquote>
      <ol>
        <li>package.preload[modname]</li>
        <li>Lua Loader, 通过package.searchpath搜索package.path</li>
        <li>C Loader, 通过package.searchpath搜索package.cpath</li>
        <li>All-In-One loader</li>
      </ol>
    </blockquote>
  </li>
  <li>调用loader载入模块</li>
  <li>将载入结果保存至package.loaded[modname]并返回结果</li>
</ol>

<p>可用lua模拟载入过程：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function findloader(modname)
    local loader = nil
    local ext = nil
    for _,s in ipairs(package.searchers) do
        loader,ext = s(modname)
        if type(loader)==&#34;function&#34; then return loader,ext end
    end
    error(&#34;findloader fail&#34;)
end

function myreq(modname)
    local m = package.loaded[modname]
    if m then return m end

    local loader,ext = findloader(modname)
    local ret = loader(modname, ext) or true
    package.loaded[modname] = ret
    return ret
end
</code></pre></div></div>

<h3 id="all-in-one-loader">All-In-One Loader</h3>
<p>例如:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require(&#34;a.b.c&#34;)
</code></pre></div></div>
<ol>
  <li>查找a的C library(见过程2.3)</li>
  <li>检查它是否有luaopen_a_b_c函数</li>
</ol>