---
layout: post
title: Lua_on_Nginx 
tags: [lua文章]
categories: [topic]
---

          <p>Nginx的高并发是它的一大显著优势，Lua则是一门较为轻便的脚本语言。把他们组合在一起，则极大的增强了Nginx的能力（灵活性，扩展性）。<br>Nginx-Lua模块是由淘宝开发的第三方模块，使用它可以把Lua内嵌到Nginx中。</p>
<p>nginx  地址：<a href="http://www.nginx.org" target="_blank" rel="noopener noreferrer">http://www.nginx.org</a></p>
<p>luajit 地址：<a href="http://luajit.org/download.html" target="_blank" rel="noopener noreferrer">http://luajit.org/download.html</a></p>
<p>HttpLuaModule 地址：<a href="http://wiki.nginx.org/HttpLuaModule" target="_blank" rel="noopener noreferrer">http://wiki.nginx.org/HttpLuaModule</a></p>

<h2 id="1-系统环境"><a href="http://www.leocook.org/#1-%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83" class="headerlink" title="1.系统环境"></a>1.系统环境</h2><p>必须的编译环境，需要提前准备好。我这里的环境是ubuntu14.04，用的apt source是官方的源，使用163 source的时候有问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install make</span><br><span class="line">apt-get install gcc</span><br><span class="line">apt-get install libpcre3 libpcre3-dev</span><br><span class="line">apt-get install libssl-dev</span><br></pre></td></tr></table></figure>
<h2 id="2-Lua的运行时环境配置"><a href="http://www.leocook.org/#2-Lua%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" class="headerlink" title="2.Lua的运行时环境配置"></a>2.Lua的运行时环境配置</h2><h3 id="2-1-下载Lua的运行环境"><a href="http://www.leocook.org/#2-1-%E4%B8%8B%E8%BD%BDLua%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" class="headerlink" title="2.1.下载Lua的运行环境"></a>2.1.下载Lua的运行环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/</span><br><span class="line"></span><br><span class="line">wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf LuaJIT-2.0.4.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="2-2-编译安装"><a href="http://www.leocook.org/#2-2-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85" class="headerlink" title="2.2.编译安装"></a>2.2.编译安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/LuaJIT-2.0.4</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="3-下载Nginx的lua模块"><a href="http://www.leocook.org/#3-%E4%B8%8B%E8%BD%BDNginx%E7%9A%84lua%E6%A8%A1%E5%9D%97" class="headerlink" title="3.下载Nginx的lua模块"></a>3.下载Nginx的lua模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/</span><br><span class="line"></span><br><span class="line">wget https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf v0.10.5.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="4-Nginx配置"><a href="http://www.leocook.org/#4-Nginx%E9%85%8D%E7%BD%AE" class="headerlink" title="4.Nginx配置"></a>4.Nginx配置</h2><h3 id="4-1-下载nginx"><a href="http://www.leocook.org/#4-1-%E4%B8%8B%E8%BD%BDnginx" class="headerlink" title="4.1.下载nginx"></a>4.1.下载nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/</span><br><span class="line"></span><br><span class="line">wget http://nginx.org/download/nginx-1.10.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf nginx-1.10.1.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="4-2-编译安装"><a href="http://www.leocook.org/#4-2-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85" class="headerlink" title="4.2.编译安装"></a>4.2.编译安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 导入环境变</span><br><span class="line">export LUAJIT_LIB=/usr/local/lib</span><br><span class="line">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line"></span><br><span class="line"># 安装到/usr/local/nginx-1.10.1目录下</span><br><span class="line">./configure --prefix=/usr/local/nginx-1.10.1 --add-module=../lua-nginx-module-0.10.5</span><br><span class="line"></span><br><span class="line">make -j2</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="4-3-配置"><a href="http://www.leocook.org/#4-3-%E9%85%8D%E7%BD%AE" class="headerlink" title="4.3.配置"></a>4.3.配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx-1.10.1</span><br><span class="line">vi conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>然后在http -&gt; server下加入配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /lua_test {</span><br><span class="line">    default_type 'text/plain';</span><br><span class="line">    content_by_lua 'ngx.say("hello, ttlsa lua")';</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这个配置后，访问<a href="http://www.leocook.org/http://%5Bhostname%5D:%5Bport%5D/lua_test%EF%BC%8C%E5%B0%B1%E8%83%BD%E8%AE%BF%E9%97%AE%E4%BD%A0%E6%89%80%E5%AE%9A%E4%B9%89%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9D%97%E4%BA%86%E3%80%82" target="_blank" rel="noopener noreferrer">http://[hostname]:[port]/lua_test，就能访问你所定义的代码块了。</a></p>
<p>如果你还想修改nginx的http端口，修改一下<strong>http.server</strong>中的<strong>listen</strong>值，就可以了。</p>
<h3 id="4-4-启动nginx"><a href="http://www.leocook.org/#4-4-%E5%90%AF%E5%8A%A8nginx" class="headerlink" title="4.4.启动nginx"></a>4.4.启动nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx-1.10.1/sbin/nginx</span><br></pre></td></tr></table></figure>
<h3 id="4-5-验证"><a href="http://www.leocook.org/#4-5-%E9%AA%8C%E8%AF%81" class="headerlink" title="4.5.验证"></a>4.5.验证</h3><p>查看端口的运行情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# netstat -anp|grep 4002</span><br><span class="line">tcp        0      0 0.0.0.0:4002            0.0.0.0:*               LISTEN      1736/nginx</span><br></pre></td></tr></table></figure>
<p>或者直接请求4002端口。（我这里使用的是4002端口，你可以根据需要，设置为你需要的。）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/usr/local/nginx-1.10.1/sbin# curl http://192.168.1.160:4002/lua_test</span><br><span class="line">hello, ttlsa lua</span><br></pre></td></tr></table></figure>
<h2 id="5-FAQ"><a href="http://www.leocook.org/#5-FAQ" class="headerlink" title="5.FAQ"></a>5.FAQ</h2><h3 id="5-1-缺少pcre3"><a href="http://www.leocook.org/#5-1-%E7%BC%BA%E5%B0%91pcre3" class="headerlink" title="5.1.缺少pcre3"></a>5.1.缺少pcre3</h3><ul>
<li>错误log</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure: error: the HTTP rewrite module requires the PCRE library.</span><br><span class="line">You can either disable the module by using --without-http_rewrite_module</span><br><span class="line">option, or install the PCRE library into the system, or build the PCRE library</span><br><span class="line">statically from the source with nginx by using --with-pcre=&lt;path&gt; option.</span><br></pre></td></tr></table></figure>
<ul>
<li>解决办法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libpcre3 libpcre3-dev</span><br></pre></td></tr></table></figure>
<h3 id="5-2-缺少libssl"><a href="http://www.leocook.org/#5-2-%E7%BC%BA%E5%B0%91libssl" class="headerlink" title="5.2.缺少libssl"></a>5.2.缺少libssl</h3><ul>
<li>错误log</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure: error: the HTTP gzip module requires the zlib library.</span><br><span class="line">You can either disable the module by using --without-http_gzip_module</span><br><span class="line">option, or install the zlib library into the system, or build the zlib library</span><br><span class="line">statically from the source with nginx by using --with-zlib=&lt;path&gt; option.</span><br></pre></td></tr></table></figure>
<ul>
<li>解决办法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libssl-dev</span><br></pre></td></tr></table></figure>
<p>参考地址：<br><a href="http://www.ttlsa.com/nginx/nginx-modules-ngx_lua/" target="_blank" rel="noopener noreferrer">http://www.ttlsa.com/nginx/nginx-modules-ngx_lua/</a></p>