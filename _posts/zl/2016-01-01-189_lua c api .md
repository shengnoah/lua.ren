---
layout: post
title: lua c api  
tags: [lua文章]
categories: [topic]
---
   <h2 id="一-概述">一 概述</h2> <p>很多情况下有这种需求：在特定的框架中针对不同的业务做少量修改。使用 <code class="highlighter-rouge">C/C++</code> 开发稳定的框架，调用针对不同业务开发的 <code class="highlighter-rouge">Lua</code> 函数可以实现需求。其实从 <code class="highlighter-rouge">C/C++</code> 调用 <code class="highlighter-rouge">Lua</code> 函数非常简单，<strong>调用时将 <code class="highlighter-rouge">Lua</code> 函数压入栈、将函数参数压入栈，调用 <code class="highlighter-rouge">lua_pcall</code> 完成调用；调用后从栈获得调用函数返回结果</strong>。</p> <h2 id="二-示例">二 示例</h2> <h3 id="1-进程示例">1. 进程示例</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#include "lua.h"
#include "lauxlib.h"
#include "lualib.h"
</span>
<span class="cm">/******************************************************************************
 * 函数结构体定义
 ******************************************************************************/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">function_buf_s</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>  <span class="c1">// 函数名
</span>    <span class="kt">int</span> <span class="n">nargs</span><span class="p">;</span>   <span class="c1">// 参数数量
</span>    <span class="kt">int</span> <span class="n">nret</span><span class="p">;</span>    <span class="c1">// 返回值数量
</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span> <span class="c1">// 函数体
</span><span class="p">}</span> <span class="n">function_buf</span><span class="p">;</span>

<span class="c1">// 此处 function 不应该使用 function f() ... end 方式编写，写出的函数其实不会被执行
</span><span class="k">static</span> <span class="n">function_buf</span> 
<span class="n">lua_function</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">"sayhi"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">"local name = ...</span><span class="se">n</span><span class="s">"</span>
     <span class="s">"return string.format('hi %s!', name)</span><span class="se">n</span><span class="s">"</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="s">"echo"</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="s">"function echo(msg)</span><span class="se">n</span><span class="s">"</span>
     <span class="s">"    return msg</span><span class="se">n</span><span class="s">"</span>
     <span class="s">"end</span><span class="se">n</span><span class="s">"</span>
     <span class="s">"local msg = ...</span><span class="se">n</span><span class="s">"</span>
     <span class="s">"return echo(msg)</span><span class="se">n</span><span class="s">"</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">sayHi</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">function_buf</span> <span class="o">*</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lua_function</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">luaL_loadbuffer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">),</span> 
                              <span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"call loadbuffer fail ret:%d, code:%s"</span><span class="p">,</span> 
                          <span class="n">ret</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"lua"</span><span class="p">);</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"lua_pcall fail ret:%d %s"</span><span class="p">,</span> 
                          <span class="n">ret</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// 输出类型
</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"typename %s</span><span class="se">n</span><span class="s">"</span><span class="p">,</span> <span class="n">luaL_typename</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lua_isstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"lua_pcall ret not string"</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// 函数执行结果在栈中，取出来再放入栈
</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pushfstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"sayhi say:%s"</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
 * 通用入口函数
 * 调用时首先将函数名压入栈，之后是其他参数
 ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">common_entry</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lua_isstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"first arg should be function name, string type"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">function_name</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    
    <span class="n">function_buf</span> <span class="o">*</span><span class="n">function</span> <span class="o">=</span> <span class="n">lua_function</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(;</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">function</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">function_name</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"not found:%s function in array"</span><span class="p">,</span> <span class="n">function_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">luaL_loadbuffer</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">),</span> 
                              <span class="n">function</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"call loadbuffer fail ret:%d, code:%s"</span><span class="p">,</span> 
                          <span class="n">ret</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">nargs</span><span class="p">,</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">nret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">"lua_pcall fail ret:%d %s"</span><span class="p">,</span> 
                          <span class="n">ret</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="kt">int</span> <span class="n">nret</span> <span class="o">=</span> <span class="n">function</span><span class="o">-&gt;</span><span class="n">nret</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">nret</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"ret:%d is:%s</span><span class="se">n</span><span class="s">"</span><span class="p">,</span> <span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">nret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> 
<span class="k">struct</span> <span class="n">luaL_reg</span> <span class="n">call_function_lib</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">"sayHi"</span><span class="p">,</span> <span class="n">sayHi</span><span class="p">},</span>
    <span class="p">{</span><span class="s">"common_entry"</span><span class="p">,</span> <span class="n">common_entry</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************
* 注册函数
******************************************************************************/</span>
<span class="kt">int</span> 
<span class="nf">luaopen_call_function</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">luaL_openlib</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">"call_function"</span><span class="p">,</span> <span class="n">call_function_lib</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>进程中有两个示例，<code class="highlighter-rouge">sayHi</code> 函数接收一个 <code class="highlighter-rouge">string</code> 参数并返回一个 <code class="highlighter-rouge">string</code> 参数；<code class="highlighter-rouge">common_entry</code> 函数可以根据函数名选择相应的函数体进行执行，更加灵活。</p> <p><strong>在函数定义中需要注意，<code class="highlighter-rouge">luaL_loadbuffer</code> 系列函数会将字符串当做进程段载入并放在栈顶，但是并未执行函数。如果载入的代码段是 <code class="highlighter-rouge">function f()…end</code> 格式，使用 <code class="highlighter-rouge">lua_pcall</code> 调用代码段时函数 <code class="highlighter-rouge">f</code> 仅做了定义，未执行函数体。</strong></p> <h3 id="2-调用示例">2. 调用示例</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/lua5.1.5/bin/lua <span class="nt">-e</span> <span class="s2">"require 'call_function'; ret = call_function.sayHi('lua'); print(ret)"</span>
typename string
sayhi say:hi lua!

<span class="nv">$ </span>/usr/local/lua5.1.5/bin/lua <span class="nt">-e</span> <span class="s2">"require 'call_function'; ret = call_function.common_entry('echo','lua is cool'); print(ret)"</span>
ret:1 is:lua is cool
lua is cool
</code></pre></div></div> <h2 id="三-函数说明">三 函数说明</h2> <h3 id="1-lual_error">1. <code class="highlighter-rouge">luaL_error</code>
</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">luaL_error</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
</code></pre></div></div> <p>触发错误，并使用 <code class="highlighter-rouge">fmt</code> 与后续参数格式化输出错误消息字符串。<code class="highlighter-rouge">luaL_error</code> 函数并不会退出，通常的是否用法为：</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</code></pre></div></div> <h2 id="四-参考资料">四 参考资料</h2> <p>-<a href="https://www.lua.org/pil/25.2.html">programming in lua</a></p> <p>-<a href="https://www.lua.org/manual/5.1/manual.html#luaL_loadbuffer">lua 5.1 手册</a></p>