---
layout: post
title: Lua 正确处理可变参数  
tags: [lua文章]
categories: [topic]
---


                
                

				<p>为了在 Lua 里处理可变参数，我们可能会写下面这样的代码：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">args</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">({</span><span class="o">...</span><span class="p">})</span> <span class="k">then</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">{</span><span class="o">...</span><span class="p">}</span> <span class="k">do</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"empty var"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">args</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1">-- output:</span>
<span class="c1">-- 10</span>
<span class="c1">-- 20</span>
<span class="c1">-- 30</span>
</code></pre></div></div>

<p>咋一看，貌似没什么问题，但是当传入 <code class="highlighter-rouge">args(10, nil, 30)</code> 时，发现并不符合我们的预期：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- output:</span>
<span class="c1">-- 10</span>
</code></pre></div></div>

<p>原因就在于 <code class="highlighter-rouge">ipairs</code> 遍历的 table 必须是一个序列。序列的数字索引必须连续。table 中间包括 <code class="highlighter-rouge">nil</code>，这样的 table 就不是序列，例如：<code class="highlighter-rouge">a={10, nil, 30}</code> 它不是序列，因为它的数字索引是 1 3 不是连续的, 所以它不是序列。为了处理这个问题，就要引入 <code class="highlighter-rouge">select</code> 了。</p>

<p>调用 <code class="highlighter-rouge">select</code> 时，需要传入一个 selector 和变长参数。如果 selector 为数字 n, 那么 <code class="highlighter-rouge">select</code> 返回它的第 n 个可变实参，否则只能为字符串 #, 这样 <code class="highlighter-rouge">select</code> 会返回变长参数的总数。</p>

<p>增强后的函数为：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">args</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">({</span><span class="o">...</span><span class="p">})</span> <span class="k">then</span>
        <span class="c1">-- get the count of the params</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">select</span><span class="p">(</span><span class="s1">'#'</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">do</span>
            <span class="c1">-- select the param</span>
            <span class="kd">local</span> <span class="n">param</span> <span class="o">=</span> <span class="nb">select</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"empty var"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">args</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1">-- output:</span>
<span class="c1">-- 10</span>
<span class="c1">-- nil</span>
<span class="c1">-- 30</span>
</code></pre></div></div>





<p><strong>我个人认为 <code class="highlighter-rouge">pairs</code> 对 <code class="highlighter-rouge">nil</code> 的表达能力是极其有限的</strong>，比如这个用例：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">30</span><span class="p">}</span>

<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"in"</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"============="</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">select</span><span class="p">(</span><span class="s1">'#'</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">param</span> <span class="o">=</span> <span class="nb">select</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">unpack</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- output:</span>
<span class="c1">-- in	1	10</span>
<span class="c1">-- in	3	30</span>
<span class="c1">-- =============</span>
<span class="c1">-- 10</span>
<span class="c1">-- nil</span>
<span class="c1">-- 30</span>
</code></pre></div></div>

<p>可以看到 <code class="highlighter-rouge">pairs</code> 只遍历了两次，1 =&gt; 10、3 =&gt; 20 其并没有表现出 2 =&gt; nil ，虽然我们可以从结果来推断出这个结论，但是显然，在某些场景下我们更需要的是直接还原出这个结果来。这其实和 cjson 的稀松数组类似。</p>

<p>而使用 <code class="highlighter-rouge">select</code> 后，我们就可以直接看到期待的效果了。</p>


                <hr style="visibility: hidden;">