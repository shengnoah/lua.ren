---
layout: post
title: Lua远程调用的实现方法 
tags: [lua文章]
categories: [topic]
---
<p>游戏开发中，客户端、服务端之间的交互是很频繁的，尤其是逻辑玩法的实现，需要大量的交互。</p>

<p>如果所有的交互都按功能构建出不同的协议，这样即繁琐又不方便修改。</p>

<p>通过Lua，使用远程调用可以极大的方便客户端、服务器的通信。</p>

<p>在Lua中，通过C++告诉对方，我要调用哪个函数、传递哪些参数，来执行相关的功能。</p>

<p>这样就不用定义一大串协议，而只需定义一种：远程调用协议。</p>

<p>如果要对方执行相应的函数，需要传递以下信息：</p>
<ol>
  <li>函数名</li>
  <li>参数</li>
</ol>

<p>当C++获得函数名、参数后，就可以构建RPC数据包，实现远程调用了。</p>

<p><strong>本文讲述如何在C++中获得Lua远程调用的函数名、参数。</strong></p>

<hr/>

<p>例如，我想实现：</p>

<p>客户端登录的功能，我就可以在客户端调用位于服务端的loginreq函数。</p>

<p>具体的形式有如下两种：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">rpc</span><span class="p">(</span><span class="s2">&#34;loginreq&#34;</span><span class="p">,</span> <span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">)</span>
<span class="n">server</span><span class="p">.</span><span class="n">loginreq</span><span class="p">(</span><span class="s2">&#34;username&#34;</span><span class="p">,</span> <span class="s2">&#34;password&#34;</span><span class="p">)</span></code></pre></figure>

<p>第一种，是直接导出一个全局函数rpc，并将函数名作为第一个参数传递过去。</p>

<p>第二种，是导出一个全局table，以函数名作为key。</p>

<hr/>

<p>第一种实现比较简单：</p>

<p>直接导出全局函数，依次获取栈的值：函数名、参数列表。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[handler2] Call function &lt;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">funcname</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&gt; with &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; params:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">printstack</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">handler2</span><span class="p">);</span>
<span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;rpc&#34;</span><span class="p">);</span></code></pre></figure>

<hr/>

<p>第二种相对复杂一些：</p>

<p>导出全局table，设置metatable.__index处理table访问，Lua会将key作为第二个参数，传给__index（__index(table, key)），由此可以获得函数名。
将函数名存储到处理函数的upvalue中，以便后续使用。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">__index</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">funcname</span><span class="p">);</span>
	<span class="n">lua_pushcclosure</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">handler1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_upvalueindex</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[handler1] Call function &lt;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">funcname</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&gt; with &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; params:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">printstack</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>	<span class="c1">// server
</span>
<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>	<span class="c1">// metatable
</span><span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">__index</span><span class="p">);</span>
<span class="n">lua_setfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;__index&#34;</span><span class="p">);</span>

<span class="n">lua_setmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>

<span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;server&#34;</span><span class="p">);</span></code></pre></figure>

<hr/>

<p>完整代码如下：</p>

<p>test.cpp</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;iostream&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="cp">#include &#34;lua.hpp&#34;
</span>
<span class="kt">void</span> <span class="nf">printstack</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: (&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lua_typename</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;) &#34;</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LUA_TNIL</span><span class="p">:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;nil&#34;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LUA_TBOOLEAN</span><span class="p">:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">lua_toboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LUA_TNUMBER</span><span class="p">:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">lua_tonumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LUA_TSTRING</span><span class="p">:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LUA_TTABLE</span><span class="p">:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;table&#34;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;*&#34;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handler1</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">lua_upvalueindex</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[handler1] Call function &lt;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">funcname</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&gt; with &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; params:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">printstack</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handler2</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;[handler2] Call function &lt;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">funcname</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&gt; with &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; params:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">printstack</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__index</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">funcname</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">funcname</span><span class="p">);</span>
	<span class="n">lua_pushcclosure</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">handler1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">regluafuncs</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>	<span class="c1">// server
</span>
	<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>	<span class="c1">// metatable
</span>	<span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">__index</span><span class="p">);</span>
	<span class="n">lua_setfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;__index&#34;</span><span class="p">);</span>

	<span class="n">lua_setmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>
	
	<span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;server&#34;</span><span class="p">);</span>

	<span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">handler2</span><span class="p">);</span>
	<span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;rpc&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span>

	<span class="n">regluafuncs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">luaL_dofile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;test.lua&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>test.lua</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="n">server</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&#34;abc&#34;</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="p">},</span> <span class="k">function</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span>
<span class="n">rpc</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s2">&#34;abc&#34;</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="s2">&#34;hello&#34;</span><span class="p">},</span> <span class="k">function</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span></code></pre></figure>

<p>执行输出：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[handler1] Call function &lt;test&gt; with 7 params:
1: (nil) nil
2: (number) 1
3: (boolean) 1
4: (boolean) 0
5: (string) abc
6: (table) table
7: (function) *
[handler2] Call function &lt;test&gt; with 8 params:
1: (string) test
2: (nil) nil
3: (number) 1
4: (boolean) 1
5: (boolean) 0
6: (string) abc
7: (table) table
8: (function) *</code></pre></figure>