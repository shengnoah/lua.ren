---
layout: post
title: 在redis中使用Lua脚本 
tags: [lua文章]
categories: [topic]
---
<h2 id="脚本介绍"><a href="#脚本介绍" class="headerlink" title="脚本介绍"></a>脚本介绍</h2><p>Redis在2.6版本中推出了脚本功能,使用Lua语言(一种“卫星语言”,能够方便地嵌入到其他语言中使用)编写脚本传到Redis中执行。在Lua脚本中可以调用大部分的Redis命令,使用脚本的好处如下:<br/></p>
<ul>
<li><p>减少网络开销: 多个redis请求可以在一个脚本中一次发送一个请求,减少网络往返时延。</p>
</li>
<li><p>原子操作: Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入。编写脚本的<br/>过程中无需担心会出现竞态条件,也就无需使用事务。事务可以完成的所有功能都可以用脚本实现。</p>
</li>
<li><p>复用: 客户端发送的脚本会永久存储在Redis中,其他语言开发的项目可以复用之。</p>
</li>
</ul>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="1-访问频率限制"><a href="#1-访问频率限制" class="headerlink" title="1.访问频率限制"></a>1.访问频率限制</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">local</span> <span class="built_in">times</span> = redis.call(<span class="string">&#39;incr&#39;</span>,KEYS[1])</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="built_in">times</span> == 1 <span class="keyword">then</span> </div><div class="line"></div><div class="line">redis.call(<span class="string">&#39;expire&#39;</span>,KEYS[1],ARGV[1])</div><div class="line">end </div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="built_in">times</span> &gt; tonumber(ARGV[2]) <span class="keyword">then</span>	</div><div class="line"><span class="built_in">return</span> 0</div><div class="line">end </div><div class="line"></div><div class="line"><span class="built_in">return</span> 1	</div><div class="line"></div><div class="line"><span class="comment">#保存该脚本为test.lua,执行该脚本:</span></div><div class="line"></div><div class="line">redis-cli --eval /path/test.lua key1 , 10 2</div><div class="line"></div><div class="line"><span class="comment">#--eval参数是告诉redis-cli读取并运行后面的Lua脚本,/path/test.jua是脚本文件的路径,key1是要操作的键，在脚本中使用KEYS[1]获取,10和2是参数，在脚本中使用ARGV[1]和ARGV[2]获得值（每10秒最多访问3次),注意空格</span></div></pre></td></tr></tbody></table></figure>
<h3 id="2-java代码示例"><a href="#2-java代码示例" class="headerlink" title="2.java代码示例"></a>2.java代码示例</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//redis lua 脚本</span></div><div class="line"><span class="keyword">static</span> String luaScript = <span class="string">&#34;local timeValue = redis.call(&#39;get&#39;,KEYS[1]) if timeValue &lt; ARGV[1] then return  redis.call(&#39;mset&#39;,KEYS[1],ARGV[1],KEYS[2],ARGV[2]) end return nil&#34;</span>;</div><div class="line"></div><div class="line"><span class="comment">//执行脚本</span></div><div class="line">redisClient.executeLuaScript(luaScript,<span class="string">&#34;key1&#34;</span>, <span class="string">&#34;key2&#34;</span>, <span class="string">&#34;value1&#34;</span>, <span class="string">&#34;value2&#34;</span>);</div><div class="line"></div><div class="line"><span class="comment">//executeLuaScript方法:</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="params">(String script,String key1,String key2,String avg1,String avg2)</span> <span class="keyword">throws</span> Exception </span>{</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.execution(<span class="keyword">new</span> JedisResultTask() {</div><div class="line">            <span class="function"><span class="keyword">protected</span> Object <span class="title">doExecution</span><span class="params">(Jedis jedis)</span> </span>{</div><div class="line">                <span class="keyword">return</span> jedis.eval(script,<span class="number">2</span>,key1,key2,avg1,avg2);</div><div class="line">            }</div><div class="line">        });</div><div class="line">    }</div></pre></td></tr></tbody></table></figure>
<h3 id="3-解决抢红包高并发的问题"><a href="#3-解决抢红包高并发的问题" class="headerlink" title="3.解决抢红包高并发的问题"></a>3.解决抢红包高并发的问题</h3><blockquote>
<blockquote>
<blockquote>
<blockquote>
<p><a href="http://blog.csdn.net/hengyunabc/article/details/19433779/" target="_blank" rel="external noopener noreferrer">传送门</a></p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>