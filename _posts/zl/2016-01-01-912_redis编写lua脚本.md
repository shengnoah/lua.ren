---
layout: post
title: redis编写lua脚本 
tags: [lua文章]
categories: [topic]
---
<p>由于redis并没有类似mysql或者mongo的乐观锁机制，并发控制成了一个棘手的问题<br/>这块是可以用redis的watch来做，但是如果能实现乐观锁，那就非常方便了</p>
<h2 id="redis使用lua的基础语法"><a href="#redis使用lua的基础语法" class="headerlink" title="redis使用lua的基础语法"></a>redis使用lua的基础语法</h2><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">eval</span> <span class="string">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span> 2 key1 key2 first second</span><br/><span class="line">1) <span class="string">&#34;key1&#34;</span></span><br/><span class="line">2) <span class="string">&#34;key2&#34;</span></span><br/><span class="line">3) <span class="string">&#34;first&#34;</span></span><br/><span class="line">4) <span class="string">&#34;second&#34;</span></span><br/></pre></td></tr></tbody></table></figure>
<h2 id="lua可以调用的redis函数"><a href="#lua可以调用的redis函数" class="headerlink" title="lua可以调用的redis函数"></a>lua可以调用的redis函数</h2><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">redis.call()</span><br/><span class="line">redis.<span class="built_in">pcall</span>()</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h2><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> version = redis.call(<span class="string">&#34;INCR&#34;</span>, KEYS[<span class="number">2</span>])</span><br/><span class="line"><span class="keyword">if</span> version == <span class="number">1</span> <span class="keyword">then</span></span><br/><span class="line">    redis.call(<span class="string">&#34;EXPIRE&#34;</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">3</span>])</span><br/><span class="line"><span class="keyword">end</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> <span class="built_in">tostring</span>(version) ~= ARGV[<span class="number">2</span>] <span class="keyword">then</span></span><br/><span class="line">    <span class="keyword">return</span> {<span class="number">-1</span>, version}</span><br/><span class="line"><span class="keyword">end</span>;</span><br/><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&#34;SET&#34;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>])</span><br/></pre></td></tr></tbody></table></figure>
<p>运行方式：<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">redis-cli EVAL <span class="string">&#34;<span class="variable">$(cat ./helloWorld.lua)</span>&#34;</span> 3 mykey version1 expire 1 1 100</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h2 id="redis并发控制"><a href="#redis并发控制" class="headerlink" title="redis并发控制"></a>redis并发控制</h2><figure class="highlight go"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *RedisDB)</span> <span class="params">(key <span class="keyword">string</span>, val <span class="keyword">interface</span>{}, versionKey <span class="keyword">string</span>, versionVal <span class="keyword">int</span>, versionExpire <span class="keyword">int</span>)</span> <span class="params">(err error)</span></span> {</span><br/><span class="line">	<span class="keyword">if</span> versionExpire == <span class="number">0</span> {</span><br/><span class="line">		versionExpire = <span class="number">100</span></span><br/><span class="line">	}</span><br/><span class="line">	storeValue, err := db.getStoreValue(val)</span><br/><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br/><span class="line">		<span class="keyword">return</span></span><br/><span class="line">	}</span><br/><span class="line"></span><br/><span class="line">	conn := db.Option.Pool.Get()</span><br/><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br/><span class="line">	<span class="keyword">if</span> err = conn.Err(); err != <span class="literal">nil</span> {</span><br/><span class="line">		<span class="keyword">return</span> err</span><br/><span class="line">	}</span><br/><span class="line"></span><br/><span class="line">	script := <span class="string">`</span></span><br/><span class="line"><span class="string">local version = redis.call(&#34;INCR&#34;, KEYS[2])</span></span><br/><span class="line"><span class="string">if version == 1 then</span></span><br/><span class="line"><span class="string">    redis.call(&#34;EXPIRE&#34;, KEYS[2], ARGV[3])</span></span><br/><span class="line"><span class="string">end;</span></span><br/><span class="line"><span class="string"></span></span><br/><span class="line"><span class="string">if tostring(version) ~= ARGV[2] then</span></span><br/><span class="line"><span class="string">    return {-1, version}</span></span><br/><span class="line"><span class="string">end;</span></span><br/><span class="line"><span class="string">return redis.call(&#34;SET&#34;, KEYS[1], ARGV[1])</span></span><br/><span class="line"><span class="string">`</span></span><br/><span class="line">	getScript := redis.NewScript(<span class="number">3</span>, script)</span><br/><span class="line">	res, err := redis.String(getScript.Do(conn, key, versionKey, <span class="string">&#34;expire&#34;</span>, storeValue, versionVal, versionExpire))</span><br/><span class="line"></span><br/><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br/><span class="line">		utils.Error(err)</span><br/><span class="line">		<span class="keyword">return</span></span><br/><span class="line">	}</span><br/><span class="line">	<span class="keyword">if</span> res == <span class="string">&#34;-1&#34;</span> {</span><br/><span class="line">		<span class="comment">//err = ErrConflict</span></span><br/><span class="line">	}redis</span><br/><span class="line">	<span class="keyword">return</span></span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h2 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h2><p><a href="https://redisbook.readthedocs.io/en/latest/feature/scripting.html" target="_blank" rel="noopener noreferrer">Redis 命令参考 · lua 脚本</a></p>