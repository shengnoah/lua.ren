---
layout: post
title: lua与c++的交互 
tags: [lua文章]
categories: [topic]
---
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>Lua作为一个运行效率非常高的脚本语言,简单方便,如今很多游戏开发都会用到.今天研究下c++和lua是如何交互的~</p>

<h2 id="2-c-调用lua"><a href="#2-c-调用lua" class="headerlink" title="2.c++调用lua"></a>2.c++调用lua</h2><p>我是在macos上实验的,过程应该和linux上类似.使用的lua版本是5.3.0.</p>
<p>c++调用lua原理主要是通过Lua的堆栈,一方将传递的参数以及参数个数压入栈中,另一方则在栈中取出参数,并将返回值压入栈中,由另一方取出,实现交互.这个过程和c++和汇编(如nasm)的交互过程很像.</p>
<h3 id="i-添加依赖"><a href="#i-添加依赖" class="headerlink" title="(i).添加依赖"></a>(i).添加依赖</h3><p>将liblua.a添加到项目中:</p>
<p><img src="https://Nirvana1997.github.io//2018/08/22/lua与c-的交互/lib.png" alt="lib"/></p>
<p>设置search paths:</p>
<p>Header Search Paths设置为lua安装位置,用来搜索头文件.</p>
<p>Library Search Paths设置为项目存放.a库的目录.</p>
<p><img src="https://Nirvana1997.github.io//2018/08/22/lua与c-的交互/path.png" alt="lib"/></p>
<h3 id="ii-代码测试"><a href="#ii-代码测试" class="headerlink" title="(ii).代码测试"></a>(ii).代码测试</h3><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">extern</span> <span class="string">&#34;C&#34;</span> {</span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lua.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lualib.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lauxlib.h&#34;</span></span></span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="params">()</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    </span><br/><span class="line">    lua_State *L = luaL_newstate();</span><br/><span class="line">    <span class="comment">//2.入栈操作</span></span><br/><span class="line">    lua_pushstring(L, <span class="string">&#34;Hello World~&#34;</span>);</span><br/><span class="line">    <span class="comment">//3.取值操作</span></span><br/><span class="line">    <span class="keyword">if</span> (lua_isstring(L, <span class="number">1</span>)) { <span class="comment">//判断是否可以转为string</span></span><br/><span class="line">        <span class="built_in">cout</span> &lt;&lt; lua_tostring(L, <span class="number">1</span>) &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//转为string并返回</span></span><br/><span class="line">    }</span><br/><span class="line">    <span class="comment">//4.关闭state</span></span><br/><span class="line">    lua_close(L);</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="iii-运行代码"><a href="#iii-运行代码" class="headerlink" title="(iii).运行代码"></a>(iii).运行代码</h3><p>运行结果:</p>
<p><img src="https://Nirvana1997.github.io//2018/08/22/lua与c-的交互/run.png" alt="lib"/></p>
<h3 id="iv-求和代码"><a href="#iv-求和代码" class="headerlink" title="(iv).求和代码:"></a>(iv).求和代码:</h3><p>lua代码:</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sum</span><span class="params">(a, b)</span></span></span><br/><span class="line">  <span class="keyword">return</span> (a+b);</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<p>c++代码:</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">extern</span> <span class="string">&#34;C&#34;</span> {</span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lua.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lualib.h&#34;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&#34;lauxlib.h&#34;</span></span></span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="params">()</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="comment">//创建Lua状态</span></span><br/><span class="line">    lua_State *L = luaL_newstate();</span><br/><span class="line">    <span class="keyword">if</span> (L == <span class="literal">NULL</span>)</span><br/><span class="line">    {</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">    }</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment">//加载Lua文件</span></span><br/><span class="line">    <span class="keyword">int</span> bRet = luaL_loadfile(L, <span class="string">&#34;sum.lua&#34;</span>);</span><br/><span class="line">    <span class="keyword">if</span> (bRet)</span><br/><span class="line">    {</span><br/><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;load file error&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">    }</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment">//运行Lua文件</span></span><br/><span class="line">    bRet = lua_pcall(L, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br/><span class="line">    <span class="keyword">if</span> (bRet)</span><br/><span class="line">    {</span><br/><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&#34;pcall error&#34;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">    }</span><br/><span class="line">    <span class="comment">//读取函数</span></span><br/><span class="line">    lua_getglobal(L, <span class="string">&#34;Sum&#34;</span>);        <span class="comment">// 获取函数，压入栈中</span></span><br/><span class="line">    lua_pushinteger(L, <span class="number">10</span>);          <span class="comment">// 压入参数</span></span><br/><span class="line">    lua_pushinteger(L, <span class="number">8</span>);          <span class="comment">// 压入参数</span></span><br/><span class="line">    <span class="keyword">int</span> iRet = lua_pcall(L, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);<span class="comment">// 调用函数，调用完成以后，会将返回值压入栈中，第一个2表示参数个数，第二个1表示返回结果个数。</span></span><br/><span class="line">    <span class="keyword">if</span> (iRet)                       <span class="comment">// 调用出错</span></span><br/><span class="line">    {</span><br/><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *pErrorMsg = lua_tostring(L, <span class="number">-1</span>);</span><br/><span class="line">        <span class="built_in">cout</span> &lt;&lt; pErrorMsg &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">        lua_close(L);</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">    }</span><br/><span class="line">    <span class="keyword">if</span> (lua_isinteger(L, <span class="number">-1</span>))        <span class="comment">//取值输出</span></span><br/><span class="line">    {</span><br/><span class="line">        <span class="keyword">int</span> sum = lua_tointeger(L, <span class="number">-1</span>);</span><br/><span class="line">        <span class="built_in">cout</span> &lt;&lt; sum &lt;&lt; <span class="built_in">endl</span>;</span><br/><span class="line">    }</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment">//关闭state</span></span><br/><span class="line">    lua_close(L);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>结果:</p>
<p><img src="https://Nirvana1997.github.io//2018/08/22/lua与c-的交互/sum.png" alt="sum"/></p>
<h2 id="3-lua调用c"><a href="#3-lua调用c" class="headerlink" title="3.lua调用c++"></a>3.lua调用c++</h2><p>lua调用c++原理主要是将c++代码编译成.so动态库,然后在lua中用require引入,从而调用.通信还是通过lua栈来实现的.这里就不展开了.具体可以参考<a href="http://www.lua.org/manual/" target="_blank" rel="noopener noreferrer">lua官方文档</a>,还有<a href="http://cloudwu.github.io/lua53doc/" target="_blank" rel="noopener noreferrer">lua5.3中文文档</a></p>
<h2 id="4-LuaTinker"><a href="#4-LuaTinker" class="headerlink" title="4.LuaTinker"></a>4.LuaTinker</h2><p>以上介绍的都是lua官方的提供给c的一些api,较为底层,其实有很多c++和lua代码的绑定库,将以上的栈操作以及函数注册等封装了起来,如LuaBind,LuaTinker等,我们的项目中使用的就是LuaTinker.LuaTinker使用方法可以在<a href="https://github.com/zupet/LuaTinker" target="_blank" rel="noopener noreferrer">git仓库</a>中查看.</p>