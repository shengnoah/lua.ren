---
layout: post
title: OpenResty中使用Lua的MongoDB库，使用连接池节省连接认证时间 
tags: [lua文章]
categories: [topic]
---
<p>因为服务器的mongodb开启了auth认证的，所以每次连接都要验证密码，测试了下GitHub上面的几个lua的mongodb库，无论是官方的<a href="https://github.com/mongodb-labs/mongorover" title="mongorover" target="_blank" rel="external noopener noreferrer">mongorover</a>，还是纯的lua库：<a href="https://github.com/LuaDist2/lua-resty-mongol3" title="lua-resty-mongol3" target="_blank" rel="external noopener noreferrer">lua-resty-mongol3</a>，一个简单的insert操作都比php耗费的时间更长，如果业务用lua来做的优势就没有那么明显了，单纯的不认证的insert操作lua的优势很是明显的，所以要么取消认证，要么就是可以结合openresty的连接池。而且发现使用连接池后，纯的lua mongodb库竟然比mongorover更快。<br/><br/>下面是动态判断该连接是否是连接池里面的一些判断，把连接与认证封装在一起,减少不必要认证次数。同时修改了仓库的源码，以支持支持自定义连接池，这样可以让不同 用户名、密码、数据库 的连接分开，不相互干扰。</p>
<p>新建一个lua文件，只做连接操作。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">local mongo = require &#34;resty.mongol&#34;</div><div class="line">local _M = {}</div><div class="line"></div><div class="line">--把连接与认证封装在一起,减少不必要认证次数</div><div class="line">local function connect(config)</div><div class="line">    local db = mongo:new()</div><div class="line">    if not db then</div><div class="line">        return nil,nil, &#34;db not initialized&#34;</div><div class="line">    end</div><div class="line">    if config.host == nil or config.host == &#39;&#39; or config.port == nil or config.port == &#39;&#39; or config.database == nil or config.database == &#39;&#39; then</div><div class="line">        return nil,nil, &#34;host,port,database can&#39;t empty&#34;</div><div class="line">    end</div><div class="line">    local user = config.user</div><div class="line">    if(user == nil or user == &#39;&#39;) then</div><div class="line">	user = &#39;&#39;</div><div class="line">    end</div><div class="line">    --支持自定义连接池，这样可以让不同 用户名、密码、数据库 的连接分开，不相互干扰，mongol库本身是没有实现的，所以修改了源码</div><div class="line">    local pool = user .. &#34;:&#34; .. config.database .. &#34;:&#34; .. config.host .. &#34;:&#34; .. config.port</div><div class="line">    local ok, err = db:connect(config.host, config.port, {pool = pool}) </div><div class="line">    if not ok then</div><div class="line">	return nil,nil,err</div><div class="line">    end</div><div class="line">    --选择数据库</div><div class="line">    local select_db = db:new_db_handle(config.database)</div><div class="line">    --获取连接池里面的已经auth过连接的数量</div><div class="line">    local times,err =db:get_reused_times()</div><div class="line">    if((times == 0 or times == nil) and #user &gt; 0) then</div><div class="line">	 ok,err = select_db:auth_scram_sha1(config.user,config.password)</div><div class="line">	if not ok then</div><div class="line">		return nil,nil,err</div><div class="line">     	end</div><div class="line">    end</div><div class="line">    return db,select_db,nil</div><div class="line">end</div><div class="line"></div><div class="line">return _M</div></pre></td></tr></tbody></table></figure>