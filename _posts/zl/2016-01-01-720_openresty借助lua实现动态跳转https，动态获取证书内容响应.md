---
layout: post
title: openresty借助lua实现动态跳转https，动态获取证书内容响应 
tags: [lua文章]
categories: [topic]
---
<hr/>
<p>内容描述:<br/>  借助openresty通过lua代码实现动态跳转https，并动态获取证书</p>
<hr/>

<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/></pre></td><td class="code"><pre><span class="line">server {</span><br/><span class="line">    listen 80;</span><br/><span class="line">    </span><br/><span class="line">    rewrite_by_lua <span class="string">&#39;rewrite_https(&#34;site&#34;)&#39;</span>;</span><br/><span class="line">    include /usr/<span class="built_in">local</span>/openresty/nginx/conf/gb/site/facadehost_common.conf;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">server {</span><br/><span class="line">    listen 443 ssl;</span><br/><span class="line">    ssl on;</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment"># ssl_certificate ssl_certificate_key用于满足Nginx配置的占位符</span></span><br/><span class="line">    ssl_certificate /usr/<span class="built_in">local</span>/openresty/nginx/conf/ssl/nginx.pem;</span><br/><span class="line">    ssl_certificate_key /usr/<span class="built_in">local</span>/openresty/nginx/conf/ssl/nginx.key.pem;</span><br/><span class="line">    </span><br/><span class="line">    <span class="comment"># 通过ssl_certificate_by_lua_file动态读取证书内容</span></span><br/><span class="line">    ssl_certificate_by_lua_file /usr/<span class="built_in">local</span>/openresty/nginx/script/lua/dynamicssl.lua;</span><br/><span class="line"></span><br/><span class="line">    include /usr/<span class="built_in">local</span>/openresty/nginx/conf/site/facadehost_common.conf; <span class="comment"># location的存放文件</span></span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>以上的配置文件，客户访问80端口，通过rewrite_by_lua 读取rewrite_https函数方法，满足条件跳转https,  rewrite_https函数 定义在init.lua文件中，通过在http区域加载初始化lua代码导入<br/>这块不理解的可以看openresty处理请求的流程图</p>
<p><a href="https://moonbingbing.gitbooks.io/openresty-best-practices/ngx_lua/phase.html?q=" target="_blank" rel="noopener noreferrer">openresty执行阶段概念</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">http {</span><br/><span class="line">    include       mime.types;</span><br/><span class="line">    lua_package_path <span class="string">&#34;/usr/local/openresty/nginx/script/lua/?.lua;;&#34;</span>;</span><br/><span class="line">    init_by_lua_file /usr/<span class="built_in">local</span>/openresty/nginx/script/lua/init.lua;</span><br/><span class="line"></span><br/><span class="line">    lua_shared_dict lua_cache 128m;</span><br/><span class="line">    ......</span><br/></pre></td></tr></tbody></table></figure>
<p>init.lua<br/></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/></pre></td><td class="code"><pre><span class="line">-- 是否强制https</span><br/><span class="line"><span class="keyword">function</span> is_force_ssl(stype)</span><br/><span class="line">    <span class="built_in">local</span> value = get_env_var(stype, <span class="string">&#39;is_force_ssl&#39;</span>) <span class="comment"># 通过get_env_var函数读取json文件，判断is_force_ssl的值对应什么(通过json文件灵活配置是否跳转https)</span></span><br/><span class="line">    <span class="keyword">if</span> value == nil <span class="keyword">then</span></span><br/><span class="line">        value = <span class="string">&#39;false&#39;</span></span><br/><span class="line">    end</span><br/><span class="line">    <span class="built_in">return</span> value</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line">--检查当前访问的域名是否有对应的ssl证书，用于是否强制跳转https的判断</span><br/><span class="line"><span class="keyword">function</span> is_have_ssl()</span><br/><span class="line">    <span class="built_in">local</span> server_name = ngx.var.host</span><br/><span class="line">    <span class="built_in">local</span> is_have_ssl = <span class="string">&#39;true&#39;</span></span><br/><span class="line">    <span class="keyword">if</span> server_name ~= nil <span class="keyword">then</span></span><br/><span class="line">        server_name = string.gsub(server_name, <span class="string">&#34;^www%.&#34;</span>, <span class="string">&#34;&#34;</span>) <span class="comment"># www和顶级域名公用一份证书文件</span></span><br/><span class="line">        <span class="built_in">local</span> file = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/ssl/&#34;</span> .. server_name .. <span class="string">&#34;.pem&#34;</span>)</span><br/><span class="line">        <span class="keyword">if</span> file == nil <span class="keyword">then</span></span><br/><span class="line">            file = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/letsencrypt/ssl/&#34;</span> .. server_name .. <span class="string">&#34;/fullchain1.pem&#34;</span>)</span><br/><span class="line">            <span class="keyword">if</span> file == nil <span class="keyword">then</span></span><br/><span class="line">                is_have_ssl = <span class="string">&#39;false&#39;</span></span><br/><span class="line">            <span class="keyword">else</span></span><br/><span class="line">                file.close()</span><br/><span class="line">            end</span><br/><span class="line">        <span class="keyword">else</span></span><br/><span class="line">            file:close()</span><br/><span class="line">        end</span><br/><span class="line">    end</span><br/><span class="line">    <span class="built_in">return</span> is_have_ssl</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">function</span> rewrite_https(stype)</span><br/><span class="line">    -- 有证书也不跳https, 直接返回</span><br/><span class="line">    -- 可以写不跳转https的逻辑代码，直接<span class="built_in">return</span>返回</span><br/><span class="line"></span><br/><span class="line">    -- a)配置跳转 b)有证书  满足a并b 才会进行跳转</span><br/><span class="line">    <span class="built_in">local</span> is_force_ssl  = is_force_ssl(stype)</span><br/><span class="line">    <span class="built_in">local</span> is_have_ssl   = is_have_ssl()</span><br/><span class="line">    <span class="keyword">if</span> is_force_ssl == <span class="string">&#34;true&#34;</span> and is_have_ssl == <span class="string">&#39;true&#39;</span> <span class="keyword">then</span></span><br/><span class="line">        <span class="built_in">local</span> httpsPort = <span class="string">&#34;&#34;</span></span><br/><span class="line">        <span class="keyword">if</span> ngx.var.server_port == <span class="string">&#34;8787&#34;</span> <span class="keyword">then</span>  <span class="comment"># 自定义的8787端口，然后跳转https的8989端口</span></span><br/><span class="line">            <span class="built_in">local</span> _uri = ngx.var.uri</span><br/><span class="line">            <span class="keyword">if</span> string.match(_uri, <span class="string">&#34;/rcenter/&#34;</span>) or string.start(_uri, <span class="string">&#34;/fserver/&#34;</span>) or string.start(_uri, <span class="string">&#34;/ftl/&#34;</span>) or string.start(_uri, <span class="string">&#34;/__purge/&#34;</span>) <span class="keyword">then</span> <span class="comment">#url符合这些的也不跳https</span></span><br/><span class="line">                <span class="built_in">return</span>   <span class="comment">#直接返回，不往下继续走了</span></span><br/><span class="line">            end</span><br/><span class="line">            httpsPort = <span class="string">&#34;:8989&#34;</span>   <span class="comment"># 8787访问跳转https8989</span></span><br/><span class="line">        elseif ngx.var.server_port == <span class="string">&#34;8383&#34;</span> <span class="keyword">then</span></span><br/><span class="line">            httpsPort = <span class="string">&#34;:8585&#34;</span>  <span class="comment"># 8383跳转8585</span></span><br/><span class="line">        end</span><br/><span class="line">        <span class="built_in">local</span> _host = ngx.var.host</span><br/><span class="line">        <span class="built_in">local</span> _request_uri = ngx.var.request_uri</span><br/><span class="line">        <span class="built_in">return</span> ngx.redirect(<span class="string">&#39;https://&#39;</span>.._host..httpsPort.._request_uri, <span class="string">&#39;301&#39;</span>)</span><br/><span class="line">    <span class="keyword">else</span></span><br/><span class="line">        <span class="built_in">return</span></span><br/><span class="line">    end</span><br/><span class="line">end</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>上面的lua代码，是判断满足条件跳转https，下面的代码描述动态获取证书</p>
<p>dynamicssl.lua<br/></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> ssl = require <span class="string">&#34;ngx.ssl&#34;</span></span><br/><span class="line">ssl.clear_certs()</span><br/><span class="line"><span class="built_in">local</span> server_name = ssl.server_name()</span><br/><span class="line"><span class="keyword">if</span> server_name ~= nil <span class="keyword">then</span></span><br/><span class="line">    server_name = string.gsub(server_name,<span class="string">&#34;^www%.&#34;</span>,<span class="string">&#34;&#34;</span>)</span><br/><span class="line">    <span class="built_in">local</span> file = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/ssl/&#34;</span> .. server_name ..<span class="string">&#34;.pem&#34;</span>)</span><br/><span class="line">    <span class="keyword">if</span> file == nil <span class="keyword">then</span></span><br/><span class="line">        file = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/letsencrypt/ssl/&#34;</span> .. server_name ..<span class="string">&#34;/fullchain1.pem&#34;</span>)</span><br/><span class="line">        <span class="keyword">if</span> file == nil <span class="keyword">then</span></span><br/><span class="line">            file = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/ssl/nginx.pem&#34;</span>)</span><br/><span class="line">        end</span><br/><span class="line">    end</span><br/><span class="line">    <span class="built_in">local</span> f = assert(file)</span><br/><span class="line">    <span class="built_in">local</span> pem_cert_chain = f:<span class="built_in">read</span>(<span class="string">&#34;*a&#34;</span>)</span><br/><span class="line">    <span class="built_in">local</span> der_cert_chain, err = ssl.cert_pem_to_der(pem_cert_chain)</span><br/><span class="line">    ssl.set_der_cert(der_cert_chain)</span><br/><span class="line">    f:close()</span><br/><span class="line">    </span><br/><span class="line">    <span class="built_in">local</span> kfile = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/ssl/&#34;</span> .. server_name ..<span class="string">&#34;.key.pem&#34;</span>)</span><br/><span class="line">    <span class="keyword">if</span> kfile == nil <span class="keyword">then</span></span><br/><span class="line">        kfile = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/letsencrypt/ssl/&#34;</span> .. server_name ..<span class="string">&#34;/privkey1.pem&#34;</span>)</span><br/><span class="line">        <span class="keyword">if</span> kfile == nil <span class="keyword">then</span></span><br/><span class="line">            kfile = io.open(<span class="string">&#34;/usr/local/openresty/nginx/conf/ssl/nginx.key.pem&#34;</span>)</span><br/><span class="line">        end</span><br/><span class="line">    end</span><br/><span class="line">    <span class="built_in">local</span> k = assert(kfile)</span><br/><span class="line">    <span class="built_in">local</span> pem_priv_key = k:<span class="built_in">read</span>(<span class="string">&#34;*a&#34;</span>)</span><br/><span class="line">    <span class="built_in">local</span> der_priv_key, err = ssl.priv_key_pem_to_der(pem_priv_key)</span><br/><span class="line">    ssl.set_der_priv_key(der_priv_key)</span><br/><span class="line">    k:close()</span><br/><span class="line">end</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>读取证书内容，判断合法，继续匹配location，完成后续请求.</p>