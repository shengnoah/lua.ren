---
layout: post
title: lua 
tags: [lua文章]
categories: [topic]
---
<h3 id="介绍">介绍</h3>

<hr/>

<ol>
<li>Lua 是一个小巧的脚本语言。<code>openresty采用的是LuaJIT 2 ，而不是标准的lua</code>。</li>
<li>解释下什么是jit

<ul>
<li>LuaJIT 的运行时环境包括一个用手写汇编实现的 Lua 解释器和一个可以直接生成机器代码的 JIT 编译器。
Lua 代码在被执行之前总是会先被 lfn 成 LuaJIT 自己定义的字节码（Byte Code）。关于 LuaJIT 字节码的文档，可以参见：<a href="http://wiki.luajit.org/Bytecode-2.0（这个文档描述的是">http://wiki.luajit.org/Bytecode-2.0（这个文档描述的是</a> LuaJIT 2.0 的字节码，不过 2.1 里面的变化并不算太大）。
一开始的时候，Lua 字节码总是被 LuaJIT 的解释器解释执行。LuaJIT 的解释器会在执行字节码时同时记录一些运行时的统计信息，比如每个 Lua 函数调用入口的实际运行次数，还有每个 Lua 循环的实际执行次数。当这些次数超过某个预设的阈值时，便认为对应的 Lua 函数入口或者对应的 Lua 循环足够的“热”，这时便会触发 JIT 编译器开始工作。
JIT 编译器会从热函数的入口或者热循环的某个位置开始尝试编译对应的 Lua 代码路径。编译的过程是把 LuaJIT 字节码先转换成 LuaJIT 自己定义的中间码（IR），然后再生成针对目标体系结构的机器码（比如 x86_64 指令组成的机器码）。</li>
<li>当然jit并不是支持所有的原语，所有对性能要求很高的情况下，应该尽量使用jit支持的原语。
<br/>
<br/></li>
</ul></li>
</ol>

<h3 id="环境搭建">环境搭建</h3>

<hr/>

<ol>
<li>按照官网的搭建方式即可 <br/>

<ul>
<li>eg: mac 上环境搭建 <br/>
tar zxf LuaJIT-2.0.5.tar.gz <br/>
cd LuaJIT-2.0.5<br/>
make <br/>
make install<br/>
<br/></li>
</ul></li>
</ol>

<h3 id="数据类型">数据类型</h3>

<hr/>

<ol>
<li>nil、boolean、 number、string、table、function<br/>

<ul>
<li>lua将nil表示为<code>无效值</code> ，一个变量在第一次赋值前默认为nil,将 nil 赋予给一个全局变量就等同于删除它。</li>
<li>Lua 中 nil 和 false 为“假”，其它所有值均为“真”。比如 0 和空字符串就是“真”</li>
<li>一般地，Lua 的 number 类型就是用双精度浮点数来实现的。值得一提的是，LuaJIT 支持所谓的“dual-number”（双数）模式，即 LuaJIT 会根据上下文用整型来存储整数，而用双精度浮点数来存放浮点数</li>
<li>三种写法： 单引号、双引号、长括号（[[]]）</li>
<li>Table 类型实现了一种抽象的“关联数组”。“关联数组”是一种具有特殊索引方式的数组，索引通常是字符串（string）或者 number 类型，但也可以是除 nil 以外的任意类型的值。</li>
<li>在 Lua 中，函数 也是一种数据类型，函数可以存储在变量中，可以通过参数传递给其他函数，还可以作为其他函数的返回值。<br/></li>
</ul></li>
</ol>

<h3 id="表达式-着重说下不一样">表达式（着重说下不一样）</h3>

<hr/>

<ol>
<li>算术运算符

<ul>
<li>print(5.0 / 10)    –&gt;打印 0.5。 <code>浮点数相除的结果是浮点数</code></li>
</ul></li>

<li><p>关系运算符</p>

<ul>
<li>~= 不等于
<br/></li>
</ul></li>

<li><p>逻辑运算符</p>

<ul>
<li>and 逻辑与</li>
<li>or 逻辑或</li>
<li>not 逻辑非</li>
</ul></li>
</ol>

<h3 id="控制结构">控制结构</h3>

<hr/>

<h5 id="分支结构-elseif">分支结构 （<code>elseif</code>）</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">if x &gt; 0 then
    print(&#34;x is a positive number&#34;)
end</pre></td></tr></tbody></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">if x &gt; 0 then
    print(&#34;x is a positive number&#34;)
else
    print(&#34;x is a non-positive number&#34;)
end</pre></td></tr></tbody></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">if score == 100 then
    print(&#34;Very good!Your score is 100&#34;)
elseif score &gt;= 60 then
    print(&#34;Congratulations, you have passed it,your score greater or equal to 60&#34;)
--此处可以添加多个elseif
else
    print(&#34;Sorry, you do not pass the exam! &#34;)
end</pre></td></tr></tbody></table>
</div>
</div>
<h5 id="循环结构-没有提供-continue-却也提供了另外一个标准控制语句-break">循环结构（<code>没有提供 continue，却也提供了另外一个标准控制语句 break</code>）</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">while 表达式 do
--body
end</pre></td></tr></tbody></table>
</div>
</div>
<ul>
<li><p>直到 until 的条件为真时才结束</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">x = 10
repeat
print(x)
until false</pre></td></tr></tbody></table>
</div>
</div></li>

<li><p>for 数字型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">for var = begin, finish, step do
--body
end</pre></td></tr></tbody></table>
</div>
</div></li>

<li><p>for 泛型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">只能遍历数组
local a = {&#34;a&#34;, &#34;b&#34;, &#34;c&#34;, &#34;d&#34;}
for i, v in ipairs(a) do
print(&#34;index:&#34;, i, &#34; value:&#34;, v)
end</pre></td></tr></tbody></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">遍历 k、v
for k,v in pairs(revDays) do
print(&#34;k:&#34;, k, &#34; v:&#34;, v)
end</pre></td></tr></tbody></table>
</div>
</div></li>

<li><p><code>ipairs() 内建函数是可以被 JIT 编译的，而 pairs() 则只能被解释执行</code></p></li>
</ul>