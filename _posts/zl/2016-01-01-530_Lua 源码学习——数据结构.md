---
layout: post
title: Lua 源码学习——数据结构 
tags: [lua文章]
categories: [topic]
---
<ul id="markdown-toc">
  <li><a href="#数据结构简介" id="markdown-toc-数据结构简介">数据结构简介</a></li>
  <li><a href="#字符串" id="markdown-toc-字符串">字符串</a></li>
</ul>

<h2 id="数据结构简介">数据结构简介</h2>

<p>Lua 中支持的数据结构包括：</p>

<table>
  <thead>
    <tr>
      <th>宏</th>
      <th>类型</th>
      <th>对应数据结构</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LUA_TNONE</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>LUA_TNIL</td>
      <td>nil</td>
      <td> </td>
    </tr>
    <tr>
      <td>LUA_TBOOLEAN</td>
      <td>boolean</td>
      <td>int</td>
    </tr>
    <tr>
      <td>LUA_TLIGHTUSERDATA</td>
      <td>pointer</td>
      <td>void *</td>
    </tr>
    <tr>
      <td>LUA_TNUMBER</td>
      <td>number</td>
      <td>lua_Number</td>
    </tr>
    <tr>
      <td>LUA_TSTRING</td>
      <td>string</td>
      <td>TString</td>
    </tr>
    <tr>
      <td>LUA_TTABLE</td>
      <td>table</td>
      <td>Table</td>
    </tr>
    <tr>
      <td>LUA_TFUNCTION</td>
      <td>function</td>
      <td>CClosure, LClosure</td>
    </tr>
    <tr>
      <td>LUA_TUSERDATA</td>
      <td>pointer</td>
      <td>void *</td>
    </tr>
    <tr>
      <td>LUA_TTHREAD</td>
      <td>lua vm, thread</td>
      <td>lua_State</td>
    </tr>
  </tbody>
</table>

<p>注意：</p>
<ul>
  <li>LUA_TLIGHTUSERDATA 与 LUA_TUSERDATA 都是 void * 指针，它们的区别是，前者的分配释放由 Lua 外部的使用者负责、后者的分配释放由 Lua 内部完成；</li>
  <li>LUA_TSTRING 及以后的类型，需要进行 GC 操作；</li>
</ul>

<p>之前已经多次说过，Lua 使用联合体 lua_TValue 来同时表示上述类型的数据。其定义类似于：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">union</span> <span class="n">GCObject</span> <span class="p">{</span>
    <span class="n">GCheader</span> <span class="n">gch</span><span class="p">;</span>
    <span class="k">union</span> <span class="n">TString</span> <span class="n">ts</span><span class="p">;</span>       <span class="c1">// string
</span>    <span class="k">union</span> <span class="n">Udata</span> <span class="n">u</span><span class="p">;</span>          <span class="c1">// userdata
</span>    <span class="k">union</span> <span class="n">Closure</span> <span class="n">cl</span><span class="p">;</span>       <span class="c1">// function
</span>    <span class="k">struct</span> <span class="n">Table</span> <span class="n">h</span><span class="p">;</span>         <span class="c1">// table
</span>    <span class="k">struct</span> <span class="n">Proto</span> <span class="n">p</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">UpVal</span> <span class="n">uv</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">lua_state</span> <span class="n">th</span><span class="p">;</span>    <span class="c1">// thread
</span><span class="p">};</span>

<span class="k">union</span> <span class="n">Value</span> <span class="p">{</span>
    <span class="n">GCObject</span><span class="o">*</span> <span class="n">gc</span><span class="p">;</span>   <span class="c1">// 所有可 GC 的数据，包括 string, table, function, userdata, thread
</span>    <span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>        <span class="c1">// light userdata
</span>    <span class="n">lua_Number</span> <span class="n">n</span><span class="p">;</span>   <span class="c1">// number
</span>    <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>          <span class="c1">// boolean
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">lua_TValue</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">tt</span><span class="p">;</span>         <span class="c1">// 数据类型
</span>    <span class="n">Value</span> <span class="n">value</span><span class="p">;</span>    <span class="c1">// 数据
</span><span class="p">};</span>
</code></pre></div></div>

<h2 id="字符串">字符串</h2>

<p>正如之前所了解的，Lua 中的字符串是一个不可变的数据。事实上，Lua 虚拟机存在一块全局的数据区，用来存放此虚拟机中的所有字符串。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
** String headers for string table
*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">TString</span> <span class="p">{</span>
  <span class="n">L_Umaxalign</span> <span class="n">dummy</span><span class="p">;</span>  <span class="cm">/* ensures maximum alignment for strings */</span>
  <span class="k">struct</span> <span class="p">{</span>
    <span class="n">CommonHeader</span><span class="p">;</span>
    <span class="n">lu_byte</span> <span class="n">reserved</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hash</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">tsv</span><span class="p">;</span>
<span class="p">}</span> <span class="n">TString</span><span class="p">;</span>
</code></pre></div></div>