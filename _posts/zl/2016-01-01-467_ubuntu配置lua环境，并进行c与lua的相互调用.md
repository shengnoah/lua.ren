---
layout: post
title: ubuntu配置lua环境，并进行c与lua的相互调用 
tags: [lua文章]
categories: [topic]
---
<p>先查看一下apt可获取的lua版本<br/><img src="http://arrayindex.me//2018/08/29/ubuntu配置lua环境，并进行c与lua的相互调用/1.png" alt=""/><br/><br/>我们选择lua5.1版本进行安装<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">sudo apt install lua5.1</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>安装完之后测试一下是否安装成功，如果可以正常使用，则lua环境已经安装完毕。<br/><img src="http://arrayindex.me//2018/08/29/ubuntu配置lua环境，并进行c与lua的相互调用/2.png" alt=""/></p>
<h1 id="2-安装lua相关的c库"><a href="#2-安装lua相关的c库" class="headerlink" title="2.安装lua相关的c库"></a>2.安装lua相关的c库</h1><p>lua环境安装完毕，但是此时在c中还不能对lua进行调用，或者生成供lua调用的c库，因为还没有安装lua的c库，通过下面这条命令安装相应的库文件和头文件<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">sudo apt-get install lua5.1-0-dev</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>安装完毕后，我们写代码进行测试</p>
<h2 id="2-1生成c的动态库供lua调用"><a href="#2-1生成c的动态库供lua调用" class="headerlink" title="2.1生成c的动态库供lua调用"></a>2.1生成c的动态库供lua调用</h2><p>新建一个c文件<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">vim addlib.c</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>写一个addc函数供lua调用<br/></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua5.1/lualib.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua5.1/lauxlib.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="keyword">int</span> a,b,c;</span><br/><span class="line">    a = lua_tonumber(L,<span class="number">1</span>);</span><br/><span class="line">    b = lua_tonumber(L,<span class="number">2</span>);</span><br/><span class="line">    c = a + b;</span><br/><span class="line">    lua_pushnumber(L,c);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">lib</span>[] =</span></span><br/><span class="line"><span class="class">{</span></span><br/><span class="line">    </span><br/><span class="line">    {<span class="string">&#34;addc&#34;</span>,addc},</span><br/><span class="line">    {<span class="literal">NULL</span>,<span class="literal">NULL</span>}</span><br/><span class="line">};</span><br/><span class="line"><span class="comment">//luaopen_xxx  这个xxx一定要和导出的库名一样，不然lua无法识别这个函数，无法进行函数的注册 </span></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_addlib</span><span class="params">(lua_State *L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="comment">//这里的&#34;testadd&#34;是在lua中调用库函数的全局变量名，不需要和库名addlib保持一致,但一般会用一样的名字</span></span><br/><span class="line">    luaL_register(L,<span class="string">&#34;testadd&#34;</span>,lib);</span><br/><span class="line">    <span class="comment">//luaL_register(L,&#34;addlib&#34;,lib);</span></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>保存后对代码进行编译，生成lua用的so或dll库<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">gcc addlib.c -fPIC -shared -o addlib.so</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p><img src="http://arrayindex.me//2018/08/29/ubuntu配置lua环境，并进行c与lua的相互调用/4.png" alt=""/><br/>接下来进行lua对c调用的测试<br/><img src="http://arrayindex.me//2018/08/29/ubuntu配置lua环境，并进行c与lua的相互调用/5.png" alt=""/><br/>调用成功</p>
<h2 id="2-2在c中调用lua"><a href="#2-2在c中调用lua" class="headerlink" title="2.2在c中调用lua"></a>2.2在c中调用lua</h2><p>创建printHello.lua文件<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">vim printHello.lua</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>写一个PrintHelloLua函数<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrintHelloLua</span><span class="params">()</span></span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;hello !!!&#34;</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>创建luaFunctionTest.c文件<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">vim luaFunctionTest.c</span><br/></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua5.1/lualib.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua5.1/lauxlib.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="comment">//创建lua运行环境</span></span><br/><span class="line">    lua_State *luaEnv = lua_open();</span><br/><span class="line">    luaopen_base(luaEnv);</span><br/><span class="line">    luaL_openlibs(luaEnv);</span><br/><span class="line">    <span class="keyword">if</span>(!luaEnv)</span><br/><span class="line">    {</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">//载入lua文件</span></span><br/><span class="line">    <span class="keyword">int</span> loadInfo = luaL_loadfile(luaEnv,<span class="string">&#34;printHello.lua&#34;</span>);</span><br/><span class="line">    <span class="keyword">if</span>(loadInfo)</span><br/><span class="line">    {</span><br/><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br/><span class="line">    }</span><br/><span class="line">    <span class="comment">//执行lua文件</span></span><br/><span class="line">    lua_pcall(luaEnv,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">//调用PrintHelloLua函数</span></span><br/><span class="line">    lua_getglobal(luaEnv,<span class="string">&#34;PrintHelloLua&#34;</span>);</span><br/><span class="line">    lua_pcall(luaEnv,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>生成可执行文件,需要通过 -llua5.1指明使用的库文件<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">gcc -o luaFunctionTest luaFunctionTest.c -llua5.1</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>运行可执行文件,成功输出 hello !!!<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">./luaFunctionTest</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p><img src="http://arrayindex.me//2018/08/29/ubuntu配置lua环境，并进行c与lua的相互调用/6.png" alt=""/></p>