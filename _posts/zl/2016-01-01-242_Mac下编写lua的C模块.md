---
layout: post
title: Mac下编写lua的C模块 
tags: [lua文章]
categories: [topic]
---

    <p>最近在研究lua下protobuf的使用，必然就会接触到了云风大侠的pbc，github上下了源码进行编译，发现想要把binding下面的测试代码运行起来，还是有一些坑点的。</p>

<p>在 <code class="highlighter-rouge">/binding/lua53</code> 目录下有 <code class="highlighter-rouge">Makefile</code> <code class="highlighter-rouge">pbc-lua53.c</code> <code class="highlighter-rouge">protobuf.lua</code> <code class="highlighter-rouge">test.lua</code>几个主要的文档。</p>

<p>调用的层次大概是：test.lua会 <code class="highlighter-rouge">require</code> <code class="highlighter-rouge">protobuf.lua</code> 文档，它是对 <code class="highlighter-rouge">pbc-lua53.c</code> 导出的C函数库的一个封装，因此 <code class="highlighter-rouge">protobuf.lua</code>是真正 <code class="highlighter-rouge">require</code> C函数库的。<code class="highlighter-rouge">Makefile</code> 复杂将<code class="highlighter-rouge">pbc-lua53.c</code> 编译成动态链接库。</p>

<p>但是要注意Linux和Mac上编译选项的差异，直接在命令行下 <code class="highlighter-rouge">make</code> 会报错:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Undefined symbols for architecture x86_64:
  "_luaL_buffinit", referenced from:
      __pattern_pack in pbc-lua53-57d6af.o
  "_luaL_checkinteger", referenced from:
  ...
</code></pre></div></div>

<p>看到<code class="highlighter-rouge">Undefined symbols</code>的第一反应是没有链接lua的静态库嘛，于是顺手就修改<code class="highlighter-rouge">Makefile</code>文档，指定lua库的链接:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$(CC) $(CFLAGS) -shared -o $@ -llua -I../.. -I$(LUADIR) -L../../build $^ -lpbc
</code></pre></div></div>

<p><code class="highlighter-rouge">make</code>一下，编译通过，运行<code class="highlighter-rouge">lua test.lua</code>却报错：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lua: multiple Lua VMs detected
stack traceback:
····
</code></pre></div></div>

<p>google一下，原因是我们编译protobuf.so动态链接库，静态链接了一次lua库，然后运行test.lua的时候，又动态链接了一次，导致<code class="highlighter-rouge">multiple Lua VMs detected</code> 。</p>

<p>正确的 <code class="highlighter-rouge">Makefile</code>修改方式，应该是：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C = gcc
CFLAGS = -O2 -fPIC -Wall -bundle -undefined dynamic_lookup
LUADIR = /usr/local/include
TARGET = protobuf.so

.PHONY : all clean

all : $(TARGET)

$(TARGET) : pbc-lua53.c
»···$(CC) $(CFLAGS) -o $@ -I../.. -I$(LUADIR) -L../../build $^ -lpbc

clean :
»···rm -f $(TARGET)
</code></pre></div></div>

<p>通过 <code class="highlighter-rouge">-bundle -undefined dynamic_lookup</code> 指定未找到的符号将在动态链接的时候，进行动态查找。同时删掉<code class="highlighter-rouge">-shared</code> 选项。</p>

<p><code class="highlighter-rouge">make</code>然后<code class="highlighter-rouge">lua test.lua</code>结果如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test/addressbook.proto
tutorial
Profile
	nick_name [1] LABEL_OPTIONAL
	icon [2] LABEL_OPTIONAL
Person
	name [1] LABEL_REQUIRED
	id [2] LABEL_REQUIRED
	email [3] LABEL_OPTIONAL
	phone [4] LABEL_REPEATED
	test [5] LABEL_REPEATED
	profile [6] LABEL_OPTIONAL
Ext
AddressBook
	person [1] LABEL_REPEATED
Alice
12345
	1301234567	HOME
	87654321	WORK
Alice	123	table: 0x7feff8600950
</code></pre></div></div>

<p>测试的case正常跑通！</p>