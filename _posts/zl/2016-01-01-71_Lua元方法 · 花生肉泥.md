---
layout: post
title: Lua元方法 · 花生肉泥 
tags: [lua文章]
categories: [topic]
---
<p>lua在创建新的table时不会创建元表，比如<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {}</span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(t))     </span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>我们是使用getmetatable来获取一个table或者userdata类型变量的元表，当创建新的table变量时，使用getmetatable去获得元表，将返回nil，同理可以用setmetatable去设置一个table或userdata类型变量的元表，代码如下：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {}</span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(t))     </span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> t1 = {}</span><br/><span class="line"><span class="built_in">setmetatable</span>(t,t1)</span><br/><span class="line"><span class="built_in">assert</span>(<span class="built_in">getmetatable</span>(t) == t1)</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>任何table都可以作为任何值的元表，而一组相关的table有可以<strong>共享一个通用的元表</strong>，此元表描述了他们共同行为，<strong>一个table甚至可以作为它自己的元表</strong>，用于描述其特有的行为，总之，任何搭配形式都是合法的。</p>
<p>在lua中，只能设置table元表，若要设置其他类型的元表，必须通过C代码完成，还存在一个特例，对于字符串，标准的字符串程序库为所有的字符串设置了一个元表，而其他类型在默认情况下都没有元表，例：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(<span class="string">&#34;Hello World&#34;</span>))     <span class="comment">--&gt;table:0062EA18</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(<span class="number">10</span>))     </span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>在table中，可以重新定义的元方法有以下几个:<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">__add</span>(a,b)     <span class="comment">-- 加法</span></span><br/><span class="line"><span class="built_in">__sub</span>(a,b)     <span class="comment">-- 减法</span></span><br/><span class="line"><span class="built_in">__mul</span>(a,b)     <span class="comment">-- 乘法</span></span><br/><span class="line"><span class="built_in">__div</span>(a,b)     <span class="comment">-- 除法</span></span><br/><span class="line"><span class="built_in">__mod</span>(a,b)     <span class="comment">-- 取模</span></span><br/><span class="line"><span class="built_in">__pow</span>(a,b)     <span class="comment">-- 乘幂</span></span><br/><span class="line"><span class="built_in">__unm</span>(a,b)     <span class="comment">-- 相反数</span></span><br/><span class="line"><span class="built_in">__concat</span>(a,b)     <span class="comment">-- 连接</span></span><br/><span class="line"><span class="built_in">__len</span>(a,b)     <span class="comment">-- 长度</span></span><br/><span class="line"><span class="built_in">__eq</span>(a,b)     <span class="comment">-- 相等</span></span><br/><span class="line"><span class="built_in">__lt</span>(a,b)     <span class="comment">-- 小于</span></span><br/><span class="line"><span class="built_in">__le</span>(a,b)     <span class="comment">-- 小于等于</span></span><br/><span class="line"><span class="built_in">__index</span>(a,b)     <span class="comment">-- 索引查询</span></span><br/><span class="line"><span class="built_in">__newindex</span>(a,b,c)     <span class="comment">-- 索引更新</span></span><br/><span class="line"><span class="built_in">__call</span>(a,...)     <span class="comment">-- 执行方法调用</span></span><br/><span class="line"><span class="built_in">__tostring</span>(a)     <span class="comment">-- 字符串输出</span></span><br/><span class="line"><span class="built_in">__metatable</span>     <span class="comment">-- 保护元表</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>算术类的元方法<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/></pre></td><td class="code"><pre><span class="line">Set = {}</span><br/><span class="line"><span class="keyword">local</span> mt = {}     <span class="comment">-- 集合的元素</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 根据参数列表中的值创建一个新集合</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(l)</span></span></span><br/><span class="line">     <span class="keyword">local</span> set = {}</span><br/><span class="line">     <span class="built_in">setmetatable</span>(set,mt)</span><br/><span class="line">     <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">pairs</span>(l) <span class="keyword">do</span></span><br/><span class="line">          set[v] = <span class="literal">true</span></span><br/><span class="line">     <span class="keyword">end</span></span><br/><span class="line">     <span class="keyword">return</span> set</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="comment">-- 并集操作</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.union</span><span class="params">(a, b)</span></span></span><br/><span class="line">    <span class="keyword">local</span> retSet = Set.new{} <span class="comment">-- 此处相当于Set.new({})</span></span><br/><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> retSet[v] = <span class="literal">true</span> <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">pairs</span>(b) <span class="keyword">do</span> retSet[v] = <span class="literal">true</span> <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> retSet</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 交集操作</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.intersection</span><span class="params">(a, b)</span></span></span><br/><span class="line">    <span class="keyword">local</span> retSet = Set.new{}</span><br/><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> retSet[v] = b[v] <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> retSet</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 打印集合的操作</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.toString</span><span class="params">(set)</span></span></span><br/><span class="line">     <span class="keyword">local</span> tb = {}</span><br/><span class="line">     <span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">pairs</span>(set) <span class="keyword">do</span></span><br/><span class="line">          tb[#tb + <span class="number">1</span>] = e</span><br/><span class="line">     <span class="keyword">end</span></span><br/><span class="line">     <span class="keyword">return</span> <span class="string">&#34;{&#34;</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(tb, <span class="string">&#34;, &#34;</span>) .. <span class="string">&#34;}&#34;</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.print</span><span class="params">(s)</span></span></span><br/><span class="line">     <span class="built_in">print</span>(Set.toString(s))</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>现在，定义一个“+”来计算两个集合的并集，那么就需要让所有用于表示集合的table共享一个元表，并且在该元表中定义如何执行一个加法操作，首先创建一个常规的table</p>