---
layout: post
title: Programming in Lua(Thrid Edition)笔记 
tags: [lua文章]
categories: [topic]
---
<h3 id="16-Object-oriented-Programming"><a href="#16-Object-oriented-Programming" class="headerlink" title="16 Object-oriented Programming"></a>16 Object-oriented Programming</h3>
<ul>
<li>对象和方法<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">Account = {</span><br/><span class="line">	balance = <span class="number">0</span>,</span><br/><span class="line">	withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(self, v)</span></span></span><br/><span class="line">		self.balance = self.balance - v</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">}</span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br/><span class="line">	self.balance = self.balance + v</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">Account.deposit(Account, <span class="number">200.00</span>)</span><br/><span class="line">Account:withdraw(<span class="number">100.00</span>)</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>在用冒号<code>:</code>而不是<code>.</code>创建或使用一个table的函数时，会自动生成或调用一个<code>self</code>指代table自身</p>
<ul>
<li>类，用<code>__index</code>来类的实例化<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span><span class="params">(o)</span></span></span><br/><span class="line">	o = o <span class="keyword">or</span> {} </span><br/><span class="line">	<span class="built_in">setmetatable</span>(o, self)</span><br/><span class="line">	self.<span class="built_in">__index</span> = self</span><br/><span class="line">	<span class="keyword">return</span> o</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">a = Account:new{balance = <span class="number">0</span>}</span><br/><span class="line"><span class="built_in">print</span>(a.balance) <span class="comment">--&gt; 0</span></span><br/><span class="line">a:deposit(<span class="number">100.00</span>)</span><br/><span class="line"><span class="built_in">print</span>(a.balance) <span class="comment">--&gt; 100</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>初次调用<code>a.balance = a.balance + v</code>，右侧的<code>balance</code>是类的默认值，右侧是对象的新域，之后再调用，右侧的<code>balance</code>为对象的域</p>
<ul>
<li><p>继承，子类可以在父类的基础上修改方法，修改后的方法是在子类自身的域</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/></pre></td><td class="code"><pre><span class="line">SpecialAccount = Account:new()</span><br/><span class="line">s = SpecialAccount:new{limit = <span class="number">1000.00</span>}</span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SpecialAccount:withdraw</span><span class="params">(v)</span></span></span><br/><span class="line">	<span class="keyword">if</span> v - self.balance &gt;= self:getLimit() <span class="keyword">then</span></span><br/><span class="line">		<span class="built_in">error</span><span class="string">&#34;insufficient funds&#34;</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	self.balance = self.balance - v</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SpecialAccount:getLimit</span><span class="params">()</span></span></span><br/><span class="line">	<span class="keyword">return</span> self.limit <span class="keyword">or</span> <span class="number">0</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="built_in">print</span>(s.balance) <span class="comment">--&gt; 0</span></span><br/><span class="line">s:deposit(<span class="number">100.00</span>)</span><br/><span class="line"><span class="built_in">print</span>(s.balance) <span class="comment">--&gt; 100</span></span><br/><span class="line">s:withdraw(<span class="number">200.00</span>)</span><br/><span class="line"><span class="built_in">print</span>(s.balance) <span class="comment">--&gt; 200</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>多重继承</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- look up for &#39;k&#39; in list of tables &#39;plist&#39;</span></span><br/><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span><span class="params">(k, plist)</span></span></span><br/><span class="line">	<span class="keyword">for</span> i = <span class="number">1</span>, #plist <span class="keyword">do</span></span><br/><span class="line">		<span class="keyword">local</span> v = plist[i][k] <span class="comment">-- try &#39;i&#39;-th superclass</span></span><br/><span class="line">		<span class="keyword">if</span> v <span class="keyword">then</span> <span class="keyword">return</span> v <span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClass</span><span class="params">(...)</span></span></span><br/><span class="line">	<span class="keyword">local</span> c = {} <span class="comment">-- new class</span></span><br/><span class="line">	<span class="keyword">local</span> parents = {...}</span><br/><span class="line">	<span class="comment">-- class will search for each method in the list of its parents</span></span><br/><span class="line">	<span class="built_in">setmetatable</span>(c, {<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br/><span class="line">		<span class="keyword">return</span> search(k, parents)</span><br/><span class="line">	<span class="keyword">end</span>})</span><br/><span class="line">	<span class="comment">-- prepare &#39;c&#39; to be the metatable of its instances</span></span><br/><span class="line">	c.<span class="built_in">__index</span> = c</span><br/><span class="line">	<span class="comment">-- define a new constructor for this new class</span></span><br/><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">c:new</span><span class="params">(o)</span></span></span><br/><span class="line">		o = o <span class="keyword">or</span> {}</span><br/><span class="line">		<span class="built_in">setmetatable</span>(o, c)</span><br/><span class="line">		<span class="keyword">return</span> o</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">return</span> c <span class="comment">-- return new class</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">Named = {}</span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Named:getname</span><span class="params">()</span></span></span><br/><span class="line">	<span class="keyword">return</span> self.name</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Named:setname</span><span class="params">(n)</span></span></span><br/><span class="line">	self.name = n</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">NamedAccount = createClass(Account, Named)</span><br/><span class="line">account = NamedAccount:new{name = <span class="string">&#34;Paul&#34;</span>}</span><br/><span class="line"><span class="built_in">print</span>(account:getname()) <span class="comment">--&gt; Paul</span></span><br/><span class="line"><span class="built_in">print</span>(account)</span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>用<code>createClass()</code>创造一个继承自两个父类的子类。为了减少<code>search()</code>在父类中搜索的复杂度，可以采用记忆化搜索，将搜索的结果保存在原table中<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">setmetatable</span>(c, {<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, k)</span></span></span><br/><span class="line">	<span class="keyword">local</span> v = search(k, parents)</span><br/><span class="line">	t[k] = v <span class="comment">-- save for next access</span></span><br/><span class="line">	<span class="keyword">return</span> v</span><br/><span class="line"><span class="keyword">end</span>})</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>这样做的缺点：It is difficult to change method definitions after the system is running, because these changes do not propagate down the hierarhy chain.（说实话，我没看懂这句话……）</p>
<ul>
<li><p>privacy，用局部变量和闭包构造私有成员，使得私有成员从外部无法直接获得，只能在内部获得</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newAccount</span><span class="params">(initialBalance)</span></span></span><br/><span class="line">	<span class="keyword">local</span> self = {</span><br/><span class="line">		balance = initialBalance,</span><br/><span class="line">		LIM = <span class="number">10000.00</span>,</span><br/><span class="line">	}</span><br/><span class="line">	<span class="keyword">local</span> extra = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br/><span class="line">		<span class="keyword">if</span> self.balance &gt; self.LIM <span class="keyword">then</span></span><br/><span class="line">			<span class="keyword">return</span> self.balance * <span class="number">0.10</span></span><br/><span class="line">		<span class="keyword">else</span></span><br/><span class="line">			<span class="keyword">return</span> <span class="number">0</span></span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">local</span> withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br/><span class="line">		self.balance = self.balance - v</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">local</span> deposit = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br/><span class="line">		self.balance = self.balance + v</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">local</span> getBalance = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br/><span class="line">		<span class="keyword">return</span> self.balance + extra()</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">return</span> {</span><br/><span class="line">		withdraw = withdraw,</span><br/><span class="line">		deposit = deposit,</span><br/><span class="line">		getBalance = getBalance</span><br/><span class="line">	}</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">acc1 = newAccount(<span class="number">100.00</span>)</span><br/><span class="line">acc1.withdraw(<span class="number">110.00</span>)</span><br/><span class="line"><span class="built_in">print</span>(acc1.getBalance()) <span class="comment">--&gt; -10</span></span><br/><span class="line">acc1.deposit(<span class="number">50.00</span>)</span><br/><span class="line"><span class="built_in">print</span>(acc1.getBalance()) <span class="comment">--&gt; 40</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p>single-method object，用闭包创建对象，无需创建一个接口table，根据参数调用不同的方法，没有继承，但是有私有性</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newObject</span><span class="params">(value)</span></span></span><br/><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(action, v)</span></span></span><br/><span class="line">		<span class="keyword">if</span> action == <span class="string">&#34;get&#34;</span> <span class="keyword">then</span> <span class="keyword">return</span> value</span><br/><span class="line">		<span class="keyword">elseif</span> action == <span class="string">&#34;set&#34;</span> <span class="keyword">then</span> value = v</span><br/><span class="line">		<span class="keyword">else</span> <span class="built_in">error</span>(<span class="string">&#34;invalid action&#34;</span>)</span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">d = newObject(<span class="number">0</span>)</span><br/><span class="line"><span class="built_in">print</span>(d(<span class="string">&#34;get&#34;</span>)) <span class="comment">--&gt; 0</span></span><br/><span class="line">d(<span class="string">&#34;set&#34;</span>, <span class="number">10</span>)</span><br/><span class="line"><span class="built_in">print</span>(d(<span class="string">&#34;get&#34;</span>)) <span class="comment">--&gt; 10</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
</ul>