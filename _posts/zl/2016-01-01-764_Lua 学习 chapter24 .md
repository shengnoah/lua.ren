---
layout: post
title: Lua 学习 chapter24  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>将协程用作迭代器</li>
  <li>事件驱动式编程</li>
</ol>

<blockquote>
  <p>人人真真的生活过，学习过，改变过，努力过，才能创造出一个满意的自己。</p>
</blockquote>

<h2 id="将协程用作迭代器">将协程用作迭代器</h2>

<p>不断的resume来实现迭代。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="k">function</span> <span class="nf">printResult</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">a</span> <span class="k">do</span>
        <span class="nb">io.write</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&#34; &#34;</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="nb">io.write</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">n</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">permgen</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="ow">or</span> <span class="o">#</span><span class="n">a</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">then</span>
        <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="k">do</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">permgen</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">permutations</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="n">permgen</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">function</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">code</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="n">permutations</span><span class="p">({</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="s2">&#34;b&#34;</span><span class="p">,</span><span class="s2">&#34;c&#34;</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">printResult</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="事件驱动式编程">事件驱动式编程</h2>

<p>假设我们有一个I/O库：</p>

<ol>
  <li>lib.runloop()：运行事件循环，在其中处理所有发生的事件并调用对应的回调函数。</li>
  <li>lib.readline(steam,callback)：从指定流中读取一行，并在读取完成后带着读取的结果调用指定的回调函数</li>
  <li>lib.writeline(stream,line,callback)：该函数写入一行</li>
  <li>lib.stop():打破循环，用于程序结束</li>
</ol>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">lib</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">lib</span><span class="p">.</span><span class="n">readline</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;等待输入：&#34;</span><span class="p">)</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">waitInput</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
<span class="k">end</span>
<span class="n">lib</span><span class="p">.</span><span class="n">writeline</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">callback</span><span class="p">)</span>
    <span class="nb">io.write</span><span class="p">(</span><span class="n">line</span> <span class="o">..</span> <span class="s2">&#34;from others&#34;</span><span class="p">)</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">waitWrite</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
<span class="k">end</span>

<span class="n">lib</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">end</span>

<span class="n">lib</span><span class="p">.</span><span class="n">runloop</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">while</span> <span class="n">lib</span><span class="p">.</span><span class="n">flag</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">lib</span><span class="p">.</span><span class="n">waitInput</span> <span class="k">then</span>
            <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="nb">io.read</span><span class="p">()</span>
            <span class="n">lib</span><span class="p">.</span><span class="n">waitInput</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="n">lib</span><span class="p">.</span><span class="n">callback</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elseif</span> <span class="n">lib</span><span class="p">.</span><span class="n">waitWrite</span> <span class="k">then</span>
            <span class="n">lib</span><span class="p">.</span><span class="n">waitWrite</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="n">lib</span><span class="p">.</span><span class="n">callback</span><span class="p">()</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">run</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="n">code</span><span class="p">()</span>
        <span class="n">lib</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">end</span><span class="p">)</span>
    <span class="n">co</span><span class="p">()</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">runloop</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">putline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.running</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">callback</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">getline</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.running</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
    <span class="k">end</span><span class="p">)</span>
    <span class="n">lib</span><span class="p">.</span><span class="n">readline</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">line</span>
<span class="k">end</span>

<span class="n">run</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span>
    <span class="kd">local</span> <span class="n">t</span><span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="n">getline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="k">then</span>
            <span class="k">break</span>
        <span class="k">end</span>
        <span class="nb">table.insert</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">#</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
        <span class="n">putline</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">..</span> <span class="s2">&#34;</span><span class="se">n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>


                <hr style="visibility: hidden;"/>
                
                <hr style="visibility: hidden;"/>