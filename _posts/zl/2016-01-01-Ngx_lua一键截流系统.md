---
layout: post
title: Ngx_lua一键截流系统 
tags: [lua文章]
categories: [lua文章]
---
### [](https://fankeke.github.io/#%E8%83%8C%E6%99%AF "背景")背景

由于某些服务的流量过大，为保护其后端服务，需要在接入层Nginx对某些服务流量进行截流。本系统可以提供按照百分比对指定域名的制定URI进行截流的功能

### [](https://fankeke.github.io/#%E7%95%8C%E9%9D%A2 "接口")接口

管理员可以轻松在管理接口进行配置，接口接口大致如下

![](https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/1.png)

### [](https://fankeke.github.io/#%E5%AE%9E%E7%8E%B0 "实现")实现

采用nginx＋Lua的实现整个系统的截流功能，大致架构图如下：

![](https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/2.png)

管理员在接口上写入数据，管理端服务会将数据放入redis集群，各个nginx节点，会定时从redis集群拉取截流数据。

### [](https://fankeke.github.io/#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5
"服务接入")服务接入

为了对达到快速方便的截流目的，默认是每个服务都接入截流系统，而不需要进行nginx配置文档的修改。

access_by_lua_file “/etc/nginx/hlb-lua/access_lua/online_access.lua”; （1）  
server {

    
    
    server_name        server1;
    

}  
server {  
server_name server2;  
}  
server {

    
    
    server_name        server3;
    

}

server {  
server_name server4;  
}

这样能够到达全自动化的截流：  
1 不需要在每个服务配置中做添加任何字段，也就意味着完全不用reload Nginx  
2 针对某个服务下的某个路径进行截流，只需在管理端接口上输入数据即可完成

### [](https://fankeke.github.io/#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95
"性能测试")性能测试

由于默认所有流量经过截流检测系统，需要比较造成的性能影响。计算截流逻辑的耗时。每组数据共采集5000条请求的日志，用ab实现压测，计算其在截流逻辑处的平均耗时。共测试10组数据

![](https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/3.png)

由压测结果来看，截流逻辑耗时稳定在20us以下。

### [](https://fankeke.github.io/#%E7%81%BE%E9%9A%BE%E6%B5%8B%E8%AF%95
"灾难测试")灾难测试

截流系统依赖redis集群，考虑到集群的挂掉后对整改系统的影响，需要进行灾难测试。灾难测试分为两部分，分别是对管理端的影响和对Nginx节点的影响。  
说明：由于所有截流数据缓存在集群的一个分片上，故灾难测试在该分片上进行。下面说的分片特指存放截流数据的分片

![](https://fankeke.github.io/img/Ngx_lua%E4%B8%80%E9%94%AE%E6%88%AA%E6%B5%81%E7%B3%BB%E7%BB%9F/4.png)  
结论：从结论看出，截流系统对于redis集群的故障能够做到有损提供服务，做到高可用。

### [](https://fankeke.github.io/#%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1
"接口设计")接口设计

####
[](https://fankeke.github.io/#%E8%AE%BE%E7%BD%AE-%E4%BF%AE%E6%94%B9%EF%BC%89%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5
"设置\(修改）降级策略")设置(修改）降级策略

curl www.admin.com/degrade/admin/?action=set -d
‘{“deg_servername”:”xx”,”deg_location”:”yy”,”deg_percent”:”100”}’

####
[](https://fankeke.github.io/#%E5%88%A0%E9%99%A4%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5
"删除降级策略")删除降级策略

curl www.admin.com/degrade/admin/?action=del -d
‘{“deg_servername”:”xx”,”deg_location”:”yy”}’

####
[](https://fankeke.github.io/#%E6%9F%A5%E7%9C%8B%E6%9F%A5%E7%9C%8B%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5
"查看查看降级策略")查看查看降级策略

curl www.admin.com/degrade/admin/?action=get -d
‘{“deg_servername”:”xx”,”deg_location”:”yy”}’