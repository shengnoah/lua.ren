---
layout: post
title: Lua学习笔记:对迭代和闭包的理解 
tags: [lua文章]
categories: [topic]
---
<div class="content" itemprop="articleBody">
    <h2 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h2><ul>
<li><strong>迭代是一种遍历一种集合中所有元素的机制，在遍历的过程中需要在每次成功之间保持一些状态，比如当前变量的index等。而闭包的机制恰好很适合迭代，因为闭包是一种可以访问外部嵌套环境中的变量的函数，而这个变量可以用来保持状态。在lua中闭包结构通常由闭包函数本身和一个创建该闭包函数的工厂函数组成。</strong></li>
<li><strong>以下面代码为例，GetValue就是个工厂，它生产出一个闭包，这个闭包将状态保持在t和i这两个变量中。其实在我看来主要是i中，在循环中每次调用闭包（迭代器）都是在更新它的状态i，这段代码完美的展示了迭代器的概念。</strong></li>
</ul>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line">tt = {<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span></span><br/><span class="line">	<span class="keyword">local</span> i =<span class="number">0</span></span><br/><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br/><span class="line">		i=i+<span class="number">1</span></span><br/><span class="line">		<span class="keyword">return</span> t[i]</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">iterator = GetValue(tt)</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br/><span class="line">	<span class="keyword">local</span> v = iterator()</span><br/><span class="line">	<span class="keyword">if</span> v == <span class="literal">nil</span> <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">break</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line">	<span class="built_in">print</span>(v)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>

<h2 id="泛型for"><a href="#泛型for" class="headerlink" title="泛型for"></a>泛型for</h2><ul>
<li><p><strong>泛型for在内部保存了3个值，分别是一个迭代器函数、一个恒定状态和一个控制变量。其形态如下，其中var-list是变量列表，exp-list表达式列表。var-list第一个原始就是控制变量，在循环中它不会是nil，如果是nil了循环就结束了。</strong></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &lt;var-list&gt; <span class="keyword">in</span> &lt;<span class="built_in">exp</span>-list&gt; <span class="keyword">do</span></span><br/><span class="line">    &lt;body&gt;</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>迭代器是for中内部保存的，恒定状态应该是你需要循环的数据，比如一个table，控制变量是返回值变量列表的第一个变量，同时它也是用恒定状态和控制变量调用迭代器后得到的结果。假设迭代器函数是f，恒定状态是s，控制变量初始是a0，那么有a1 = f(s,a0) a2 = f(s,a1)…</strong></p>
</li>
<li><p><strong>lua中将for的迭代器返回值固定为了3个，因此得到的是nexttnil.</strong></p>
<h2 id="无状态迭代器"><a href="#无状态迭代器" class="headerlink" title="无状态迭代器"></a>无状态迭代器</h2></li>
<li><p><strong>不保存任何状态的迭代器，可以在多个循环中使用同一个迭代器。例子：ipairs。准确说ipairs是个工厂，它生产了一个简单的迭代器。</strong></p>
</li>
<li><p><strong>一个简单的迭代器的实现</strong></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getNext</span><span class="params">(list, node)</span></span></span><br/><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> node <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">return</span> list</span><br/><span class="line">	<span class="keyword">else</span></span><br/><span class="line">		<span class="keyword">return</span> node.<span class="built_in">next</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tra</span><span class="params">(list)</span></span></span><br/><span class="line">	<span class="keyword">return</span> getNext,list,<span class="literal">nil</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">list = <span class="literal">nil</span></span><br/><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br/><span class="line">	list  = {val = line, <span class="built_in">next</span> = list}</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> list <span class="keyword">do</span></span><br/><span class="line">	<span class="built_in">print</span>(tra(node.val))</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>

</li>
</ul>
<p><strong>在lua中for迭代的迭代器其实主要是个生成器，它生成了iterator，然后依靠for来循环调用。注意生成迭代的函数的返回值必须是函数、恒定状态、控制变量这个顺序。</strong></p>

  </div>