---
layout: post
title: lua c api  
tags: [lua文章]
categories: [topic]
---
<h2 id="一-概述">一 概述</h2> <p>在 <code class="highlighter-rouge">Lua</code> 中使用 <code class="highlighter-rouge">userdata</code> 表示 <code class="highlighter-rouge">C</code> 中的复杂数据类型（其实是一块内存区域），对于 <code class="highlighter-rouge">uerdata</code> 没有预定义的操作。<code class="highlighter-rouge">light userdata</code> 表示指针类型数据，并不需要创建（它是指针值），同时，<strong><code class="highlighter-rouge">light userdata</code> 不被 <code class="highlighter-rouge">gc</code> 管理</strong>。<code class="highlighter-rouge">ligth userdata</code> 的主要用途是用户自己管理内存，避免 <code class="highlighter-rouge">gc</code> 管理内存。</p> <h2 id="二-使用-userdata-实现数组">二 使用 <code class="highlighter-rouge">userdata</code> 实现数组</h2> <p>在 <code class="highlighter-rouge">lua</code> 中使用 <code class="highlighter-rouge">table</code> 作为数组，在数组变大时会耗费非常多的内存，使用 <code class="highlighter-rouge">userdata</code> 能够降低内存使用。<code class="highlighter-rouge">userdata</code> 可以有 <code class="highlighter-rouge">metatable</code>，对 <code class="highlighter-rouge">userdata</code> 类型进行识别（判断 <code class="highlighter-rouge">C</code> 类型是否正确）增加元方法。</p> <h3 id="1-示例代码">1. 示例代码</h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#include &#34;lua.h&#34;
#include &#34;lauxlib.h&#34;
#include &#34;lualib.h&#34;
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">NumArray</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* variable part */</span>
<span class="p">}</span> <span class="n">NumArray</span><span class="p">;</span>

<span class="cm">/******************************************************************************
* 创建 array
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">newarray</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">luaL_checkint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NumArray</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">);</span>
    <span class="n">NumArray</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">NumArray</span> <span class="o">*</span><span class="p">)</span><span class="n">lua_newuserdata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
    
    <span class="n">luaL_getmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;LuaBook.array&#34;</span><span class="p">);</span>
    <span class="n">lua_setmetatable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span>
    
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* new userdatum is already on the stack */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">NumArray</span> <span class="o">*</span>
<span class="nf">checkarray</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ud</span> <span class="o">=</span> <span class="n">luaL_checkudata</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;LuaBook.array&#34;</span><span class="p">);</span>
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ud</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;`array&#39; expected&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">NumArray</span> <span class="o">*</span><span class="p">)</span><span class="n">ud</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* 更新 array 中内容
* @param  userdata    array
* @param  index
* @para   value
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">setarray</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//NumArray *a = (NumArray *)lua_touserdata(L, 1);
</span>    <span class="n">NumArray</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">checkarray</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>    
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;`array&#39; expected&#34;</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">luaL_checkint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="s">&#34;index out of range&#34;</span><span class="p">);</span>
    
    <span class="kt">double</span> <span class="n">value</span> <span class="o">=</span> <span class="n">luaL_checknumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    
    <span class="n">a</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* 获得 array 中内容
* @param  userdata    array
* @param  index
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">getarray</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//NumArray *a = (NumArray *)lua_touserdata(L, 1);
</span>    <span class="n">NumArray</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">checkarray</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;`array&#39; expected&#34;</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">luaL_checkint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="s">&#34;index out of range&#34;</span><span class="p">);</span>
    
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************
* 获得 array 大小
* @param  userdata    array
******************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">getsize</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// NumArray *a = (NumArray *)lua_touserdata(L, 1);
</span>    <span class="n">NumArray</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">checkarray</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    
    <span class="n">luaL_argcheck</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;`array&#39; expected&#34;</span><span class="p">);</span>
    <span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> 
<span class="k">struct</span> <span class="n">luaL_reg</span> <span class="n">array_lib</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s">&#34;new&#34;</span><span class="p">,</span> <span class="n">newarray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;set&#34;</span><span class="p">,</span> <span class="n">setarray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;get&#34;</span><span class="p">,</span> <span class="n">getarray</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="n">getsize</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************
* 注册函数
******************************************************************************/</span>
<span class="kt">int</span> 
<span class="nf">luaopen_userdata</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建 metatable，使用 array.new 创建的数组元表是同一个元表
</span>    <span class="n">luaL_newmetatable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;LuaBook.array&#34;</span><span class="p">);</span>
    <span class="n">luaL_openlib</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;array&#34;</span><span class="p">,</span> <span class="n">array_lib</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="2-调用示例">2. 调用示例</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/lua5.1.5/bin/lua <span class="nt">-e</span> <span class="s2">&#34;require &#39;userdata&#39;; arr = array.new(20); print(type(arr)); array.set(arr,1,20);print(&#39;arr[1]=&#39;,array.get(arr,1));print(&#39;size:&#39;,array.size(arr))&#34;</span>
userdata
arr[1]<span class="o">=</span>	20
size:	20
</code></pre></div></div> <h2 id="三-添加元方法">三 添加元方法</h2> <p>在创建元表时可以在元表中添加元方法，方便使用 <code class="highlighter-rouge">Lua</code> 的 <code class="highlighter-rouge">__index</code>、<code class="highlighter-rouge">__newindex</code> 方法。修改 <code class="highlighter-rouge">luaopen_userdata</code> 方法实现：</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> 
<span class="nf">luaopen_userdata</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建 metatable，使用 array.new 创建的数组元表是同一个元表
</span>    <span class="n">luaL_newmetatable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;LuaBook.array&#34;</span><span class="p">);</span>
    <span class="n">luaL_openlib</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;array&#34;</span><span class="p">,</span> <span class="n">array_lib</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>    
    
    <span class="cm">/* now the stack has the metatable at index 1 and
       `array&#39; at index 2 */</span>
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;__index&#34;</span><span class="p">);</span>
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;get&#34;</span><span class="p">);</span>
    <span class="n">lua_gettable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>  <span class="cm">/* get array.get on stack top*/</span>
    <span class="n">lua_settable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span>  <span class="cm">/* metatable.__index = array.get */</span>
    
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;__newindex&#34;</span><span class="p">);</span>
    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">&#34;set&#34;</span><span class="p">);</span>
    <span class="n">lua_gettable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="cm">/* get array.set */</span>
    <span class="n">lua_settable</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* metatable.__newindex = array.set */</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>在这里的栈操作要仔细</strong></p> <h3 id="调用示例">调用示例</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>/usr/local/lua5.1.5/bin/lua <span class="nt">-e</span> <span class="s2">&#34;require &#39;userdata&#39;; arr = array.new(20); print(type(arr)); arr[1]=20;print(&#39;arr[1]=&#39;,arr[1])&#34;</span>
userdata
arr[1]<span class="o">=</span>	20
</code></pre></div></div> <h2 id="四-函数说明">四 函数说明</h2> <h3 id="1-lua_newuserdata">1. <code class="highlighter-rouge">lua_newuserdata</code></h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">lua_newuserdata</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div> <p>创建一块 <code class="highlighter-rouge">size</code> 大小的内存区域，将其压入栈顶并返回内存地址指针。</p> <h3 id="2-lual_checkudata">2. <code class="highlighter-rouge">luaL_checkudata</code></h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">luaL_checkudata</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">narg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tname</span><span class="p">);</span>
</code></pre></div></div> <p>检查函数的第 <code class="highlighter-rouge">narg</code> 参数是否是 <code class="highlighter-rouge">tname</code> 类型的 <code class="highlighter-rouge">userdata</code>。<code class="highlighter-rouge">luaL_checkudata</code> 首先将 <code class="highlighter-rouge">narg</code> 转换为 <code class="highlighter-rouge">userdata</code> ，然后获得元表；同时，从注册表中根据 <code class="highlighter-rouge">tname</code> 获得元表，两者相互比较如果不同触发错误并返回 <code class="highlighter-rouge">NULL</code>，如果相同则返回 <code class="highlighter-rouge">narg</code> 指向的 <code class="highlighter-rouge">userdata</code>。</p> <p><em>可以看 <code class="highlighter-rouge">luaL_checkudata</code> 代码实现，非常简单。</em></p> <h3 id="3-lual_newmetatable">3. <code class="highlighter-rouge">luaL_newmetatable</code></h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">luaL_newmetatable</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tname</span><span class="p">);</span>
</code></pre></div></div> <p>创建一个新的可以作为 <code class="highlighter-rouge">userdata</code> 类型元表的 <code class="highlighter-rouge">table</code>，并使用 <code class="highlighter-rouge">tname</code> 作为 <code class="highlighter-rouge">key</code> 存储在注册表中。如果注册表中已经存在 <code class="highlighter-rouge">tname</code> 类型的值，返回值为 <code class="highlighter-rouge">0</code>。</p> <h3 id="4-lual_getmetatable">4. <code class="highlighter-rouge">luaL_getmetatable</code></h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">luaL_getmetatable</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tname</span><span class="p">);</span>
</code></pre></div></div> <p>将注册表中与名称 <code class="highlighter-rouge">tname</code> 关联的元表压入栈中。</p> <h3 id="5-lua_setmetatable">5. <code class="highlighter-rouge">lua_setmetatable</code></h3> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">lua_setmetatable</span> <span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
</code></pre></div></div> <p>从栈顶弹出一个 <code class="highlighter-rouge">table</code> 并将其设置为栈中 <code class="highlighter-rouge">index</code> 索引出的值的元表。</p> <h2 id="五-参考资料">五 参考资料</h2> <ul> <li> <p><a href="https://www.lua.org/pil/28.4.html">programming in lua</a></p> </li> <li> <p><a href="https://www.lua.org/manual/5.1/manual.html">lua 5.1 manual</a></p> </li> </ul>