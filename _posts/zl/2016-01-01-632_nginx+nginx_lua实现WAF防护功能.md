---
layout: post
title: nginx+nginx_lua实现WAF防护功能 
tags: [lua文章]
categories: [topic]
---
<blockquote class="blockquote-center"><p>Do one thing at a time, and do well.</p></blockquote><h2 id="nginx-lua"><a href="#nginx-lua" class="headerlink" title="nginx_lua"></a>nginx_lua</h2><p>nginx_lua模块是nginx的第三方模块，它可以将lua语言嵌入到nginx配置中，从而极大的扩展了nginx的能力，nginx以高并发而知名，而lua作为嵌入式语言轻便，两者的结合可以做到在nginx层就实现编程,而这里我们加入waf的lua过滤编程来实现waf。<br/></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>需要的程序包：</p><ul><li>nginx</li><li>nginx_devel_kit（拓展nginx服务器核心功能的模块）</li><li>lua-nginx-module（nginx_lua模块）</li><li>nginx_lua_waf（waf策略 web应用防火墙）</li><li>LuaJIT（c实现的lua解释器）</li></ul><h3 id="LuaJIT"><a href="#LuaJIT" class="headerlink" title="LuaJIT"></a>LuaJIT</h3><p>下载网站：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~]</div><div class="line">~]<span class="comment"># tar xf LuaJIT-2.0.5.tar.gz</span></div><div class="line">~]<span class="comment"># cd LuaJIT-2.0.5</span></div><div class="line">~]<span class="comment"># make -j 2 &amp;&amp; make install</span></div></pre></td></tr></tbody></table></figure><p><code>lib和include是直接放在/usr/local/lib和/usr/local/include</code></p><p>设置环境变量(nginx编译时需要)<br/></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># ~]# vim /etc/profile.d/LuaJIT.conf</span></div><div class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</div><div class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</div><div class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/lib/:<span class="variable">$LD_LIBRARY_PATH</span></div><div class="line">~]<span class="comment"># . /etc/profile.d/LuaJIT.conf</span></div></pre></td></tr></tbody></table></figure><p></p><h3 id="nginx-devel-kit"><a href="#nginx-devel-kit" class="headerlink" title="nginx_devel_kit"></a>nginx_devel_kit</h3><p>第三方模块，我们可以到nginx wiki是查找：www.nginx.com/resources/wiki/modules/index.html</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># git clone https://github.com/simpl/ngx_devel_kit</span></div></pre></td></tr></tbody></table></figure><h3 id="lua-nginx-module"><a href="#lua-nginx-module" class="headerlink" title="lua-nginx-module"></a>lua-nginx-module</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># git clone https://github.com/openresty/lua-nginx-module</span></div></pre></td></tr></tbody></table></figure><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><p>编译nginx_devel_kit和lua-nginx-module进nginx<br/></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># wget http://nginx.org/download/nginx-1.12.1.tar.gz</span></div><div class="line">~]<span class="comment"># tar xf nginx-1.12.1.tar.gz</span></div><div class="line">~]<span class="comment"># cd nginx-1.12.1</span></div><div class="line">~]<span class="comment"># yum install -y openssl-devel pcre-devel</span></div><div class="line">~]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --add-module=../ngx_devel_kit --add-module=../lua-nginx-module --user=nginx --group=nginx</span></div></pre></td></tr></tbody></table></figure><p></p><h3 id="nginx-lua-waf"><a href="#nginx-lua-waf" class="headerlink" title="nginx_lua_waf"></a>nginx_lua_waf</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~]<span class="comment"># wget -c https://github.com/loveshell/ngx_lua_waf/archive/master.zip</span></div><div class="line">~]<span class="comment"># mkdir -p /usr/local/nginx/conf/waf</span></div><div class="line">~]<span class="comment"># unzip master.zip </span></div><div class="line">~]<span class="comment"># cd ngx_lua_waf-master</span></div><div class="line">~]<span class="comment"># cp -rf * /usr/local/nginx/conf/waf/</span></div><div class="line">~]<span class="comment"># mkdir -p /usr/local/nginx/logs/hack</span></div><div class="line">~]<span class="comment"># chown -R nginx /usr/local/nginx/logs/hack</span></div></pre></td></tr></tbody></table></figure><h4 id="nginx-lua-waf的用途"><a href="#nginx-lua-waf的用途" class="headerlink" title="nginx_lua_waf的用途"></a>nginx_lua_waf的用途</h4><ul><li>防止sql注入，本地包含，部分溢出，fuzzing测试，xss,SSRF等web攻击</li><li>防止svn/备份之类文件泄漏</li><li>防止ApacheBench之类压力测试工具的攻击</li><li>屏蔽常见的扫描黑客工具，扫描器</li><li>屏蔽异常的网络请求</li><li>屏蔽图片附件类目录php执行权限</li><li>防止webshell上传</li></ul><h4 id="nginx-lua-waf的使用"><a href="#nginx-lua-waf的使用" class="headerlink" title="nginx_lua_waf的使用"></a>nginx_lua_waf的使用</h4><p>nginx安装路径假设为:/usr/local/nginx/conf/<br/>在nginx.conf的http段添加<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">lua_need_request_body on;</div><div class="line">      lua_package_path &#34;/usr/local/nginx/conf/waf/?.lua&#34;;</div><div class="line">      lua_shared_dict limit 10m;</div><div class="line">      init_by_lua_file  /usr/local/nginx/conf/waf/init.lua; </div><div class="line">      access_by_lua_file /usr/local/nginx/conf/waf/waf.lua;</div></pre></td></tr></tbody></table></figure><p></p><p>配置config.lua里的waf规则目录(一般在waf/conf/目录下)<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RulePath = &#34;/usr/local/nginx/conf/waf/wafconf/&#34;</div></pre></td></tr></tbody></table></figure><p></p><h4 id="config-lua-配置说明"><a href="#config-lua-配置说明" class="headerlink" title="config.lua 配置说明"></a>config.lua 配置说明</h4><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">RulePath = &#34;/usr/local/nginx/conf/waf/wafconf/&#34;</div><div class="line">      --规则存放目录</div><div class="line">      attacklog = &#34;off&#34;</div><div class="line">      --是否开启攻击信息记录，需要配置logdir</div><div class="line">      logdir = &#34;/usr/local/nginx/logs/hack/&#34;</div><div class="line">      --log存储目录，该目录需要用户自己新建，切需要nginx用户的可写权限</div><div class="line">      UrlDeny=&#34;on&#34;</div><div class="line">      --是否拦截url访问</div><div class="line">      Redirect=&#34;on&#34;</div><div class="line">      --是否拦截后重定向</div><div class="line">      CookieMatch = &#34;on&#34;</div><div class="line">      --是否拦截cookie攻击</div><div class="line">      postMatch = &#34;on&#34; </div><div class="line">      --是否拦截post攻击</div><div class="line">      whiteModule = &#34;on&#34; </div><div class="line">      --是否开启URL白名单</div><div class="line">      black_fileExt={&#34;php&#34;,&#34;jsp&#34;}</div><div class="line">      --填写不允许上传文件后缀类型</div><div class="line">      ipWhitelist={&#34;127.0.0.1&#34;}</div><div class="line">      --ip白名单，多个ip用逗号分隔</div><div class="line">      ipBlocklist={&#34;1.0.0.1&#34;}</div><div class="line">      --ip黑名单，多个ip用逗号分隔</div><div class="line">      CCDeny=&#34;on&#34;</div><div class="line">      --是否开启拦截cc攻击(需要nginx.conf的http段增加lua_shared_dict limit 10m;)</div><div class="line">      CCrate = &#34;100/60&#34;</div><div class="line">      --设置cc攻击频率，单位为秒.</div><div class="line">      --默认1分钟同一个IP只能请求同一个地址100次</div><div class="line">      html=[[Please go away~~]]</div><div class="line">      --警告内容,可在中括号内自定义</div><div class="line">      备注:不要乱动双引号，区分大小写</div></pre></td></tr></tbody></table></figure><h3 id="waf-conf-自定义过滤规则"><a href="#waf-conf-自定义过滤规则" class="headerlink" title="waf.conf 自定义过滤规则"></a>waf.conf 自定义过滤规则</h3><ul><li>args里面的规则get参数进行过滤的</li><li>url是只在get请求url过滤的规则</li><li>post是只在post请求过滤的规则</li><li>whitelist是白名单，里面的url匹配到不做过滤</li><li>user-agent是对user-agent的过滤规则</li></ul><p><code>注意：默认开启了get和post过滤，需要开启cookie过滤的，编辑waf.lua取消部分--注释即可</code></p><h2 id="WAF测试"><a href="#WAF测试" class="headerlink" title="WAF测试"></a>WAF测试</h2><p><img src="https://jusene.github.io//image/98.png" alt="" title="渗透测试"/></p><p>看下日志：<br/></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hack]<span class="comment"># tail -f localhost_2017-09-16_sec.log </span></div><div class="line">10.211.55.2 [2017-09-16 14:01:40] <span class="string">&#34;GET localhost/?id=select%20*%20from%20mysql;&#34;</span> <span class="string">&#34;-&#34;</span>  <span class="string">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:56.0) Gecko/20100101 Firefox/56.0&#34;</span> <span class="string">&#34;select.+(from|limit)&#34;</span></div><div class="line">10.211.55.2 [2017-09-16 14:05:51] <span class="string">&#34;GET localhost/?id=union%20select%20*%20from%20mysql;&#34;</span> <span class="string">&#34;-&#34;</span>  <span class="string">&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:56.0) Gecko/20100101 Firefox/56.0&#34;</span> <span class="string">&#34;select.+(from|limit)&#34;</span></div></pre></td></tr></tbody></table></figure><p></p><p>从日志中我们可以看见我么测试的url的args请求触发了那条规则。</p><p>从config.lua中我们还可以看见cc防护，测试下：<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~]# cat /usr/local/nginx/conf/waf/config.lua</div><div class="line">...</div><div class="line">CCDeny=&#34;on&#34;     #开启cc防护</div><div class="line">CCrate=&#34;5/60&#34;   #降低触发阀值便于测试</div><div class="line">...</div><div class="line">~]# nginx -s reload</div></pre></td></tr></tbody></table></figure><p></p><p>测试结果，当我在1分钟频繁请求超过5次，返回404错误，最后结果返回的是503错误，当我们停止访问，过一会就可以恢复访问，经过测试这个防护是针对请求ip的，证明cc防护还是可以达到一定的效果的。</p><p><img src="https://jusene.github.io//image/99.png" alt="" title="cc防护"/></p><p>这是nginx+lua的一种扩展，而nginx的另一个分支openresty将nginx与lua做了很多扩展，有空一定需要好好研究下。</p>