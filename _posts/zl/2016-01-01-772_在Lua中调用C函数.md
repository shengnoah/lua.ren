---
layout: post
title: 在Lua中调用C函数 
tags: [lua文章]
categories: [topic]
---
<p>Lua调用C语言中的函数是通过栈来进行参数传递的，这与大部分编程语言的内部函数调用的实现一致。</p><p>我们先实现如下C代码</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/><span class="line">78</span><br/><span class="line">79</span><br/><span class="line">80</span><br/><span class="line">81</span><br/><span class="line">82</span><br/><span class="line">83</span><br/><span class="line">84</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lualib.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lauxlib.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="params">(lua_State * L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    </span><br/><span class="line">    <span class="keyword">double</span> a = luaL_checknumber(L, <span class="number">1</span>);</span><br/><span class="line">    <span class="built_in">printf</span>(<span class="string">&#34;第一个参数：%fn&#34;</span>, a);</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">// 获取第二个函数参数</span></span><br/><span class="line">    <span class="keyword">double</span> b = luaL_checknumber(L, <span class="number">2</span>);</span><br/><span class="line">    <span class="built_in">printf</span>(<span class="string">&#34;第二个参数：%fn&#34;</span>, b);</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">// 设置函数返回值</span></span><br/><span class="line">    lua_pushnumber(L, a + b);</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">// 函数返回值的数量，在这里函数返回值为1</span></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">i_swap</span><span class="params">(lua_State * L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="keyword">int</span> i = lua_tointeger(L, <span class="number">1</span>);</span><br/><span class="line">    <span class="keyword">int</span> j = lua_tointeger(L, <span class="number">2</span>);</span><br/><span class="line">    <span class="built_in">printf</span>(<span class="string">&#34;%d 和 %d 交换位置n&#34;</span>, i, j);</span><br/><span class="line"></span><br/><span class="line">    lua_pushinteger(L, j);</span><br/><span class="line">    lua_pushinteger(L, i);</span><br/><span class="line"></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 计算斐波拉契数列</span></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">i_fib</span><span class="params">(lua_State * L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="comment">// lua_Integer长度为64位，防止溢出（事实上当n的值达到100左右即使64位也会发生溢出了）</span></span><br/><span class="line">    lua_Integer sum = <span class="number">0</span>;</span><br/><span class="line">    lua_Integer a = <span class="number">0</span>; <span class="comment">// n - 2</span></span><br/><span class="line">    lua_Integer b = <span class="number">0</span>; <span class="comment">// n - 1</span></span><br/><span class="line"></span><br/><span class="line">    <span class="keyword">int</span> n = lua_tointeger(L, <span class="number">1</span>);</span><br/><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br/><span class="line">    <span class="keyword">while</span> (i &lt;= n) {</span><br/><span class="line">        <span class="comment">// printf(&#34;sum is %dn&#34;, sum);</span></span><br/><span class="line">        i++;</span><br/><span class="line">        <span class="keyword">if</span> (i == <span class="number">1</span>) {</span><br/><span class="line">            a = <span class="number">0</span>;</span><br/><span class="line">            b = <span class="number">1</span>;</span><br/><span class="line">        }</span><br/><span class="line">        sum = a + b;</span><br/><span class="line">        a = b;</span><br/><span class="line">        b = sum;</span><br/><span class="line">    }</span><br/><span class="line"></span><br/><span class="line">    lua_pushinteger(L, sum);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 获取当前的毫秒时间戳</span></span><br/><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">i_time</span><span class="params">(lua_State * L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br/><span class="line">    gettimeofday( &amp;tv, <span class="literal">NULL</span> );</span><br/><span class="line">    <span class="keyword">double</span> t = tv.tv_sec + (<span class="keyword">double</span>)((<span class="keyword">int</span>)(tv.tv_usec*<span class="number">0.001</span>) * <span class="number">0.001</span>);</span><br/><span class="line"></span><br/><span class="line">    <span class="comment">// 以整数返回</span></span><br/><span class="line">    lua_pushinteger(L, (lua_Integer)(t * <span class="number">1000</span>));</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// 打开名为mylib的库，在Lua中使用require(&#39;mylib&#39;)可以调用mylib中的函数</span></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_mylib</span><span class="params">(lua_State * L)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">    <span class="comment">// 对函数进行注册，之后在Lua中可以直接调用</span></span><br/><span class="line">    lua_register(L, <span class="string">&#34;add&#34;</span>, i_add);</span><br/><span class="line">    lua_register(L, <span class="string">&#34;swap&#34;</span>, i_swap);</span><br/><span class="line">    lua_register(L, <span class="string">&#34;fib_c&#34;</span>, i_fib);</span><br/><span class="line">    lua_register(L, <span class="string">&#34;current_time&#34;</span>, i_time);</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>我们把上面的代码保存在 <code>mylib.c</code> 文件中，随后使用如下命令对源代码进行编译得到 <code>mylib.so</code> 文件</p><pre><code>gcc mylib.c -fPIC -shared -o mylib.so -I/usr/local/include/lua5.3 -llua5.3
</code></pre><p>得到动态链接库之后我们在当前文件夹下创建 <code>test.lua</code> 文件，之后输入如下代码<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">package</span>.<span class="built_in">cpath</span> = <span class="string">&#39;./?.so;&#39;</span> .. <span class="built_in">package</span>.<span class="built_in">cpath</span> <span class="comment">-- 把库文件添加到环境变量中</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">require</span>(<span class="string">&#39;mylib&#39;</span>)</span><br/><span class="line"><span class="built_in">print</span>(add(<span class="number">1</span>, <span class="number">2</span>))</span><br/><span class="line"><span class="built_in">print</span>(swap(<span class="number">2333</span>, <span class="number">666</span>))</span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 计算斐波那契数列</span></span><br/><span class="line">fib_lua = <span class="function"><span class="keyword">function</span><span class="params">(n)</span></span></span><br/><span class="line">    sum = <span class="number">0</span></span><br/><span class="line">    a = <span class="number">0</span> <span class="comment">-- n - 2</span></span><br/><span class="line">    b = <span class="number">0</span> <span class="comment">-- n - 1</span></span><br/><span class="line"></span><br/><span class="line">    i = <span class="number">0</span></span><br/><span class="line">    <span class="keyword">repeat</span></span><br/><span class="line">        i = i + <span class="number">1</span></span><br/><span class="line">        <span class="keyword">if</span> i == <span class="number">1</span> <span class="keyword">then</span></span><br/><span class="line">            a = <span class="number">0</span></span><br/><span class="line">            b = <span class="number">1</span></span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">        sum = a + b</span><br/><span class="line">        a = b</span><br/><span class="line">        b = sum</span><br/><span class="line">    <span class="keyword">until</span> i &gt; n</span><br/><span class="line">    <span class="keyword">return</span> sum</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">n = <span class="number">10000000</span> <span class="comment">-- 计算的斐波那契数列位数</span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 使用lua计算</span></span><br/><span class="line">start = current_time()</span><br/><span class="line">fib_lua(n)</span><br/><span class="line">luaCost = current_time() - start</span><br/><span class="line"><span class="built_in">print</span>(luaCost)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 使用C语言计算</span></span><br/><span class="line">start = current_time()</span><br/><span class="line">fib_c(n)</span><br/><span class="line">cCost = current_time() - start</span><br/><span class="line"><span class="built_in">print</span>(cCost)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">-- 计算lua与C语言的耗时比</span></span><br/><span class="line"><span class="built_in">print</span>(luaCost / cCost)</span><br/></pre></td></tr></tbody></table></figure><p></p><p>执行 <code>lua test.lua</code> 得到如下结果：</p><pre><code>第一个参数：1.000000
第二个参数：2.000000
3.0
2333 和 666 交换位置
666     2333
1887
40
47.175
</code></pre><p>至此我们就使用Lua成功的调用了C语言中的函数，我们发现C语言的执行效率差不多是Lua的四十多倍（C语言的执行效率是Python的80多倍），可见Lua作为一个脚本语言，其执行速度还是很快的。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://cloudwu.github.io/lua53doc/manual.html#4" target="_blank" rel="noopener noreferrer">Lua 5.3 参考手册</a></p>