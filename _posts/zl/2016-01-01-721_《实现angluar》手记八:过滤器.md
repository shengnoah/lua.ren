---
layout: post
title: 《实现angluar》手记八:过滤器 
tags: [lua文章]
categories: [topic]
---
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>实现过滤器<code>|</code>以及内置过滤器函数<code>filter</code></p>
<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>过滤器函数接受一个表达式, 并且返回一个处理后的最终值, 其使用的是 <code>|</code>管道语法, 左边接受的是原始的表达式, 右边接受的是过滤器函数, <strong>过滤器函数只接受一个值</strong></p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">myExpression | uppercase</span><br/></pre></td></tr></tbody></table></figure>

<p>过滤器可以组合</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">myNumbers | odd | increment</span><br/></pre></td></tr></tbody></table></figure>

<p>由于过滤器就是一个函数, 上述表达式实际上等价于</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">increment(odd(myNumbers))</span><br/></pre></td></tr></tbody></table></figure>

<h2 id="过滤器注册"><a href="#过滤器注册" class="headerlink" title="过滤器注册"></a>过滤器注册</h2><p>recurse函数递归调用自身, 加上数组的push方法, 这样得出来的字符串恰好是我们想要的, 注意forEach之中作者鸡贼地仅仅遍历拼接了ast.body前n-1项</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line">ASTCompiler.prototype.recurse = function (ast, context, create) {</span><br/><span class="line">    var intoId;</span><br/><span class="line">    var self = this;</span><br/><span class="line">    switch (ast.type) {</span><br/><span class="line">        case AST.Program:</span><br/><span class="line">            _.forEach(_.initial(ast.body), function (stmt) {</span><br/><span class="line">                self.state.body.push(self.recurse(stmt), &#39;;&#39;);</span><br/><span class="line">            });</span><br/><span class="line">            self.state.body.push(&#39;return &#39;, self.recurse(_.last(ast.body)), &#39;;&#39;);</span><br/><span class="line">            break;</span><br/></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">register(&#39;upcase&#39;, function () {</span><br/><span class="line">    return function (str) {</span><br/><span class="line">        return str.toUpperCase();</span><br/><span class="line">    };</span><br/><span class="line">});</span><br/><span class="line">var fn = parse(&#39;aString | upcase&#39;);</span><br/><span class="line">fn({ aString: &#39;Hello&#39; });</span><br/></pre></td></tr></tbody></table></figure>

<p>上面几段代码最终编译成下面的函数</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/></pre></td><td class="code"><pre><span class="line">(function anonymous(ensureSafeMemberName, ensureSafeObject, ensureSafeFunction, ifDefined, filter) {</span><br/><span class="line">    var v0 = filter(&#39;upcase&#39;);</span><br/><span class="line">    var fn = function(s, l) {</span><br/><span class="line">        var v1;</span><br/><span class="line">        if (l &amp;&amp; (&#39;aString&#39;in l)) {</span><br/><span class="line">            v1 = (l).aString;</span><br/><span class="line">        }</span><br/><span class="line">        if (!(l &amp;&amp; (&#39;aString&#39;in l)) &amp;&amp; s) {</span><br/><span class="line">            v1 = (s).aString;</span><br/><span class="line">        }</span><br/><span class="line">        ensureSafeObject(v1);</span><br/><span class="line">        return v0(v1);</span><br/><span class="line">    };</span><br/><span class="line">    return fn;</span><br/><span class="line">}</span><br/><span class="line">)</span><br/></pre></td></tr></tbody></table></figure>

<p>我们来看下作者是如何解决传参的问题的</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/></pre></td><td class="code"><pre><span class="line">    var fnString = this.filterPrefix() +</span><br/><span class="line">        &#39;var fn=function(s,l){&#39; +</span><br/><span class="line">        (this.state.vars.length ?</span><br/><span class="line">            &#39;var &#39; + this.state.vars.join(&#39;,&#39;) + &#39;;&#39; :</span><br/><span class="line">            &#39;&#39;</span><br/><span class="line">        ) +</span><br/><span class="line">        this.state.body.join(&#39;&#39;) +</span><br/><span class="line">        &#39;}; return fn;&#39;;</span><br/><span class="line"></span><br/><span class="line">    return new Function(</span><br/><span class="line">        &#39;ensureSafeMemberName&#39;,</span><br/><span class="line">        &#39;ensureSafeObject&#39;,</span><br/><span class="line">        &#39;ensureSafeFunction&#39;,</span><br/><span class="line">        &#39;ifDefined&#39;,</span><br/><span class="line">        &#39;filter&#39;,</span><br/><span class="line">        fnString)(</span><br/><span class="line">            ensureSafeMemberName,</span><br/><span class="line">            ensureSafeObject,</span><br/><span class="line">            ensureSafeFunction,</span><br/><span class="line">            ifDefined,</span><br/><span class="line">            filter);</span><br/><span class="line">`</span><br/></pre></td></tr></tbody></table></figure>

<h2 id="过滤器的链式调用"><a href="#过滤器的链式调用" class="headerlink" title="过滤器的链式调用"></a>过滤器的链式调用</h2><h2 id="额外的过滤器参数"><a href="#额外的过滤器参数" class="headerlink" title="额外的过滤器参数"></a>额外的过滤器参数</h2><h2 id="内置的filter过滤器"><a href="#内置的filter过滤器" class="headerlink" title="内置的filter过滤器"></a>内置的filter过滤器</h2><p>降级写法 <code>var token = op3 ? ch3 : (op2 ? ch2 : ch);</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line">// &#34;=&#34;与&#34;==&#34;,&#34;==&#34; </span><br/><span class="line">var ch = this.ch;</span><br/><span class="line">var ch2 = this.ch + this.peek();</span><br/><span class="line">var ch3 = this.ch + this.peek() + this.peek(2);</span><br/><span class="line">var op = OPERATORS[ch];</span><br/><span class="line">var op2 = OPERATORS[ch2];</span><br/><span class="line">var op3 = OPERATORS[ch3];</span><br/><span class="line">if (op || op2 || op3) {</span><br/><span class="line">    var token = op3 ? ch3 : (op2 ? ch2 : ch);</span><br/><span class="line">    this.tokens.push({ text: token });</span><br/><span class="line">    this.index += token.length;</span><br/><span class="line">} else {</span><br/><span class="line">    throw &#39;Unexpected next character: &#39; + this.ch;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>

<p>优先级的处理方法: 让优先级比较<code>低</code>的去调用优先级比较<code>高</code>的函数<br/>The final precedence order of the operators can be read by looking at the order in which the AST builder’s methods are called <code>in reverse</code>:</p>
<ol>
<li>Primary expressions: Lookups, function calls, method calls.</li>
<li>Unary expressions: +a, -a, !a.</li>
<li>Multiplicative arithmetic expressions: a * b, a / b, and a % b.</li>
<li>Additive arithmetic expressions: a + b and a - b.</li>
<li>Relational expressions: a &lt; b, a &gt; b, a &lt;= b, and a &gt;= b.</li>
<li>Equality testing expressions: a == b, a != b, a === b, and a !== b.</li>
<li>Logical AND expressions: a &amp;&amp; b.</li>
<li>Logical OR expressions: a || b.</li>
<li>Ternary expressions: a ? b : c.</li>
<li>Assignments: a = b.</li>
</ol>