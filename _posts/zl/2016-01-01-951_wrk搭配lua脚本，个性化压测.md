---
layout: post
title: wrk搭配lua脚本，个性化压测 
tags: [lua文章]
categories: [topic]
---
<h2 id="压测工具">压测工具</h2>

<ul>
  <li>wrk</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wrk -t2 -c10 -d10s -s wrk.lua http://www.baidu.com
</code></pre>
</div>

<ul>
  <li>
    <p>apache benchmark：性能基准测试时使用</p>
  </li>
  <li>
    <p>Hey：go实现的压测工具</p>
  </li>
  <li>
    <p>http_load：</p>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>http_load -p 100 -s 10 urls
</code></pre>
</div>

<ul>
  <li>siege</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>siege -c 200 -r 10 -f baidu.url
</code></pre>
</div>

<h2 id="wrk">wrk</h2>
<p>对于一些动态构建的请求，比如：认证、校验、MD加密、http请求参数化， ab、http_load、siege都不能满足需求，倒是jmeter、wrk可以。
更多的lua示例可以参照<a href="https://github.com/wg/wrk/tree/master/scripts">github</a>
wrk请求压测，调用lua分下面3个阶段：setup、running、done
<img src="http://type.so/usr/uploads/2016/08/970528889.png" alt=""/></p>

<ul>
  <li>wrk的全局属性, 可以直接拿到lua中使用的</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wrk = {
  scheme  = &#34;http&#34;,
  host    = &#34;localhost&#34;,
  port    = nil,
  method  = &#34;GET&#34;,
  path    = &#34;/&#34;,
  headers = {},
  body    = nil,
  thread  = &lt;userdata&gt;,
}
</code></pre>
</div>

<ul>
  <li>wrk的全局方法, 可以直接拿到lua中使用的</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>-- 生成整个request的string，例如：返回
-- GET / HTTP/1.1
-- Host: tool.lu
function wrk.format(method, path, headers, body)

-- 获取域名的IP和端口，返回table，例如：返回 `{127.0.0.1:80}`
function wrk.lookup(host, service)

-- 判断addr是否能连接，例如：`127.0.0.1:80`，返回 true 或 false
function wrk.connect(addr)
</code></pre>
</div>

<ul>
  <li>Setup阶段
setup是在线程创建之后，启动之前。</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>function setup(thread)

-- thread提供了1个属性，3个方法
-- thread.addr 设置请求需要打到的ip
-- thread:get(name) 获取线程全局变量
-- thread:set(name, value) 设置线程全局变量
-- thread:stop() 终止线程
</code></pre>
</div>

<ul>
  <li>Running阶段</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>function init(args)
-- 每个线程仅调用1次，args 用于获取命令行中传入的参数, 例如 --env=pre

function delay()
-- 每个线程调用多次，发送下一个请求之前的延迟, 单位为ms

function request()
-- 每个线程调用多次，返回http请求

function response(status, headers, body)
-- 每个线程调用多次，返回http响应
</code></pre>
</div>

<ul>
  <li>Done阶段</li>
</ul>

<p>可以用于自定义结果报表，整个过程中只执行一次</p>

<div class="highlighter-rouge"><pre class="highlight"><code>function done(summary, latency, requests)


latency.min              -- minimum value seen
latency.max              -- maximum value seen
latency.mean             -- average value seen
latency.stdev            -- standard deviation
latency:percentile(99.0) -- 99th percentile value
latency(i)               -- raw value and count

summary = {
  duration = N,  -- run duration in microseconds
  requests = N,  -- total completed requests
  bytes    = N,  -- total bytes received
  errors   = {
    connect = N, -- total socket connection errors
    read    = N, -- total socket read errors
    write   = N, -- total socket write errors
    status  = N, -- total HTTP status codes &gt; 399
    timeout = N  -- total request timeouts
  }
}
</code></pre>
</div>

<h2 id="示例秒杀系统qps压测">示例，秒杀系统，QPS压测：</h2>

<ul>
  <li>接口：</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>GET /miaosha/i/miaosha?goodsRandomName=0e67e331-c521-406a-b705-64e557c4c06c&amp;mobile=15050033920 HTTP/1.1
Host: 127.0.0.1:8080
</code></pre>
</div>

<ul>
  <li>lua</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>-- example script that demonstrates use of setup() to pass
-- data to and from the threads

local counter = 1
local threads = {}

function setup(thread)
   thread:set(&#34;id&#34;, counter)
   table.insert(threads, thread)
   counter = counter + 1
end

function init(args)
   requests  = 0
   responses = 0

   local msg = &#34;thread %d created&#34;
   print(msg:format(id))
end

function request()
   requests = requests + 1
   local returnRequest = &#34;/miaosha/i/miaosha?goodsRandomName=0e67e331-c521-406a-b705-64e557c4c06c&#34;
                        .. &#34;&amp;mobile=&#34; .. math.random(15000000000,19999999999)
   print(wrk.format(nil, returnRequest))
   return wrk.format(nil, returnRequest)
end

function response(status, headers, body)
   responses = responses + 1
end

function done(summary, latency, requests)
   for index, thread in ipairs(threads) do
      local id        = thread:get(&#34;id&#34;)
      local requests  = thread:get(&#34;requests&#34;)
      local responses = thread:get(&#34;responses&#34;)
      local msg = &#34;thread %d made %d requests and got %d responses&#34;
      print(msg:format(id, requests, responses))
   end
end

</code></pre>
</div>

<ul>
  <li>run</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wrk -t400 -c400 -d60s -s wrk.lua http://127.0.0.1:8080
</code></pre>
</div>