---
layout: post
title: 使用元表优化 Lua 配置文件 
tags: [lua文章]
categories: [topic]
---
<div class="main-content-wrap">
<h2 id="配置文件">配置文件</h2>
<p>在游戏工程中，通常有大量配置是由策划提供，再转换成程序方便读取的格式添加到工程中。</p>
<p>在我参与的<code>Cocos2dx-Lua</code>工程中，策划通常在<code>Excel</code>中配置，再通过脚本转换为<code>Lua-Table</code>的文件。</p>
<p>比如常见的道具表转换后：</p>
<div class="highlight"><pre class="chroma"><code class="language-Lua" data-lang="Lua"><span class="c1">-- PropModel.lua</span>
<span class="n">PropModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="mi">1001</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>          <span class="o">=</span> <span class="mi">1001</span><span class="p">,</span>
        <span class="n">name</span>        <span class="o">=</span> <span class="s2">&#34;道具1001&#34;</span><span class="p">,</span>
        <span class="n">desc</span>        <span class="o">=</span> <span class="s2">&#34;道具1001描述&#34;</span><span class="p">,</span>
        <span class="n">colorLv</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">-- 颜色等级</span>
        <span class="n">ifSell</span>      <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否可以出售</span>
        <span class="n">ifUse</span>       <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否可以使用</span>
        <span class="n">useExtraStr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>   <span class="c1">-- 使用时额外消耗的资源</span>
        <span class="n">useNeedNum</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">-- 使用消耗数量</span>
        <span class="n">maxNum</span>      <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>   <span class="c1">-- 最大堆叠数量</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="mi">1002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>          <span class="o">=</span> <span class="mi">1002</span><span class="p">,</span>
        <span class="n">name</span>        <span class="o">=</span> <span class="s2">&#34;道具1002&#34;</span><span class="p">,</span>
        <span class="n">desc</span>        <span class="o">=</span> <span class="s2">&#34;道具1002描述&#34;</span><span class="p">,</span>
        <span class="n">colorLv</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">-- 颜色等级</span>
        <span class="n">ifSell</span>      <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否可以出售</span>
        <span class="n">ifUse</span>       <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 是否可以使用</span>
        <span class="n">useExtraStr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>   <span class="c1">-- 使用时额外消耗的资源</span>
        <span class="n">useNeedNum</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">-- 使用消耗数量</span>
        <span class="n">maxNum</span>      <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>   <span class="c1">-- 最大堆叠数量</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span></code></pre></div>
<p><code>Excel</code>配置中每一行数据经过转换后对应<code>Lua-Table</code>的一个<code>item</code>。</p>
<p>通过观察可以发现其中有部分字段很容易重复，如：<code>colorLv</code>、<code>ifUse</code>、<code>useNeedNum</code>等，
这些字段通常为枚举或者有固定的分类，只有几个不同的值，然而配置表中每个<code>item</code>都需要为这些内容创建一个字段。</p>
<h2 id="优化">优化</h2>
<p>有了这些重复的字段，就给了我们优化的空间。
通过使用<code>Lua</code>的元表，可以让每个<code>item</code>拥有共同的字段而非每个<code>item</code>去创建一个字段。
从而节省内存开销。</p>
<p>如优化之后：</p>
<div class="highlight"><pre class="chroma"><code class="language-Lua" data-lang="Lua"><span class="n">PropModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="mi">1001</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>          <span class="o">=</span> <span class="mi">1001</span><span class="p">,</span>
        <span class="n">name</span>        <span class="o">=</span> <span class="s2">&#34;道具1001&#34;</span><span class="p">,</span>
        <span class="n">desc</span>        <span class="o">=</span> <span class="s2">&#34;道具1001描述&#34;</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">[</span><span class="mi">1002</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ID</span>          <span class="o">=</span> <span class="mi">1002</span><span class="p">,</span>
        <span class="n">name</span>        <span class="o">=</span> <span class="s2">&#34;道具1002&#34;</span><span class="p">,</span>
        <span class="n">desc</span>        <span class="o">=</span> <span class="s2">&#34;道具1002描述&#34;</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">-- 将重复内容提取为默认item</span>
<span class="kd">local</span> <span class="n">default__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">colorLv</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ifSell</span>      <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">ifUse</span>       <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
    <span class="n">useExtraStr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
    <span class="n">useNeedNum</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">maxNum</span>      <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">local</span> <span class="n">base</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="n">default__</span><span class="p">,</span>
<span class="p">}</span>
<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="kr">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">PropModel</span><span class="p">)</span> <span class="kr">do</span>
    <span class="n">setmetatable</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
<span class="kr">end</span></code></pre></div>
<p>这样为每个<code>item</code>设置元表后，<code>item</code>中的字段数量大幅缩减。</p>
<p>在实际生产中，这步优化被直接放在脚本中进行。在<code>Excel</code>到<code>Lua-Table</code>的过程中直接完成。</p>
<h2 id="缺点">缺点</h2>
<p>可读性变差。开发人员人工检查时需要把数据对应的<code>item</code>和<code>default__</code>组合起来看才能得到当前<code>item</code>的数据。</p>
</div>