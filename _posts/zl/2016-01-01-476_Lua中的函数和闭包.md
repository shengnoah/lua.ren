---
layout: post
title: Lua中的函数和闭包 
tags: [lua文章]
categories: [topic]
---
<div class="page-content">
    
    
    <div class="wrap-content">
      
      <p>当Lua<strong>编译一个函数的时候，会产生一个prototype</strong>，这个prototype包含了这个函数的<strong>虚拟机器指令</strong>、<strong>常量值</strong>和<strong>一些调试信息</strong>。</p>

<p>在运行的时候，任何时候，<strong>Lua执行一个function…end表达式的时候，会为这个函数创建一个新的闭包（closure）</strong>。</p>

<p>每一个闭包包含“<strong>两个引用和一个引用数组</strong>”：</p>

<ul>
  <li>对prototype的引用</li>
  <li>对闭包环境的引用（这个环境是一个table，通过它可以查找全局变量）</li>
  <li>对upvalue的引用构成的数组，可以通过这些引用来访问外部的local变量</li>
</ul>

<p>词法作用域和一流函数的结合为对外部的local变量的访问带来的困难。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">add</span><span class="err">函数</span>                     <span class="err">调用过程</span>
<span class="n">function</span> <span class="n">add</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>              <span class="n">add2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">function</span> <span class="p">(</span><span class="n">y</span><span class="p">)</span>       <span class="nb">print</span><span class="p">(</span><span class="n">add2</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<blockquote>
  <p>说明</p>

  <p>在add2被调用的时候，函数体部分需要访问外部的local变量x。但是等到add2被调用的时候，创建add2的函数add已经返回了，如果变量x是在栈中被创建的，存储它的栈存储单元在函数返回时已经不存在了。</p>
</blockquote>

<p>大多数过程式语言，通过限制词法作用域（像Python语言），或不提供一流函数（像Pascal语言），或都限制两者（像C语言），来解决上面对访问外部变量的local变量困难的问题。研究表明，非纯正的函数式语言，像Scheme和ML语言，对闭包的编译技术创建了一大堆知识。但是这些努力并没有限制编译器的复杂度。比如，仅仅Bigloo的控制流分析，一种优化的scheme编译器，是Lua的实现的10倍大。</p>

<p><strong>Lua使用一个叫做upvalue的结构来实现闭包</strong>。对任何外部的local变量的访问都是通过upvalue来进行的。upvalue原本指向变量所在的栈的槽位。当变量离开了作用域，变量会迁移到upvalue本身的槽位中。因为变量是间接通过upvalue中的指针访问的，这个迁移对任何读写变量的代码都是透明的。不像内部函数，声明变量的函数访问变量就像访问自己的local变量一样：直接在栈中。</p>

<p><strong>可变状态可以在闭包间正确地被共享，只要为每个变量创建至多一个upvalue结构，并在需要时重新利用它就行了</strong>。要确保这种唯一性，Lua保存了一个链表，这个链表包含了所有打开的upvalue（也就是说，这些upvalue仍然指向栈）。当Lua创建了一个闭包，会遍历所有外部的local变量。对于每个变量，如果能够在链表中找到一个打开的upvalue，就会重利用这个upvalue。否则，Lua会创建一个新的upvalue,并链接到这个upvalue。注意，搜索链表的时候，只会搜索部分节点，因为对于每个被内部函数使用的local变量，链表中至多有一个入口。一旦关闭的upvalue不再被任何闭包所使用，这个upvalue入口就会被当做垃圾回收。</p>

<p>函数访问不属于自己的封闭函数，而属于某个外部函数的外部local变量是可能的。在这种情况下，即使闭包已经被创建，变量可能在栈中不存在。Lua通过使用flat closure解决了这个问题。使用flat closure，任何时候某个函数访问不在自己封闭函数中的外部变量，这个变量也会进入到封闭函数的闭包中。因此，当一个函数被初始化后，这个函数用到的所有闭包中的变量，要么在该函数的栈中，要么在该函数的闭包中。</p>

<p><img src="https://hytc1106hwc.github.io/assets/lua/how-to-write-c-functions/open-and-closed-upvalue.png" alt="Upvalue开启与关闭时结构"/></p>

<ul>
  <li>
    <p>相关资料</p>

    <p>Lua发起人向JUCS提交的论文 <a href="https://hytc1106hwc.github.io/assets/attachments/The-Implementation%20-of-Lua-5.0.pdf">[下载]</a></p>
  </li>
</ul>


      
	  
<script src="http://qzonestyle.gtimg.cn/qzone/app/qzlike/qzopensl.js#jsdate=20111201" charset="utf-8"></script>
<script type="text/javascript">
	(function(){
		var p = {
			url:'https://hytc1106hwc.github.io/2018/01/30/functions-and-closures-in-lua.html',
			showcount:'0',/*是否显示分享总数,显示：'1'，不显示：'0' */
			desc:'',/*默认分享理由(可选)*/
			summary:'Lua中的函数和闭包Lua中的函数与闭包的实现机制',/*分享摘要(可选)*/
			title:'Lua中的函数和闭包',/*分享标题(可选)*/
			site:'',/*分享来源 如：腾讯网(可选)*/
			pics:'', /*分享图片的路径(可选)*/
			style:'203',
			width:98,
			height:22
		};
		var s = [];
		for(var i in p){
			s.push(i + '=' + encodeURIComponent(p[i]||''));
		}
		$("div.page-share").append(['<a version="1.0" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?',s.join('&'),'" target="_blank" rel="nofollow noopener noreferrer" >Qzone</a>'].join(''));
		/*document.write(['<a version="1.0" class="qzOpenerDiv" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?',s.join('&'),'" target="_blank" rel="noopener noreferrer">分享</a>'].join(''));*/
	})();
</script>
	  
<script src="/assets/js/jquery-qrcode-0.14.0.js"></script>
<script type="text/javascript">
	function showHideWechatCode(){
		
		var ops = {
			// render method: 'canvas', 'image' or 'div'
			render: 'canvas',

			// version range somewhere in 1 .. 40
			minVersion: 1,
			maxVersion: 40,

			// error correction level: 'L', 'M', 'Q' or 'H'
			ecLevel: 'L',

			// offset in pixel if drawn onto existing canvas
			left: 1,
			top: 1,

			// size in pixel
			size: 100,

			// code color or image element
			fill: '#000',

			// background color or image element, null for transparent background
			background: null,

			// content
			text: 'https://hytc1106hwc.github.io/2018/01/30/functions-and-closures-in-lua.html',

			// corner radius relative to module width: 0.0 .. 0.5
			radius: 0,

			// quiet zone in modules
			quiet: 0,

			// modes
			// 0: normal
			// 1: label strip
			// 2: label box
			// 3: image strip
			// 4: image box
			mode: 0,

			mSize: 0.1,
			mPosX: 0.5,
			mPosY: 0.5,

			label: 'no label',
			fontname: 'sans',
			fontcolor: '#000',

			image: null
		};

		if ($("div.weixin-container").hasClass("loaded"))
		{
			$("div.weixin-qrcode-img").empty();
			$("div.weixin-container").removeClass("loaded")
		}
		else
		{
			$("div.weixin-qrcode").html('<div class="weixin-qrcode-img"></div>');
			$("div.weixin-qrcode-img").qrcode(ops);
			$("div.weixin-container").addClass("loaded");
		}
		
		
	}

	(function(){
		$("div.page-share").append('<a href="javascript:void(0)" onclick="showHideWechatCode()" rel="nofollow">WeChat</a>');
	})();
</script>

      <section class="comment-area">
  <div class="comment-wrapper">
    
    
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//mr-brown.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> 

    </div> 
  </div>