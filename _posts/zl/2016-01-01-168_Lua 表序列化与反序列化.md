---
layout: post
title: Lua 表序列化与反序列化 
tags: [lua文章]
categories: [topic]
---
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天看了下同事写的关于 Lua 序列化的代码，觉得代码存在几个问题，其主要欠缺以下几点：</p>
<h3 id="1-支持循环引用的-table，反序列后，能正确恢复循环引用状态，如："><a href="#1-支持循环引用的-table，反序列后，能正确恢复循环引用状态，如：" class="headerlink" title="1.支持循环引用的 table，反序列后，能正确恢复循环引用状态，如："></a>1.支持循环引用的 table，反序列后，能正确恢复循环引用状态，如：</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>}</span><br/><span class="line">a.b = {<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, a}</span><br/></pre></td></tr></tbody></table></figure>

<hr/>
<h3 id="2-字符串内支持内嵌双引号、支持转义字，如一下字符串："><a href="#2-字符串内支持内嵌双引号、支持转义字，如一下字符串：" class="headerlink" title="2.字符串内支持内嵌双引号、支持转义字，如一下字符串："></a>2.字符串内支持内嵌双引号、支持转义字，如一下字符串：</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> s = <span class="string">&#34;ss&#34;aa&#34;bbncc&#34;</span></span><br/></pre></td></tr></tbody></table></figure>
<p>序列化后我希望是这样子：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="string">&#39;ss&#34;aa&#34;bbncc&#39;</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<hr/>
<h3 id="3-Table-数组部分序列化后隐藏每个值得索引值，如："><a href="#3-Table-数组部分序列化后隐藏每个值得索引值，如：" class="headerlink" title="3.Table 数组部分序列化后隐藏每个值得索引值，如："></a>3.Table 数组部分序列化后隐藏每个值得索引值，如：</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {<span class="number">4</span>, <span class="number">7</span>, <span class="number">9</span>}</span><br/></pre></td></tr></tbody></table></figure>
<p>如果保留数组的索引值，会是这样子：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">{[<span class="number">1</span>]=<span class="number">4</span>,[<span class="number">2</span>]=<span class="number">7</span>,[<span class="number">3</span>]=<span class="number">9</span>}</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>为了更加节省空间，我希望的是这样子：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">{<span class="number">4</span>,<span class="number">7</span>,<span class="number">9</span>}</span><br/></pre></td></tr></tbody></table></figure><p></p>
<hr/>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>对于以上几点要求，Google 搜了下，并没有找到满足上面需求的合适版本，于是在前人的基础上做了一些改进。<br/>实现部分，序列化函数函数为 table.tostring。反序列化函数相对来说比较简单，可以直接通过函数loadstring进行加载，下面实现为函数 table.loadstring</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(t)</span></span></span><br/><span class="line">	<span class="keyword">local</span> mark   = {}</span><br/><span class="line">	<span class="keyword">local</span> assign = {}</span><br/><span class="line"> </span><br/><span class="line">	<span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">(tbl, parent)</span></span></span><br/><span class="line">		mark[tbl] = parent</span><br/><span class="line">		<span class="keyword">local</span> tmp = {}</span><br/><span class="line">		<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(tbl) <span class="keyword">do</span></span><br/><span class="line">			<span class="keyword">local</span> typek = <span class="built_in">type</span>(k)</span><br/><span class="line">			<span class="keyword">local</span> typev = <span class="built_in">type</span>(v)</span><br/><span class="line"></span><br/><span class="line">			<span class="keyword">local</span> key = typek == <span class="string">&#34;number&#34;</span> <span class="keyword">and</span> <span class="string">&#34;[&#34;</span> .. k ..<span class="string">&#34;]&#34;</span> <span class="keyword">or</span> k</span><br/><span class="line"></span><br/><span class="line">			<span class="keyword">if</span> typev == <span class="string">&#34;table&#34;</span> <span class="keyword">then</span></span><br/><span class="line">				<span class="keyword">local</span> dotkey = parent .. (typek == <span class="string">&#34;number&#34;</span> <span class="keyword">and</span> key <span class="keyword">or</span> <span class="string">&#34;.&#34;</span> .. key)</span><br/><span class="line">				<span class="keyword">if</span> mark[v] <span class="keyword">then</span></span><br/><span class="line">					<span class="built_in">table</span>.<span class="built_in">insert</span>(assign, dotkey .. <span class="string">&#34;=&#34;</span> .. mark[v])</span><br/><span class="line">				<span class="keyword">else</span></span><br/><span class="line">					<span class="keyword">if</span> typek == <span class="string">&#34;number&#34;</span> <span class="keyword">then</span></span><br/><span class="line">						<span class="built_in">table</span>.<span class="built_in">insert</span>(tmp, serialize(v,dotkey))</span><br/><span class="line">					<span class="keyword">else</span></span><br/><span class="line">						<span class="built_in">table</span>.<span class="built_in">insert</span>(tmp, key .. <span class="string">&#34;=&#34;</span> .. serialize(v, dotkey))</span><br/><span class="line">					<span class="keyword">end</span></span><br/><span class="line">				<span class="keyword">end</span></span><br/><span class="line">			<span class="keyword">else</span></span><br/><span class="line">				<span class="keyword">if</span> typev == <span class="string">&#34;string&#34;</span> <span class="keyword">then</span></span><br/><span class="line">					v = <span class="built_in">string</span>.<span class="built_in">gsub</span>(v, <span class="string">&#34;n&#34;</span>, <span class="string">&#34;\n&#34;</span>)</span><br/><span class="line">					<span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">match</span>( <span class="built_in">string</span>.<span class="built_in">gsub</span>(v,<span class="string">&#34;[^&#39;&#34;]&#34;</span>,<span class="string">&#34;&#34;</span>), <span class="string">&#39;^&#34;+$&#39;</span> ) <span class="keyword">then</span></span><br/><span class="line">						v = <span class="string">&#34;&#39;&#34;</span> .. v .. <span class="string">&#34;&#39;&#34;</span></span><br/><span class="line">					<span class="keyword">else</span></span><br/><span class="line">						v = <span class="string">&#39;&#34;&#39;</span> .. v .. <span class="string">&#39;&#34;&#39;</span></span><br/><span class="line">					<span class="keyword">end</span></span><br/><span class="line">				<span class="keyword">else</span></span><br/><span class="line">					v = <span class="built_in">tostring</span>(v)</span><br/><span class="line">				<span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">				<span class="keyword">if</span> typek == <span class="string">&#34;number&#34;</span> <span class="keyword">then</span></span><br/><span class="line">					<span class="built_in">table</span>.<span class="built_in">insert</span>(tmp, v)</span><br/><span class="line">				<span class="keyword">else</span></span><br/><span class="line">					<span class="built_in">table</span>.<span class="built_in">insert</span>(tmp, key .. <span class="string">&#34;=&#34;</span> .. v)</span><br/><span class="line">				<span class="keyword">end</span></span><br/><span class="line">			<span class="keyword">end</span></span><br/><span class="line">		<span class="keyword">end</span></span><br/><span class="line">		<span class="keyword">return</span> <span class="string">&#34;{&#34;</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(tmp, <span class="string">&#34;,&#34;</span>) .. <span class="string">&#34;}&#34;</span></span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"> </span><br/><span class="line">	<span class="keyword">return</span> serialize(t, <span class="string">&#34;ret&#34;</span>) .. <span class="built_in">table</span>.<span class="built_in">concat</span>(assign,<span class="string">&#34; &#34;</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">table.loadstring</span><span class="params">(str)</span></span></span><br/><span class="line">	<span class="keyword">local</span> chunk = loadstring(<span class="string">&#34;do local ret = &#34;</span> .. str .. <span class="string">&#34; return ret end&#34;</span>)</span><br/><span class="line">	<span class="keyword">if</span> chunk <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">return</span> chunk()</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<p>测试代码：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {a = <span class="number">1</span>, b = <span class="number">2</span>}</span><br/><span class="line">t.rt = {c = <span class="number">3</span>, d = <span class="number">4</span>, t}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> s = <span class="built_in">table</span>.<span class="built_in">tostring</span>(t)</span><br/><span class="line"><span class="built_in">print</span>(s) </span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> tl = <span class="built_in">table</span>.loadstring(s)</span><br/><span class="line"><span class="built_in">assert</span>(tl.a == t.a)</span><br/><span class="line"></span><br/><span class="line"><span class="comment">----------------------------------------------</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> t = {[<span class="string">&#39;foo&#39;</span>]=<span class="string">&#39;bar&#39;</span>, <span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="string">&#34;ss&#34;aa&#34;bbncc&#34;</span>, <span class="string">&#34;hello&#34;</span>, {<span class="string">&#39;a&#39;</span>,<span class="string">&#39;b&#39;</span>}}</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> s = <span class="built_in">table</span>.<span class="built_in">tostring</span>(t)</span><br/><span class="line"><span class="built_in">print</span>(s) <span class="comment">-- 输出 {11,22,33,&#39;ss&#34;aa&#34;bbncc&#39;,&#34;hello&#34;,{&#34;a&#34;,&#34;b&#34;},foo=&#34;bar&#34;}</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> tl = <span class="built_in">table</span>.loadstring(s)</span><br/><span class="line"><span class="built_in">assert</span>(tl.foo == t.foo)</span><br/><span class="line"><span class="built_in">assert</span>(tl[<span class="number">4</span>] == <span class="string">&#39;ss&#34;aa&#34;bbncc&#39;</span>)</span><br/></pre></td></tr></tbody></table></figure><p></p>
<hr/>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://blog.codingnow.com/cloud/LuaSerializeTable" target="_blank" rel="noopener noreferrer">云风的个人空间</a></li>
<li><a href="http://lua-users.org/wiki/TableUtils" target="_blank" rel="noopener noreferrer">lua-users wiki</a></li>
</ul>