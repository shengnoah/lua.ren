---
layout: post
title: lua 
tags: [lua文章]
categories: [topic]
---
<h2 id="一-概述">一 概述</h2> <p><code class="highlighter-rouge">lua-upstream</code> 模块提供了对 <code class="highlighter-rouge">upstrem</code> 配置的查看，查看所有的 <code class="highlighter-rouge">upstream</code>、<code class="highlighter-rouge">upstream</code> 内所有的/启用的/备用的 <code class="highlighter-rouge">server</code>，当前使用的 <code class="highlighter-rouge">upstream</code> 名。<strong>虽然有 <code class="highlighter-rouge">set_peer_down</code> 指令，但是模块只修改单个 <code class="highlighter-rouge">worker</code> 内的 <code class="highlighter-rouge">server</code> 标记（处理 <code class="highlighter-rouge">set_peer_down</code> 请求的 <code class="highlighter-rouge">worker</code>），无法再生产环境使用</strong>。</p> <h2 id="二-示例">二 示例</h2><pre><code class="language-ngin">worker_processes  1;

error_log logs/error.log info;

events {
    worker_connections 1024;
}

http {
    
    lua_code_cache off;

    upstream backend {
        server localhost:8081 down;
        server localhost:8082;
    }

    server {
        listen 8081;
        location / {
            default_type text/plain; 
            content_by_lua_block {
                ngx.say(&#34;hello world&#34;)
            }
        }
    }
    server {
        listen 8082;
        location / {
            default_type text/plain; 
            content_by_lua_block {

                ngx.say(&#34;hello world 8082&#34;)
            }
        }
    }

    server {
        listen 8080;

				## 查看当前使用的 upstream
        location /call_upstream {
            header_filter_by_lua_block {
                local upstream = require &#34;ngx.upstream&#34;
                ngx.log(ngx.INFO,&#34;current upstream:&#34;, upstream.current_upstream_name())
            }
            proxy_pass http://backend;
        }
        
				## 查看所有 upstream
        location /status_upstream {
            content_by_lua_block {
                local upstream = require &#34;ngx.upstream&#34;
                local us = upstream.get_upstreams()
                for _, v in ipairs(us) do
                    ngx.log(ngx.INFO, &#34;upstream name:&#34;, v)
                    local servers, _ = upstream.get_servers(v)

                    if not servers then
                        ngx.log(ngx.ERR, &#34;no server in upstream&#34;)
                    else 
                        for idx, s in ipairs (servers) do
                            local msg = &#34;idx:&#34; .. idx
                            
                            for k, v in pairs (s) do
                                msg = msg .. &#34; &#34; .. k .. &#34;:&#34;
                                if type(v) == &#34;table&#34; then
                                    msg = msg .. table.concat(v, &#34;,&#34;)
                                else
                                    msg = msg .. tostring(v)
                                end
                            end

                            ngx.log(ngx.INFO, msg)
                        end
                    end
                end
            }
        }
        
        ## 将 backend 中第一个启用 server 设置为 down 状态
        location /set_upstream {
            content_by_lua_block {
                local upstream = require &#34;ngx.upstream&#34;

                upstream.set_peer_down(&#34;backend&#34;, false, 0, false)
            }
        }
    }
}
</code></pre><h3 id="1-示例运行">1. 示例运行</h3> <p>在调用 <code class="highlighter-rouge">status_upstream</code>、<code class="highlighter-rouge">set_upstream</code>、<code class="highlighter-rouge">status_upstream</code> 调用顺序中，最终并无法看到 <code class="highlighter-rouge">server</code> 被标记为 <code class="highlighter-rouge">down</code> 状态。这是 <code class="highlighter-rouge">set_peer_down</code> 修改的是 <code class="highlighter-rouge">round_robin</code> 模块中 <code class="highlighter-rouge">server</code> 的标记，<code class="highlighter-rouge">get_servers</code> 读取的是配置结构体（<code class="highlighter-rouge">ngx_http_upstream_server_t</code>）中的内容。</p> <h3 id="2-get_servers-函数">2. <code class="highlighter-rouge">get_servers</code> 函数</h3> <p>如果 <code class="highlighter-rouge">server</code> 未指定 <code class="highlighter-rouge">down/backup</code> 标记，在 <code class="highlighter-rouge">get_servers</code> 函数返回值中不会包含 <code class="highlighter-rouge">down/backup</code> 状态。</p> <h2 id="三-后记">三 后记</h2> <p>在 <code class="highlighter-rouge">lua-upstream</code> 模块的 <code class="highlighter-rouge">TODO</code> 中有提及动态添加、删除 <code class="highlighter-rouge">server</code> 的考虑，到时候应该会更好用。</p> <h2 id="四-链接">四 链接</h2> <ul> <li><em><a href="https://github.com/openresty/lua-upstream-nginx-module">项目连接</a></em></li> </ul>