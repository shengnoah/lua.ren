---
layout: post
title: Lua 学习 chapter28  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>基础知识</li>
  <li>操作表</li>
  <li>一些简便方法</li>
  <li>调用lua函数</li>
</ol>

<blockquote>
  <p>回顾复习加巩固，自己应该认真地学习复习和巩固，并不是只有学习新知识是自己最重要的，而是复习和巩固才是自己最重要的，所以自己每天必须抽出一定的时间对自己的学习进行复习和巩固。</p>
</blockquote>

<h2 id="基础知识">基础知识</h2>

<p>lua可以作为配置文件来供c语言使用，例如我们来定义一个窗口的大小。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>width = 200
height = 300
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后我们使用LuaAPI来指挥lua语言解析该文件，并获取width和height的值。</p>

<ul>
  <li>luaL_loadfile(lua_State *L, fname):加载文件并且编译，返回一个执行这个文件的函数，放到栈顶</li>
  <li>lua_pcall(L,0,0,0):调用栈中的函数，第二个参数为函数参数的个数，第三个参数为返回值的个数，第四个参数为错误处理函数。在压入结果之前，pcall函数会将参数和函数出栈，将返回值从第一个按照顺序压入栈中。至于最后一个参数为零，则lua会把错误信息作为string压倒栈中，如果是函数，第四个参数为它在栈中的索引，一般这个错误处理函数应该在被压入栈且位于待调用函数之下。</li>
  <li>lua_getglobal(lua_State *L, const char *key):根据key值获取全局变量，并放到栈顶。</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;stdarg.h&gt;
#include&lt;stdlib.h&gt;
</span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
<span class="cp">#include &lt;lua.h&gt;
#include &lt;lauxlib.h&gt;
#include &lt;lualib.h&gt;
</span><span class="p">}</span>

<span class="kt">int</span> <span class="nf">getglobint</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">var</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">load</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fname</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">h</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span><span class="c1">//打开lua</span>
	<span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span><span class="c1">//打开标准库</span>

	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">load</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d %d&#34;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">getglobint</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">isnum</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span><span class="c1">//将相应的全局变量的值压入到栈中。</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lua_tointegerx</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isnum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isnum</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;&#39;%s&#39; should be a number </span><span class="se">n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">load</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fname</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">luaL_loadfile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span> <span class="o">||</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="c1">//loadfile加载代码，pcall运行编译后的代码段</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;cannot  run config. file %s&#34;</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">getglobint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;width&#34;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">getglobint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;height&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">argp</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
	<span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>


<span class="err">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="操作表">操作表</h2>

<p>现在我们要为每个窗口配置一种背景色，假设最终的颜色格式是由三个数字分量组成的RGB颜色。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>width = 200
height = 300
BLUE = {red = 0,green = 0,blue = 1.0}
background = BLUE
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们可以对表进行操作，具体用到的函数：</p>

<ul>
  <li>lua_pushstring(L,key)</li>
  <li>lua_gettable(L,-2) //-2是表的索引，它会pop出key，然后根据key取值，并把值放到栈中</li>
  <li>lua_getfield(L,-1,key)//相当于上面的两步，这个函数会返回结果的类型</li>
  <li>lua_pushnumber(L,val)</li>
  <li>lua_pushstring(L,key)</li>
  <li>lua_settable(L,-3)// -3是表的索引，它会pop出val，key，然后给表设置值。</li>
  <li>lua_setfield(L,-2,key)// 相当于上面的两步，它会pop出val然后根据key设置值。</li>
  <li>lua_createtable(L,int narr,int nrec):narr,表示连续的值个数，nrec表示hash的值个数。</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="rouge-code"><pre><span class="cp">#include&lt;stdio.h&gt;
#include&lt;string.h&gt;
#include&lt;stdarg.h&gt;
#include&lt;stdlib.h&gt;
</span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
<span class="cp">#include &lt;lua.h&gt;
#include &lt;lauxlib.h&gt;
#include &lt;lualib.h&gt;
</span><span class="p">}</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">MAX_COLOR</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ColorTable</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">}</span><span class="n">colortable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&#34;WHITE&#34;</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;RED&#34;</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;GREEN&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;BLUE&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_COLOR</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">getglobint</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">var</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">load</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fname</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">h</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="nf">getColor</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">b</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">getcolorfield</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">setcolor</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span><span class="k">struct</span> <span class="n">ColorTable</span> <span class="o">*</span><span class="n">ct</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">setcolorfield</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">();</span><span class="c1">//打开lua</span>
	<span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span><span class="c1">//打开标准库</span>

	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>
	<span class="n">load</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d %d </span><span class="se">n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">getColor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;background&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">green</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blue</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">t</span><span class="s">%d</span><span class="se">t</span><span class="s">%d</span><span class="se">n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">colortable</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">setcolor</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">colortable</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">getglobint</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">isnum</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lua_tointegerx</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isnum</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isnum</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;&#39;%s&#39; should be a number </span><span class="se">n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">load</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fname</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">luaL_loadfile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">fname</span><span class="p">)</span> <span class="o">||</span> <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;cannot  run config. file %s&#34;</span><span class="p">,</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">getglobint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;width&#34;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">getglobint</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;height&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">argp</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">argp</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">argp</span><span class="p">);</span>
	<span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">getColor</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lua_istable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;&#39;%s&#39; is not a table&#34;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">getcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;red&#34;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">g</span> <span class="o">=</span> <span class="n">getcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;green&#34;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">getcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;blue&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">getcolorfield</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">isnum</span><span class="p">;</span>
	<span class="n">lua_getfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">lua_tonumberx</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isnum</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_COLOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isnum</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;invalid component &#39;%s&#39; in color&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lua_pop</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setcolor</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">ColorTable</span><span class="o">*</span> <span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lua_newtable</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
	<span class="n">setcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;red&#34;</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">);</span>
	<span class="n">setcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;green&#34;</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">);</span>
	<span class="n">setcolorfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;blue&#34;</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">);</span>
	<span class="n">lua_setglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">setcolorfield</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lua_pushstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">lua_pushnumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="kt">double</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAX_COLOR</span><span class="p">);</span>
	<span class="n">lua_settable</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
	<span class="c1">//lua_setfield(L, -2, index); lua_setfield是将pushstring和settable结合起来的</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="调用lua函数">调用lua函数</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="rouge-code"><pre><span class="c1">//一个通用的调用函数</span>
<span class="c1">//这里vl其实就是一个指针，指向了参数的地址。</span>
<span class="c1">//</span>
<span class="c1">//va_start()所做的就是让vl指向函数的最后一个确定的参数（声明程序中是sig）的下一个参数的地址。</span>
<span class="c1">//</span>
<span class="c1">//va_arg()所做的就是根据vl指向的地址，和第二个参数所确定的类型，将这个参数的中的数据提取出来，作为返回值，同时让ap指向下一个参数。</span>
<span class="c1">//</span>
<span class="c1">//va_end()所做的就是让vl这个指针指向0。</span>
<span class="kt">void</span> <span class="nf">call_va</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sig</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">vl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">narg</span><span class="p">,</span> <span class="n">nres</span><span class="p">;</span> <span class="c1">//参数和结果的个数</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">vl</span><span c