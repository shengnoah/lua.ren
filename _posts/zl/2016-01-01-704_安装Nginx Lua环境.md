---
layout: post
title: 安装Nginx Lua环境 
tags: [lua文章]
categories: [topic]
---
<h2 id="环境准备">环境准备：</h2>

<blockquote>
<p>$ yum -y install pcre-devel</p>

<p>$ yum -y install openssl openssl-devel</p>
</blockquote>

<h3 id="下载所需文件">下载所需文件</h3>

<p>亦可参考官方安装指南：<a href="https://github.com/openresty/lua-nginx-module#installation">lua-nginx-module Installation</a></p>

<p>这是我总结的安装，供参考：</p>

<p>需要最新版的Nginx，LuaJIT，ngx_devel_kit，lua-nginx-module等安装文件:</p>

<ul>
<li><a href="http://nginx.org/en/download.html">Nginx</a></li>
<li><a href="http://luajit.org/download.html">LuaJIT</a> Lua或者LuaJIT都是可以的，但是出于性能的考虑，推荐安装LuaJIT</li>
<li><a href="https://github.com/simpl/ngx_devel_kit/tags">ngx_devel_kit</a></li>
<li><a href="https://github.com/openresty/lua-nginx-module/tags">lua-nginx-module</a></li>
</ul>

<p>参考命令下载：</p>

<blockquote>
<p>$ curl -O <a href="http://nginx.org/download/nginx-1.10.1.tar.gz">http://nginx.org/download/nginx-1.10.1.tar.gz</a></p>

<p>$ curl -O <a href="http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz">http://luajit.org/download/LuaJIT-2.1.0-beta2.tar.gz</a></p>

<p>$ curl -L -O <a href="https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz">https://github.com/simpl/ngx_devel_kit/archive/v0.2.19.tar.gz</a></p>

<p>$ curl -L -O <a href="https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz">https://github.com/openresty/lua-nginx-module/archive/v0.10.5.tar.gz</a></p>
</blockquote>

<h2 id="安装luajit">安装LuaJIT</h2>

<blockquote>
<p>$ wget <a href="http://luajit.org/download/LuaJIT-">http://luajit.org/download/LuaJIT-</a><version>.tar.gz</version></p>

<p>$ tar zxvf LuaJIT-<version>.tar.gz</version></p>

<p>$ cd LuaJIT-<version></version></p>

<p>$ make</p>

<p>$ sudo make install</p>
</blockquote>

<h2 id="编译安装lua-nginx-module">编译安装lua-nginx-module</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">export LUAJIT_LIB=/usr/local/lib
export LUAJIT_INC=/usr/local/include/luajit-2.1

cd nginx-1.10.1
./configure --prefix=/opt/nginx  --with-ld-opt=&#34;-Wl,-rpath,/usr/local/lib&#34;  --add-module=/path/to/ngx_devel_kit-0.3.0  --add-module=/path/to/nginx/lua-nginx-module-0.10.5
make
make install</pre></td></tr></tbody></table>
</div>
</div>
<h2 id="动态module方式">动态module方式</h2>

<p>Nginx 1.9.11 开始可以编译module为一个动态module，在执行./configure命令时用–add-dynamic-module=PATH替换–add-module=PATH。编译后可以在nginx.conf配置中使用 load_module 来动态加载这个module：</p>

<blockquote>
<p>load_module /path/to/modules/ndk_http_module.so;</p>

<p>load_module /path/to/modules/ngx_http_lua_module.so;</p>
</blockquote>

<h2 id="lua-cjson-install">lua cjson install</h2>

<p>Eureka Zuul 网关
  安装编译cjson需要lua运行时，编译前需要修改MakeFile中的LUA_VERSION、LUA_INCLUDE_DIR、LUA_CMODULE_DIR参数，让cjson模块知道lua库文件和头文件目录，才可以正常编译安装。</p>

<p>下载解压：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">wget http://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz
tar -zxvf cjson-2.1.0.tar.gz
cd cjson-2.1.0</pre></td></tr></tbody></table>
</div>
</div>
<p>修改MakeFile：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tbody><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">LUA_VERSION =  luajit-2.1
LUA_INCLUDE_DIR =   $(PREFIX)/include/$(LUA_VERSION)
LUA_CMODULE_DIR =   $(PREFIX)/lib


make &amp; sudo make install
sudo cp cjson.so /usr/local/lib/lua/5.1/</pre></td></tr></tbody></table>
</div>
</div>