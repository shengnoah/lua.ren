---
layout: post
title: centos下安装openresty+ngx_lua_waf防火墙部署 
tags: [lua文章]
categories: [topic]
---
<p>全文默认安装路径：/usr/local/src</p>

<h3 id="1、安装Luagit"><a href="#1、安装Luagit" class="headerlink" title="1、安装Luagit:"></a>1、安装Luagit:</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line"># cd /usr/local/src</span><br/><span class="line"># wget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz</span><br/><span class="line"># tar -zxvf LuaJIT-2.1.0-beta3.tar.gz</span><br/><span class="line"># cd LuaJIT-2.1.0-beta3</span><br/><span class="line"># make</span><br/><span class="line"># make install</span><br/><span class="line">#ln -sf luajit-2.1.0-beta3 /usr/local/bin/luajit</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="2、安装openresty"><a href="#2、安装openresty" class="headerlink" title="2、安装openresty:"></a>2、安装openresty:</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"># cd /usr/local/src</span><br/><span class="line"># wget http://openresty.org/download/ngx_openresty-1.13.6.2.tar.gz</span><br/><span class="line"># wget https://sourceforge.net/projects/pcre/files/pcre/8.42/pcre-8.42.tar.gz</span><br/><span class="line"># tar -zvxf pcre-8.42.tar.gz</span><br/><span class="line"># tar -zvxf ngx_openresty-1.13.6.2.tar.gz</span><br/><span class="line"># cd ngx_openresty-1.13.6.2.tar.gz</span><br/><span class="line"># ./configure --prefix=/usr/local/openresty --with-luajit --with-pcre=/usr/local/src/pcre-8.42/ --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module</span><br/><span class="line"># gmake &amp;&amp; gmake install</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="3、下载ngx-lua-waf"><a href="#3、下载ngx-lua-waf" class="headerlink" title="3、下载ngx_lua_waf"></a>3、下载ngx_lua_waf</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"># cd /usr/local/openresty/nginx/</span><br/><span class="line"># git clone https://github.com/loveshell/ngx_lua_waf.git</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="4、修改nginx添加配置，支持lua脚本地址，在http段位置："><a href="#4、修改nginx添加配置，支持lua脚本地址，在http段位置：" class="headerlink" title="4、修改nginx添加配置，支持lua脚本地址，在http段位置："></a>4、修改nginx添加配置，支持lua脚本地址，在http段位置：</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">###相关项目存放地址</span><br/><span class="line">lua_package_path &#34;/usr/local/openresty/nginx/ngx_lua_waf/?.lua&#34;;</span><br/><span class="line">###存放limit表的大小</span><br/><span class="line">lua_shared_dict limit 10m;</span><br/><span class="line">###相应地址</span><br/><span class="line">init_by_lua_file  /usr/local/openresty/nginx/ngx_lua_waf/init.lua;</span><br/><span class="line">access_by_lua_file /usr/local/openresty/nginx/ngx_lua_waf/waf.lua;</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="5、修改ngx-lua-waf相关配置："><a href="#5、修改ngx-lua-waf相关配置：" class="headerlink" title="5、修改ngx_lua_waf相关配置："></a>5、修改ngx_lua_waf相关配置：</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line">RulePath = &#34;/usr/local/openresty/nginx/ngx_lua_waf/wafconf/&#34;   ##指定相应位置</span><br/><span class="line">attacklog = &#34;on&#34;                            ##开启日志</span><br/><span class="line">logdir = &#34;/usr/local/openresty/nginx/logs/hack/&#34;           ##日志存放位置</span><br/><span class="line">UrlDeny=&#34;on&#34;                              ##是否开启URL防护</span><br/><span class="line">Redirect=&#34;on&#34;                             ##地址重定向</span><br/><span class="line">CookieMatch=&#34;on&#34;                           ##cookie拦截</span><br/><span class="line">postMatch=&#34;on&#34;                            ##post拦截</span><br/><span class="line">whiteModule=&#34;on&#34;                           ##白名单</span><br/><span class="line">black_fileExt={&#34;php&#34;,&#34;jsp&#34;}                        </span><br/><span class="line">ipWhitelist={&#34;127.0.0.1&#34;}                    ##白名单IP</span><br/><span class="line">ipBlocklist={&#34;1.0.0.1&#34;}                     ##黑名单IP</span><br/><span class="line">CCDeny=&#34;on&#34;                             ##开启CC防护        </span><br/><span class="line">CCrate=&#34;100/60&#34;                          ##60秒内允许同一个IP访问100次</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="6、创建日志存放目录："><a href="#6、创建日志存放目录：" class="headerlink" title="6、创建日志存放目录："></a>6、创建日志存放目录：</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"># mkdir /usr/local/openresty/nginx/logs/hack/</span><br/><span class="line"># chown -R nobody:nobody /usr/local/openresty/nginx/logs/hack/</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="7、启动nginx-测试"><a href="#7、启动nginx-测试" class="headerlink" title="7、启动nginx 测试"></a>7、启动nginx 测试</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"># cd /usr/local/openresty/nginx/sbin</span><br/><span class="line"># ./nginx</span><br/></pre></td></tr></tbody></table></figure>