---
layout: post
title: Lua封装 [ 奔跑的蜗牛 ] 
tags: [lua文章]
categories: [topic]
---
<p class="page-title-sub">
      <span id="post-title-date">撰写于 2018-05-25</span>
      
        <span id="post-title-updated">修改于 2018-05-25</span>
      
      
      <span id="post-title-categories">分类
      
      
        
        
        <a href="/categories/高级Lua/">高级Lua</a>
      
      </span>
      
      
      <span id="post-title-tags">
      标签
      
      
        
        
        <a href="/tags/Lua/">Lua</a>
      
      </span>
      
    </p>
    
    <p>lua本身是不具有OO的特性，但是里面有一些特殊性东西可以帮助lua实现OO，例如可以巧妙的使用metatable，实现继承；lua的底层是<br/>C，本事是不支持多态，但是可以通过覆盖，实现简单的函数的多态。那封装是怎么实现的呢？</p>
<p>lua的封装很简单，为了防止命名污染，工程里面一般使用的一个table，把自定义的函数和变量存入里面，这样就保证了这些变量和函数的名字有了独立的命名空间，大概如下：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> P = {}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">(x)</span></span></span><br/><span class="line">	<span class="keyword">return</span> <span class="built_in">tonumber</span>(x)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">P:new</span><span class="params">()</span></span></span><br/><span class="line">	<span class="keyword">local</span> o = {}</span><br/><span class="line">	<span class="built_in">setmetatable</span>(o, self)</span><br/><span class="line">	self._index = self</span><br/><span class="line">	<span class="keyword">return</span> o</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">P:add</span><span class="params">(x, y)</span></span></span><br/><span class="line">	<span class="keyword">local</span> x_num = self:toNumber(x)</span><br/><span class="line">	<span class="keyword">local</span> y_num = self:toNumber(y)</span><br/><span class="line">	<span class="keyword">if</span> x_num <span class="keyword">and</span> y_num <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">return</span> x_num + y_num</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> P</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>如果我们不想让函数 toNumer “暴露”出去，只在内部使用，也就相当于OO的私有函数，怎么处理呢？很简单，不把 toNumber 放在 P 中就好了，这样函数就不会暴露出去。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> P = {}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toNumer</span><span class="params">(x)</span></span></span><br/><span class="line">	<span class="keyword">return</span> <span class="built_in">tonumber</span>(x)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">P:new</span><span class="params">()</span></span></span><br/><span class="line">	<span class="keyword">local</span> o = {}</span><br/><span class="line">	<span class="built_in">setmetatable</span>(o, self)</span><br/><span class="line">	self._index = self</span><br/><span class="line">	<span class="keyword">return</span> o</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">P:add</span><span class="params">(x, y)</span></span></span><br/><span class="line">	<span class="keyword">local</span> x_num = self:toNumber(x)</span><br/><span class="line">	<span class="keyword">local</span> y_num = self:toNumber(y)</span><br/><span class="line">	<span class="keyword">if</span> x_num <span class="keyword">and</span> y_num <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">return</span> x_num + y_num</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> P</span><br/></pre></td></tr></tbody></table></figure>
<p>还有一种方法，就是把所有的函数都定义为局部函数，把需要暴露出去的函数放入table中，这样我们不再需要调用函数的时候在前面加上前缀，公有的和私有的函数调用方法相同。在package的结尾处，有一个简单的列表列出所有公有的函数。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toNumer</span><span class="params">(x)</span></span></span><br/><span class="line">	<span class="keyword">return</span> <span class="built_in">tonumber</span>(x)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">()</span></span></span><br/><span class="line">	<span class="keyword">local</span> o = {}</span><br/><span class="line">	<span class="built_in">setmetatable</span>(o, self)</span><br/><span class="line">	self._index = self</span><br/><span class="line">	<span class="keyword">return</span> o</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(x, y)</span></span></span><br/><span class="line">	<span class="keyword">local</span> x_num = self:toNumber(x)</span><br/><span class="line">	<span class="keyword">local</span> y_num = self:toNumber(y)</span><br/><span class="line">	<span class="keyword">if</span> x_num <span class="keyword">and</span> y_num <span class="keyword">then</span></span><br/><span class="line">		<span class="keyword">return</span> x_num + y_num</span><br/><span class="line">	<span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> {new = new, add = add}</span><br/></pre></td></tr></tbody></table></figure>
<p><a href="http://book.luaer.cn/_92.htm" target="_blank" rel="noopener noreferrer">参考文献:lua手册</a></p>