---
layout: post
title: lua学习笔记（一）:根据user 
tags: [lua文章]
categories: [topic]
---
<blockquote>
  <p>同一个url，https://www.baidu.com/，在电脑上打开，展示pc页面，在手机上打开，则显示移动端页面，对此很是好奇,
如何才能实现这功能呢？</p>
</blockquote>

<h4 id="js去控制">js去控制？</h4>

<p>遇到这个问题，首先想到的思路是根据浏览器内的user-agent属性去区分pc端和移动端，继而很自然的想到，
在js里使用<kbd>navigator.userAgent</kbd>获得user-agent，并直接在js里做跳转</p>

<p>比如：访问mattina.cn，默认展示pc.html</p>

<p>在pc.html内:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var ua = navigator.userAgent.toLowerCase(); 
if(ua.match(/regexHere/))
	location.href= &#39;mobile.html&#39;;
</code></pre></div></div>

<p>这样可以打到文章开头提到的效果，但是会有一个弊端，移动端访问，页面势必会再刷新一次，对用户体验很不好</p>

<p>js中转页面跳转，放弃！</p>

<h4 id="nginxlua">nginx+lua</h4>

<p>在学习了一段时间的openresty后，准备用lua来实现同一个url，pc和移动端定向到不同页面</p>

<p>openresty的基础知识就不赘述了，这里主要提几个相关指令</p>

<h5 id="ngxreqset_uri">ngx.req.set_uri</h5>

<p>语法:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngx.req.set_uri(uri, [jump])
</code></pre></div></div>

<p>重写当前的请求至uri，jump非必填，默认为false，如果为true，则表示重写后的uri会重新匹配nginx里的location，如果为false，则不会。</p>

<h5 id="ngxredirect">ngx.redirect</h5>

<p>语法：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngx.redirect(uri, [status])
</code></pre></div></div>

<p>该方法会给客户端返回一个301/302重定向，具体是301还是302取决于设定的status值，如果不指定status值，默认是返回302 (ngx.HTTP_MOVED_TEMPORARILY)</p>

<p>301重定向不仅能使页面实现自动跳转，对于搜索引擎来说，也可能可以传递PR值。</p>

<p>下面，开始做测试！</p>

<h5 id="一些前期准备工作">一些前期准备工作</h5>

<p>在搭建好openresty环境后，配置了两个location，用来测试</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server{
	listen 80;
	server_name mattina.cn;
	location /mobile {
		root   html;    
		index  mobile.html;
	}
	location /pc {
		root   html;
		index  pc.html;
	}
}
</code></pre></div></div>

<p><a href="http://mattina.cn/pc" target="_blank" rel="noopener noreferrer">mattina.cn/pc</a>,代表pc页面</p>

<p><a href="http://mattina.cn/mobile" target="_blank" rel="noopener noreferrer">mattina.cn/mobile</a>,代表移动页面</p>

<p>我们用主域名mattina.cn来做起始页面</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
    rewrite_by_lua &#39;
        require(&#34;ua.ua&#34;).redirect_by_user_agent()
   &#39;;
}
</code></pre></div></div>

<p>这里使用的‘rewrite_by_lua’，是lua模块里的常用命令，具体可以翻阅<a href="http://xuewb.com/index.html">OpenResty最佳实践</a></p>

<p>万事俱备，只欠lua脚本了</p>

<h5 id="lua脚本">lua脚本</h5>

<p>为了根据user-agent区分pc还是移动端，需要定义好匹配规则</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mobileUserAgent = {
                    &#34;mobile&#34;,&#34;android&#34;,&#34;iphone&#34;,
                    &#34;blackberry&#34;, &#34;webos&#34;, &#34;ipod&#34;, &#34;lge vx&#34;, &#34;midp&#34;, &#34;maemo&#34;, &#34;mmp&#34;, &#34;mobile&#34;,
                    &#34;netfront&#34;, &#34;hiptop&#34;, &#34;nintendo DS&#34;, &#34;novarra&#34;, &#34;openweb&#34;, &#34;opera mobi&#34;,
                    &#34;opera mini&#34;, &#34;palm&#34;, &#34;psp&#34;, &#34;phone&#34;, &#34;smartphone&#34;, &#34;symbian&#34;, &#34;up.browser&#34;,
                    &#34;up.link&#34;, &#34;wap&#34;, &#34;windows ce&#34;
                 }
</code></pre></div></div>

<p>在redirect_by_user_agent函数中，首先需要获取请求携带的user-agent信息</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local userAgent = string.lower(ngx.req.get_headers().user_agent)
</code></pre></div></div>

<p>这里转换为小写，是为了后续正则匹配方便</p>

<p>这里仅仅做一个例子，根据自己的需求增删</p>

<p>在拿到user-agent之后，便开始匹配：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local matchUa
for i,v in ipairs(mobileUserAgent) do
    matchUa=string.match(userAgent,v)
    if matchUa then
        return ngx.req.set_uri(&#34;/mobile&#34;, true)
    end
end
return ngx.req.set_uri(&#34;/pc&#34;, true)
</code></pre></div></div>

<p>如果想跳转到其他域名，可以使用</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngx.redirect(target,ngx.HTTP_MOVED_TEMPORARILY)
</code></pre></div></div>

<p>比如判断该url是微信浏览器访问，则调转微信oauth链接：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if matchUa then
     local fullUrl = ngx.var.scheme..&#34;://&#34;..ngx.var.host..ngx.var.request_uri
     local encodeUrl = urlcodec.encodeURI(fullUrl)    // url编码
     local target = ouathPrefix .. encodeUrl
     return ngx.redirect(target,ngx.HTTP_MOVED_TEMPORARILY)
end
</code></pre></div></div>

<h4 id="存在问题静态资源">存在问题:静态资源</h4>

<p>如果单纯用上述lua脚本去控制跳转，会存在这样一个问题：页面内的静态资源也被lua重定向，导致获取不到</p>

<p>需要在lua里对静态资源单独判断并跳转到静态资源的location</p>

<h4 id="成果">成果</h4>

<p>访问</p>

<p><a href="http://mattina.cn" target="_blank" rel="noopener noreferrer">mattina.cn</a></p>

<p>在电脑端浏览器里打开，展示“PC PAGE”</p>

<p>在手机里，或者chrome审查模式里模拟移动端访问，展示“MOBILE PAGE”</p>

<blockquote>
  <p>chrome里ctrl+shift+i 调出审查模式，然后ctrl+shift+m切换成移动端模拟器</p>
</blockquote>


                <hr/>