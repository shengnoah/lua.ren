---
layout: post
title: Redis实现分布式锁Lua脚本 
tags: [lua文章]
categories: [topic]
---
<h3 id="简单锁"><a href="#简单锁" class="headerlink" title="简单锁"></a>简单锁</h3><p>采用键值对存储，键是锁的标识，值是全局唯一值（如uuid）。</p>
<h4 id="获取锁"><a href="#获取锁" class="headerlink" title="获取锁"></a>获取锁</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>] <span class="comment">-- 锁标识</span></span><br/><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>] <span class="comment">-- 全局唯一值</span></span><br/><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>]) <span class="keyword">or</span> <span class="number">0</span> <span class="comment">-- 过期时间，默认不过期</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#39;setnx&#39;</span>, key, value) == <span class="number">1</span>) <span class="keyword">then</span></span><br/><span class="line">    <span class="keyword">if</span> (ttl &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br/><span class="line">        redis.call(<span class="string">&#39;expire&#39;</span>, key, ttl)</span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="释放锁"><a href="#释放锁" class="headerlink" title="释放锁"></a>释放锁</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>] <span class="comment">-- 锁标识</span></span><br/><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>] <span class="comment">-- 全局唯一值</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#39;get&#39;</span>, key) == value) <span class="keyword">then</span></span><br/><span class="line">    redis.call(<span class="string">&#39;del&#39;</span>, key)</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line">    </span><br/><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h4><p>将获取锁和释放锁的代码分别保存到lock_aquire.lua和lock_release.lua文件。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ vi lock_aquire.lua</span><br/><span class="line">$ vi lock_release.lua</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>将两个lua脚本文件加载到redis中，分别返回一个sha值。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">$ redis-cli script load <span class="string">&#34;<span class="variable">$(cat lock_aquire.lua)</span>&#34;</span></span><br/><span class="line"><span class="string">&#34;cc5c8c3fe44fb651fb06e4c39300749ced0ae22b&#34;</span></span><br/><span class="line">$ redis-cli script load <span class="string">&#34;<span class="variable">$(cat lock_release.lua)</span>&#34;</span></span><br/><span class="line"><span class="string">&#34;c6a18bc663c9d324644615321834667b914b8350&#34;</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>在redis客户端中执行evalsha命令，传入步骤2生成的sha值。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line">redis&gt; evalsha cc5c8c3fe44fb651fb06e4c39300749ced0ae22b 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111获取锁成功</span></span><br/><span class="line">redis&gt; evalsha cc5c8c3fe44fb651fb06e4c39300749ced0ae22b 1 dist_lock 222222</span><br/><span class="line">(<span class="built_in">integer</span>) 0     <span class="comment"># 客户端222222获取锁失败</span></span><br/><span class="line">redis&gt; evalsha c6a18bc663c9d324644615321834667b914b8350 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111释放锁成功</span></span><br/><span class="line">redis&gt; evalsha cc5c8c3fe44fb651fb06e4c39300749ced0ae22b 1 dist_lock 222222</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端222222获取锁成功</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="可重入锁"><a href="#可重入锁" class="headerlink" title="可重入锁"></a>可重入锁</h3><p>采用Hash结构存储，只有一个字段，字段的键是全局唯一值（如uuid），代表锁的拥有者，字段的值是个计数器。每获取一次锁计数器加1，每释放一次锁计数器减1，当计数器减为0时删除锁。</p>
<h4 id="获取锁-1"><a href="#获取锁-1" class="headerlink" title="获取锁"></a>获取锁</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>] <span class="comment">-- 锁标识</span></span><br/><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>] <span class="comment">-- 全局唯一值</span></span><br/><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>]) <span class="keyword">or</span> <span class="number">0</span> <span class="comment">-- 过期时间，默认不过期</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#39;exists&#39;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br/><span class="line">    redis.call(<span class="string">&#39;hincrby&#39;</span>, key, value, <span class="number">1</span>)</span><br/><span class="line">    <span class="keyword">if</span> (ttl &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br/><span class="line">        redis.call(<span class="string">&#39;expire&#39;</span>, key, ttl)</span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#39;hexists&#39;</span>, key, value) == <span class="number">1</span>) <span class="keyword">then</span></span><br/><span class="line">    redis.call(<span class="string">&#39;hincrby&#39;</span>, key, value, <span class="number">1</span>)</span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="释放锁-1"><a href="#释放锁-1" class="headerlink" title="释放锁"></a>释放锁</h4><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>] <span class="comment">-- 锁标识</span></span><br/><span class="line"><span class="keyword">local</span> value = ARGV[<span class="number">1</span>] <span class="comment">-- 全局唯一值</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#39;hexists&#39;</span>, key, value) == <span class="number">1</span>) <span class="keyword">then</span></span><br/><span class="line">    <span class="comment">-- 当计数器为0时才真正删除锁</span></span><br/><span class="line">    <span class="keyword">if</span> (redis.call(<span class="string">&#39;hincrby&#39;</span>, key, value, <span class="number">-1</span>) &lt; <span class="number">1</span>) <span class="keyword">then</span></span><br/><span class="line">        redis.call(<span class="string">&#39;del&#39;</span>, key)</span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="运行效果-1"><a href="#运行效果-1" class="headerlink" title="运行效果"></a>运行效果</h4><p>将获取锁和释放锁的代码分别保存到lock_aquire.lua和lock_release.lua文件。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ vi lock_aquire.lua</span><br/><span class="line">$ vi lock_release.lua</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>将两个lua脚本文件加载到redis中，分别返回一个sha值。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">$ redis-cli script load <span class="string">&#34;<span class="variable">$(cat lock_aquire.lua)</span>&#34;</span></span><br/><span class="line"><span class="string">&#34;464f5e1f5a94422063a0ed087e4e545dd7786d07&#34;</span></span><br/><span class="line">$ redis-cli script load <span class="string">&#34;<span class="variable">$(cat lock_release.lua)</span>&#34;</span></span><br/><span class="line"><span class="string">&#34;f33de5bbd21fcb322e226d1ebcb5a6fdd51f4f2f&#34;</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>在redis客户端中执行evalsha命令，传入步骤2生成的sha值。<br/></p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/></pre></td><td class="code"><pre><span class="line">redis&gt; evalsha 464f5e1f5a94422063a0ed087e4e545dd7786d07 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111获取锁成功</span></span><br/><span class="line">redis&gt; evalsha 464f5e1f5a94422063a0ed087e4e545dd7786d07 1 dist_lock 222222</span><br/><span class="line">(<span class="built_in">integer</span>) 0     <span class="comment"># 客户端222222获取锁失败</span></span><br/><span class="line">redis&gt; evalsha 464f5e1f5a94422063a0ed087e4e545dd7786d07 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111再次获取锁</span></span><br/><span class="line">redis&gt; evalsha f33de5bbd21fcb322e226d1ebcb5a6fdd51f4f2f 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111释放锁成功</span></span><br/><span class="line">redis&gt; evalsha f33de5bbd21fcb322e226d1ebcb5a6fdd51f4f2f 1 dist_lock 111111</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端111111再次释放锁</span></span><br/><span class="line">redis&gt; evalsha 464f5e1f5a94422063a0ed087e4e545dd7786d07 1 dist_lock 222222</span><br/><span class="line">(<span class="built_in">integer</span>) 1     <span class="comment"># 客户端222222获取锁成功</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="http://redisdoc.com/" target="_blank" rel="noopener noreferrer">Redis 命令参考</a></li>
</ul>