---
layout: post
title: lua读取redis数据的null判断 
tags: [lua文章]
categories: [topic]
---
<p>最近在配合移动端调试的时候，被抓去debug一个在清除redis缓存之后才会出现的网关错误。于是打开服务器上的log定位到类似错误:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">[error] 7#7: *12030 lua entry thread aborted: runtime error: /data/share/apps/lua/access_check.lua:133: bad argument #1 to &#39;decode&#39; (string expected, got userdata)</span><br/></pre></td></tr></tbody></table></figure>
<p>该段代码的主要作用是在<code>openresty</code>中<code>lua</code>读取<code>redis</code>中数据并解码为<code>json</code>：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> access_token = redis_client:read_by_key(token_key)</span><br/><span class="line">   <span class="keyword">if</span> access_token == <span class="literal">nil</span> <span class="keyword">then</span></span><br/><span class="line">       </span><br/><span class="line">       <span class="keyword">return</span> <span class="literal">false</span></span><br/><span class="line">   <span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">   <span class="keyword">local</span> obj_token = cjson.decode(access_token)</span><br/><span class="line">   <span class="comment">-- do something</span></span><br/></pre></td></tr></tbody></table></figure>
<p>通过查询资料得知原因：<strong><code>lua</code>读取<code>redis</code>数据返回结果为空时，返回的结果不是<code>nil</code>而是<code>userdata</code>类型的<code>ngx.null</code>。</strong></p>
<hr/>

<h4 id="为什么要这么设计？"><a href="#为什么要这么设计？" class="headerlink" title="为什么要这么设计？"></a><a href="https://github.com/openresty/lua-resty-redis/issues/90" target="_blank" rel="noopener noreferrer">为什么要这么设计？</a></h4><blockquote>
<p>因为<code>nil</code>在<code>lua</code>中有特殊的意义，如果一个变量被设置为<code>nil</code>相当于告知该变量<code>未定义</code>(不存在)一样，如果把<code>redis</code>查询的结果为空设置为<code>nil</code>，而该查询的<code>key</code>对应在<code>redis</code>中又是存在的，就无法把<code>查询为空</code>和<code>未定义</code>区分开来了，这样显然是不合理的。所以必须使用一个<code>userdata</code>类型的值来表示这个查询记录为空，但是又不等同于<code>未定义变量</code>（ngx.null)。</p>
</blockquote>
<hr/>
<p>因此，代码做如下修改即可:</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> access_token = redis_client:read_by_key(token_key)</span><br/><span class="line">   <span class="keyword">if</span> access_token == ngx.null <span class="keyword">or</span> access_token == <span class="literal">nil</span> <span class="keyword">then</span></span><br/><span class="line">       </span><br/><span class="line">       <span class="keyword">return</span> <span class="literal">false</span></span><br/><span class="line">   <span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line">   <span class="keyword">local</span> obj_token = cjson.decode(access_token)</span><br/><span class="line">   <span class="comment">-- do something</span></span><br/></pre></td></tr></tbody></table></figure>