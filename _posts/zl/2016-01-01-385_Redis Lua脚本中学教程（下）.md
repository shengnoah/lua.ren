---
layout: post
title: Redis Lua脚本中学教程（下） 
tags: [lua文章]
categories: [topic]
---
<p> 在中学教程的上半部分我们介绍了Redis Lua相关的命令，没有看过或者忘记的同学可以步行前往直接使用机票<a href="https://jackeyzhe.github.io/2019/06/10/Redis-Lua%E8%84%9A%E6%9C%AC%E4%B8%AD%E5%AD%A6%E6%95%99%E7%A8%8B%EF%BC%88%E4%B8%8A%EF%BC%89/">Redis Lua脚本中学教程（上）</a>。今天我们来简单学习一下Lua的语法。</p>
<p>在介绍Lua语法之前，先来介绍一下Lua的身世。Lua是由简称为PUC-Rio的团队设计、开发和维护的。Lua在葡萄牙语中是月亮的意思，所以它不是简写，而是一个名词。所以只能写成Lua，而不能写成LUA或者其他什么的。接下来我们正式入门Lua。</p>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>变量名可以是由字母、数字和下划线组成的字符串，但不能以数字开头。另外需要注意的是，需要尽量避免使用下划线加一个或多个大写字母格式的变量名，因为这是Lua的保留字，除了这种格式以外，还有一些普通格式的保留字：</p>
<table>
<thead>
<tr>
<th style="text-align:center">and</th>
<th style="text-align:center">break</th>
<th style="text-align:center">do</th>
<th style="text-align:center">else</th>
<th style="text-align:center">elseif</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">end</td>
<td style="text-align:center">false</td>
<td style="text-align:center">for</td>
<td style="text-align:center">function</td>
<td style="text-align:center">goto</td>
</tr>
<tr>
<td style="text-align:center">if</td>
<td style="text-align:center">in</td>
<td style="text-align:center">local</td>
<td style="text-align:center">nil</td>
<td style="text-align:center">not</td>
</tr>
<tr>
<td style="text-align:center">or</td>
<td style="text-align:center">repeat</td>
<td style="text-align:center">return</td>
<td style="text-align:center">then</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">until</td>
<td style="text-align:center">while</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>Lua是大小写敏感的，and是保留字，但And和AND不是。</p>
<h5 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h5><p>前面我们提到过Redis不支持Lua的全局变量，但Lua本身是支持全局变量的。</p>
<p>全局变量不需要声明，直接一个未初始化的变量时，它的值是nil。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">&gt; b </span><br/><span class="line">&gt; b = <span class="number">10</span></span><br/><span class="line">&gt; b <span class="comment">--&gt; 10</span></span><br/></pre></td></tr></tbody></table></figure>
<p>如果显示的将nil赋值给某个全局变量，Lua会认为我们不再使用这个变量。</p>
<h5 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h5><p>Lua的变量默认是全局变量，局部变量需要显示声明。局部变量可以避免增加不必要的名称来混淆全局环境，同时也能避免两部分代码的命名冲突。另外，访问局部变量要比访问全局变量的速度更快。</p>
<p>局部变量的使用范围是有限制的，只在它声明的块中可用。（块可以是控制结构体或函数体或者是整个文件中）</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br/><span class="line"><span class="keyword">local</span> i = <span class="number">1</span> <span class="comment">-- local to the chunk</span></span><br/><span class="line"><span class="keyword">while</span> i &lt;= x <span class="keyword">do</span></span><br/><span class="line"><span class="keyword">local</span> x = i * <span class="number">2</span> <span class="comment">-- local to the while body</span></span><br/><span class="line"><span class="built_in">print</span>(x) <span class="comment">--&gt; 2, 4, 6, 8, ...</span></span><br/><span class="line">i = i + <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="keyword">if</span> i &gt; <span class="number">20</span> <span class="keyword">then</span></span><br/><span class="line"><span class="keyword">local</span> x <span class="comment">-- local to the &#34;then&#34; body</span></span><br/><span class="line">x = <span class="number">20</span></span><br/><span class="line"><span class="built_in">print</span>(x + <span class="number">2</span>) <span class="comment">-- (would print 22 if test succeeded)</span></span><br/><span class="line"><span class="keyword">else</span></span><br/><span class="line"><span class="built_in">print</span>(x) <span class="comment">--&gt; 10 (the global one)</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="built_in">print</span>(x) <span class="comment">--&gt; 10 (the global one)</span></span><br/></pre></td></tr></tbody></table></figure>
<p>在交互模式下，每次输入都是一块代码，当你输入local i = 1时，就定义了一个局部变量i，而当你在下一行使用i时，发现它又成了全局变量。因此上面的栗子就不能用了。为了解决这个问题，我们需要在程序中显式的使用<strong>do-end</strong>标记代码块的范围。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x1, x2</span><br/><span class="line"><span class="keyword">do</span></span><br/><span class="line">  <span class="keyword">local</span> a2 = <span class="number">2</span>*a</span><br/><span class="line">  <span class="keyword">local</span> d = (b^<span class="number">2</span> - <span class="number">4</span>*a*c)^(<span class="number">1</span>/<span class="number">2</span>)</span><br/><span class="line">  x1 = (-b + d)/a2</span><br/><span class="line">  x2 = (-b - d)/a2</span><br/><span class="line"><span class="keyword">end</span>                      <span class="comment">-- scope of &#39;a2&#39; and &#39;d&#39; ends here</span></span><br/><span class="line"><span class="built_in">print</span>(x1, x2)            <span class="comment">-- &#39;x1&#39; and &#39;x2&#39; still in scope</span></span><br/></pre></td></tr></tbody></table></figure>
<p>使用这种方式标记代码块范围是一种良好的习惯，而使用局部变量编程也要优于使用全局变量，因此有很多人呼吁Lua默认应该定义局部变量，但是这样也会存在问题。最好的解决方案是不要默认，使用所有的变量之前都要声明。</p>
<p>Lua有一个常见的习语：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> foo = foo</span><br/></pre></td></tr></tbody></table></figure>
<p>这里定义了一个局部变量foo，并把全局变量foo的值赋给局部变量。这一习语主要用来提升变量foo的访问速度，或者对变量进行暂存，防止其他函数改变这个变量的值。</p>
<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><h5 id="单行注释"><a href="#单行注释" class="headerlink" title="单行注释"></a>单行注释</h5><p>Lua的单行注释使用双横线“–”表示，双横线后的内容为注释内容。</p>
<h5 id="多行注释"><a href="#多行注释" class="headerlink" title="多行注释"></a>多行注释</h5><p>多行注释的一种表现是以双横线加双左中括号开始，以双右中括号结束。例如：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[A multi-line</span></span><br/><span class="line"><span class="comment">long comment</span></span><br/><span class="line"><span class="comment">]]</span></span><br/></pre></td></tr></tbody></table></figure>
<p>不过通常我们使用另一种写法：以双横线加双左中括号开始，以双横线加双右中括号结束，这种写法看起来更加美观，同时解注释也更加方便：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br/><span class="line"><span class="comment">print(10) -- no action (commented out)</span></span><br/><span class="line"><span class="comment">--]]</span></span><br/></pre></td></tr></tbody></table></figure>
<p>解注释</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">---[[</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="number">10</span>) <span class="comment">--&gt; 10</span></span><br/><span class="line"><span class="comment">--]]</span></span><br/></pre></td></tr></tbody></table></figure>
<p>这里稍微解释一下这种写法的原理，注释时，后一组双横线在注释内容中，因此不起作用，只为了对称，效果和普通多行注释一样。而解注释时，第一组双横线前又加了一个横线，就不能认为是多行注释了，只能当做单行注释，因此，第一行被注释掉了，这时后一组双横线就会起作用了，注释掉后面的双右中括号。</p>
<h4 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h4><p>Lua是一种动态类型语言，它有8种基本类型：nil，Boolean，number，string，userdata，function，thread和table。type函数可以返回指定值的类型：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">type</span>(<span class="literal">nil</span>) </span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="literal">true</span>) <span class="comment">--&gt; boolean</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="number">10.4</span> * <span class="number">3</span>) <span class="comment">--&gt; number</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="string">&#34;Hello world&#34;</span>) <span class="comment">--&gt; string</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="built_in">io</span>.<span class="built_in">stdin</span>) <span class="comment">--&gt; userdata</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="built_in">print</span>) <span class="comment">--&gt; function</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="built_in">type</span>) <span class="comment">--&gt; function</span></span><br/><span class="line">&gt; <span class="built_in">type</span>({}) <span class="comment">--&gt; table</span></span><br/><span class="line">&gt; <span class="built_in">type</span>(<span class="built_in">type</span>(X)) <span class="comment">--&gt; string</span></span><br/></pre></td></tr></tbody></table></figure>
<h5 id="Nil"><a href="#Nil" class="headerlink" title="Nil"></a>Nil</h5><p>Nil类型的值只有一种，就是nil，它是一种没有值的表现。</p>
<h5 id="Boolean"><a href="#Boolean" class="headerlink" title="Boolean"></a>Boolean</h5><p>Boolean类型有两种取值，@false{} and @true{}。但是Boolean类型并不能囊括所有的条件值：在条件判断时，Lua会将false和nil判断为假，其他的都判断为真。</p>
<p><em>画外音：Lua把0和空字符串也判断为真，这点感觉设计的不太好啊</em></p>
<p>and、or和not是Lua的逻辑运算符。</p>
<p>and的运算方法是，判断第一个操作数是不是false，如果不是，结果就是第二个操作数。</p>
<p>or的运算方法是，判断第一个操作数是不是真，如果不是，结果就是第二个操作数。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">&gt; <span class="number">4</span> <span class="keyword">and</span> <span class="number">5</span> <span class="comment">--&gt; 5</span></span><br/><span class="line">&gt; <span class="literal">nil</span> <span class="keyword">and</span> <span class="number">13</span> </span><br/><span class="line">&gt; <span class="literal">false</span> <span class="keyword">and</span> <span class="number">13</span> <span class="comment">--&gt; false</span></span><br/><span class="line">&gt; <span class="number">0</span> <span class="keyword">or</span> <span class="number">5</span> <span class="comment">--&gt; 0</span></span><br/><span class="line">&gt; <span class="literal">false</span> <span class="keyword">or</span> <span class="string">&#34;hi&#34;</span> <span class="comment">--&gt; &#34;hi&#34;</span></span><br/><span class="line">&gt; <span class="literal">nil</span> <span class="keyword">or</span> <span class="literal">false</span> <span class="comment">--&gt; false</span></span><br/></pre></td></tr></tbody></table></figure>
<h5 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h5><p>Table是Lua中主要的（也是唯一的）结构化数据表现类型。它可以用来表现很多种数据类型，如数组、集合、记录等。</p>
<p>每个表的key可以是不同类型的，对于未定义索引的表元素，它的默认值是nil。和其他大部分语言不同的是<strong>Lua中表的下标是从1开始的</strong>。</p>
<p>Table有两种格式：record-style和list-style</p>
<p>record-style可以直接用”.”访问，list-style可以用下标来访问。定义时可以一起定义。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line">polyline = {color=<span class="string">&#34;blue&#34;</span>,</span><br/><span class="line">            thickness=<span class="number">2</span>,</span><br/><span class="line">            npoints=<span class="number">4</span>,</span><br/><span class="line">            {x=<span class="number">0</span>,   y=<span class="number">0</span>},</span><br/><span class="line">            {x=<span class="number">-10</span>, y=<span class="number">0</span>},</span><br/><span class="line">            {x=<span class="number">-10</span>, y=<span class="number">1</span>},</span><br/><span class="line">            {x=<span class="number">0</span>,   y=<span class="number">1</span>}</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>当我们访问一个可能为空的Table，往往需要先判断非空</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> lib <span class="keyword">and</span> lib.foo <span class="keyword">then</span> ....</span><br/></pre></td></tr></tbody></table></figure>
<p>使用这种方式访问结构比较深的表示就会非常痛苦：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">zip = company <span class="keyword">and</span> company.director <span class="keyword">and</span></span><br/><span class="line">                      company.director.address <span class="keyword">and</span></span><br/><span class="line">                        company.director.address.zipcode</span><br/></pre></td></tr></tbody></table></figure>
<p>Lua没有像C#一样提供?.这样的操作，不过我们可以使用or {}的形式来处理。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">zip = (((company <span class="keyword">or</span> {}).director <span class="keyword">or</span> {}).address <span class="keyword">or</span> {}).zipcode</span><br/></pre></td></tr></tbody></table></figure>
<h4 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h4><p>Lua提供了一些基本的流程控制语句：</p>
<ul>
<li>if用于条件判断</li>
<li>while、repeat和for用于便利</li>
<li>end可以终止if、for和while</li>
<li>until可以终止repeat</li>
<li>break用于跳出循环</li>
<li>return用于跳出函数</li>
<li>goto会跳转到指定位置</li>
</ul>
<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p>Lua中函数可以接收的参数是list，如果没有参数，也需要写一对空的括号”()”（一句废话）。如果只有一个参数，则括号可写可不写。Lua还提供了一种特殊的函数访问方法，有兴趣的话可以参考<a href="https://www.lua.org/pil/16.html" target="_blank" rel="noopener noreferrer">https://www.lua.org/pil/16.html</a></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">o:foo(x)</span><br/></pre></td></tr></tbody></table></figure>
<p>Lua程序中既可以使用定义在Lua中的函数，也可以使用定义在C语言中的函数。</p>
<p>Lua函数有一个非常方便的特性：可以返回多个结果。</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>  <span class="params">(a)</span></span></span><br/><span class="line">  <span class="keyword">local</span> mi = <span class="number">1</span></span><br/><span class="line">  <span class="keyword">local</span> m = a[mi]</span><br/><span class="line">  <span class="keyword">for</span> i = <span class="number">1</span>, #a <span class="keyword">do</span></span><br/><span class="line">    <span class="keyword">if</span> a[i] &gt; m <span class="keyword">then</span></span><br/><span class="line">      mi = i; m = a[i]</span><br/><span class="line"><span class="keyword">end</span> <span class="keyword">end</span></span><br/><span class="line">  <span class="keyword">return</span> m, mi</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">print</span>(maximum({<span class="number">8</span>,<span class="number">10</span>,<span class="number">23</span>,<span class="number">12</span>,<span class="number">5</span>}))     <span class="comment">--&gt; 23   3</span></span><br/></pre></td></tr></tbody></table></figure>
<p>Lua可以自动调整返回结果的数量，当函数作为语句调用时，会舍弃所有返回值；当函数作为表达式调用时，只保留第一个返回值；如果要获得全部返回值，函数调用需要是表达式最后一个。</p>
<p>Lua函数也支持可变参数：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(...)</span></span></span><br/><span class="line">  <span class="keyword">local</span> s = <span class="number">0</span></span><br/><span class="line">  <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>{...} <span class="keyword">do</span></span><br/><span class="line">		s=s+ v </span><br/><span class="line">  <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">return</span> s </span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/><span class="line"><span class="built_in">print</span>(add(<span class="number">3</span>, <span class="number">4</span>, <span class="number">10</span>, <span class="number">25</span>, <span class="number">12</span>))   <span class="comment">--&gt; 54</span></span><br/></pre></td></tr></tbody></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>来简单总结一下，本文我们介绍了Lua的基本语法，包括如何定义变量（包括全局变量和局部变量），8种基本数据类型，流程控制语句以及Lua中函数的一些特性。相信看完本文，你就可以写一些简单的Lua脚本了。</p>
<p>对Lua感兴趣的同学可以自行前往<a href="https://www.lua.org/" target="_blank" rel="noopener noreferrer">Lua官网</a>继续深造。</p>