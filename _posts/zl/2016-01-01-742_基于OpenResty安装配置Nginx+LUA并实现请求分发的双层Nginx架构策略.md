---
layout: post
title: 基于OpenResty安装配置Nginx+LUA并实现请求分发的双层Nginx架构策略 
tags: [lua文章]
categories: [topic]
---
<p>台CentOS6.x<br/>192.168.1.210<br/>192.168.1.211<br/>192.168.1.212<br/>网络拓扑<br/>210和211作为应用层web服务器<br/>212作为网络请求分发代理服务器</p>
<h1 id="Step1-安装Linux依赖"><a href="#Step1-安装Linux依赖" class="headerlink" title="Step1:安装Linux依赖"></a>Step1:安装Linux依赖</h1><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">yum install -y readline-devel pcre-devel openssl-devel gcc</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="Step2-安装Nginx-Openresty"><a href="#Step2-安装Nginx-Openresty" class="headerlink" title="Step2:安装Nginx Openresty"></a>Step2:安装Nginx Openresty</h1><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line">wget http://openresty.org/download/ngx_openresty-1.7.7.2.tar.gz  </span><br/><span class="line">tar -xzvf ngx_openresty-1.7.7.2.tar.gz  </span><br/><span class="line">cd /usr/servers/ngx_openresty-1.7.7.2/</span><br/><span class="line"></span><br/><span class="line">cd bundle/LuaJIT-2.1-20150120/  </span><br/><span class="line">make clean &amp;&amp; make &amp;&amp; make install  </span><br/><span class="line">ln -sf luajit-2.1.0-alpha /usr/local/bin/luajit</span><br/><span class="line"></span><br/><span class="line">cd bundle  </span><br/><span class="line">wget https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz  </span><br/><span class="line">tar -xvf 2.3.tar.gz  </span><br/><span class="line"></span><br/><span class="line">cd bundle  </span><br/><span class="line">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/v0.3.0.tar.gz  </span><br/><span class="line">tar -xvf v0.3.0.tar.gz  </span><br/><span class="line"></span><br/><span class="line">cd /usr/servers/ngx_openresty-1.7.7.2  </span><br/><span class="line">./configure --prefix=/usr/servers --with-http_realip_module  --with-pcre  --with-luajit --add-module=./bundle/ngx_cache_purge-2.3/ --add-module=./bundle/nginx_upstream_check_module-0.3.0/ -j2  </span><br/><span class="line">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>

<h1 id="Step3-检查安装并启动"><a href="#Step3-检查安装并启动" class="headerlink" title="Step3:检查安装并启动"></a>Step3:检查安装并启动</h1><p>安装完成后有以下目录：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">cd /usr/servers/  </span><br/><span class="line">ll</span><br/><span class="line"></span><br/><span class="line">/usr/servers/luajit</span><br/><span class="line">/usr/servers/lualib</span><br/><span class="line">/usr/servers/nginx</span><br/></pre></td></tr></tbody></table></figure>
<p>检查nginx版本</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/servers/nginx/sbin/nginx -V</span><br/></pre></td></tr></tbody></table></figure>
<p>启动nginx:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/servers/nginx/sbin/nginx</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="Step4-Nginx添加LUA配置"><a href="#Step4-Nginx添加LUA配置" class="headerlink" title="Step4:Nginx添加LUA配置"></a>Step4:Nginx添加LUA配置</h1><p>使LUA配置按照工程化目录结构进行配置。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">mkdir /usr/hello</span><br/><span class="line"></span><br/><span class="line">cp -r /usr/servers/lualib /usr/hello/</span><br/></pre></td></tr></tbody></table></figure>
<p>打开nginx.conf配置文件</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">vi /usr/servers/nginx/conf/nginx.conf</span><br/></pre></td></tr></tbody></table></figure>
<p>在http部分添加：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">lua_package_path &#34;/usr/hello/lualib/?.lua;;&#34;;  </span><br/><span class="line">lua_package_cpath &#34;/usr/hello/lualib/?.so;;&#34;;  </span><br/><span class="line">include /usr/hello/hello.conf;</span><br/></pre></td></tr></tbody></table></figure>
<p>创建hello的lua配置和脚本</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">vi /usr/hello/hello.conf</span><br/><span class="line"></span><br/><span class="line">server {  </span><br/><span class="line">    listen       80;  </span><br/><span class="line">    server_name  _;  </span><br/><span class="line">  </span><br/><span class="line">    location /hello/test {  </span><br/><span class="line">        default_type &#39;text/html&#39;;   </span><br/><span class="line">        content_by_lua_file /usr/hello/lua/test.lua;  </span><br/><span class="line">    }  </span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>编辑lua脚本:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">mkdir /usr/hello/lua</span><br/><span class="line"></span><br/><span class="line">vi /usr/hello/lua/test.lua</span><br/><span class="line"></span><br/><span class="line">ngx.say(&#34;hello world&#34;)</span><br/></pre></td></tr></tbody></table></figure>
<p>Nginx检查配置是否正确</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">[root@eshop-cache01 hello]# /usr/servers/nginx/sbin/nginx -t  </span><br/><span class="line">nginx: the configuration file /usr/servers/nginx/conf/nginx.conf syntax is ok</span><br/><span class="line">nginx: configuration file /usr/servers/nginx/conf/nginx.conf test is successful</span><br/></pre></td></tr></tbody></table></figure>
<p>Nginx重新加载配置生效</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/servers/nginx/sbin/nginx -s reload</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="Step5-访问LUA配置的location路径"><a href="#Step5-访问LUA配置的location路径" class="headerlink" title="Step5:访问LUA配置的location路径"></a>Step5:访问LUA配置的location路径</h1><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">curl http://192.168.1.210/hello/test</span><br/></pre></td></tr></tbody></table></figure>
<p>返回test.lua中脚本输出的“hello world”。</p>
<h1 id="Step6-分发层Nginx安装LUA脚本实现请求分发"><a href="#Step6-分发层Nginx安装LUA脚本实现请求分发" class="headerlink" title="Step6:分发层Nginx安装LUA脚本实现请求分发"></a>Step6:分发层Nginx安装LUA脚本实现请求分发</h1><p>我们作为一个流量分发的nginx，会发送http请求到后端的应用nginx上面去，所以要先引入lua http lib包。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">cd /usr/hello/lualib/resty/  </span><br/><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua  </span><br/><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua</span><br/></pre></td></tr></tbody></table></figure>
<p>在分发层Nginx写LUA脚本：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/></pre></td><td class="code"><pre><span class="line">nano /usr/hello/lua/test.lua</span><br/><span class="line"></span><br/><span class="line">local uri_args = ngx.req.get_uri_args()</span><br/><span class="line">local ecourseId = uri_args[&#34;ecourseId&#34;]</span><br/><span class="line"></span><br/><span class="line">local host = {&#34;192.168.1.210&#34;, &#34;192.168.1.211&#34;}</span><br/><span class="line">local hash = ngx.crc32_long(ecourseId)</span><br/><span class="line">hash = (hash % 2) + 1</span><br/><span class="line">backend = &#34;http://&#34;..host[hash]</span><br/><span class="line"></span><br/><span class="line">local paras = &#34;&#34;;</span><br/><span class="line">local request_args_tab = ngx.req.get_uri_args()</span><br/><span class="line">for k, v in pairs(request_args_tab) do</span><br/><span class="line">    paras=paras..k..&#34;=&#34;..v..&#34;&amp;&#34;</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line">local requestPath = ngx.var.uri</span><br/><span class="line">requestPath = requestPath..&#34;?&#34;..paras</span><br/><span class="line"></span><br/><span class="line">local http = require(&#34;resty.http&#34;)</span><br/><span class="line">local httpc = http.new()</span><br/><span class="line"></span><br/><span class="line">local resp, err = httpc:request_uri(backend, {</span><br/><span class="line">    method = &#34;GET&#34;,</span><br/><span class="line">    path = requestPath</span><br/><span class="line">})</span><br/><span class="line"></span><br/><span class="line">if not resp then</span><br/><span class="line">    ngx.say(&#34;request error :&#34;, err)</span><br/><span class="line">    return</span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line">ngx.say(resp.body)</span><br/><span class="line"></span><br/><span class="line">httpc:close()</span><br/></pre></td></tr></tbody></table></figure>
<p>Nginx重新加载配置生效</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/servers/nginx/sbin/nginx -s reload</span><br/></pre></td></tr></tbody></table></figure>
<p>测试请求分发,在浏览器地址栏输入</p>
<p><a href="http://192.168.1.212/hello/test?ecourseId=1" target="_blank" rel="noopener noreferrer">http://192.168.1.212/hello/test?ecourseId=1</a><br/><a href="http://192.168.1.212/hello/test?ecourseId=2" target="_blank" rel="noopener noreferrer">http://192.168.1.212/hello/test?ecourseId=2</a><br/><a href="http://192.168.1.212/hello/test?ecourseId=3" target="_blank" rel="noopener noreferrer">http://192.168.1.212/hello/test?ecourseId=3</a><br/><a href="http://192.168.1.212/hello/test?ecourseId=4" target="_blank" rel="noopener noreferrer">http://192.168.1.212/hello/test?ecourseId=4</a><br/>查看返回的结果，请求被分发到应用层web服务器节点了。根据ecourseId与应用层web服务节点数取模，找到对应的应用层服务器节点。</p>
<h1 id="Step7-按照相同的方法部署另外两台机器的Nginx"><a href="#Step7-按照相同的方法部署另外两台机器的Nginx" class="headerlink" title="Step7:按照相同的方法部署另外两台机器的Nginx"></a>Step7:按照相同的方法部署另外两台机器的Nginx</h1><p>安装过程，略…<br/>应用层Nginx添加http请求功能包即可。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">cd /usr/hello/lualib/resty/  </span><br/><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua  </span><br/><span class="line">wget https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="补充：LUA脚本获取Nginx-Http请求的相关参数说明"><a href="#补充：LUA脚本获取Nginx-Http请求的相关参数说明" class="headerlink" title="补充：LUA脚本获取Nginx Http请求的相关参数说明"></a>补充：LUA脚本获取Nginx Http请求的相关参数说明</h1><p>1.获取当前请求的url相关信息</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/></pre></td><td class="code"><pre><span class="line">function test()</span><br/><span class="line">-- 这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI。</span><br/><span class="line">local request_uri = ngx.var.request_uri</span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url==&#34;) .. tools.u8_to_gbk(cjson.encode(request_uri)) )</span><br/><span class="line"></span><br/><span class="line"> -- HTTP方法（如http，https）。按需使用，例：</span><br/><span class="line"> local scheme = ngx.var.scheme server_addr</span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url scheme==&#34;) .. tools.u8_to_gbk(cjson.encode(scheme)) )</span><br/><span class="line"></span><br/><span class="line"> -- 服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数。</span><br/><span class="line"> local server_addr = ngx.var.server_addruri </span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url server_addr==&#34;) .. tools.u8_to_gbk(cjson.encode(server_addr)) )</span><br/><span class="line"></span><br/><span class="line">-- 请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。</span><br/><span class="line"> local uri = ngx.var.uri </span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url uri==&#34;) .. tools.u8_to_gbk(cjson.encode(uri)) )</span><br/><span class="line"></span><br/><span class="line"> -- 服务器名称</span><br/><span class="line"> local server_name  = ngx.var.server_name  </span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url server_name ==&#34;) .. tools.u8_to_gbk(cjson.encode(server_name )) </span><br/><span class="line"></span><br/><span class="line"> -- 请求到达服务器的端口号。</span><br/><span class="line">local server_port  = ngx.var.server_name  </span><br/><span class="line"> log(tools.gbk_to_u8(&#34;获取当前请求的url server_port ==&#34;) .. tools.u8_to_gbk(cjson.encode(server_port )) </span><br/><span class="line">end</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">test()</span><br/></pre></td></tr></tbody></table></figure>
<p>2.获取发送请求端过来的url相关信息</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">-- 获取远程的IP地址。</span><br/><span class="line">local remote_addr  = ngx.var.remote_addr </span><br/><span class="line"> log(m_uuid,tools.gbk_to_u8(&#34;获取发送请求过来的远程请求remote_addr ==&#34;) .. tools.u8_to_gbk(cjson.encode(remote_addr )) )</span><br/><span class="line"></span><br/><span class="line"> -- 获取远程的端口号</span><br/><span class="line"> local remote_port  = ngx.var.remote_port  </span><br/><span class="line"> log(m_uuid,tools.gbk_to_u8(&#34;获取发送请求过来的远程请求remote_port ==&#34;) .. tools.u8_to_gbk(cjson.encode(remote_port )) )</span><br/></pre></td></tr></tbody></table></figure>