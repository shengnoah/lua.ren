---
layout: post
title: Tengine+Lua+GraphicsMagick动态裁剪图片 
tags: [lua文章]
categories: [topic]
---
<ul>
<li>Tengine：<a href="https://github.com/alibaba/tengine" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/tengine</a></li>
<li>Lua：<a href="http://www.lua.org/ftp/" target="_blank" rel="noopener noreferrer">http://www.lua.org/ftp/</a> ，这里使用 lua-5.3.1.tar.gz</li>
<li>LuaJIT：<a href="http://luajit.org/download.html" target="_blank" rel="noopener noreferrer">http://luajit.org/download.html</a> ，这里使用 LuaJIT-2.0.4.tar.gz</li>
<li>GraphicdMagick：<a href="https://sourceforge.net/projects/graphicsmagick/files/graphicsmagick/" target="_blank" rel="noopener noreferrer">https://sourceforge.net/projects/graphicsmagick/files/graphicsmagick/</a> ，这里使用 GraphicsMagick-1.3.18.tar.gz</li>
</ul>
<h1 id="安装Lua"><a href="#安装Lua" class="headerlink" title="安装Lua"></a>安装Lua</h1><p>先安装依赖：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">yum install readline readline-devel -y</span><br/></pre></td></tr></tbody></table></figure>
<p>解压文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">tar -zxvf lua-5.3.1.tar.gz</span><br/></pre></td></tr></tbody></table></figure>
<p>进入目录，执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> lua-5.3.1</span><br/><span class="line">make linux &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<p>验证安装成功: </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">lua -v</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装luaJIT"><a href="#安装luaJIT" class="headerlink" title="安装luaJIT"></a>安装luaJIT</h1><p>解压文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">tar -zxvf LuaJIT-2.0.4.tar.gz</span><br/></pre></td></tr></tbody></table></figure>
<p>进入目录，执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> LuaJIT-2.0.4</span><br/><span class="line">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装tengine"><a href="#安装tengine" class="headerlink" title="安装tengine"></a>安装tengine</h1><p>安装依赖：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel openssl openssl-devel</span><br/></pre></td></tr></tbody></table></figure>
<p>解压文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">unzip tengine-master.zip</span><br/></pre></td></tr></tbody></table></figure>
<p>进入目录，执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> tengine-master</span><br/><span class="line"></span><br/><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/Tengine --dso-path=/usr/<span class="built_in">local</span>/Tengine/modules --with-http_realip_module --with-http_gzip_static_module --with-http_stub_status_module --with-http_concat_module --with-http_lua_module  --http-proxy-temp-path=/var/tmp/Tengine/proxy_temp --http-fastcgi-temp-path=/var/tmp/Tengine/fastcgi_temp --http-uwsgi-temp-path=/var/tmp/Tengine/uwsgi_temp --http-scgi-temp-path=/var/tmp/Tengine/cgi_temp --http-client-body-temp-path=/var/tmp/Tengine/client_body_temp --http-log-path=/var/<span class="built_in">log</span>/Tengine/access.log --error-log-path=/var/<span class="built_in">log</span>/Tengine/error.log</span><br/></pre></td></tr></tbody></table></figure>
<p>再执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<p>验证安装成功: </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ /usr/<span class="built_in">local</span>/Tengine/sbin/nginx</span><br/><span class="line">/usr/<span class="built_in">local</span>/Tengine/sbin/nginx: error <span class="keyword">while</span> loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br/></pre></td></tr></tbody></table></figure>
<p>提示找不到文件，配置一个软连接：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/lib/libluajit-5.1.so.2</span><br/></pre></td></tr></tbody></table></figure>
<p>验证安装成功: </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ /usr/<span class="built_in">local</span>/Tengine/sbin/nginx</span><br/><span class="line">nginx: [emerg] mkdir() <span class="string">&#34;/var/tmp/Tengine/client_body_temp&#34;</span> failed (2: No such file or directory)</span><br/></pre></td></tr></tbody></table></figure>
<p>手动创建该目录：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">mkdir -p /var/tmp/Tengine/client_body_temp</span><br/></pre></td></tr></tbody></table></figure>
<p>然后，访问 <a href="http://192.168.56.100/" target="_blank" rel="noopener noreferrer">http://192.168.56.100/</a> ，可以看到：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">Welcome to tengine!</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="安装GraphicsMagick"><a href="#安装GraphicsMagick" class="headerlink" title="安装GraphicsMagick"></a>安装GraphicsMagick</h1><p>安装依赖：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">yum install libjpeg libjpeg-devel libpng libpng-devel giflib giflib-devel freetype freetype-devel -y</span><br/></pre></td></tr></tbody></table></figure>
<p>解压文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">tar -zxvf GraphicsMagick-1.3.18.tar.gz</span><br/></pre></td></tr></tbody></table></figure>
<p>进入目录，执行：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> GraphicsMagick-1.3.18</span><br/><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/GraphicsMagick --<span class="built_in">enable</span>-shared</span><br/></pre></td></tr></tbody></table></figure>
<p>再编译安装：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br/></pre></td></tr></tbody></table></figure>
<p>验证安装成功: </p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/GraphicsMagick/bin/gm version</span><br/></pre></td></tr></tbody></table></figure>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>创建 ImageResizer.lua 文件：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/Tengine/lua/</span><br/><span class="line">touch /usr/local/Tengine/lua/ImageResizer.lua</span><br/></pre></td></tr></tbody></table></figure>
<p>ImageResizer.lua：</p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> command = <span class="string">&#34;/usr/local/GraphicsMagick/bin/gm convert &#34;</span> .. ngx.var.request_filepath .. <span class="string">&#34; -resize &#34;</span> .. ngx.var.width .. <span class="string">&#34;x&#34;</span> .. ngx.var.height .. <span class="string">&#34; +profile &#34;*&#34; &#34;</span> .. ngx.var.request_filepath .. <span class="string">&#34;_&#34;</span> .. ngx.var.width .. <span class="string">&#34;x&#34;</span> .. ngx.var.height .. <span class="string">&#34;.&#34;</span> .. ngx.var.ext;</span><br/><span class="line"><span class="built_in">os</span>.<span class="built_in">execute</span>(command);</span><br/><span class="line"></span><br/><span class="line">ngx.exec(ngx.var.request_uri);</span><br/></pre></td></tr></tbody></table></figure>
<p>修改 /usr/local/Tengine/conf/nginx.conf：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/></pre></td><td class="code"><pre><span class="line">user  root;  # 裁剪图片需要root权限</span><br/><span class="line">worker_processes  1;</span><br/><span class="line"></span><br/><span class="line">events {</span><br/><span class="line">    worker_connections  1024;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">http {</span><br/><span class="line">    include       mime.types;</span><br/><span class="line">    default_type  application/octet-stream;</span><br/><span class="line"></span><br/><span class="line">    sendfile        on;</span><br/><span class="line">    #tcp_nopush     on;</span><br/><span class="line"></span><br/><span class="line">    keepalive_timeout  65;</span><br/><span class="line"></span><br/><span class="line">    server {</span><br/><span class="line">        listen       80;</span><br/><span class="line">        server_name  img.javachen.com;</span><br/><span class="line">        root /data/image/upload;</span><br/><span class="line"></span><br/><span class="line">        location / {</span><br/><span class="line">             root /data/image/upload; # 站点根目录</span><br/><span class="line">             expires 1h;    # 缓存时间</span><br/><span class="line">             add_header Cache-Control max-age=3600; # 缓存时间</span><br/><span class="line">             access_log   /var/log/Tengine/host_access.log;</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">        #如果 url 格式如：xxxx.gif_数字x数字.gif</span><br/><span class="line">        location ~* ^(.+.(jpg|jpeg|gif|png))_(d+)x(d+).(jpg|jpeg|gif|png)$ {</span><br/><span class="line">           root /data/image/upload;    #这里必须设置，否则根目录，即 $document_root 会是 Nginx 默认的 Nginx Root/html，在 Lua 中会得不到期望的值</span><br/><span class="line">           if (!-f $request_filename) { #如果文件不存在时才需要裁剪</span><br/><span class="line">              #此HTTP Header无实际意义，用于测试</span><br/><span class="line">              add_header X-Powered-By &#39;Lua GraphicsMagick&#39;;  </span><br/><span class="line">              #此 HTTP Header无实际意义，用于测试</span><br/><span class="line">              add_header file-path $request_filename;  </span><br/><span class="line"></span><br/><span class="line">              #在编写外部 Lua脚本时，设置为off Nginx不会缓存 </span><br/><span class="line">              lua_code_cache on;  Lua，方便调试</span><br/><span class="line">              #设置原始图片路径，如：/document_root/1.gif</span><br/><span class="line">              set $request_filepath /data/image/upload$1;  </span><br/><span class="line">              set $width $3;     # 设置裁剪/缩放的宽度</span><br/><span class="line">              set $height $4;    # 设置裁剪/缩放的高度</span><br/><span class="line">              set $ext $5;      # 图片文件格式后缀</span><br/><span class="line"></span><br/><span class="line">              #加载外部 Lua 文件</span><br/><span class="line">              content_by_lua_file /usr/local/Tengine/lua/ImageResizer.lua;  </span><br/><span class="line">            }</span><br/><span class="line">        }</span><br/><span class="line"></span><br/><span class="line">        error_page   500 502 503 504  /50x.html;</span><br/><span class="line">        location = /50x.html {</span><br/><span class="line">            root   html;</span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>重新加载配置文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/Tengine/sbin/nginx -s reload</span><br/></pre></td></tr></tbody></table></figure>
<p>创建图片上传目录：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">mkdir -p  /data/image/upload</span><br/></pre></td></tr></tbody></table></figure>
<p>配置hosts：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">192.168.56.100  img.javachen.com</span><br/></pre></td></tr></tbody></table></figure>
<p>在 /data/image/upload 下存放一个图片 1.png，然后访问：<a href="http://192.168.56.100/1.png，再访问缩放图片：http://192.168.56.100/1.png_245x245.png" target="_blank" rel="noopener noreferrer">http://192.168.56.100/1.png，再访问缩放图片：http://192.168.56.100/1.png_245x245.png</a></p>
<p>查看 /data/image/upload 目录是否有生成新的文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">$ ll /data/image/upload/</span><br/><span class="line">1.png  1.png_145x145.png  1.png_245x245.png  1.png_45x45.png</span><br/></pre></td></tr></tbody></table></figure>