---
layout: post
title: Lua 学习 chapter22  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>具有动态名称的全局变量</li>
  <li>非全局环境</li>
  <li>环境和模块</li>
  <li>_ENV和load</li>
</ol>

<blockquote>
  <p>只有疯狂过，你才知道自己究竟能不能成功。</p>
</blockquote>

<h2 id="具有动态名称的全局变量">具有动态名称的全局变量</h2>

<p>在lua中，所有的全局变量都被存在_G中，通过_G[name]可以访问到任意一个全局变量。在lua中，全局变量不需要声明就可以直接使用，但是这个可能会造成非常难以查询的bug，所以我们可以对全局变量进行简单的封装。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="nb">setmetatable</span><span class="p">(</span><span class="nb">_G</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">__newindex</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="nb">error</span><span class="p">(</span><span class="s2">&#34;attempt to write to undeclared variable&#34;</span> <span class="o">..</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="nb">error</span><span class="p">(</span><span class="s2">&#34;attempt to read undeclared variable&#34;</span> <span class="o">..</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>
<span class="p">})</span>
<span class="c1">--这样我们怎么对全局变量初始化呢？使用rawset方法。</span>
<span class="k">function</span> <span class="nf">declare</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">initval</span><span class="p">)</span>
    <span class="nb">rawset</span><span class="p">(</span><span class="nb">_G</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">initval</span> <span class="ow">or</span> <span class="kc">false</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">--改版后的</span>
<span class="kd">local</span> <span class="n">declaredNames</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">setmetatable</span><span class="p">(</span><span class="nb">_G</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">__newindex</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">declaredNames</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">then</span>
            <span class="kd">local</span> <span class="n">w</span> <span class="o">=</span> <span class="nb">debug.getinfo</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;S&#34;</span><span class="p">).</span><span class="n">what</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">~=</span> <span class="s2">&#34;main&#34;</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">~=</span> <span class="s2">&#34;C&#34;</span> <span class="k">then</span>
                <span class="nb">error</span><span class="p">(</span><span class="s2">&#34;attempt to write to undeclared variable&#34;</span> <span class="o">..</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">end</span>
            <span class="n">declaredNames</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">end</span>
        <span class="nb">rawset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">declaredNames</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">then</span>
            <span class="nb">error</span><span class="p">(</span><span class="s2">&#34;attempt to read undeclared variable&#34;</span> <span class="o">..</span> <span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="非全局环境">非全局环境</h2>

<p>lua语言中处理全局变量的方式：</p>

<ul>
  <li>编译器在编译所有代码之前，在外层创建局部变量_ENV</li>
  <li>编译器将所有自由名称变换为_ENV.var;</li>
  <li>函数load(or loadfile)使用全局环境初始化代码段的第一个上值，即lua语言内部维护的一个普通表。</li>
</ul>

<p>_ENV只是一个普通的变量，将其赋值为nil会使得后续的代码不能直接访问全局变量。</p>

<p>我们还可以使用_ENV来绕过局部声明的变量，直接访问全局变量。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="nb">print</span><span class="p">,</span> <span class="n">sin</span> <span class="o">=</span> <span class="nb">print</span><span class="p">,</span> <span class="nb">math.sin</span>
<span class="n">_ENV</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span> <span class="c1">--error 访问不到全局</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">13</span>
<span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">12</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">_ENV</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="c1">--访问全局的a，当然也可以使用_G来访问全局的a</span>

<span class="n">_ENV</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="c1">--print is a nil</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">_ENV</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span> <span class="o">=</span> <span class="nb">_G</span><span class="p">}</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">g</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">_ENV</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">a</span><span class="p">}</span> <span class="c1">-- 1 , 15</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>通常_G和_ENV指向的是同一个表。但是，尽管如此，他们是很不一样的实体。_ENV是一个局部变量，所以对“全局变量”的访问实际上访问的都是_ENV。_G则是一个在任何情况下都没有任何特殊状态的全局变量。_ENV永远指向的是当前的环境；而假设在可见且无人改变过其值的前提下，_G通常指向的是全局变量。</p>

<p>_ENV的主要作用就是改变当前的环境。</p>

<h2 id="环境和模块">环境和模块</h2>

<p>为了防止污染全局环境：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">local</span> <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_ENV</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">hello</span><span class="p">()</span>
	<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">sayHello</span><span class="p">()</span>
	<span class="n">hello</span><span class="p">()</span> <span class="c1">--M.hello</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">M</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">sqrt</span> <span class="o">=</span> <span class="nb">math.sqrt</span>
<span class="kd">local</span> <span class="k">in</span> <span class="o">=</span> <span class="n">io</span>
<span class="n">_ENV</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="c1">--这样就不能进行外部访问了</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<p>load函数通常被加载代码段的上值_ENV初始化为全局变量。</p>

<h2 id="_env和load">_ENV和load</h2>

<p>函数load通常把加载代码段的上值_ENV初始化为全局变量。不过，函数load还有一个可选的第四个参数来让我们为_ENV指定一个不同的初始值。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">--file &#34;config.lua&#34;</span>
<span class="n">width</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">height</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1">--加载文件</span>
<span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nb">loadfile</span><span class="p">(</span><span class="s2">&#34;config&#34;</span><span class="p">,</span><span class="s2">&#34;t&#34;</span><span class="p">,</span><span class="n">env</span><span class="p">)()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>配置文件中的代码会运行在空的环境env中，类似于某种沙盒。特别的，所有的定义都会进入这个环境中。即使出错，配置文件也无法影响任何别的东西。</p>


                <hr style="visibility: hidden;"/>
                
                <hr style="visibility: hidden;"/>