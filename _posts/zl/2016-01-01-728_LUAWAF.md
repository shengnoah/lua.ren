---
layout: post
title: LUAWAF 
tags: [lua文章]
categories: [topic]
---
<h2 id="LUAWAF"><a href="#LUAWAF" class="headerlink" title="LUAWAF"></a>LUAWAF</h2><p><a href="https://github.com/MissError/WAF" target="_blank" rel="noopener noreferrer">LUAWAF</a>是我编写的一个针对Nginx的Web应用提供安全防护的Web应用防火墙。</p>
<h2 id="支持平台"><a href="#支持平台" class="headerlink" title="支持平台"></a>支持平台</h2><p>目前<a href="https://github.com/MissError/WAF" target="_blank" rel="noopener noreferrer">WAF</a>只支持Windows平台</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>1，使用本软件最好直接在OpenResty官网下载OpenResty，OpenResty自身带有Nginx</p>
<p>2，将该<a href="https://github.com/MissError/WAF" target="_blank" rel="noopener noreferrer">WAF</a>下载到OpenResty的lua目录下，解压即可</p>
<p>3，日志读写的文件必须给与相应的权限</p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><p>1，需要在nginx.conf文件中包含WAF解压出来的conf中的waf.conf文件</p>
<p>2，需要在waf/conf路径下的config.lua文件中修改日志存储位置以及规则存储位置</p>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><pre><code>是否开启白名单IP检查
_M.IPWhiteCheck = &#34;on&#34;

是否开启黑名单IP检查
_M.IPBlockCheck = &#34;on&#34;

是否开启白名单URl检查
_M.WhiteUrlCheck = &#34;on&#34;

是否开启黑名单URl检查
_M.BlockUrlCheck = &#34;on&#34;

是否开启参数检查
_M.ArgCheck = &#34;on&#34;

是否开启useragent检查
_M.UserAgentCheck = &#34;on&#34;

是否开启cookie检查
_M.CookieCheck = &#34;on&#34;

是否开启CC攻击防御
_M.CCDenyCheck = &#34;on&#34;

是否开启POST上传检查
_M.PostCheck = &#34;on&#34;

CC攻击的速率（次数/秒）
_M.CCRate = &#34;100/60&#34;

IP访问的速率（次数/秒）
_M.Count = &#34;100/60&#34;

是否开启日志记录
_M.LogCheck = &#34;on&#34;

疑似对攻击网站的行为的封禁时间(单位：秒)
_M.BlockTime = &#34;1800&#34;

是否开启错误页面重定向
_M.Redirect = &#34;on&#34;

是否开启某些关键路径只有某些IP可以访问
_M.AccessControl = &#34;on&#34;

是否开启XSS检测
_M.XSSCheck = &#34;on&#34;

是否开启数据库存储
_M.MysqlLog = &#34;on&#34;
</code></pre><p>以上处于waf/conf/config.lua配置文件中，若是配置文件中问on的表示该功能启用，网站禁止访问时间以秒为单位，可以根据自己的需求进行设置，同样的检测CC攻击和IP访问频率也可以根据（次数/秒）设置</p>
<h2 id="规则说明"><a href="#规则说明" class="headerlink" title="规则说明"></a>规则说明</h2><p>LUAWAF采用的匹配规则大部分是<a href="https://github.com/SpiderLabs/owasp-modsecurity-crs" target="_blank" rel="noopener noreferrer">OWASP ModSecurity Core Rule Set (CRS) Project (Official Repository) </a>中的规则，同时还借鉴了<a href="https://github.com/loveshell/ngx_lua_waf" target="_blank" rel="noopener noreferrer">@loveshell</a>的ngx_lua_waf中的规则</p>
<pre><code>规则配置文件在waf/rule文件夹下

args.rulel里面的规则用于GET请求时检查参数和参数名是否正确
block.rule里面的规则用于检测GET请求时用户访问的URL是否是敏感信息
cookies.rule里面的规则用于检测在请求头中的cookie是否包含的扫描器特征值
filenameExt.rule里面的规则用于检测上传的文件扩展名是否合法
IPBlocklist.rule里面的规则是禁止访问的IP
IPWhitelist.rule里面的规则是可以不需要进行权限控制和黑名单检测的IP
manage_IP.json里面的规则用于权限管理检测
post.rule里面的规则用于检测POST请求中的数据
useragents.rule里面的规则用于检测在请求头中的useragent是否包含的扫描器特征值
White.rule里面的规则不需要进行过滤
xss.rule里面的规则用于检测XSS攻击

默认开启了WAF的所有功能，若是需要关掉某些功能，只需要在access.lua文件中使用“--”对相应的功能注释
</code></pre><h2 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h2><pre><code>日志记录提供两种方式：本地日志记录和数据库记录

本地日志记录的日志文件名称格式如下:虚拟主机名_sec.log
本地日志记录的日志文件中的数据以JSON格式存储，方便Web应用管理员通过日志对Web的日志进行分析

数据库记录需要手动建立一个waflog的数据库，并且需要在config.lua文件中配置数据库的相关配置
</code></pre><h3 id="本地日志记录结果："><a href="#本地日志记录结果：" class="headerlink" title="本地日志记录结果："></a>本地日志记录结果：</h3><p><img src="https://i.loli.net/2018/10/23/5bced6ad06817.jpg" alt="22190235.jpg"/></p>
<h3 id="数据库记录结果："><a href="#数据库记录结果：" class="headerlink" title="数据库记录结果："></a>数据库记录结果：</h3><p><img src="https://i.loli.net/2018/10/23/5bced6d3a9c50.jpg" alt="20330746.jpg"/></p>
<h2 id="WAF的功能"><a href="#WAF的功能" class="headerlink" title="WAF的功能"></a>WAF的功能</h2><pre><code>防御sql注入，xss等web攻击
防止svn、数据库和网站备份等敏感信息文件泄漏
防止ApacheBench之类压力测试工具的攻击
屏蔽常见像SQLMAP、netsparkerd等黑客扫描工具
屏蔽异常的网络请求
禁止图片附件类目录php执行权限
防止webshell上传
提供对HTTP请求头中的useragent、cookie和referrer进行检测
提供对Web应用后台只允许特定的IP进行访问
</code></pre><h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>感谢OpenResty的开发者<a href="https://github.com/agentzh/" target="_blank" rel="noopener noreferrer">@agentzh</a></p>
<p>LUAWAF感谢<a href="https://github.com/loveshell/ngx_lua_waf" target="_blank" rel="noopener noreferrer">@loveshell</a>的ngx_lua_waf所提供的思路</p>