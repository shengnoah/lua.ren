---
layout: post
title: Lua中的封装 
tags: [lua文章]
categories: [topic]
---
<p><code class="highlighter-rouge">Lua</code>中没有<code class="highlighter-rouge">private</code>，<code class="highlighter-rouge">table</code>中的<code class="highlighter-rouge">key/value</code>可以随意访问，利用<code class="highlighter-rouge">metatable</code>虽然可以施加一些限制，但是实际上有各种方法可以绕过这些限制。<br/>
下面介绍一种方法，实现真正的封装。</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">LuaClass</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&#34;LuaClass&#34;</span>
<span class="kd">local</span> <span class="n">TestClass</span> <span class="o">=</span> <span class="n">LuaClass</span><span class="p">(</span><span class="s2">&#34;TestClass&#34;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">PrivateDataMap</span> <span class="o">=</span> <span class="n">LuaClass</span><span class="p">:</span><span class="n">PrivateDataMap</span><span class="p">{</span>
    <span class="s2">&#34;MemberA&#34;</span><span class="p">,</span>
    <span class="s2">&#34;MemberB&#34;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">TestClass</span><span class="p">:</span><span class="n">GetMemberA</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">PrivateDataMap</span><span class="p">:</span><span class="n">Get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s2">&#34;MemberA&#34;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">TestClass</span><span class="p">:</span><span class="n">SetMemberA</span><span class="p">(</span><span class="n">Value</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">ExistValue</span> <span class="o">=</span> <span class="n">PrivateDataMap</span><span class="p">:</span><span class="n">Get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s2">&#34;MemberA&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ExistValue</span> <span class="o">~=</span> <span class="n">Value</span> <span class="k">then</span> <span class="c1">-- 比较差异</span>
        <span class="n">PrivateDataMap</span><span class="p">:</span><span class="n">Set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s2">&#34;MemberA&#34;</span><span class="p">,</span> <span class="n">Value</span><span class="p">)</span>
        <span class="n">DispatchXXX</span> <span class="c1">-- 触发事件 </span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">TestClass</span><span class="p">:</span><span class="n">GetMemberB</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">PrivateDataMap</span><span class="p">:</span><span class="n">Get</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s2">&#34;MemberB&#34;</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>上面这段代码中，每个<code class="highlighter-rouge">object</code>对应两个成员<code class="highlighter-rouge">MemberA</code>、<code class="highlighter-rouge">MemberB</code>，因为<code class="highlighter-rouge">PrivateDataMap</code>是局部变量，所以外部的代码无法直接访问，只能通过<code class="highlighter-rouge">TestClass</code>提供的接口访问这些成员。<br/>
<code class="highlighter-rouge">PrivateDataMap</code>的实现方法如下：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">function</span> <span class="nf">LuaClass</span><span class="p">:</span><span class="n">PrivateDataMap</span><span class="p">(</span><span class="n">MemberNameList</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">DataMap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">function</span> <span class="nf">DataMap</span><span class="p">:</span><span class="n">Set</span><span class="p">(</span><span class="n">Owner</span><span class="p">,</span> <span class="n">MemberName</span><span class="p">,</span> <span class="n">Value</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">Owner2ValueMap</span> <span class="o">=</span> <span class="n">DataMap</span><span class="p">[</span><span class="n">MemberName</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Owner2ValueMap</span> <span class="k">then</span>
            <span class="n">Owner2ValueMap</span><span class="p">[</span><span class="n">Owner</span><span class="p">]</span> <span class="o">=</span> <span class="n">Value</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">function</span> <span class="nf">DataMap</span><span class="p">:</span><span class="n">Get</span><span class="p">(</span><span class="n">Owner</span><span class="p">,</span> <span class="n">MemberName</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">Owner2ValueMap</span> <span class="o">=</span> <span class="n">DataMap</span><span class="p">[</span><span class="n">MemberName</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Owner2ValueMap</span> <span class="ow">and</span> <span class="n">Owner2ValueMap</span><span class="p">[</span><span class="n">Owner</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="kd">local</span> <span class="n">CommonFunction</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&#34;CommonFunction&#34;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">MemberName</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">MemberNameList</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">DataMap</span><span class="p">[</span><span class="n">MemberName</span><span class="p">]</span> <span class="o">=</span> <span class="n">CommonFunction</span><span class="p">:</span><span class="n">CreateWeakTable</span><span class="p">()</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">DataMap</span>
<span class="k">end</span></code></pre></figure>

<p>其中，<code class="highlighter-rouge">object</code>与<code class="highlighter-rouge">member</code>的对应关系存储在<code class="highlighter-rouge">weaktable</code>中，不会影响<code class="highlighter-rouge">object</code>的释放。</p>