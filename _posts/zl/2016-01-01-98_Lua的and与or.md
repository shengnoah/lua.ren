---
layout: post
title: Lua的and与or 
tags: [lua文章]
categories: [topic]
---
<p>很早就知道lua的and与or的巧妙用法：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="n">num</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="s2">&#34;one&#34;</span> <span class="ow">or</span> <span class="s2">&#34;not one&#34;</span></code></pre></figure>

<p>这句话可以简洁的表达如下意思：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
<span class="k">if</span> <span class="n">num</span><span class="o">==</span><span class="mi">1</span> <span class="k">then</span>
	<span class="n">str</span> <span class="o">=</span> <span class="s2">&#34;one&#34;</span>
<span class="k">else</span>
	<span class="n">str</span> <span class="o">=</span> <span class="s2">&#34;not one&#34;</span>
<span class="k">end</span></code></pre></figure>

<p>类似与c++的:?运算符，一直用着没啥问题，可是前不久遇到了一个很奇怪的bug，查到最后，锁定在这个用法上，举例：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="k">function</span> <span class="nf">get_item</span><span class="p">(</span><span class="n">config_id</span><span class="p">,</span> <span class="n">star_lv</span><span class="p">,</span> <span class="n">server_id</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">item</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">do</span>
    	<span class="k">if</span> <span class="n">item</span><span class="p">.</span><span class="n">config_id</span><span class="o">==</span><span class="n">config_id</span> <span class="ow">and</span> <span class="n">item</span><span class="p">.</span><span class="n">star_lv</span><span class="o">==</span><span class="n">star_lv</span> <span class="ow">and</span> <span class="p">(</span><span class="n">server_id</span> <span class="ow">and</span> <span class="n">item</span><span class="p">.</span><span class="n">server_id</span><span class="o">==</span><span class="n">server_id</span> <span class="ow">or</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span>
        	<span class="k">return</span> <span class="n">item</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>我是想：根据config_id, star_lv和server_id来查找物品，其中server_id可以不填（即为nil），若不填，则忽略。<br/>
逻辑上是对的，可是运行时候有bug，原因就是：server_id and item.server_id==server_id or true这一句。<br/>
原来，lua的and和or返回的值是：<strong>使它可以确定其最终值的值</strong></p>

<p>简单测试一下即可看出规律：</p>

<figure class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="nb">print</span><span class="p">(</span><span class="kc">false</span> <span class="ow">and</span> <span class="kc">nil</span><span class="p">)</span>    <span class="c1">-- false</span>
<span class="nb">print</span><span class="p">(</span><span class="kc">nil</span> <span class="ow">and</span> <span class="kc">true</span><span class="p">)</span>     <span class="c1">-- nil</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">123</span> <span class="ow">and</span> <span class="kc">nil</span><span class="p">)</span>      <span class="c1">-- nil</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">123</span> <span class="ow">and</span> <span class="mi">456</span><span class="p">)</span>      <span class="c1">-- 456</span>
<span class="nb">print</span><span class="p">(</span><span class="kc">false</span> <span class="ow">or</span> <span class="kc">nil</span><span class="p">)</span>     <span class="c1">-- nil</span>
<span class="nb">print</span><span class="p">(</span><span class="kc">nil</span> <span class="ow">or</span> <span class="mi">123</span><span class="p">)</span>       <span class="c1">-- 123</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">123</span> <span class="ow">or</span> <span class="kc">nil</span><span class="p">)</span>       <span class="c1">-- 123</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">123</span> <span class="ow">or</span> <span class="mi">456</span><span class="p">)</span>       <span class="c1">-- 123</span></code></pre></figure>

<p>为了验证返回的是值（而不是bool值），我用nil来代替false，用123，456来代替true。<br/>
而a = b and c or d这种写法，等同于a = (b and c) or d，也就是根据b and c来决定是否返回d。<br/>
结果就很明显了，b and c有2种情况：</p>

<ol>
  <li>b:true -&gt; c</li>
  <li>b:false -&gt; b</li>
</ol>

<p>然后再和d做逻辑或运算：x or d，而x or d在：</p>

<ol>
  <li>x:true -&gt; x</li>
  <li>x:false -&gt; d</li>
</ol>

<p>分析到这里，可以得出，对于：a = b and c or d来说，若：</p>

<ol>
  <li>b:true -&gt;
    <ol>
      <li>c:true -&gt; a = c</li>
      <li>c:false -&gt; a = d</li>
    </ol>
  </li>
  <li>b:false -&gt; a = d</li>
</ol>

<p>坑已经暴露出来了，a = b and c or d 不等与 C++的a = b ? c : d<br/>
<strong>只有在c为true的时候，才可以这么用</strong><br/>
ps. 只有false和nil才是false，其他都为true</p>