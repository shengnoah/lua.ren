---
layout: post
title: Lua 学习 chapter24  
tags: [lua文章]
categories: [topic]
---
<h3 id="目录">目录</h3>
<ol>
  <li>协程</li>
</ol>

<blockquote>
  <p>人人真真的生活过，学习过，改变过，努力过，才能创造出一个满意的自己。</p>
</blockquote>

<h2 id="协程">协程</h2>
<blockquote>
  <p>协程是一系列的可执行语句，拥有自己的栈、局部变量和指令指针，同时协程又与其他协程共享了全局变量和其他几乎一切资源。线程和协程的主要区别在于，一个线程程序可以并行运行多个线程，而协程却需要彼此协作的运行，即任意指定时刻只能有一个协程运行。</p>
</blockquote>

<p>协程相关的函数都在coroutine表中，其中create为创建协程函数，参数为协程要执行的代码函数。它会返回一个thread类型的协程。
一个协程拥有四种状态：挂起，运行，正常和死亡。
当一个协程被创建的时候，它处于挂起状态。函数resume用于启动或再次启动一个协程的运行，并将其状态由挂起改为运行。协程函数执行完毕之后进入死亡状态。当使用协程A唤醒协程B的时候，协程A即不是挂起状态（因为不能唤醒协程A），也不是运行状态（因为B正在运行）。所以A此时的状态就被称为正常状态。</p>

<p>lua语言一个非常有用的机制是通过一对resume-yield来交换数据，第一个resume函数（没有对应等待它的yield）会把所有额外参数传递给协程的主函数。
在函数resume的返回之中，第一个返回值为true时表示没有错误，之后的返回值对应函数yield的参数。</p>

<p>可以将唤醒协程的函数放在一个函数中，因为这种模式比较常见，所以lua语言专门提供了一个特殊的函数coroutine函数来完成这个功能。
当执行wrap中的函数时候，就唤醒协程。</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
<span class="k">end</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1">--&gt; true 6。执行状态和结果</span>

<span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">))</span> <span class="c1">--2 4 6,返回值是唤醒这个yield的参数值</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
<span class="k">end</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="c1">-- true	3	5,返回yield的参数，是最开始传进来的参数</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="c1">-- true	6，返回结果，根据最开始传进来的参数</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="c1">--false	cannot resume dead coroutine</span>

<span class="k">function</span> <span class="nf">permutations</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
	<span class="k">return</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="n">permgen</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>生产者与消费者的例子：</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">receive</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">status</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">producer</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">io.read</span><span class="p">()</span>
            <span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">filter</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">math.huge</span> <span class="k">do</span>
            <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">receive</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%5d %s&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="n">receive</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
        <span class="nb">io.write</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">n</span><span class="s2">&#34;</span><span class="p">)</span>
        <span class="kd">local</span> <span class="n">exit</span> <span class="o">=</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&#34;%l+&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">exit</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;q&#34;</span> <span class="k">then</span>
            <span class="k">break</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">consumer</span><span class="p">(</span><span class="n">filter</span><span class="p">(</span><span class="n">producer</span><span class="p">()))</span>
</pre></td></tr></tbody></table></code></pre></div></div>



                <hr style="visibility: hidden;"/>
                
                <hr style="visibility: hidden;"/>