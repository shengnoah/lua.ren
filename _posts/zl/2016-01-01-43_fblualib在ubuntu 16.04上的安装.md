---
layout: post
title: fblualib在ubuntu 16.04上的安装 
tags: [lua文章]
categories: [topic]
---
<p>最近需要复现一下<a href="https://github.com/bgshih/crnn" target="_blank" rel="noopener noreferrer">CRNN</a>的结果，因为自己实现的版本点数不够高，所以需要跑一下人家的代码。一共有两个依赖，一个是TORCH，这个好装，另一个是fblualib，这个项目已经停止维护了，真的是跳了无数个坑，这里做一个记录。最后也只能跑inference不能train BTW. 但是对于其他跳坑的人可能也是有帮助的.<br/><br/><br/></p>
<ul>
<li><a href="#概览">概览</a></li>
<li><a href="#torch">torch</a></li>
<li><a href="#cudnntorch">cudnn.torch</a></li>
<li><a href="#googletest">googletest</a></li>
<li><a href="#folly">folly</a></li>
<li><a href="#mstch">mstch</a></li>
<li><a href="#zstd">zstd</a></li>
<li><a href="#googletest-1">googletest</a></li>
<li><a href="#wangle">wangle</a></li>
<li><a href="#fbthrift">fbthrift</a></li>
<li><a href="#thpp">thpp</a></li>
<li><a href="#fblualib">fblualib</a></li>
<li><a href="#crnn">CRNN</a></li>
<li><a href="#各种报错的解决办法">各种报错的解决办法</a></li>
</ul>

<h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>首先是需要安装的包<br/><a href="https://github.com/facebookarchive/fblualib/blob/master/install_all.sh" target="_blank" rel="noopener noreferrer">fblualib</a>,<a href="https://github.com/facebook/folly/" target="_blank" rel="noopener noreferrer">folly</a>,<a href="https://github.com/no1msd/mstch" target="_blank" rel="noopener noreferrer">mstch</a>,<a href="https://github.com/facebook/zstd" target="_blank" rel="noopener noreferrer">zstd</a>,<a href="https://github.com/facebook/wangle" target="_blank" rel="noopener noreferrer">wangle</a>,<a href="https://github.com/facebook/thpp" target="_blank" rel="noopener noreferrer">thpp</a>,<a href="https://github.com/facebook/fbthrift/" target="_blank" rel="noopener noreferrer">fbthrift</a><br/>其次：<br/>system：ubuntu 16.04，相比来说14.04应该更好装<br/>python:2.7，之前试了python3，但是在import frontend的时候遇到了一些问题，没有解决好，就放弃了，其实是有希望的。<br/></p>
<h3 id="torch"><a href="#torch" class="headerlink" title="torch"></a>torch</h3><p>commit 0219027e6c4644a0ba5c5bf137c989a0a8c9e01b</p>
<h3 id="cudnn-torch"><a href="#cudnn-torch" class="headerlink" title="cudnn.torch"></a>cudnn.torch</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/soumith/cudnn.torch</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="googletest"><a href="#googletest" class="headerlink" title="googletest"></a>googletest</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">wget https://github.com/google/googletest/archive/release-1.8.0.tar.gz &amp;&amp; </span><br/><span class="line">tar zxf release-1.8.0.tar.gz &amp;&amp; </span><br/><span class="line">rm -f release-1.8.0.tar.gz &amp;&amp; </span><br/><span class="line">cd googletest-release-1.8.0 &amp;&amp; </span><br/><span class="line">cmake configure . &amp;&amp; </span><br/><span class="line">make &amp;&amp; </span><br/><span class="line">make install</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="folly"><a href="#folly" class="headerlink" title="folly"></a>folly</h3><p>commit ID:<code>5817bad</code><br/>依赖：<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/></pre></td><td class="code"><pre><span class="line">sudo apt-get install </span><br/><span class="line">    g++ </span><br/><span class="line">    cmake </span><br/><span class="line">    libboost-all-dev </span><br/><span class="line">    libevent-dev </span><br/><span class="line">    libdouble-conversion-dev </span><br/><span class="line">    libgoogle-glog-dev </span><br/><span class="line">    libgflags-dev </span><br/><span class="line">    libiberty-dev </span><br/><span class="line">    liblz4-dev </span><br/><span class="line">    liblzma-dev </span><br/><span class="line">    libsnappy-dev </span><br/><span class="line">    make </span><br/><span class="line">    zlib1g-dev </span><br/><span class="line">    binutils-dev </span><br/><span class="line">    libjemalloc-dev </span><br/><span class="line">    libssl-dev </span><br/><span class="line">    pkg-config</span><br/><span class="line">    libunwind8-dev </span><br/><span class="line">    libelf-dev </span><br/><span class="line">    libdwarf-dev</span><br/></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/facebook/folly/</span><br/><span class="line">cd folly/folly</span><br/><span class="line">autoreconf -ivf</span><br/><span class="line">./configure &amp;&amp;</span><br/><span class="line">make &amp;&amp;</span><br/><span class="line">sudo make install &amp;&amp;</span><br/><span class="line">sudo ldconfig &amp;&amp;</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="mstch"><a href="#mstch" class="headerlink" title="mstch"></a>mstch</h3><p>commit ID:<code>0fde1cf</code><br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/no1msd/mstch</span><br/><span class="line">cd mstch</span><br/><span class="line">mkdir build</span><br/><span class="line">cd build</span><br/><span class="line">cmake ..</span><br/><span class="line">make -j 4</span><br/><span class="line">sudo make install</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="zstd"><a href="#zstd" class="headerlink" title="zstd"></a>zstd</h3><p>commit ID:<code>87125c2</code> dev branch<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/facebook/zstd</span><br/><span class="line">cd zstd</span><br/><span class="line">sudo make install</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="googletest-1"><a href="#googletest-1" class="headerlink" title="googletest"></a>googletest</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/google/googletest</span><br/><span class="line">cmake make install</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="wangle"><a href="#wangle" class="headerlink" title="wangle"></a>wangle</h3><p>commit ID:`31fbaba<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/facebook/wangle</span><br/><span class="line">cmake .</span><br/><span class="line">make</span><br/><span class="line">ctest</span><br/><span class="line">sudo make install</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="fbthrift"><a href="#fbthrift" class="headerlink" title="fbthrift"></a>fbthrift</h3><p>commit ID:<code>94a399a</code><br/>更改的部分<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/></pre></td><td class="code"><pre><span class="line">diff --git a/CMakeLists.txt b/CMakeLists.txt</span><br/><span class="line">index 51271e3..7a15eae 100644</span><br/><span class="line">--- a/CMakeLists.txt</span><br/><span class="line">+++ b/CMakeLists.txt</span><br/><span class="line">@@ -8,6 +8,9 @@ set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)</span><br/><span class="line"> set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)</span><br/><span class="line"> set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)</span><br/><span class="line"></span><br/><span class="line">+set(CMAKE_CXX_FLAGS &#34;-fPIC&#34;)</span><br/><span class="line">+set(CMAKE_C_FLAGS &#34;-fPIC&#34;)</span><br/><span class="line">+</span><br/><span class="line"> set(TEMPLATES_INSTALL_DIR include/thrift/templates CACHE STRING</span><br/><span class="line">     &#34;The subdirectory where compiler template files should be installed&#34;)</span><br/><span class="line"> set(BIN_INSTALL_DIR bin CACHE STRING</span><br/><span class="line">主要为了解决python包 thrift-compiler无法生成的问题</span><br/></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">cd build</span><br/><span class="line">cmake ..</span><br/><span class="line">make -j 32</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="thpp"><a href="#thpp" class="headerlink" title="thpp"></a>thpp</h3><p>commit ID:<code>0a4c745</code><br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">git clone https://github.com/facebook/thpp</span><br/><span class="line">cd thpp/thpp</span><br/><span class="line">./build.sh</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>更改的部分<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/></pre></td><td class="code"><pre><span class="line">diff --git a/thpp/CMakeLists.txt b/thpp/CMakeLists.txt</span><br/><span class="line">index 4ae3683..603702b 100644</span><br/><span class="line">--- a/thpp/CMakeLists.txt</span><br/><span class="line">+++ b/thpp/CMakeLists.txt</span><br/><span class="line">@@ -42,7 +42,7 @@ ELSE()</span><br/><span class="line">   ADD_DEFINITIONS(-DNO_THRIFT)</span><br/><span class="line"> ENDIF()</span><br/><span class="line"></span><br/><span class="line">-SET(CMAKE_CXX_FLAGS &#34;${CMAKE_CXX_FLAGS} -std=gnu++11&#34;)</span><br/><span class="line">+SET(CMAKE_CXX_FLAGS &#34;${CMAKE_CXX_FLAGS} -std=gnu++14&#34;)</span><br/><span class="line"></span><br/><span class="line"> SET(src</span><br/><span class="line">   Storage.cpp</span><br/><span class="line">------------------------------------------------------</span><br/><span class="line">   diff --git a/thpp/build.sh b/thpp/build.sh</span><br/><span class="line">   index 79af5d9..7c807e7 100755</span><br/><span class="line">   --- a/thpp/build.sh</span><br/><span class="line">   +++ b/thpp/build.sh</span><br/><span class="line">   @@ -52,4 +52,4 @@ make</span><br/><span class="line">    ctest</span><br/><span class="line"></span><br/><span class="line">    # Install</span><br/><span class="line">   -make install</span><br/><span class="line">   +sudo make install</span><br/><span class="line">------------------------------------------------------</span><br/><span class="line">diff --git a/thpp/detail/TensorGeneric.h b/thpp/detail/TensorGeneric.h</span><br/><span class="line">index a8837f6..6b67c72 100644</span><br/><span class="line">--- a/thpp/detail/TensorGeneric.h</span><br/><span class="line">+++ b/thpp/detail/TensorGeneric.h</span><br/><span class="line">@@ -188,17 +188,17 @@ template &lt;&gt; struct TensorOps&lt;Tensor&lt;real&gt;&gt; {</span><br/><span class="line">   }</span><br/><span class="line">   static void _max(THTensor* values, THLongTensor* indices,</span><br/><span class="line">                    THTensor* t, int dim) {</span><br/><span class="line">-    return THTensor_(max)(values, indices, t, dim);</span><br/><span class="line">+    return THTensor_(max)(values, indices, t, dim, 1);</span><br/><span class="line">   }</span><br/><span class="line">   static void _min(THTensor* values, THLongTensor* indices,</span><br/><span class="line">                    THTensor* t, int dim) {</span><br/><span class="line">-    return THTensor_(min)(values, indices, t, dim);</span><br/><span class="line">+    return THTensor_(min)(values, indices, t, dim, 1);</span><br/><span class="line">   }</span><br/><span class="line">   static void _sum(THTensor* r, THTensor* t, int dim) {</span><br/><span class="line">-    return THTensor_(sum)(r, t, dim);</span><br/><span class="line">+    return THTensor_(sum)(r, t, dim, 1);</span><br/><span class="line">   }</span><br/><span class="line">   static void _prod(THTensor* r, THTensor* t, int dim) {</span><br/><span class="line">-    return THTensor_(prod)(r, t, dim);</span><br/><span class="line">+    return THTensor_(prod)(r, t, dim, 1);</span><br/><span class="line">   }</span><br/><span class="line">   static void _cumsum(THTensor* r, THTensor* t, int dim) {</span><br/><span class="line">     return THTensor_(cumsum)(r, t, dim);</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="fblualib"><a href="#fblualib" class="headerlink" title="fblualib"></a>fblualib</h3><p>commit ID:<code>4812779</code><br/>更改的部分，这个改的太多了<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">modified:   fblualib/build.sh</span><br/><span class="line">modified:   fblualib/ffivector/CMakeLists.txt</span><br/><span class="line">modified:   fblualib/ffivector/FFIVector.cpp</span><br/><span class="line">modified:   fblualib/mattorch/CMakeLists.txt</span><br/><span class="line">modified:   fblualib/python/CMakeLists.txt</span><br/><span class="line">modified:   fblualib/thrift/ChunkedCompression.h</span><br/><span class="line">modified:   fblualib/thrift/Encoding.h</span><br/><span class="line">modified:   fblualib/thrift/LuaObject.h</span><br/><span class="line">modified:   fblualib/thrift/LuaSerialization.cpp</span><br/><span class="line">modified:   fblualib/torch/CMakeLists.txt</span><br/><span class="line">modified:   fblualib/util/Reactor.cpp</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="CRNN"><a href="#CRNN" class="headerlink" title="CRNN"></a>CRNN</h3><p>ptr的问题</p>
<h3 id="各种报错的解决办法"><a href="#各种报错的解决办法" class="headerlink" title="各种报错的解决办法"></a>各种报错的解决办法</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">Could not find a package configuration file provided by &#34;Torch&#34; with any of</span><br/><span class="line">  the following names:</span><br/><span class="line"></span><br/><span class="line">    TorchConfig.cmake</span><br/><span class="line">    torch-config.cmake</span><br/><span class="line"></span><br/><span class="line">export CMAKE_PREFIX_PATH=/path/to/torch</span><br/></pre></td></tr></tbody></table></figure>