---
layout: post
title: Lua源码阅读：标准库 
tags: [lua文章]
categories: [topic]
---
<p>Lua标准库中定义的一些函数及其实现方式。</p>

<h2 id="lmathlib-c"><a href="#lmathlib-c" class="headerlink" title="lmathlib.c"></a>lmathlib.c</h2><p>从一个简单的math.Abs()函数开始：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span>  <span class="params">(lua_State *L)</span> </span>{</span><br/><span class="line">  <span class="keyword">if</span> (lua_isinteger(L, <span class="number">1</span>)) {</span><br/><span class="line">    lua_Integer n = lua_tointeger(L, <span class="number">1</span>);</span><br/><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) n = (lua_Integer)(<span class="number">0u</span> - n);</span><br/><span class="line">    lua_pushinteger(L, n);</span><br/><span class="line">  }</span><br/><span class="line">  <span class="keyword">else</span></span><br/><span class="line">    lua_pushnumber(L, l_mathop(<span class="built_in">fabs</span>)(luaL_checknumber(L, <span class="number">1</span>)));</span><br/><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>首先，先检查传入的值是否是int类型，这里调用了lapi.c中的lua_isinteger函数，检查传入值的TValue原始类型标签是否是LUA_TNUMINT，这部分的检查在lObject.h中定义的函数完成，同时数据类型LUA_TNUMINT也在lObject.h中定义：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LUA_TNUMINT	(LUA_TNUMBER | (1 &lt;&lt; 4))  <span class="comment">/* integer numbers */</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="comment">// lObject.h</span></span><br/></pre></td></tr></tbody></table></figure>
<p>如果传入的值的<strong>TValue</strong>是int类型的（传入的值是lua_state类型的），调用lua_tointeger将传入的值转换为int类型（实际上是lua_Integer类型，其最根源是longlong类型的，在luaconf.h中定义），将其赋给n，如果n小于零，则用一个unsigned 0减去它，将其置为正数，最后将n存入到TValue中，将其存放在lua_state的栈顶。</p>
<p>如果不是int类型的，则检查其是否是一个number类型的值，如果是一个number则调用fabs，将其push栈，否则返回一个错误提示。</p>
<h2 id="lstrlib-c"><a href="#lstrlib-c" class="headerlink" title="lstrlib.c"></a>lstrlib.c</h2><p>strlib中一部分是关于字符串的操作函数，一部分是关于模式匹配的函数，先挑选一个Reverse函数进行分析：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">str_reverse</span> <span class="params">(lua_State *L)</span> </span>{</span><br/><span class="line">  <span class="keyword">size_t</span> l, i;</span><br/><span class="line">  luaL_Buffer b;</span><br/><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *s = luaL_checklstring(L, <span class="number">1</span>, &amp;l);</span><br/><span class="line">  <span class="keyword">char</span> *p = luaL_buffinitsize(L, &amp;b, l);</span><br/><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; l; i++)</span><br/><span class="line">    p[i] = s[l - i - <span class="number">1</span>];</span><br/><span class="line">  luaL_pushresultsize(&amp;b, l);</span><br/><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<p>简单来说就是利用一个指针（index）来对字符数组进行逆序的赋值，从数组s中获取赋值给数组p。</p>