---
layout: post
title: lua与luajit string hash算法对比 
tags: [lua文章]
categories: [topic]
---
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>研究lua与luajit两种string hash算法的原理，以及性能对比</p>

<h2 id="string-hash"><a href="#string-hash" class="headerlink" title="string hash"></a>string hash</h2><h3 id="lua"><a href="#lua" class="headerlink" title="lua"></a>lua</h3><ol>
<li>如果string长度小于32，则会对所有字符串的字符进行遍历，然后计算hash值</li>
<li>如果string长度大于等于32，则把string进行等分，等分间隔为长度/32+1，然后取每等分的第一个字符进行hash值计算。所以不管字符串多长，最多会循环32次</li>
</ol>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span>  <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> l, <span class="keyword">unsigned</span> <span class="keyword">int</span> seed)</span> </span>{</span><br/><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> h = seed ^ cast(<span class="keyword">unsigned</span> <span class="keyword">int</span>, l);</span><br/><span class="line">  <span class="keyword">size_t</span> l1;</span><br/><span class="line">  <span class="keyword">size_t</span> step = (l &gt;&gt; LUAI_HASHLIMIT) + <span class="number">1</span>;  <span class="comment">// LUAI_HASHLIMIT值为5，l是字符串长度，不是一</span></span><br/><span class="line">  <span class="keyword">for</span> (l1 = l; l1 &gt;= step; l1 -= step)</span><br/><span class="line">    h = h ^ ((h&lt;&lt;<span class="number">5</span>) + (h&gt;&gt;<span class="number">2</span>) + cast_byte(str[l1 - <span class="number">1</span>]));</span><br/><span class="line">  <span class="keyword">return</span> h;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="luajit"><a href="#luajit" class="headerlink" title="luajit"></a>luajit</h3><ol>
<li>如果string小于4，则会取字符串的第一位，最后一位，以及中间位，进行hash值计算</li>
<li>如果string长度大于等于4，则会取字符串第1~4位，最后4位，len/2-2~len/2+2，len/4-1~len/4+3，进行hash计算</li>
</ol>
<h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码我整理了封装了下，用来展示和测试</span></span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">define</span> lj_rol(x, n)	(((x)<span class="meta-string">&lt;&lt;(n)) | ((x)&gt;&gt;(-(int)(n)&amp;(8*sizeof(x)-1))))</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luajit_hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> len)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> a, b, h = len;</span><br/><span class="line">	<span class="keyword">if</span> (len &gt;= <span class="number">4</span>) {  <span class="comment">/* Caveat: unaligned access! */</span></span><br/><span class="line">		a = lj_getu32(str);</span><br/><span class="line">		h ^= lj_getu32(str + len - <span class="number">4</span>);</span><br/><span class="line">		b = lj_getu32(str + (len &gt;&gt; <span class="number">1</span>) - <span class="number">2</span>);</span><br/><span class="line">		h ^= b; h -= lj_rol(b, <span class="number">14</span>);</span><br/><span class="line">		b += lj_getu32(str + (len &gt;&gt; <span class="number">2</span>) - <span class="number">1</span>);</span><br/><span class="line">	}</span><br/><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>) {</span><br/><span class="line">		a = *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)str;</span><br/><span class="line">		h ^= *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(str + len - <span class="number">1</span>);</span><br/><span class="line">		b = *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(str + (len &gt;&gt; <span class="number">1</span>));</span><br/><span class="line">		h ^= b; h -= lj_rol(b, <span class="number">14</span>);</span><br/><span class="line">	}</span><br/><span class="line">	a ^= h; a -= lj_rol(h, <span class="number">11</span>);</span><br/><span class="line">	b ^= a; b -= lj_rol(a, <span class="number">25</span>);</span><br/><span class="line">	h ^= b; h -= lj_rol(b, <span class="number">16</span>);</span><br/><span class="line">	<span class="keyword">return</span> h;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>从采样随机性及次数上来看，肯定是lua原生自带的hash算法好。但也因为采样次数增加，导致原生hash算法的性能会有损失</p>
<h2 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h2><p>对lua以及luajit的string hash算法，进行不同字符串长度的性能对比</p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>操作系统：Debian GNU/Linux 8<br/>CPU：Intel(R) Xeon(R) CPU E5-2640 v2 @ 2.00GHz<br/>内存：64G</p>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/><span class="line">78</span><br/><span class="line">79</span><br/><span class="line">80</span><br/><span class="line">81</span><br/><span class="line">82</span><br/><span class="line">83</span><br/><span class="line">84</span><br/><span class="line">85</span><br/><span class="line">86</span><br/><span class="line">87</span><br/><span class="line">88</span><br/><span class="line">89</span><br/></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> lua_hash_seed = <span class="number">0</span>;</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> len)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> h = lua_hash_seed ^ (<span class="keyword">unsigned</span> <span class="keyword">int</span>)len;</span><br/><span class="line">	<span class="keyword">size_t</span> step = (len &gt;&gt; <span class="number">5</span>) + <span class="number">1</span>;</span><br/><span class="line">	<span class="keyword">for</span> (; len &gt;= step; len -= step)</span><br/><span class="line">		h ^= ((h &lt;&lt; <span class="number">5</span>) + (h &gt;&gt; <span class="number">2</span>) + (<span class="keyword">unsigned</span> <span class="keyword">char</span>)(str[len - <span class="number">1</span>]));</span><br/><span class="line">	<span class="keyword">return</span> h;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">define</span> lj_rol(x, n)	(((x)<span class="meta-string">&lt;&lt;(n)) | ((x)&gt;&gt;(-(int)(n)&amp;(8*sizeof(x)-1))))</span></span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luajit_hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> len)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> a, b, h = len;</span><br/><span class="line">	<span class="keyword">if</span> (len &gt;= <span class="number">4</span>) {  <span class="comment">/* Caveat: unaligned access! */</span></span><br/><span class="line">		a = lj_getu32(str);</span><br/><span class="line">		h ^= lj_getu32(str + len - <span class="number">4</span>);</span><br/><span class="line">		b = lj_getu32(str + (len &gt;&gt; <span class="number">1</span>) - <span class="number">2</span>);</span><br/><span class="line">		h ^= b; h -= lj_rol(b, <span class="number">14</span>);</span><br/><span class="line">		b += lj_getu32(str + (len &gt;&gt; <span class="number">2</span>) - <span class="number">1</span>);</span><br/><span class="line">	}</span><br/><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>) {</span><br/><span class="line">		a = *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)str;</span><br/><span class="line">		h ^= *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(str + len - <span class="number">1</span>);</span><br/><span class="line">		b = *(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)(str + (len &gt;&gt; <span class="number">1</span>));</span><br/><span class="line">		h ^= b; h -= lj_rol(b, <span class="number">14</span>);</span><br/><span class="line">	}</span><br/><span class="line">	a ^= h; a -= lj_rol(h, <span class="number">11</span>);</span><br/><span class="line">	b ^= a; b -= lj_rol(a, <span class="number">25</span>);</span><br/><span class="line">	h ^= b; h -= lj_rol(b, <span class="number">16</span>);</span><br/><span class="line">	<span class="keyword">return</span> h;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">random_string</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> &amp;str, <span class="keyword">size_t</span> size)</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i)</span><br/><span class="line">	{</span><br/><span class="line">		str.push_back((<span class="keyword">char</span>)(rand() % <span class="number">255</span>));</span><br/><span class="line">	}</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HASH_COUNT 100000</span></span><br/><span class="line"><span class="keyword">int</span> a[HASH_COUNT];</span><br/><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br/><span class="line"><span class="function"></span>{</span><br/><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> str;</span><br/><span class="line"></span><br/><span class="line">	srand(clock());</span><br/><span class="line"></span><br/><span class="line">	<span class="keyword">int</span> step = <span class="number">1</span>;</span><br/><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> len = <span class="number">1</span>; len &lt;= <span class="number">65535</span>; len += step)</span><br/><span class="line">	{</span><br/><span class="line">		<span class="built_in">printf</span>(<span class="string">&#34;string len = %d:n&#34;</span>, len);</span><br/><span class="line"></span><br/><span class="line">		random_string(str, step);</span><br/><span class="line">		</span><br/><span class="line">		{</span><br/><span class="line">			<span class="keyword">clock_t</span> start = clock();</span><br/><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; HASH_COUNT; ++i)</span><br/><span class="line">			{</span><br/><span class="line">				a[i] = luajit_hash(str.c_str(), str.size());	<span class="comment">// 防止编译器优化;</span></span><br/><span class="line">			}</span><br/><span class="line">			<span class="keyword">clock_t</span> use_time = clock() - start;</span><br/><span class="line"></span><br/><span class="line">			<span class="built_in">printf</span>(<span class="string">&#34;tluajit use: %lfn&#34;</span>, use_time*<span class="number">1.0</span> / CLOCKS_PER_SEC);</span><br/><span class="line">		}</span><br/><span class="line">		</span><br/><span class="line">		{</span><br/><span class="line">			<span class="keyword">clock_t</span> start = clock();</span><br/><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; HASH_COUNT; ++i)</span><br/><span class="line">			{</span><br/><span class="line">				a[i] = lua_hash(str.c_str(), str.size());</span><br/><span class="line">			}</span><br/><span class="line">			<span class="keyword">clock_t</span> use_time = clock() - start;</span><br/><span class="line"></span><br/><span class="line">			<span class="built_in">printf</span>(<span class="string">&#34;tlua use: %lfn&#34;</span>, use_time*<span class="number">1.0</span> / CLOCKS_PER_SEC);</span><br/><span class="line">		}</span><br/><span class="line">	}</span><br/><span class="line"></span><br/><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/></pre></td><td class="code"><pre><span class="line">string len = 1:</span><br/><span class="line">    luajit use: 0.000615</span><br/><span class="line">    lua use: 0.000205</span><br/><span class="line">string len = 2:</span><br/><span class="line">    luajit use: 0.000410</span><br/><span class="line">    lua use: 0.000352</span><br/><span class="line">string len = 3:</span><br/><span class="line">    luajit use: 0.000426</span><br/><span class="line">    lua use: 0.000505</span><br/><span class="line">string len = 4:</span><br/><span class="line">    luajit use: 0.000485</span><br/><span class="line">    lua use: 0.000552</span><br/><span class="line">string len = 5:</span><br/><span class="line">    luajit use: 0.000531</span><br/><span class="line">    lua use: 0.000803</span><br/><span class="line">string len = 6:</span><br/><span class="line">    luajit use: 0.000455</span><br/><span class="line">    lua use: 0.000910</span><br/><span class="line">string len = 7:</span><br/><span class="line">    luajit use: 0.000479</span><br/><span class="line">    lua use: 0.001106</span><br/><span class="line">...</span><br/><span class="line">string len = 31:</span><br/><span class="line">    luajit use: 0.000483</span><br/><span class="line">    lua use: 0.005269</span><br/><span class="line">string len = 32:</span><br/><span class="line">    luajit use: 0.000506</span><br/><span class="line">    lua use: 0.002439</span><br/><span class="line">...</span><br/></pre></td></tr></tbody></table></figure>
<ul>
<li>可以看到，除了1，2长度的字符串，lua原生hash快，其他都是luajit快。<br/>漫的速度大致可以通过lua原生hash的循环次数大致估算，如果循环满32次，则性能大致是luajit的1/10倍，如果为16次则为1/5。</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>lua原生的hash算法会导致性能的开销，测试最慢为0.005s/10W次，而luajit为0.0004s/10W次</li>
<li>性能开销带来的同时，从算法层面看到，lua原生的hash算法会跟好，不过这还得需要在实际使用当中进行测试才能得到更准确得结论</li>
</ol>