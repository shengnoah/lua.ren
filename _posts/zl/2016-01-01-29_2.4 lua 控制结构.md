---
layout: post
title: 2.4 lua 控制结构 
tags: [lua文章]
categories: [topic]
---
<p>流程控制语句对于程序设计来说特别重要，它可以用于设定程序的逻辑结构。一般需要与条件判断语句结合使用。Lua 语言提供的控制结构有 if，while，repeat，for，并提供 break 关<br/>键字来满足更丰富的需求。</p>
<h2 id="if-else"><a href="#if-else" class="headerlink" title="if/else"></a>if/else</h2><p>if-else 是我们熟知的一种控制结构。Lua 跟其他语言一样，提供了 if-else 的控制结构。语法上更接近shell的语言，逻辑结构上和其他语言没有较大的区别，直接上实例，一看便知。</p>
<h3 id="单分支if-end"><a href="#单分支if-end" class="headerlink" title="单分支if-end"></a>单分支if-end</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br/><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;x is a positive number&#34;</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/></pre></td></tr></tbody></table></figure>
<h3 id="双分支if-else-end"><a href="#双分支if-else-end" class="headerlink" title="双分支if-else-end"></a>双分支if-else-end</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br/><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;x is a positive number&#34;</span>)</span><br/><span class="line"><span class="keyword">else</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;x is a non-positive number&#34;</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"></span><br/></pre></td></tr></tbody></table></figure>
<h3 id="多分支if-elseif-else-end"><a href="#多分支if-elseif-else-end" class="headerlink" title="多分支if-elseif-else-end"></a>多分支if-elseif-else-end</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line">score = <span class="number">90</span></span><br/><span class="line"><span class="keyword">if</span> score == <span class="number">100</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;Very good!Your score is 100&#34;</span>)</span><br/><span class="line"><span class="keyword">elseif</span> score &gt;= <span class="number">60</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;Congratulations, you have passed it,your score greater or equal to 60&#34;</span>)</span><br/><span class="line"><span class="comment">--此处可以添加多个elseif</span></span><br/><span class="line"><span class="keyword">else</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;Sorry, you do not pass the exam! &#34;</span>)</span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="comment">--运行输出：Congratulations, you have passed it,your score greater or equal to 60</span></span><br/></pre></td></tr></tbody></table></figure>
<p><strong>特别注意|</strong>与 C 语言的不同之处是 else 与 if 是连在一起的，若将 else 与 if 写成 “else if” 则相当于在else 里嵌套另一个 if 语句，如下代码：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/></pre></td><td class="code"><pre><span class="line">score = <span class="number">0</span></span><br/><span class="line"><span class="keyword">if</span> score == <span class="number">100</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;Very good!Your score is 100&#34;</span>)</span><br/><span class="line"><span class="keyword">elseif</span> score &gt;= <span class="number">60</span> <span class="keyword">then</span></span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;Congratulations, you have passed it,your score greater or equal to 60&#34;</span>)</span><br/><span class="line"><span class="keyword">else</span></span><br/><span class="line">    <span class="keyword">if</span> score &gt; <span class="number">0</span> <span class="keyword">then</span></span><br/><span class="line">        <span class="built_in">print</span>(<span class="string">&#34;Your score is better than 0&#34;</span>)</span><br/><span class="line">    <span class="keyword">else</span></span><br/><span class="line">        <span class="built_in">print</span>(<span class="string">&#34;My God, your score turned out to be 0&#34;</span>)</span><br/><span class="line">    <span class="keyword">end</span> <span class="comment">--与上一示例代码不同的是，此处要添加一个end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>从上述实例中可以发现，除了<code>else if</code>这种形式较<code>elseif</code>多了一个<code>end</code>外看起来并没有什么区别。上述实例中<code>else if</code>在判断的最后，如果在中间的话，意味着后面的<code>elseif</code>将会出现语法错误。</p>
<h2 id="while"><a href="#while" class="headerlink" title="while"></a>while</h2><p>Lua 跟其他常见语言一样，提供了 <code>while</code> 控制结构，语法上也没有什么特别的。但是没有提供do-while 型的控制结构，但是提供了功能相当的 <code>repeat</code>。<br/><code>while</code> 型控制结构语法如下，当表达式值为假（ 即 <code>false</code> 或 <code>nil</code>） 时结束循环。也可以使用break 语言提前跳出循环。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> 表达式 <span class="keyword">do</span></span><br/><span class="line">    <span class="comment">--body</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">--示例代码，求 1 + 2 + 3 + 4 + 5 的结果</span></span><br/><span class="line">x = <span class="number">1</span></span><br/><span class="line">sum = <span class="number">0</span></span><br/><span class="line"><span class="keyword">while</span> x &lt;= <span class="number">5</span> <span class="keyword">do</span></span><br/><span class="line">    sum = sum + x</span><br/><span class="line">    x = x + <span class="number">1</span></span><br/><span class="line"><span class="keyword">end</span></span><br/><span class="line"><span class="built_in">print</span>(sum) <span class="comment">--&gt;output 15</span></span><br/></pre></td></tr></tbody></table></figure>
<p><strong>特别注意：</strong><br/>Lua 并没有像许多其他语言那样提供类似 <code>continue</code> 这样的控制语句用来立即进入下一个循环迭代（ 如果有的话） 。因此，我们需要仔细地安排循环体里的分支，以避免这样的需求。</p>
<p>没有提供 <code>continue</code> ，却也提供了另外一个标准控制语句 <code>break</code> ，可以跳出当前循环。例如遍历 <code>table</code>，查找值为 <code>11</code> 的数组下标索引:<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">21</span>}</span><br/><span class="line"><span class="keyword">local</span> i</span><br/><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span></span><br/><span class="line">    <span class="keyword">if</span> <span class="number">11</span> == v <span class="keyword">then</span></span><br/><span class="line">        <span class="built_in">print</span>(<span class="string">&#34;index[&#34;</span> .. i .. <span class="string">&#34;] have right value[11]&#34;</span>)</span><br/><span class="line">        <span class="keyword">break</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h2 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h2><p>Lua 中的 <code>repeat</code> 控制结构类似于其他语言（ 如：C++ 语言） 中的 do-while，但是控制方式是刚好相反的。简单点说，执行 <code>repeat</code> 循环体后，直到 <code>until</code> 的条件为<strong>真</strong>时才结束，而其他语言（ 如：C++ 语言） 的 do-while 则是当条件为假时就结束循环。<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br/><span class="line"><span class="keyword">repeat</span></span><br/><span class="line">    <span class="built_in">print</span>(x)</span><br/><span class="line"><span class="keyword">until</span> <span class="literal">false</span></span><br/><span class="line"><span class="comment">--该代码将导致死循环，因为until的条件一直为假，循环不会结束</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>除了条件相反外，<code>repeat</code>和<code>while</code>是一样的。</p>
<h2 id="for"><a href="#for" class="headerlink" title="for"></a>for</h2><p>for 语句有两种形式：数字 for（ numeric for） 和范型 for（ generic for）。</p>
<h3 id="数字for"><a href="#数字for" class="headerlink" title="数字for"></a>数字for</h3><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var = begin, finish, step <span class="keyword">do</span></span><br/><span class="line">    <span class="comment">--body</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<p>关于数字 for 需要关注以下几点:</p>
<ol>
<li>var 从 begin 变化到 finish，每次变化都以 step 作为步长递增 var;</li>
<li>begin、finish、step 三个表达式只会在循环开始时执行一次;</li>
<li>第三个表达式 step是可选的，默认为 1;</li>
<li>控制变量 var 的作用域仅在 for 循环内，需要在外面控制，则需将值赋给一个新的变量;</li>
<li>循环过程中不要改变控制变量的值，那样会带来不可预知的影响.</li>
</ol>
<figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">10</span>, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></span><br/><span class="line">    <span class="built_in">print</span>(i)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure>
<p>如果不想给循环设置上限的话，可以使用常量 math.huge：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br/><span class="line">    <span class="keyword">if</span> (<span class="number">0.3</span>*i^<span class="number">3</span> - <span class="number">20</span>*i^<span class="number">2</span> - <span class="number">500</span> &gt;=<span class="number">0</span>) <span class="keyword">then</span></span><br/><span class="line">        <span class="built_in">print</span>(i)</span><br/><span class="line">        <span class="keyword">break</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3 id="泛型for"><a href="#泛型for" class="headerlink" title="泛型for"></a>泛型for</h3><p>泛型 for 循环通过一个迭代器（ iterator） 函数来遍历所有值：<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印数组a的所有值</span></span><br/><span class="line"><span class="keyword">local</span> a = {<span class="string">&#34;a&#34;</span>, <span class="string">&#34;b&#34;</span>, <span class="string">&#34;c&#34;</span>, <span class="string">&#34;d&#34;</span>}</span><br/><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#34;index:&#34;</span>, i, <span class="string">&#34; value:&#34;</span>, v)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>结果：<br/></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">index: 1 value: a</span><br/><span class="line">index: 2 value: b</span><br/><span class="line">index: 3 value: c</span><br/><span class="line">index: 4 value: d</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>注意到在上述实例中使用到<code>ipairs</code>函数。Lua 的基础库提供了<code>ipairs</code>，这是一个用于遍历<strong>数组</strong>的迭代器函数。在每次循环中，i 会被赋予一个索引值，同时 v 被赋予一个对应于该索引的数组元素值。那么如何遍历<code>table</code>呢？lua提供了<code>pairs</code>函数可以遍历<code>tbale</code>中的<code>key</code>.<br/></p><figure class="highlight lua"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印table t中所有的key</span></span><br/><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br/><span class="line">    <span class="built_in">print</span>(k)</span><br/><span class="line"><span class="keyword">end</span></span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>从外观上看泛型 for 比较简单，但其实它是非常强大的。通过不同的迭代器，几乎可以遍历所有的东西， 而且写出的代码极具可读性。标准库提供了几种迭代器，包括用于迭代文件中每行的（ io.lines） 、 迭代 table 元素的（ pairs） 、迭代数组元素的（ ipairs） 、迭代字符串中单词的（ string.gmatch） 等。<br/>泛型 for 循环与数字型 for 循环有两个相同点:</p>
<ol>
<li>循环变量是循环体的局部变量；</li>
<li>决不应该对循环变量作任何赋值。</li>
</ol>
<p><strong>特别注意：</strong>在 LuaJIT 2.1 中， ipairs() 内建函数是可以被 JIT 编译的，而 pairs() 则只能被解释执行。因此在性能敏感的场景，应当合理安排数据结构，避免对哈希表进行遍历。事实上，即使未来 pairs 可以被 JIT 编译，哈希表的遍历本身也不会有数组遍历那么高效，毕竟哈希表就不是为遍历而设计的数据结构。</p>