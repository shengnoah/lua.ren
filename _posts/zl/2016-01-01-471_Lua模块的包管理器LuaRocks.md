---
layout: post
title: Lua模块的包管理器LuaRocks 
tags: [lua文章]
categories: [topic]
---
<blockquote>
<p>LuaRocks是Lua模块的包管理器。<br/>它允许你创建和安装Lua模块，作为独立包名为rocks。 您可以在Unix和Windows上下载并安装LuaRocks。<br/>LuaRocks是免费软件，使用与Lua相同的许可证。  </p>
</blockquote>
<p>@[TOC]</p>
<p>官方 ：<a href="https://luarocks.org/" target="_blank" rel="noopener noreferrer">https://luarocks.org/</a></p>
<h2><span id="linux系统下安装">linux系统下安装</span></h2><p>安装包列表：<br/><a href="http://luarocks.github.io/luarocks/releases/" target="_blank" rel="noopener noreferrer">http://luarocks.github.io/luarocks/releases/</a></p>
<h3><span id="简单安装">简单安装</span></h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line">$ wget https://luarocks.org/releases/luarocks-2.4.3.tar.gz</span><br/><span class="line">$ tar zxpf luarocks-2.4.3.tar.gz</span><br/><span class="line">$ cd luarocks-2.4.3</span><br/><span class="line">$ ./configure; sudo make bootstrap</span><br/><span class="line">$ sudo luarocks install luasocket</span><br/><span class="line">$ lua</span><br/><span class="line">Lua 5.3.4 Copyright (C) 1994-2017 Lua.org, PUC-Rio</span><br/><span class="line">&gt; require &#34;socket&#34;</span><br/></pre></td></tr></tbody></table></figure>
<p>设置prefix会自动将Luarocks以及往后使用Luarocks安装的Lua包，LuaC包都安装到Luarocks安装路径下的相应位置，否则相关的包文件散落在文件系统中，显得杂乱不便于管理。<br/>如果所安装的Lua模板包含bin文件，则会自动安装到此目录下的bin路径，与Luarocks可执行文件同一路径，更便于管理、使用。</p>
<h3><span id="openresty-安装-luarocks-示例">openresty 安装 luarocks 示例</span></h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line">tar xzf luarocks-${RESTY_LUAROCKS_VERSION}.tar.gz</span><br/><span class="line">cd luarocks-${RESTY_LUAROCKS_VERSION}</span><br/><span class="line">./configure </span><br/><span class="line"> --prefix=/usr/local/openresty/luajit </span><br/><span class="line"> --with-lua=/usr/local/openresty/luajit </span><br/><span class="line"> --lua-suffix=jit-2.1.0-beta3 </span><br/><span class="line"> --with-lua-include=/usr/local/openresty/luajit/include/luajit-2.1</span><br/><span class="line">make build</span><br/><span class="line">make install</span><br/></pre></td></tr></tbody></table></figure>
<h2><span id="在-openresty-中使用-luarocks">在 OpenResty 中使用 LuaRocks</span></h2><p><a href="https://openresty.org/cn/using-luarocks.html" target="_blank" rel="noopener noreferrer">https://openresty.org/cn/using-luarocks.html</a>  </p>
<h3><span id="安装-luarocks">安装 LuaRocks</span></h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line">wget http://luarocks.org/releases/luarocks-2.0.4.1.tar.gz</span><br/><span class="line">tar -xzvf luarocks-2.0.4.1.tar.gz</span><br/><span class="line">cd luarocks-2.0.4.1/</span><br/><span class="line">./configure</span><br/><span class="line">make</span><br/><span class="line">sudo make install</span><br/></pre></td></tr></tbody></table></figure>
<h3><span id="通过-luarocks安装-lua-md5-库">通过 LuaRocks安装 Lua MD5 库</span></h3><p>在本示例中, 我们将使用 Lua MD5 library 作为服务器上的一个例子, 所以我们需要通过 LuaRocks 来安装它:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">sudo luarocks install md5</span><br/></pre></td></tr></tbody></table></figure>
<h3><span id="配置我们的-openresty-应用">配置我们的 OpenResty 应用</span></h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">cd /usr/local/openresty/nginx/</span><br/></pre></td></tr></tbody></table></figure>
<p>编辑 conf/nginx.conf 文件:<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/></pre></td><td class="code"><pre><span class="line">worker_processes  1;   # we could enlarge this setting on a multi-core machine</span><br/><span class="line">error_log  logs/error.log warn;</span><br/><span class="line"></span><br/><span class="line">events {</span><br/><span class="line">    worker_connections  1024;</span><br/><span class="line">}</span><br/><span class="line"></span><br/><span class="line">http {</span><br/><span class="line">    lua_package_path &#39;conf/?.lua;;&#39;;</span><br/><span class="line"></span><br/><span class="line">    server {</span><br/><span class="line">        listen       80;</span><br/><span class="line">        server_name  localhost;</span><br/><span class="line"></span><br/><span class="line">        location = /luarocks {</span><br/><span class="line">            content_by_lua &#39;</span><br/><span class="line">                local foo = require(&#34;foo&#34;)</span><br/><span class="line">                foo.say(&#34;hello, luarocks!&#34;)</span><br/><span class="line">            &#39;;</span><br/><span class="line">        }</span><br/><span class="line">    }</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>最后,我们创建下面两个 Lua 模块文件 conf/foo.lua<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/></pre></td><td class="code"><pre><span class="line">-- conf/foo.lua</span><br/><span class="line"></span><br/><span class="line">module(&#34;foo&#34;, package.seeall)</span><br/><span class="line"></span><br/><span class="line">local bar = require &#34;bar&#34;</span><br/><span class="line"></span><br/><span class="line">ngx.say(&#34;bar loaded&#34;)</span><br/><span class="line"></span><br/><span class="line">function say (var)</span><br/><span class="line">    bar.say(var)</span><br/><span class="line">end</span><br/></pre></td></tr></tbody></table></figure><p></p>
<p>和 conf/bar.lua 文件<br/></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/></pre></td><td class="code"><pre><span class="line">-- conf/bar.lua</span><br/><span class="line"></span><br/><span class="line">module(&#34;bar&#34;, package.seeall)</span><br/><span class="line"></span><br/><span class="line">local rocks = require &#34;luarocks.loader&#34;</span><br/><span class="line">local md5 = require &#34;md5&#34;</span><br/><span class="line"></span><br/><span class="line">ngx.say(&#34;rocks and md5 loaded&#34;)</span><br/><span class="line"></span><br/><span class="line">function say (a)</span><br/><span class="line">    ngx.say(md5.sumhexa(a))</span><br/><span class="line">end</span><br/></pre></td></tr></tbody></table></figure><p></p>
<h3><span id="开启-nginx-服务">开启 Nginx 服务</span></h3><p>现在我们通过 Nginx 开启我们的应用:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line">ulimit -n1024   # increase the maximal fd count limit per process</span><br/><span class="line">./sbin/nginx</span><br/></pre></td></tr></tbody></table></figure>
<p>如果您已经开启了 Nginx 服务,请先关闭后在重新开启:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">./sbin/nginx -s stop  #（译注:我们也可以使用平滑重启命令完成此操作 ./sbin/nginx -s reload）</span><br/></pre></td></tr></tbody></table></figure>
<h3><span id="测试我们的应用">测试我们的应用</span></h3><p>现在我们通过curl 工具或者任意兼容HTTP协议的浏览器测试我们的应用:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">curl http://localhost/luarocks</span><br/></pre></td></tr></tbody></table></figure>
<p>我们在第一次运行的时候得到以下的内容:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">rocks and md5 loaded</span><br/><span class="line">bar loaded</span><br/><span class="line">85e73df5c41378f830c031b81e4453d2</span><br/></pre></td></tr></tbody></table></figure>
<p>第二次运行的时候得到以下内容:</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">85e73df5c41378f830c031b81e4453d2</span><br/></pre></td></tr></tbody></table></figure>
<p>之所以会出现这样的输出数据是因为 Lua Nginx Module 默认缓存了已经加载过的Lua模块 并且这些输出数据的代码是在 Lua 加载时运行的因此他们将不会在执行.</p>