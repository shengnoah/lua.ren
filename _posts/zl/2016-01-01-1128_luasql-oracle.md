---
layout: post
title: luasql-oracle 
tags: [lua文章]
categories: [topic]
---
<h3 id="一安装-mac"><a href="#一安装-mac" class="headerlink" title="一安装  mac"></a>一安装  mac</h3><p>编译配置：</p>
<pre><code class="bash">git <span class="built_in">clone</span> https://github.com/keplerproject/luasql
<span class="built_in">cd</span>  luasql
vim config

LUA_LIBDIR ?= $(PREFIX)/lib/lua/$(LUA_SYS_VER)
LUA_DIR ?= $(PREFIX)/share/lua/$(LUA_SYS_VER)
LUA_INC ?= /usr/<span class="built_in">local</span>/include/luajit-2.1

<span class="comment"># - Oracle OCI8</span>
DRIVER_LIBS_oci8 ?= -L/opt/oracle/instantclient_11_2 -lz -lclntsh
DRIVER_INCS_oci8 ?= -I/opt/oracle/instantclient_11_2/sdk/include
</code></pre>
<p>安装 instantclient-sqlplus<br/>下载sql:<br/><a href="http://download.oracle.com/otn/mac/instantclient/11204/instantclient-sqlplus-macos.x64-11.2.0.4.0.zip?AuthParam=1483339513_c6c20f6dbd36fa8991b05173024a45a6" target="_blank" rel="external noopener noreferrer">instantclient-sqlplus</a></p>
<pre><code class="bash"><span class="built_in">cd</span> /opt/oracle/instantclient_11_2
unzip instantclient-sqlplus-macos.x64-11.2.0.4.0.zip
mv instantclient-sqlplus-macos/* .
mkdir  /opt/oracle/instantclient_11_2/network/admin/ 
<span class="built_in">cd</span> /opt/oracle/instantclient_11_2/network/admin/ 
<span class="comment"># 增加  tnsnames.ora </span>
cat  /opt/oracle/instantclient_11_2/network/admin/tnsnames.ora 
UATNEW_RNDEFAULT =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 10.57.115.157)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = newuat)
    )
  )
</code></pre>
<p>luajit 测试：</p>
<pre><code class="bash">cat conndb.lua 
<span class="built_in">local</span> driver = require <span class="string">&#34;luasql.oci8&#34;</span>
<span class="built_in">print</span>(driver)

<span class="built_in">local</span> env = driver.oci8()
<span class="built_in">print</span>(env)

<span class="built_in">print</span> (os.time())
<span class="built_in">local</span> dbcon = assert (env:connect(<span class="string">&#34;UATNEW_RNDEFAULT&#34;</span>, <span class="string">&#34;rntrade&#34;</span>, <span class="string">&#34;QWER1234&#34;</span>))
<span class="built_in">print</span>( dbcon )

-- <span class="built_in">local</span> sql = <span class="string">&#34;select count(1) as c from account_address&#34;</span>
-- <span class="built_in">local</span> sql = <span class="string">&#34;select * from send_messges_info WHERE ROWNUM &lt;= 10&#34;</span>
<span class="built_in">local</span> sql = <span class="string">&#34;select count(*) from send_messges_info &#34;</span>
<span class="built_in">local</span> cursor = dbcon:execute(sql)
<span class="built_in">print</span>(cursor)



<span class="built_in">local</span> ret = cursor:fetch({},<span class="string">&#34;a&#34;</span>)
<span class="keyword">for</span> k , v <span class="keyword">in</span> pairs(ret) <span class="keyword">do</span>
   <span class="built_in">print</span>(string.format(<span class="string">&#34;%s %s&#34;</span>,k , v ))
   ngx.say(string.format(<span class="string">&#34;短信总数%s %s&#34;</span>,k , v ))
end
</code></pre>
<h3 id="安装-lua-cjson"><a href="#安装-lua-cjson" class="headerlink" title="安装 lua-cjson"></a>安装 lua-cjson</h3><pre><code class="bash">git <span class="built_in">clone</span> https://github.com/mpx/lua-cjson.git
<span class="built_in">cd</span> lua-cjson
<span class="comment"># 修改 lua 目录：</span>
LUA_INC ?= /usr/<span class="built_in">local</span>/include/luajit-2.1
<span class="comment">## MacOSX (Macports)</span>
<span class="comment">#PREFIX =            /opt/local</span>
<span class="comment">#  修改CJSON_LDFLAGS =     -shared</span>
CJSON_LDFLAGS =     -bundle -undefined dynamic_lookup
make
</code></pre>