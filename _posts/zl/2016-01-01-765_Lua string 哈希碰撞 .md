---
layout: post
title: Lua string 哈希碰撞  
tags: [lua文章]
categories: [topic]
---
<p>Lua 中 40 字节以下的字符串会被内部化到一张表中(Lua 5.3)，这张表挂在 global state 结构下。对于短字符串，相同的串在同一虚拟机上只会存在一份，这被称为字符串的内部化。</p>

<blockquote>
  <p>其实字符串在 Lua VM 中是以两种内部形式保存的：短字符串及长字符串。其界限默认设置为40（字节）</p>
</blockquote>

<p>对于比较长的字符串（32字节以上），为了加快哈希过程，计算字符串哈希值是跳跃进行的（并没有 hash 全部的位）。</p>

<p><a href="http://lua-users.org/wiki/HashDos">Lua Wiki</a> 上列出了各个版本的 Lua 对于 <code class="language-plaintext highlighter-rouge">string</code> 没有计算 hash 的长度：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hash</span> <span class="n">algorithm</span> <span class="n">analysis</span>
<span class="c1">-- number of bytes not used in hash function</span>
<span class="o">==============================================================</span>
<span class="n">String</span> <span class="n">length</span>                  <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">15</span><span class="o">-</span><span class="mi">20</span> <span class="p">,</span>  <span class="mi">20</span><span class="o">-</span><span class="mi">32</span> <span class="p">,</span> <span class="mi">32</span><span class="o">-</span><span class="mi">64</span>
<span class="c1">--------------------------------------------------------------</span>
<span class="n">Lua</span> <span class="mi">5</span><span class="p">.</span><span class="mi">1</span>                        <span class="mi">0</span>   <span class="p">,</span>    <span class="mi">0</span>   <span class="p">,</span>    <span class="mi">0</span>   <span class="p">,</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span>
<span class="n">Lua</span> <span class="mi">5</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span>                      <span class="mi">0</span>   <span class="p">,</span>    <span class="mi">0</span>   <span class="p">,</span>    <span class="mi">0</span>   <span class="p">,</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span>
<span class="n">LuaJit</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">beta9</span>             <span class="mi">0</span><span class="o">-</span><span class="mi">1</span> <span class="p">,</span>   <span class="mi">2</span><span class="o">-</span><span class="mi">4</span>  <span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">16</span> <span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">16</span>
</code></pre></div></div>

<p>可以看到对于 Lua 5.1 来说，当字符串大于 32 字节时，有一半的长度被忽略掉了。这样就很容易来构造一个 hash 碰撞。比如下面 3 个字符串，就拥有相同的 hash：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">&#34;0000000000000000000000000000000000&#34;</span>
<span class="s2">&#34;f0l0l0w0m0e0n0t0w0i0t0t0e0r0?0:0)0&#34;</span>
<span class="s2">&#34;x0x0x0x0x0x0x0x0x0x0x0x0x0x0x0x0x0&#34;</span>
</code></pre></div></div>

<blockquote>
  <p>在 Python 中可以通过 <code class="language-plaintext highlighter-rouge">hash(str)</code> 来查看字符串的 hash；Ruby 可以这样 <code class="language-plaintext highlighter-rouge">str.hash</code>。遗憾的是，Lua 并没有提供这样的能力，so sad.</p>
</blockquote>

<p>另外，<a href="https://gist.github.com/funny-falcon/685dbfaea16b5919e6c84ab1b156d2f6https://gist.github.com/funny-falcon/685dbfaea16b5919e6c84ab1b156d2f6">@Sokolov Yura</a> 也给出了一个用例：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- for i in {1..6}; do time lua test_str_hash_collision.lua $i; done</span>

<span class="kd">local</span> <span class="n">lng</span> <span class="o">=</span> <span class="nb">string.rep</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="mi">128</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">N</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">N</span> <span class="ow">and</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span>
<span class="kd">local</span> <span class="n">J</span>

<span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%08x&#34;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">elseif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">500000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%s%08x&#34;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">elseif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%s%08x%s&#34;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">elseif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%s%08x%s%s&#34;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">elseif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%s%s%08x%s&#34;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">elseif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">6</span> <span class="k">then</span>
    <span class="n">J</span> <span class="o">=</span> <span class="mi">300000</span>
    <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">J</span> <span class="k">do</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="o">%</span><span class="mi">8192</span><span class="p">]</span> <span class="o">=</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&#34;%s%s%s%08x&#34;</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="o">#</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>

<p>为了防止 Hash DoS 攻击的发生，Lua 5.3 开始，一方面将长字符串独立出来，大文本的输入字符串将不再通过哈希内部化进入全局字符串表中；<u>另一方面使用一个随机种子用于字符串哈希值的计算，使得攻击者无法轻易构造出拥有相同哈希值的不同字符串</u>。</p>

<p>而对于 Lua 5.1，Wiki 给出了一个 <a href="http://lua-users.org/files/wiki_insecure/power_patches/5.1/lua_5.1_second_hash_fix.patch">Second Hash 补丁</a>，就是如果发生了冲突，则再用 <code class="language-plaintext highlighter-rouge">FNV1 hash</code> 算法重新计算 hash.</p>

<hr/>

<h4 id="参考文献">参考文献：</h4>

<ul>
  <li><a href="http://www.cnblogs.com/heartchord/p/4561308.html">lua 字符串</a></li>
  <li><a href="https://github.com/LuaJIT/LuaJIT/issues/168">Reduce string hash collisions</a></li>
  <li><a href="https://kate.io/blog/simple-hash-collisions-in-lua/">Simple Hash Collisions</a></li>
</ul>



                <hr style="visibility: hidden;"/>