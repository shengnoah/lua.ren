<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Openresty OOM 臭虫 &#8211; LUA教程</title>
<meta name="description" content="Openresty OOM 臭虫">
<meta name="keywords" content="lua">


<!-- Baidu ZZ www.lua.ren-->
<meta name="baidu-site-verification" content="code-mUfTLvBErv" />
<!-- Baidu ZZ lua.ren-->
<meta name="baidu-site-verification" content="code-1frv44bXq0" />
<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Openresty OOM 臭虫">
<meta property="og:description" content="Openresty OOM 臭虫">
<meta property="og:url" content="http://0.0.0.0:8081/topic/376/">
<meta property="og:site_name" content="LUA教程">
<meta property="og:image" content="http://0.0.0.0:8081/images/images/logo.png">





<link rel="canonical" href="http://0.0.0.0:8081/topic/376/">
<link href="http://0.0.0.0:8081/feed.xml" type="application/atom+xml" rel="alternate" title="LUA教程 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/main.css">
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://0.0.0.0:8081/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://0.0.0.0:8081/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://0.0.0.0:8081/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://0.0.0.0:8081/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://0.0.0.0:8081/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://0.0.0.0:8081/images/apple-touch-icon-144x144-precomposed.png">





<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?14cc93bf3f08d31c458639d309dde522";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>
   r

</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><h2><i class="fa fa-bars"></i></h2></a></li>
      <li class="header-item-title">
        <a href="http://0.0.0.0:8081/">
          
            <img class="logo" src="http://0.0.0.0:8081/images/logo.png" alt="LUA教程">
          
          <a href="http://0.0.0.0:8081/" class="title"> LUA教程</a>
        </a>
      </li>
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/categories"><h3>分类</h3></a>
            <ul class="header-submenu">
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#      .md">      .md</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#AI">AI</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#Documents">Documents</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#HiLua框架">HiLua框架</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#LUA教程">LUA教程</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#Lapis框架">Lapis框架</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#MoonScript语法">MoonScript语法</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#MoonScript项目">MoonScript项目</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#OPENRESTY">OPENRESTY</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#lua_guide">lua_guide</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#lua教程">lua教程</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#mysql">mysql</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#openresty最佳实践">openresty最佳实践</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#python">python</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#tools">tools</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#topic">topic</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#动态库">动态库</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#安全">安全</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#机械键盘">机械键盘</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#网关">网关</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#键盘">键盘</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#静电容键盘">静电容键盘</a></li>
              
            </ul>
          </li>
        
      
        
        

        
            
                <li class="header-item "><a href="http://0.0.0.0:8081/tags"><h3>标签</h3></a></li>
            
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua高级</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/error-handling/">Lua错语处理</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/coroutines/">Lua协程</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/metatables/">Lua元表</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/garbage-collection/">Lua垃圾回收机制</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua循环</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/for/">for循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/while/">while循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/loop/">loop循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/repeat-until/">repeat until循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/iterators/">iterators迭代器</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua判断</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/decision-making/">Lua判断</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/if-statement/">If语句</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/if-else-if-statement/">If else语句</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua基础语法</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/variables/">变量</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/strings/">字符串</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/tables/">表</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/operators/">操作符</a></li>
              
            </ul>
          </li>
        
      
      <li class="header-item"><a href="http://0.0.0.0:8081/search"><h3><i class="fa fa-search"></i></h3></a></li>
    </ul>
  </div>

<div class="entry-header">
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Openresty OOM 臭虫</h1>
      
        <h2><span class="entry-date date published updated"><time datetime="2016-09-17T22:50:18+08:00">September 17, 2016</time></span></h2>
      

      
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~14 minutes
        </p>
      
    </div>
  </div>
</div>

<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua基础语法</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/variables/">变量</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/strings/">字符串</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/tables/">表</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/operators/">操作符</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua判断</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/decision-making/">Lua判断</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/if-statement/">If语句</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/if-else-if-statement/">If else语句</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua循环</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/for/">for循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/while/">while循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/loop/">loop循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/repeat-until/">repeat until循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/iterators/">iterators迭代器</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua高级</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/error-handling/">Lua错语处理</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/coroutines/">Lua协程</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/metatables/">Lua元表</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/garbage-collection/">Lua垃圾回收机制</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/tags"><h3>标签</h3></a></li>
      
    
      
        <li><a href="http://0.0.0.0:8081/categories"><h3>分类</h3></a>
          <ul>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#      .md">      .md</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#AI">AI</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#Documents">Documents</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#HiLua框架">HiLua框架</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#LUA教程">LUA教程</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#Lapis框架">Lapis框架</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#MoonScript语法">MoonScript语法</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#MoonScript项目">MoonScript项目</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#OPENRESTY">OPENRESTY</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#lua_guide">lua_guide</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#lua教程">lua教程</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#mysql">mysql</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#openresty最佳实践">openresty最佳实践</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#python">python</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#tools">tools</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#topic">topic</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#动态库">动态库</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#安全">安全</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#机械键盘">机械键盘</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#网关">网关</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#键盘">键盘</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#静电容键盘">静电容键盘</a></li>
            
          </ul>
        </li>
      
    
  </ul>
</nav>






<div id="main" role="main">
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">Openresty OOM 臭虫</h1>
      <h3 id="openresty-oom-臭虫">Openresty OOM 臭虫</h3>

<p>最近我在线上改变了一个的 Nginx 配置，导致 OOM（Out of Memory） killer 在 Nginx 加载新配置的过程中 杀死了 Nginx 进程。这是添加到配置中的行：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
</code></pre></div></div>

<p>在这篇文章中，我将会阐述我是如何找出这个问题的根本原因、记录在这个过程中现学现用的工具。这篇文章内容细节非常琐碎。在进行深入阅读前，先列下使用的软件栈：</p>

<ul>
  <li>Openssl <code class="highlighter-rouge">1.0.2j</code></li>
  <li>OS:<code class="highlighter-rouge">Ubuntu Trusty with Linux 3.19.0-80-generic</code></li>
  <li>Nginx:<code class="highlighter-rouge">Openresty bundle 1.11.2</code></li>
  <li>glibc:<code class="highlighter-rouge">Ubuntu EGLIBC 2.19-0ubuntu6.9</code></li>
</ul>

<p>我们从 OOM Killer 开始。它是一个 Linux 内核函数，当内核不能分配更多的内存空间的时候它将会被触发。OOM Killer 的任务是探测哪一个进程是对系统危害最大（参考<a href="https://linux-mm.org/OOM_Killer"> https://linux-mm.org/OOM_Killer</a>,获取更多关于坏评分是如何计算出来的信息），一旦检测出来，将会杀死进程、释放内存。也就是说我遇到的情况是 ，Nginx 是在申请越来越多的内存，最终内核申请内存失败并且触发OOM Killer，杀死 Nginx 进程。</p>

<p>到此为止，现在让我们看看当 Nginx 重新加载配置的时候做了什么。可以使用 <code class="highlighter-rouge">strace</code> 进行跟踪。这是一个非常棒的工具，能在不用阅读源码的情况下查看程序正在做什么。</p>

<p>在我这里，执行：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo strace -p `cat /var/run/nginx.pid` -f
</code></pre></div></div>

<p>接着</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo /etc/inid.t/nginx reload
</code></pre></div></div>

<p><code class="highlighter-rouge">-f</code> 选项告诉 <code class="highlighter-rouge">strace</code> 也要对子进程进行跟踪。 在<a href="http://jvns.ca/zines/#strace-zine.">http://jvns.ca/zines/#strace-zine.</a>你能看到一个对<code class="highlighter-rouge">strace</code>非常好的评价。下面是一个非常有趣的片段，执行完<code class="highlighter-rouge">strace</code>后输出的：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[pid 31774] open("/etc/ssl/certs/ca-certificates.crt", O_RDONLY) = 5
[pid 31774] fstat(5, {st_mode=S_IFREG|0644, st_size=274340, ...}) = 0
[pid 31774] mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f6dc8266000
[pid 31774] read(5, "-----BEGIN CERTIFICATE-----\nMIIH"..., 4096) = 4096
[pid 31774] read(5, "WIm\nfQwng4/F9tqgaHtPkl7qpHMyEVNE"..., 4096) = 4096
[pid 31774] read(5, "Ktmyuy/uE5jF66CyCU3nuDuP/jVo23Ee"..., 4096) = 4096
...&lt;stripped for clarity&gt;...
[pid 31774] read(5, "MqAw\nhi5odHRwOi8vd3d3Mi5wdWJsaWM"..., 4096) = 4096
[pid 31774] read(5, "dc/BGZFjz+iokYi5Q1K7\ngLFViYsx+tC"..., 4096) = 4096
[pid 31774] brk(0x26d3000)              = 0x26b2000
[pid 31774] mmap(NULL, 1048576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f6c927c3000
[pid 31774] read(5, "/lmci3Zt1/GiSw0r/wty2p5g0I6QNcZ4"..., 4096) = 4096
[pid 31774] read(5, "iv9kuXclVzDAGySj4dzp30d8tbQk\nCAU"..., 4096) = 4096
...&lt;stripped for clarity&gt;...
[pid 31774] read(5, "ye8\nFVdMpEbB4IMeDExNH08GGeL5qPQ6"..., 4096) = 4096
[pid 31774] read(5, "VVNUIEVs\nZWt0cm9uaWsgU2VydGlmaWt"..., 4096) = 4004
[pid 31774] read(5, "", 4096)           = 0
[pid 31774] close(5)                    = 0
[pid 31774] munmap(0x7f6dc8266000, 4096) = 0

</code></pre></div></div>

<p>这段重复了很多次！有两行非常有意思。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open("/etc/ssl/certs/ca-certificates.crt", O_RDONLY) = 5
</code></pre></div></div>

<p>这行意味着是跟修改的配置（上面提到的修改）有关的操作，</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mmap(NULL, 1048576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f6c927c3000
</code></pre></div></div>

<p>这行意味着在<code class="highlighter-rouge">read</code>过程中间请求内核分配 1M 内存空间。</p>

<p>在 <code class="highlighter-rouge">strace</code> 的输出中，另一个有意思的细节是分配的内存从来没有执行<code class="highlighter-rouge">munmap</code>进行释放。注意在调用<code class="highlighter-rouge">close</code>后<code class="highlighter-rouge">0x7f6dc8266000</code>才被传入<code class="highlighter-rouge">munmap</code>。</p>

<p>这些事实让我相信 ，当设置<code class="highlighter-rouge">lua_ssl_trusted_certificate</code>这条指令后，Nginx 发生了 内存泄露（尽管我对底层调试几乎没有任何经验）。什么？Nginx 发生了内存泄露，难道那还不让人兴奋？！不要这么兴奋。</p>

<p>为了找出是Nginx 的哪个组件发生了内存泄露，我决定使用 <code class="highlighter-rouge">gdb</code>。如果编译程序的时候打开了调试符号选项，<code class="highlighter-rouge">gdb</code>将会非常有用。如上所述，我使用的是 Nginx Openresty 套件， 需要使用下面的命令开启调试符号选项重新编译：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/openresty-1.11.2.2 $ ./configure -j2 --with-debug --with-openssl=../openssl-1.0.2j/ --with-openssl-opt="-d no-asm -g3 -O0 -fno-omit-frame-pointer -fno-inline-functions"
</code></pre></div></div>

<p><code class="highlighter-rouge">--with-openssl-opt="-d no-asm -g3 -O0 -fno-omit-frame-pointer -fno-inline-functions"</code> 确保 OpenSSL 编译的时候也开启调试符号信息。现在已经在Openresty的可执行程序中带有了调试符号信息，能通过<code class="highlighter-rouge">gdb</code>启动运行、找到上面提到的触发<code class="highlighter-rouge">mmap</code>的具体的调用函数。</p>

<p>首先我们需要启动<code class="highlighter-rouge">gdb</code>调试 Openresty 可执行程序：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gdb `which openresty`
</code></pre></div></div>

<p>这个命令将打开<code class="highlighter-rouge">gdb</code>命令行，像下面这样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.2) 7.7.1
Copyright (C) 2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /usr/local/openresty/bin/openresty...done.
(gdb)

</code></pre></div></div>

<p>接下来，设置程序的命令行参数</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) set args -p `pwd` -c nginx.conf
</code></pre></div></div>

<p>这将使<code class="highlighter-rouge">gdb</code>在启动 Opneresty/Nginx 的时候把给出的命令行参数传递过去。接着配置断点，使其能够暂停程序到某一个文件的某一行或者是某一个函数。因为我想找出在<code class="highlighter-rouge">open</code>打开信任的验证文件后，那个令人奇怪的<code class="highlighter-rouge">mmap</code>的调用者，所以我首先添加了一个断点在</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open("/etc/ssl/certs/ca-certificates.crt", O_RDONLY) = 5
</code></pre></div></div>

<p>断点设置如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>break open if strcmp($rdi, "/etc/ssl/certs/ca-certificates.crt") == 0
</code></pre></div></div>

<p>如果你先前没有了解过gdb，gdb 是非常棒的工具，可以使用它添加一个自定义的条件来创建复杂的断点。这里我们告诉<code class="highlighter-rouge">gdb</code>暂停程序，如果<code class="highlighter-rouge">open</code>函数被调用并且<code class="highlighter-rouge">rdi</code>寄存器指向的数据是 <code class="highlighter-rouge">/etc/ssl/certs/ca-certificates.crt</code> 。我不知道是否还有更好的方式，<!-- 但是我是在观察了多次发现这种添加条件断点的方式 -->我是在反复尝试后，发现<code class="highlighter-rouge">open</code>函数的第一个参数（文件路径）保存在了<code class="highlighter-rouge">rdi</code>寄存器，所以才会如此设置断点。现在告诉<code class="highlighter-rouge">gdb</code>运行程序：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) run
</code></pre></div></div>

<p>第一次出现<code class="highlighter-rouge">open("/etc/ssl/certs/ca-certificates.crt", O_RDONLY)</code>调用时，<code class="highlighter-rouge">gdb</code>将会暂停程序执行。现在我们可以使用其他的<code class="highlighter-rouge">gdb</code>辅助命令观察此刻程序的内部状态。下面是程序执行到断点的时候的内部状态：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Breakpoint 1, open64 () at ../sysdeps/unix/syscall-template.S:81
81  ../sysdeps/unix/syscall-template.S: No such file or directory.
(gdb) bt
#0  open64 () at ../sysdeps/unix/syscall-template.S:81
#1  0x00007ffff6a3dec8 in _IO_file_open (is32not64=8, read_write=8, prot=438, posix_mode=&lt;optimized out&gt;, filename=0x7fffffffdb00 "\346\f\362\367\377\177", fp=0x7ffff7f28a10) at fileops.c:228
#2  _IO_new_file_fopen (fp=fp@entry=0x7ffff7f28a10, filename=filename@entry=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", mode=&lt;optimized out&gt;, mode@entry=0x6fb62d "r", is32not64=is32not64@entry=1) at fileops.c:333
#3  0x00007ffff6a323d4 in __fopen_internal (filename=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", mode=0x6fb62d "r", is32=1) at iofopen.c:90
#4  0x00000000005b3fd2 in file_fopen (filename=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", mode=0x6fb62d "r") at bss_file.c:164
#5  0x00000000005b3fff in BIO_new_file (filename=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", mode=0x6fb62d "r") at bss_file.c:172
#6  0x00000000005e8ad3 in X509_load_cert_crl_file (ctx=0x7ffff7f289e0, file=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", type=1) at by_file.c:251
#7  0x00000000005e8626 in by_file_ctrl (ctx=0x7ffff7f289e0, cmd=1, argp=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", argl=1, ret=0x0) at by_file.c:115
#8  0x00000000005e5747 in X509_LOOKUP_ctrl (ctx=0x7ffff7f289e0, cmd=1, argc=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", argl=1, ret=0x0) at x509_lu.c:120
#9  0x00000000005dd5c1 in X509_STORE_load_locations (ctx=0x7ffff7f28750, file=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", path=0x0) at x509_d2.c:94
#10 0x0000000000546e22 in SSL_CTX_load_verify_locations (ctx=0x7ffff7f27fd0, CAfile=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", CApath=0x0) at ssl_lib.c:3231
#11 0x0000000000477d94 in ngx_ssl_trusted_certificate (cf=cf@entry=0x7fffffffe150, ssl=0x7ffff7f27a78, cert=cert@entry=0x7ffff7f22f20, depth=&lt;optimized out&gt;) at src/event/ngx_event_openssl.c:687
#12 0x00000000004f0a1b in ngx_http_lua_set_ssl (llcf=0x7ffff7f22ef8, cf=0x7fffffffe150) at ../ngx_lua-0.10.7/src/ngx_http_lua_module.c:1240
#13 ngx_http_lua_merge_loc_conf (cf=0x7fffffffe150, parent=0x7ffff7f15808, child=0x7ffff7f22ef8) at ../ngx_lua-0.10.7/src/ngx_http_lua_module.c:1158
#14 0x000000000047e2b1 in ngx_http_merge_servers (cmcf=&lt;optimized out&gt;, cmcf=&lt;optimized out&gt;, ctx_index=&lt;optimized out&gt;, module=&lt;optimized out&gt;, cf=&lt;optimized out&gt;) at src/http/ngx_http.c:599
#15 ngx_http_block (cf=0x7fffffffe150, cmd=0x0, conf=0x1b6) at src/http/ngx_http.c:269
#16 0x0000000000460b5b in ngx_conf_handler (last=1, cf=0x7fffffffe150) at src/core/ngx_conf_file.c:427
#17 ngx_conf_parse (cf=cf@entry=0x7fffffffe150, filename=filename@entry=0x7ffff7f0b9e8) at src/core/ngx_conf_file.c:283
#18 0x000000000045e2f1 in ngx_init_cycle (old_cycle=old_cycle@entry=0x7fffffffe300) at src/core/ngx_cycle.c:274
#19 0x000000000044cef4 in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at src/core/nginx.c:276

</code></pre></div></div>

<p>真令人兴奋，<code class="highlighter-rouge">gdb</code>向我们展示了完整的函数调用栈及参数！查看此刻寄存器中的数据，可以用 <code class="highlighter-rouge">info registers</code>命令。为了更好的理解调用栈，我查看了一下 <code class="highlighter-rouge">Nginx</code>的内部工作流程（我记得Openresty仅仅是组装了一些额外的模块的Nginx）。Nginx 内部所有的（除了Nginx 核心）都被实现为模块，这些模块注册 handlers 和 filters。Nginx 的配置文件主要有三个主要的块组成，分别是main、server、location。
假设您的自定义Nginx模块引入了一个新的配置指令，那么您还需要注册一个处理程序（handler）来处理该指令的配置的值。因此整个过程如下 Nginx 解析配置文件，每一个配置部分解析后就会调用注册的相应处理程序。下面是<code class="highlighter-rouge">lua-nginx-module</code>（Openresty Nginx 组件的核心模块）的实现：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">ngx_http_module_t</span> <span class="n">ngx_http_lua_module_ctx</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if (NGX_HTTP_LUA_HAVE_MMAP_SBRK)                                            \
    &amp;&amp; (NGX_LINUX)                                                           \
    &amp;&amp; !(NGX_HTTP_LUA_HAVE_CONSTRUCTOR)
</span>    <span class="n">ngx_http_lua_pre_config</span><span class="p">,</span>          <span class="cm">/*  preconfiguration */</span>
<span class="cp">#else
</span>    <span class="nb">NULL</span><span class="p">,</span>                             <span class="cm">/*  preconfiguration */</span>
<span class="cp">#endif
</span>    <span class="n">ngx_http_lua_init</span><span class="p">,</span>                <span class="cm">/*  postconfiguration */</span>

    <span class="n">ngx_http_lua_create_main_conf</span><span class="p">,</span>    <span class="cm">/*  create main configuration */</span>
    <span class="n">ngx_http_lua_init_main_conf</span><span class="p">,</span>      <span class="cm">/*  init main configuration */</span>

    <span class="n">ngx_http_lua_create_srv_conf</span><span class="p">,</span>     <span class="cm">/*  create server configuration */</span>
    <span class="n">ngx_http_lua_merge_srv_conf</span><span class="p">,</span>      <span class="cm">/*  merge server configuration */</span>

    <span class="n">ngx_http_lua_create_loc_conf</span><span class="p">,</span>     <span class="cm">/*  create location configuration */</span>
    <span class="n">ngx_http_lua_merge_loc_conf</span>       <span class="cm">/*  merge location configuration */</span>
<span class="p">};</span>


</code></pre></div></div>

<p>这里是 Nginx 模块注册的处理程序。从注释中你也可以看到，Nginx 解析出来一个 location 配置 就会调用 <code class="highlighter-rouge">ngx_http_lua_merge_loc_conf </code> 将配置和 main 块合并。回到我们的上面的<code class="highlighter-rouge">gdb</code>输出,可以看到<code class="highlighter-rouge">#13</code>就是这个函数调用。默认情况下对于每一个 location 块配置这个函数将会被调用。通过<a href="https://github.com/openresty/lua-nginx-module/blob/master/src/ngx_http_lua_module.c#L1093">源码</a>我们可以看到这个函数直接去读去配置值、继承server中的配置条目、设置默认值。如果设置了<code class="highlighter-rouge">lua_ssl_trusted_certificate </code>指令，可以看到其中调用了<code class="highlighter-rouge">ngx_http_lua_set_ssl</code>,在其内部又调用了Nginx SSL 模块的 <code class="highlighter-rouge">ngx_ssl_trusted_certificate</code>。<code class="highlighter-rouge">ngx_ssl_trusted_certificate</code> 是一个非常简单的函数，对于给定的配置块（一个location 块），设置SSL 环境(context)的验证深度，调用另外一个 OpenSSL API 加载验证文件（还有一些错误处理）。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
0649 ngx_int_t
0650 ngx_ssl_trusted_certificate(ngx_conf_t *cf, ngx_ssl_t *ssl, ngx_str_t *cert,
0651     ngx_int_t depth)
0652 {
0653     SSL_CTX_set_verify_depth(ssl-&gt;ctx, depth);
0654 
0655     if (cert-&gt;len == 0) {
0656         return NGX_OK;
0657     }
0658 
0659     if (ngx_conf_full_name(cf-&gt;cycle, cert, 1) != NGX_OK) {
0660         return NGX_ERROR;
0661     }
0662 
0663     if (SSL_CTX_load_verify_locations(ssl-&gt;ctx, (char *) cert-&gt;data, NULL)
0664         == 0)
0665     {
0666         ngx_ssl_error(NGX_LOG_EMERG, ssl-&gt;log, 0,
0667                       "SSL_CTX_load_verify_locations(\"%s\") failed",
0668                       cert-&gt;data);
0669         return NGX_ERROR;
0670     }
0671 
0672     /*
0673      * SSL_CTX_load_verify_locations() may leave errors in the error queue
0674      * while returning success
0675      */
0676 
0677     ERR_clear_error();
0678 
0679     return NGX_OK;
0680 }

</code></pre></div></div>

<p>Nginx SSL 模块的完整代码在<a href="http://lxr.nginx.org/source/src/event/ngx_event_openssl.c">这里</a>能找到。</p>

<p>现在我们已经走到调用栈的一半了，并且走出了 Nginx的世界。下一个函数调用是<code class="highlighter-rouge">SSL_CTX_load_verify_locations</code>，来自于 OpenSSL。程序在这里程序打开了信任的验证文件，并且暂停。接下来将会读取文件（根据上面的<code class="highlighter-rouge">strace</code>输出）。</p>

<p>由于我最初的目的就是找出是谁调用了令人奇怪的<code class="highlighter-rouge">mmap</code> 调用，很自然的下一个断点就是:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) b mmap
</code></pre></div></div>

<p><code class="highlighter-rouge">b</code>是<code class="highlighter-rouge">break</code>的简写。<code class="highlighter-rouge">(gdb) c</code>将会继续程序的执行。程序暂停在了下一个断点：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Breakpoint 3, mmap64 () at ../sysdeps/unix/syscall-template.S:81
81  ../sysdeps/unix/syscall-template.S: No such file or directory.
(gdb) bt
#0  mmap64 () at ../sysdeps/unix/syscall-template.S:81
#1  0x00007ffff6a44ad2 in sysmalloc (av=0x7ffff6d82760 &lt;main_arena&gt;, nb=48) at malloc.c:2495
#2  _int_malloc (av=0x7ffff6d82760 &lt;main_arena&gt;, bytes=40) at malloc.c:3800
#3  0x00007ffff6a466c0 in __GI___libc_malloc (bytes=40) at malloc.c:2891
#4  0x000000000057d829 in default_malloc_ex (num=40, file=0x6f630f "a_object.c", line=350) at mem.c:79
#5  0x000000000057deb9 in CRYPTO_malloc (num=40, file=0x6f630f "a_object.c", line=350) at mem.c:346
&lt;internal OpenSSL function calls stripped for clarity&gt;
#30 0x000000000065e2f7 in PEM_X509_INFO_read_bio (bp=0x7ffff7f28c50, sk=0x0, cb=0x0, u=0x0) at pem_info.c:248
#31 0x00000000005e8b22 in X509_load_cert_crl_file (ctx=0x7ffff7f289e0, file=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", type=1) at by_file.c:256
#32 0x00000000005e8626 in by_file_ctrl (ctx=0x7ffff7f289e0, cmd=1, argp=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", argl=1, ret=0x0) at by_file.c:115
#33 0x00000000005e5747 in X509_LOOKUP_ctrl (ctx=0x7ffff7f289e0, cmd=1, argc=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", argl=1, ret=0x0) at x509_lu.c:120
#34 0x00000000005dd5c1 in X509_STORE_load_locations (ctx=0x7ffff7f28750, file=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", path=0x0) at x509_d2.c:94
#35 0x0000000000546e22 in SSL_CTX_load_verify_locations (ctx=0x7ffff7f27fd0, CAfile=0x7ffff7f20ce6 "/etc/ssl/certs/ca-certificates.crt", CApath=0x0) at ssl_lib.c:3231
#36 0x0000000000477d94 in ngx_ssl_trusted_certificate (cf=cf@entry=0x7fffffffe150, ssl=0x7ffff7f27a78, cert=cert@entry=0x7ffff7f22f20, depth=&lt;optimized out&gt;) at src/event/ngx_event_openssl.c:687
#37 0x00000000004f0a1b in ngx_http_lua_set_ssl (llcf=0x7ffff7f22ef8, cf=0x7fffffffe150) at ../ngx_lua-0.10.7/src/ngx_http_lua_module.c:1240
#38 ngx_http_lua_merge_loc_conf (cf=0x7fffffffe150, parent=0x7ffff7f15808, child=0x7ffff7f22ef8) at ../ngx_lua-0.10.7/src/ngx_http_lua_module.c:1158
#39 0x000000000047e2b1 in ngx_http_merge_servers (cmcf=&lt;optimized out&gt;, cmcf=&lt;optimized out&gt;, ctx_index=&lt;optimized out&gt;, module=&lt;optimized out&gt;, cf=&lt;optimized out&gt;) at src/http/ngx_http.c:599
&lt;Nginx function calls stripped for clarity&gt;

</code></pre></div></div>

<p>此刻我异常兴奋。我“发现”了一个OpenSSL内存泄露！带着异常兴奋的情绪，我开始阅读理解 上个世纪90年代就开发的 OpenSSL 的<a href="https://github.com/openssl/openssl/blob/master/crypto/x509/by_file.c#L2">代码</a>。如此高兴，接下来的几天几夜去理解这写函数并且试图找到我非常确定的函数中的内存泄露。看了许多给 OpenSSL 的内存泄露bug（尤其是和上面这个函数相关的）后，我信心大增，因此我有花了几天几夜去捉这个臭虫！</p>

<p>基本上这些函数做的事情是 首先打开受信任的证书文件，分配缓冲（4096字节），从文件中读取 4KB 内容到缓冲区，解密数据，转换成 OpenSSL 的内部表示，保存到给定的SSL context的<a href="https://github.com/openssl/openssl/blob/75e314f2d573d4f984ff6a371be7a4966bf5f4c5/crypto/x509/by_file.c#L211">证书存储区</a>（这个属于一个 location 块上下文环境）。因此以后无论何时，在这个<code class="highlighter-rouge">location</code>块中，当Nginx需要验证SSL 客户端证书的时候，都将会调用OpneSSL 中的<code class="highlighter-rouge">SSL_get_verify_result</code>传递开始保存保存的 SSL context。接着那个函数将会使用已经加载的和内部初始化的受信任证书验证客户端。</p>

<p>这就是日日夜夜学习的那些所有的事情如何在一起工作的收获，但是没有发现一个bug。</p>

<p>也了解到<code class="highlighter-rouge">mmap</code>是被在<code class="highlighter-rouge">CRYPTO_malloc </code>触发的<code class="highlighter-rouge">malloc</code>调用的，<code class="highlighter-rouge">CRYPTO_malloc</code>是另一个OpenSSL 函数，用来扩展证书存储大小，使其可以适应解密和内部初始化的证书数据。现在我已经知道究竟发生了什么，其不会释放所分配的内存，因为OpenSSL在这个进程生命周期中的后面可能会使用。</p>

<p><strong>但是这个主要的问题 ，当lua_ssl_trusted_certificate  指令配置后，为什 么 Nginx 消耗的内存增长如此之快，还是一个谜。</strong></p>

<p>从我手中掌握的已有数据来看是每个 location 块中的 <code class="highlighter-rouge">mmap</code>导致了这个问题。现在我决定提出 Openresty/Nginx 中的相关代码，用相同的 OpenSSL API 写一个独立C程序加载配置文件。</p>

<p>反复调用模拟多个 location 块（我这里是5000个）:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;openssl/ssl.h&gt;
#include &lt;malloc.h&gt;
#include &lt;unistd.h&gt;

void read_cert() {
        const char ca_bundlestr[] = "/etc/ssl/certs/ca-certificates.crt";

        BIO               *outbio = NULL;
        int ret;

        SSL_CTX *ctx;

        outbio  = BIO_new_fp(stdout, BIO_NOCLOSE);

        SSL_library_init();
        SSL_load_error_strings();
        OpenSSL_add_all_algorithms();

        ctx = SSL_CTX_new(SSLv23_method());

        SSL_CTX_set_mode(ctx, SSL_MODE_RELEASE_BUFFERS);
        SSL_CTX_set_mode(ctx, SSL_MODE_NO_AUTO_CHAIN);
        SSL_CTX_set_read_ahead(ctx, 1);

        ret = SSL_CTX_load_verify_locations(ctx, ca_bundlestr, NULL);
        if (ret == 0)
                BIO_printf(outbio, "SSL_CTX_load_verify_locations failed");

        BIO_free_all(outbio);
        SSL_CTX_free(ctx);
}


int main() {
        int i = 0;
        for (i = 0; i &lt; 5000; i++) {
                read_cert();
                //malloc_trim(0);
        }
        malloc_stats();
}

</code></pre></div></div>

<p>如果我能解决这里的问题，我就能解决 Openresty/Nginx 中的问题，由于这是等价于原问题的。但是猜猜发生了什么，<code class="highlighter-rouge">strace</code> 的输出跟我预期的不同！</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
read(3, "fqaEQn6/Ip3Xep1fvj1KcExJW4C+FEaG"..., 4096) = 4096
read(3, "IYWxvemF0Yml6dG9u\nc2FnaSBLZnQuMR"..., 4096) = 4096
read(3, "nVz\naXR2YW55a2lhZG8xHjAcBgkqhkiG"..., 4096) = 4096
read(3, "A\nMIIBCgKCAQEAy0+zAJs9Nt350Ulqax"..., 4096) = 4096
read(3, "MRAwDgYDVQQHEwdDYXJhY2FzMRkwFwYD"..., 4096) = 4096
read(3, "OR1YqI0JDs3G3eicJlcZaLDQP9nL9bFq"..., 4096) = 4096
read(3, "E7zelaTfi5m+rJsziO+1ga8bxiJTyPbH"..., 4096) = 4096
read(3, "Xtdj182d6UajtLF8HVj71lODqV0D1VNk"..., 4096) = 4096
read(3, "AAOCAQ8AMIIBCgKCAQEAt49VcdKA3Xtp"..., 4096) = 4096
brk(0x1cfb000)                          = 0x1cfb000
read(3, "396gwpEWoGQRS0S8Hvbn+mPeZqx2pHGj"..., 4096) = 4096
read(3, "QYwDwYDVR0T\nAQH/BAUwAwEB/zANBgkq"..., 4096) = 4096
read(3, "ETzsemQUHS\nv4ilf0X8rLiltTMMgsT7B"..., 4096) = 4096
read(3, "wVU3RhYXQgZGVyIE5lZGVybGFuZGVuMS"..., 4096) = 4096
read(3, "N/uLicFZ8WJ/X7NfZTD4p7dN\ndloedl4"..., 4096) = 4096
read(3, "fzDtgUx3M2FIk5xt/JxXrAaxrqTi3iSS"..., 4096) = 4096
read(3, "sO+wmETRIjfaAKxojAuuK\nHDp2KntWFh"..., 4096) = 4096
read(3, "8z+uJGaYRo2aWNkkijzb2GShROfyQcsi"..., 4096) = 4096
read(3, "CydAXFJy3SuCvkychVSa1ZC+N\n8f+mQA"..., 4096) = 4096
...

</code></pre></div></div>

<p><code class="highlighter-rouge">brk</code> 调用后面没有 <code class="highlighter-rouge">mmap</code> 调用，内存消耗也没有按照超出预期的增长！</p>

<p>好吧，我现在非常恼火也想放弃。但是我我的好奇心没让我放弃。我决定了解更多的关于内存分配如何工作的。</p>

<p>通常来说当程序中申请更多的内存的时候会调用glibc中的<code class="highlighter-rouge">malloc</code>(或者改版)。对于用户空间的程序，<code class="highlighter-rouge">glibc</code>抽象了很多内存管理的工作、提供了一个使用虚拟内存的 API 。</p>

<p>默认情况下，当一个程序调用<code class="highlighter-rouge">malloc</code>的申请更多的堆上内存时候，将会使用<code class="highlighter-rouge">brk</code>申请需要的内存空间。如果堆上有洞，brk将不能正常工作。</p>

<p>现在假设你有1G的堆上内存空闲空间。在上面直接创建一个洞，可以使用mmap指定具体地址A 这种方式，指定内存空间大小。这样mmap就会从堆上的内存地址A开始，申请指定大小的内存空间。</p>

<p>但是因为程序中断点还在堆开始的地方,这时如果使用<code class="highlighter-rouge">sbrk</code>函数申请的B &gt; A 字节大小的内存空间，此次请求将会失败，因为<code class="highlighter-rouge">brk</code>尝试申请的一部分内存区域已经被分配（洞）。这时候<code class="highlighter-rouge">malloc</code>会使用<code class="highlighter-rouge">mmap</code>代替申请内存空间。</p>

<p>因为<code class="highlighter-rouge">mmap</code>调用代价非常高，为了降低其调用次数，malloc 申请 1M内存即使申请分配的内存不足1M。<a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#406">https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#406</a> 注释文档中也有记载。你会发现上面的输出日志中，令人奇怪的<code class="highlighter-rouge">mmap</code>调用申请1048576字节内存，正好是1M–当brk失败后，<code class="highlighter-rouge">malloc</code>使用此默认值去调用mmap。</p>

<p>高潮来了！！！把这些线索放一起。一个明显的猜想是 <strong><code class="highlighter-rouge">brk</code> 调用后面是mmap调用在Openresty 上下文环境中，但是在独立的c中却不是，因为 Openresty 在配置文件加载之前 在某个地方创建了一个洞。</strong></p>

<p>这不难验证，使用grep 命令在PRs,issus和<a href="https://github.com/openresty/lua-nginx-module">lua-nginx-module</a>源码中查找。最后发现Luajit 需要工作在低地址空间获得更高的效率，这是为什么<code class="highlighter-rouge">lua-nginx-module</code>那群家伙决定在程序开始执行之前执行下面这段代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (sbrk(0) &lt; (void *) 0x40000000LL) {
    mmap(ngx_align_ptr(sbrk(0), getpagesize()), 1, PROT_READ,
         MAP_FIXED|MAP_PRIVATE|MAP_ANON, -1, 0);
}
</code></pre></div></div>

<p>完整代码可以在<a href="https://github.com/openresty/lua-nginx-module/blob/37e5362088bd659e318aae568b268719bd0d6707/src/ngx_http_lua_module.c#L1291">仓库</a>中找到。现在我还没太弄明白这段代码是如何让luajit拥有低地址空间的（如果有人能在评论里面解释清楚，我将非常感激），但是这确实是导致这个问题的代码。</p>

<p>为了证明，我拷贝出来这段代码到我的 独立 C 程序中：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdint.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;openssl/ssl.h&gt;
#include &lt;malloc.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define ngx_align_ptr(p, a) \
        (u_char *) (((uintptr_t) (p) + ((uintptr_t) a - 1)) &amp; ~((uintptr_t) a - 1))
</span>
<span class="n">ngx_http_lua_limit_data_segment</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x40000000LL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">mmap</span><span class="p">(</span><span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">getpagesize</span><span class="p">()),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
                                <span class="n">MAP_FIXED</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANON</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">read_cert</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="n">ca_bundlestr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/etc/ssl/certs/ca-certificates.crt"</span><span class="p">;</span>

        <span class="n">BIO</span>               <span class="o">*</span><span class="n">outbio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="n">SSL_CTX</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

        <span class="n">outbio</span>  <span class="o">=</span> <span class="n">BIO_new_fp</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">BIO_NOCLOSE</span><span class="p">);</span>

        <span class="n">SSL_library_init</span><span class="p">();</span>
        <span class="n">SSL_load_error_strings</span><span class="p">();</span>
        <span class="n">OpenSSL_add_all_algorithms</span><span class="p">();</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">SSL_CTX_new</span><span class="p">(</span><span class="n">SSLv23_method</span><span class="p">());</span>

        <span class="n">SSL_CTX_set_mode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SSL_MODE_RELEASE_BUFFERS</span><span class="p">);</span>
        <span class="n">SSL_CTX_set_mode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SSL_MODE_NO_AUTO_CHAIN</span><span class="p">);</span>
        <span class="n">SSL_CTX_set_read_ahead</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">SSL_CTX_load_verify_locations</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ca_bundlestr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">BIO_printf</span><span class="p">(</span><span class="n">outbio</span><span class="p">,</span> <span class="s">"SSL_CTX_load_verify_locations failed"</span><span class="p">);</span>

        <span class="n">BIO_free_all</span><span class="p">(</span><span class="n">outbio</span><span class="p">);</span>
        <span class="n">SSL_CTX_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">ngx_http_lua_limit_data_segment</span><span class="p">();</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">read_cert</span><span class="p">();</span>
                <span class="c1">//malloc_trim(0);</span>
        <span class="p">}</span>
        <span class="n">malloc_stats</span><span class="p">();</span>
        <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>当我编译运行这段程序的时候，通过<code class="highlighter-rouge">strace</code>我能看到和Openresty环境中相同的行为。为了更进一步的确认，我编辑Opneresty的源码、注释掉<code class="highlighter-rouge">ngx_http_lua_limit_data_segment</code>、重新编译运行，内存增长的现象没有发生。</p>

<p>搞定！！！</p>

<p>上面就是我这次的收获。根据这次结果，我提交了一个<a href="https://github.com/openresty/lua-nginx-module/issues/1005">issue</a>。当你有很多的location 块的时候，这真的会成为一个问题。例如加入你有一个很大的 Nginx 配置文件，里面有超过4k 个location 块，然后你加入了<code class="highlighter-rouge">lua_ssl_trusted_certificate</code>指令到 mian 配置块，然后当你 reload/restart/start Nginx 的时候，内存消耗将会增长到~4G(4k * 1MB)并且不会释放。</p>

<p><a href="http://blog.soul11201.com/notes/translate/2017/03/25/translate-nginx-oom.html">原文</a></p>

<p><a href="http://www.elvinefendi.com/2017/03/07/my-experience-with-lua-nginx-openssl-strace-gdb-glibc-and-linux-vm.html">原文链接</a></p>

<p><strong>在<a href="https://github.com/openresty/lua-nginx-module/blob/37e5362088bd659e318aae568b268719bd0d6707/src/ngx_http_lua_module.c#L1294">lua-nginx-module</a> 中，一个内存相关的黑魔法导致冗余的大内存分配。</strong></p>




<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/plugins/jekyll-search.js"></script>
<!--
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/scripts.min.js"></script>
-->




<!--
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
-->



<!-- Asynchronous Google Analytics snippet -->

<script>
var _hmt = _hmt || [];
(function() {
   var hm = document.createElement("script");
     hm.src = "//hm.baidu.com/hm.js?14cc93bf3f08d31c458639d309dde522";
       var s = document.getElementsByTagName("script")[0]; 
         s.parentNode.insertBefore(hm, s);
         })();
</script>







<div class="read-more">
    <!--
    <script type="text/javascript">var jd_union_pid="3001579677";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script>    
    <script type="text/javascript">var jd_union_pid="3001580358";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script<script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="513:6",jd_union_pid="CKjUrvevLhCC9PTcAxoAIL/G35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfIlURRQdeZXdPNmQ5cnRCWFV6PmlCYHdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsQBBYAXRtbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>>
    <script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="513:6",jd_union_pid="CKjUrvevLhCC9PTcAxoAIL/G35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfIlURRQdeZXdPNmQ5cnRCWFV6PmlCYHdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsQBBYAXRtbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>
    -->
    <script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="1455:6",jd_union_pid="CLzuy/evLhCC9PTcAxoAIO/F35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfImcTYFJPXkhnNXoLZWIWWiduG0cKDGdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsRARADVxNbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/375/" class="read-more-btn">装备</a>
    </div><!-- /.read-more-header -->
</div>


<div class="read-more">
    <div class="read-more-header">
        <a href="https://www.west.cn?ReferenceID=833653" target=_blank><img src="https://www.west.cn/vcp/vcp_img/free6/A/100x100_A.jpg" border=0></a>
    </div><!-- /.read-more-header -->
</div>

<div class="read-more">
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/375/" class="read-more-btn">公众号</a>
    </div><!-- /.read-more-header -->
    <p><img src="/images/media/wechat_subscription.png" alt="公众号"/></p>
</div>

<div class="read-more">
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/375/" class="read-more-btn">知识星球</a>
    </div><!-- /.read-more-header -->
    <p><img src="/images/media/openresty.png" alt="知识星球"/></p>
</div>
        <section id="disqus_thread" class="animated fadeInUp">            

            <div id="container"></div>
            <!--
            <link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
            <script src="https://jjeejj.github.io/js/gitment.js"></script>
            <link rel="stylesheet" href="/assets/css/gitment.css">
            <script src="/assets/js/gitment.js"></script>
            <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
            <script src="https://billts.site/js/gitment.js"></script>
            -->

            <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
            <script src="/assets/js/gitment.js"></script>


            <script>
              const myTheme = {
              render(state, instance) {
                const container = document.createElement('div')
                container.lang = "en-US"
                container.className = 'gitment-container gitment-root-container'
                container.appendChild(instance.renderHeader(state, instance))
                container.appendChild(instance.renderEditor(state, instance))
                container.appendChild(instance.renderComments(state, instance))
                container.appendChild(instance.renderFooter(state, instance))
                return container
              },
            }
            
            var gitment = new Gitment({
                owner: 'shengnoah',
                repo: 'candylab',
                oauth: {
                    client_id: 'a189c4862b8c5026fb74',
                    client_secret: '1fe138982bac2f6ba74a18e4f312b6832e6bea4c',
                },
                theme: myTheme,
            });
            gitment.render('container');
            </script>
            <!--
            <div id="container"></div>
            <link rel="stylesheet" href="https://dn-coding-net-public-file.qbox.me/Coding-Comments/v0.0.3/default.css">
            <script src="https://dn-coding-net-public-file.qbox.me/Coding-Comments/v0.0.3/gitment.min.js"></script>
            <script>
                var gitment = new Gitment({
                    owner: "shengyang",
                    repo: "moonscript_comments",
                    oauth: {
                        client_id: "9461c58665db4c248dd9f36b2280cc98",
                        client_secret: "00760f885aafa0dbb7789b365468177305293c95",
                    },
                });
                document.getElementById('container').appendChild(gitment.render())
            </script>
            -->
        </section>





<script type="text/javascript">
    sharing();
</script>

<script type="text/javascript" >
    $(document).ready(function () {
        $(".term").on("click", function (event) {
            var searchInput = $("#search-input");
            searchInput.val($(this).text());
            searchInput.trigger("change keyup");
            searchInput.keyup();
            searchInput.change();
        })
    })
</script>


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '18349-1575875948454-349',
        name: '糖果的实验室',
        qrcode: '/images/media/wechat_subscription.png',
        keyword: 'lua',
    });
</script>






      
      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://0.0.0.0:8081/tags#lua" title="Pages tagged lua" class="tag"><span class="term">lua</span></a></span>
        
        <span class="author vcard"><span class="fn">糖果</span></span>
        <div class="social-share">

<!--
  <ul class="socialcount socialcount-small inline-list">
    <li class="twitter">test</li>
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://0.0.0.0:8081/topic/376/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://0.0.0.0:8081/topic/376/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://0.0.0.0:8081/topic/376/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
    </ul>

 -->

</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="https://lua.ren" class="read-more-btn">关于</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3>糖果</h3>
    <div class="author-container">
      <img class="author-img" src="http://0.0.0.0:8081/images/avatar.jpg" alt="糖果" />
      <div class="author-bio">LUA教程</div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://github.com/shengnoah/luaren" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
        
      </ul>
      
        <a aria-label="Follow @shengnoah on GitHub" data-style="mega" href="https://github.com/shengnoah" class="github-button">Follow @shengnoah</a>
      
      <br>
      
    </div>
  </div>
</div>

    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/375/" class="read-more-btn">更多</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://0.0.0.0:8081/2016-01-01-994_Lua%E4%B8%AD.%E5%92%8C-%E8%8A%B1%E7%94%9F%E8%82%89%E6%B3%A5/" title=""></a></h3>
      <p>在lua开发中我们经常会混淆这两者之间的区别，下面通过一个示例来解释：12345678910111213141516171819202122Class = {}Class.__index = Class function (x,y)    local cls = {}   ...&hellip; <a href="http://0.0.0.0:8081/2016-01-01-994_Lua%E4%B8%AD.%E5%92%8C-%E8%8A%B1%E7%94%9F%E8%82%89%E6%B3%A5/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://0.0.0.0:8081/2016-01-01-987_Video-Description-A-Survey-of-Methods,-Datasets-a/" title=""></a></h4>
        <span>Published on </span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://0.0.0.0:8081/2016-01-01-902_VA_2-A-Visual-Analytics-Approach-for-_Evaluating/" title=""></a></h4>
        <span>Published on </span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->


  </article>
</div><!-- /#main -->


<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2020 糖果 </span>
<span>ICP证:<a href="http://www.beian.miit.gov.cn/">辽ICP备16003836号-2</a> </span>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
