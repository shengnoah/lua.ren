<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>深度理解Lua中的table &#8211; LUA教程</title>
<meta name="description" content="LUA教程:Lua是一门精巧的语言，与其它语言配合使用，发挥更高的效能。特别是与C和C++语言的配合。著名的项目Openresty就是使用了Lua。">
<meta name="keywords" content="lua文章">


<!-- Baidu ZZ www.lua.ren-->
<meta name="baidu-site-verification" content="code-mUfTLvBErv" />
<!-- Baidu ZZ lua.ren-->
<meta name="baidu-site-verification" content="code-1frv44bXq0" />
<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="深度理解Lua中的table">
<meta property="og:description" content="LUA教程:Lua是一门精巧的语言，与其它语言配合使用，发挥更高的效能。特别是与C和C++语言的配合。著名的项目Openresty就是使用了Lua。">
<meta property="og:url" content="http://0.0.0.0:8081/topic/672_%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3Lua%E4%B8%AD%E7%9A%84table/">
<meta property="og:site_name" content="LUA教程">
<meta property="og:image" content="http://0.0.0.0:8081/images/images/logo.png">





<link rel="canonical" href="http://0.0.0.0:8081/topic/672_%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3Lua%E4%B8%AD%E7%9A%84table/">
<link href="http://0.0.0.0:8081/feed.xml" type="application/atom+xml" rel="alternate" title="LUA教程 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/main.css">
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="http://0.0.0.0:8081/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://0.0.0.0:8081/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://0.0.0.0:8081/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://0.0.0.0:8081/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://0.0.0.0:8081/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://0.0.0.0:8081/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://0.0.0.0:8081/images/apple-touch-icon-144x144-precomposed.png">





<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?14cc93bf3f08d31c458639d309dde522";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>
   r

</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><h2><i class="fa fa-bars"></i></h2></a></li>
      <li class="header-item-title">
        <a href="http://0.0.0.0:8081/">
          
            <img class="logo" src="http://0.0.0.0:8081/images/logo.png" alt="LUA教程">
          
          <a href="http://0.0.0.0:8081/" class="title"> LUA教程</a>
        </a>
      </li>
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/categories"><h3>分类</h3></a>
            <ul class="header-submenu">
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#      .md">      .md</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#AI">AI</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#Documents">Documents</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#HiLua框架">HiLua框架</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#LUA教程">LUA教程</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#Lapis框架">Lapis框架</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#MoonScript语法">MoonScript语法</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#MoonScript项目">MoonScript项目</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#OPENRESTY">OPENRESTY</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#lua_guide">lua_guide</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#lua教程">lua教程</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#mysql">mysql</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#openresty最佳实践">openresty最佳实践</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#python">python</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#tools">tools</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#topic">topic</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#动态库">动态库</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#安全">安全</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#机械键盘">机械键盘</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#网关">网关</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#键盘">键盘</a></li>
              
                
                  <li class="sub-item"><a href="http://0.0.0.0:8081/categories/#静电容键盘">静电容键盘</a></li>
              
            </ul>
          </li>
        
      
        
        

        
            
                <li class="header-item "><a href="http://0.0.0.0:8081/tags"><h3>标签</h3></a></li>
            
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua高级</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/error-handling/">Lua错语处理</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/coroutines/">Lua协程</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/metatables/">Lua元表</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/garbage-collection/">Lua垃圾回收机制</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua循环</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/for/">for循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/while/">while循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/loop/">loop循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/repeat-until/">repeat until循环</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/iterators/">iterators迭代器</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua判断</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/decision-making/">Lua判断</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/if-statement/">If语句</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/if-else-if-statement/">If else语句</a></li>
              
            </ul>
          </li>
        
      
        
        

        
          <li class="header-item "><a href="http://0.0.0.0:8081/"><h3>Lua基础语法</h3></a>
            <ul class="header-submenu">
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/lua教程/variables/">变量</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/strings/">字符串</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/tables/">表</a></li>
              
                <li class="sub-item"><a href="http://0.0.0.0:8081/lua_guide/operators/">操作符</a></li>
              
            </ul>
          </li>
        
      
      <li class="header-item"><a href="http://0.0.0.0:8081/search"><h3><i class="fa fa-search"></i></h3></a></li>
    </ul>
  </div>

<div class="entry-header">
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>深度理解Lua中的table</h1>
      
        <h2><span class="entry-date date published updated"><time datetime="2016-01-01T00:00:00+08:00">January 01, 2016</time></span></h2>
      

      
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~6 minutes
        </p>
      
    </div>
  </div>
</div>

<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua基础语法</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/variables/">变量</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/strings/">字符串</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/tables/">表</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/operators/">操作符</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua判断</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/decision-making/">Lua判断</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/if-statement/">If语句</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/if-else-if-statement/">If else语句</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua循环</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/for/">for循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/lua教程/while/">while循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/loop/">loop循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/repeat-until/">repeat until循环</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/iterators/">iterators迭代器</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/"><h3>Lua高级</h3></a>
          <ul>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/error-handling/">Lua错语处理</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/coroutines/">Lua协程</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/metatables/">Lua元表</a></li>
            
              <li><a href="http://0.0.0.0:8081/lua_guide/garbage-collection/">Lua垃圾回收机制</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="http://0.0.0.0:8081/tags"><h3>标签</h3></a></li>
      
    
      
        <li><a href="http://0.0.0.0:8081/categories"><h3>分类</h3></a>
          <ul>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#      .md">      .md</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#AI">AI</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#Documents">Documents</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#HiLua框架">HiLua框架</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#LUA教程">LUA教程</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#Lapis框架">Lapis框架</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#MoonScript语法">MoonScript语法</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#MoonScript项目">MoonScript项目</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#OPENRESTY">OPENRESTY</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#lua_guide">lua_guide</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#lua教程">lua教程</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#mysql">mysql</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#openresty最佳实践">openresty最佳实践</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#python">python</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#tools">tools</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#topic">topic</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#动态库">动态库</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#安全">安全</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#机械键盘">机械键盘</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#网关">网关</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#键盘">键盘</a></li>
            
              
                <li><a href="http://0.0.0.0:8081/categories/#静电容键盘">静电容键盘</a></li>
            
          </ul>
        </li>
      
    
  </ul>
</nav>






<div id="main" role="main">
  <article class="hentry">
    <div class="entry-content">
        
      <h1 class="post-title entry-title">深度理解Lua中的table</h1>
      <p>Lua的table是个很有意思的东西。有些内容平时写代码的时候很少接触到，但是了解一下还是很有意思的。</p>

<p>这篇blog参考<a href="http://lua-users.org/wiki/MetatableEvents">MetatableEvents</a>，一个一个边写测试边细说。</p>

<h2 id="__newindex">__newindex</h2>

<p>原文翻译：</p>

<p><code class="highlighter-rouge">__newindex</code>用于分配属性，当调用 <code class="highlighter-rouge">myTable[key]=value</code>时，如果元表中有<code class="highlighter-rouge">__newindex</code>并且指向一个function，就会调用这个function，传入的参数为table, key 和 value</p>

<ul>
  <li>用 <code class="highlighter-rouge">rawset(myTable, key, value)</code>可以跳过这个元方法直接给myTable的key属性赋值为value。</li>
  <li>如果<code class="highlighter-rouge">__newindex</code>指向的方法中，没有调用<code class="highlighter-rouge">rawset</code>方法，传入的键值对（key/value）就不会添加到myTable中。</li>
</ul>

<p>测试代码：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __newindex = function(t, key, value)
        print(&#34;call __newindex&#34;,t, key, value)
    end
}

local test = {}
setmetatable(test, meta)

print(&#34;test&#34;, test)
print(&#34;meta&#34;, meta)

test.name = &#34;t1&#34;
test.name = &#34;t2&#34;
print(&#34;test.name&#34;, test.name)

---- result output ----
test	table: 0x7f9c13406f00
meta	table: 0x7f9c13407240
call __newindex	table: 0x7f9c13406f00	name	t1
call __newindex	table: 0x7f9c13406f00	name	t2
test.name	nil
</code></pre></div></div>

<p>测试代码中，当给t的name的赋值时，就会触发元表中的__newindex指向的function，打印的信息可以看到key和value的值。</p>

<p><code class="highlighter-rouge">__newindex</code>方法中传进来的参数<code class="highlighter-rouge">t</code>的指针和<code class="highlighter-rouge">test</code>的指针指向同一个地址，说明<code class="highlighter-rouge">__newindex</code>中的参数<code class="highlighter-rouge">t</code>，并不是元表。</p>

<p>测试代码中对t.name连续赋值时，<code class="highlighter-rouge">__newindex</code>会连续调用，需要留意一下这里，后面的测试会跟这里做一个对比。</p>

<p>赋值之后打印 t.name 的值是空的。原因是<code class="highlighter-rouge">__newindex</code>并没有给t.name赋值，我们用一个错误的方式给t.name赋值，来加深<code class="highlighter-rouge">__newindex</code>的理解。修改一下测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __newindex = function(t, key, value)
        print(&#34;call __newindex&#34;,t, key, value)
        t[key] = value
    end
}

local test = {}
setmetatable(test, meta)

print(&#34;test&#34;, test)
print(&#34;meta&#34;, meta)

test.name = &#34;t1&#34;
test.name = &#34;t2&#34;
print(test.name)

---- result output ----
...
lua: C stack overflow
...
</code></pre></div></div>

<p>报错信息，栈溢出。因为<code class="highlighter-rouge">t[key] = value</code>这段代码会调用t元表中的<code class="highlighter-rouge">__newindex</code>的方法，<code class="highlighter-rouge">__newindex</code>的方法又会调用<code class="highlighter-rouge">t[key] = value</code>，这样就进入了死循环，导致栈溢出。这时就需要用到方法<code class="highlighter-rouge">rawset</code>。</p>

<p>修改测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __newindex = function(t, key, value)
        print(&#34;call __newindex&#34;,t, key, value)
        rawset(t, key, value)
    end
}

local test = {}
setmetatable(test, meta)

test.name = &#34;t1&#34;
test.name = &#34;t2&#34;
print(&#34;test.name&#34;, test.name)

---- result output ----
call __newindex	table: 0x7fdade404e20	name	t1
test.name	t2
</code></pre></div></div>

<p>这段代码中信息比较多</p>

<p>在<code class="highlighter-rouge">__newindex</code>中使用了<code class="highlighter-rouge">rawset</code>方法，可以看到，没有栈溢出的错误了，说明用<code class="highlighter-rouge">rawset</code>给table赋值，不会进入<code class="highlighter-rouge">__newindex</code>
的方法。</p>

<p>给t.name连续赋值，会发现只进入<code class="highlighter-rouge">__newindex</code>一次，跟之前不同的是，我们在<code class="highlighter-rouge">__newindex</code>给t.name赋了值。如果t中没有这个key时，才会进入<code class="highlighter-rouge">__newindex</code>方法。否则不会进入。</p>

<p><code class="highlighter-rouge">__newindex</code>的默认值就是上面<code class="highlighter-rouge">meta.__newindex</code>的代码。如果不需要额外处理，完全可以不写。如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {}
local test = {}
setmetatable(test, meta)

test.name = &#34;t1&#34;
print(&#34;test.name&#34;, test.name)

---- result output ----
test.name	t1

</code></pre></div></div>

<h2 id="__index">__index</h2>

<p>翻译原文</p>

<p><code class="highlighter-rouge">__index</code>用于控制属性（prototype）的继承，当访问 myTable[key] 时，如果myTable中不存在这个key，但是如果元表（metatable）中有 <code class="highlighter-rouge">__index</code>时：</p>

<ul>
  <li>如果<code class="highlighter-rouge">__index</code>是一个<code class="highlighter-rouge">function</code>，传递的参数是<code class="highlighter-rouge">table</code>和<code class="highlighter-rouge">key</code>,<code class="highlighter-rouge">function</code>的返回值作为结果返回。</li>
  <li>如果<code class="highlighter-rouge">__index</code>是一个<code class="highlighter-rouge">table</code>，就返回这个表中key对应的值。
    <ul>
      <li>如果这个<code class="highlighter-rouge">table</code>不存在该<code class="highlighter-rouge">key</code>，但是这个<code class="highlighter-rouge">table</code>有元表，会继续寻找元表中的<code class="highlighter-rouge">__index</code>属性，以此类推。都没有就返回<code class="highlighter-rouge">nil</code></li>
    </ul>
  </li>
  <li>使用 “rawget(myTable,key)” 可以跳过这个元方法（__index）.</li>
</ul>

<p>写点测试：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local test = {}

local meta = {
    __index = function(t, k)
        print(&#34;__index&#34;, k)
        if rawget(t, k) == nil then
            print(&#34;Can&#39;t find &#34;.. k)
        end

        return rawget(t, k)
    end,
}

setmetatable(test, meta)

print(&#34;test.name1&#34;, test.name)
test.name = &#34;hello&#34;
print(&#34;test.name2&#34;, test.name)


---- result output ----

__index	name
Can&#39;t find name
test.name1	nil
test.name2	hello
</code></pre></div></div>

<p><code class="highlighter-rouge">__newindex</code>和<code class="highlighter-rouge">__index</code>其实可以类比成setter和getter，这么类比会比较容易理解，但是实际上还是有比较大的区别。</p>

<p>上面的测试中<code class="highlighter-rouge">__index</code>是个function。当执行test.name时，如果test.name是nil，会调用<code class="highlighter-rouge">__index</code>的function，并返回function的返回值。否则，直接返回test[key]，不会进入<code class="highlighter-rouge">__index</code>。</p>

<p>再做一个测试，这次<code class="highlighter-rouge">__index</code>是个table</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local test = {}

local meta = {
    __index = {name=&#34;meta&#34;},
}

setmetatable(test, meta)

print(&#34;test.name1&#34;, test.name)
test.name = &#34;hello&#34;
print(&#34;test.name2&#34;, test.name)

---- result output ----

test.name1	meta
test.name2	hello
</code></pre></div></div>

<p>这个测试可以看到，访问顺序是先访问test的name，如果没有值，再访问test元表中<code class="highlighter-rouge">__index</code>的table。如果test的元表还有元表，会继续向上访问，Lua继承的实现就是利用这个特性。</p>

<p>掌握<code class="highlighter-rouge">__newindex</code>和<code class="highlighter-rouge">__index</code>这两个元方法，可以把这两个元方法看做两个事件，那要就要清楚两个方法的触发条件和特性。才能融会贯通。</p>

<p>举个例子：</p>

<p>禁用全局变量</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __newindex = function(t, k, v)
        print(&#34;Error! Can&#39;t set globle variable&#34;, k)
    end,

    -- 默认实现
    -- __index = function(t, k)
    --     return rawget(t, k)
    -- end
}

setmetatable(_G, meta)

test = &#34;test&#34;
print(test)

---- result output ----

Error! Can&#39;t set globle variable	test
nil
</code></pre></div></div>

<h2 id="__mode">__mode</h2>

<p>原文翻译:</p>

<p>控制弱引用，用字符<code class="highlighter-rouge">k</code>和<code class="highlighter-rouge">v</code>来代表table的<code class="highlighter-rouge">键</code>和<code class="highlighter-rouge">值</code>是否是弱引用。这个感觉没什么好说的，只写个测试就好了。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {__mode = &#34;k&#34;}
local test = {}
setmetatable(test, meta)
key = {}
test[key] = 1
key = {}
test[key] = 2
for k,v in pairs(test) do
    print(v)
end

collectgarbage()
print(&#34;collectgarbage&#34;)

for k,v in pairs(test) do
    print(v)
end

---- result output ----

1
2
collectgarbage
2
</code></pre></div></div>

<p>例子中当调用collectgarbage()进行回收后，test表中只剩下一个值。弱引用的key被清理了。我们也可以在__mode中设置<code class="highlighter-rouge">v</code>,<code class="highlighter-rouge">kv</code>来表示<code class="highlighter-rouge">值</code> <code class="highlighter-rouge">键和值</code>都是弱引用。</p>

<h2 id="__call">__call</h2>

<p>原文翻译:</p>

<p>把table当做一个function使用，当table后跟一个圆括号时，而且table的元表中的__call指向一个function，就会调用这个function，table自己做为第一个参数，后面可接任意数量的参数，返回值就是function的返回值。</p>

<p>测试代码来模拟实现一个构造方法。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __call = function(t, ...)

        local instance = {}
        for k, v in pairs(t) do
            instance[k] = v
        end
        return instance
    end
}

local A = setmetatable({}, meta)

function A:info()
    print(&#34;info&#34;,self)
end

local a = A()
local b = A()

a:info()
b:info()

---- result output ----
info	table: 0x7f8771e05030
info	table: 0x7f8771e050a0
</code></pre></div></div>

<h2 id="__metatable">__metatable</h2>

<p>原文翻译：</p>

<p>隐藏真正的元表，当调用<code class="highlighter-rouge">getmetatable</code>时，而且table的元表有<code class="highlighter-rouge">__metatable</code>字段，则返回<code class="highlighter-rouge">__metatable</code>字段中的值。</p>

<p>测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    name = &#34;meta&#34;
}

local test = setmetatable({}, meta)
print(getmetatable(test).name)

local meta = {
    __metatable = {name = &#34;__metatable&#34;},
    name = &#34;meta&#34;
}

local test = setmetatable({}, meta)
print(getmetatable(test).name)

---- result output ----
meta
__metatable
</code></pre></div></div>

<p>结果很直观不解释了，我另外还做了个的测试，让<code class="highlighter-rouge">__metatable</code>指向了一个function，调用<code class="highlighter-rouge">getmetatable</code>时也会返回这个function。很有意思，但是暂时没想到有什么应用场景。</p>

<h2 id="__tostring">__tostring</h2>

<p>原文翻译：</p>

<p>控制字符串的表现，当调用<code class="highlighter-rouge">tostring(myTable)</code>时，且myTable的元表中有<code class="highlighter-rouge">__tostring</code>字段时，就会调用这个方法。返回值是方法的返回值。</p>

<p>测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __tostring = function(t)
        return string.format(&#34;My name is %s&#34;, t.name)
    end
}

local test = setmetatable({}, meta)
test.name = &#34;test&#34;
print(test)
print(tostring(test))

---- result output ----
My name is test
My name is test
</code></pre></div></div>

<p>这个也不做过多说明了，很容易理解。有一点提一下就是print方法会自动调用tostring(test)</p>

<h2 id="__len">__len</h2>

<p>原文翻译：</p>

<p>控制table的长度。当用<code class="highlighter-rouge">#</code>操作符请求长度时，且table的元表有<code class="highlighter-rouge">__len</code>字段指向一个function，就会调用这个function，参数是table自己，返回值是function的返回值。</p>

<p>写个测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {
    __len = function(t)
        local result = 0
        for k, v in pairs(t) do
            result = result + 1
        end
        return result
    end
}


local test = {
    [1] = &#34;A&#34;,
    [2] = &#34;B&#34;,
    [3] = &#34;C&#34;,
    [5] = &#34;D&#34;,
    [6] = &#34;E&#34;,
    [8] = &#34;F&#34;,
}
print(#test)

setmetatable(test, meta)
print(#test)

---- result output ----
3
6
</code></pre></div></div>

<p>Lua中使用<code class="highlighter-rouge">#</code>获取长度有个特性，就是如果某个key对应的值是nil就结束，上面例子中，test第4个值是nil，那返回的长度为3。我们重新定义了<code class="highlighter-rouge">__len</code>后返回了，用遍历的方式计算长度，返回table内元素的数量为6。</p>

<h2 id="__gc">__gc</h2>

<p>原文翻译：</p>

<p>简单说就是数据被垃圾回收的时候会首先触发<code class="highlighter-rouge">__gc</code>。</p>

<p>测试代码：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>local meta = {

    __gc = function(t)
        print(&#34;gc&#34;)
    end
}

local function test()
    local test = {}
    setmetatable(test, meta)
end

test()

---- result output ----
gc
</code></pre></div></div>

<p>Lua table中所有的元方法就分析完了，还有一些操作符重载的，之后再写。</p>




<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/plugins/jekyll-search.js"></script>
<!--
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript" src="http://0.0.0.0:8081/assets/js/scripts.min.js"></script>
-->




<!--
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
-->



<!-- Asynchronous Google Analytics snippet -->

<script>
var _hmt = _hmt || [];
(function() {
   var hm = document.createElement("script");
     hm.src = "//hm.baidu.com/hm.js?14cc93bf3f08d31c458639d309dde522";
       var s = document.getElementsByTagName("script")[0]; 
         s.parentNode.insertBefore(hm, s);
         })();
</script>







<div class="read-more">
    <!--
    <script type="text/javascript">var jd_union_pid="3001579677";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script>    
    <script type="text/javascript">var jd_union_pid="3001580358";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script<script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="513:6",jd_union_pid="CKjUrvevLhCC9PTcAxoAIL/G35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfIlURRQdeZXdPNmQ5cnRCWFV6PmlCYHdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsQBBYAXRtbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>>
    <script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="513:6",jd_union_pid="CKjUrvevLhCC9PTcAxoAIL/G35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfIlURRQdeZXdPNmQ5cnRCWFV6PmlCYHdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsQBBYAXRtbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>
    -->
    <script type="text/javascript">var jd_union_unid="1000159746",jd_ad_ids="1455:6",jd_union_pid="CLzuy/evLhCC9PTcAxoAIO/F35cLKgA=";var jd_width=0;var jd_height=0;var jd_union_euid="";var p="AhIOUxJYHAcVDmVEH0hfIlgRRgYlXVZaCCsfSlpMWGVEH0hfImcTYFJPXkhnNXoLZWIWWiduG0cKDGdZF2sTAxIFURxYEAAiB1QaWhUGGgFQHGslXVZaCCsQewMiWBFGBiUCFg9XHlsRARADVxNbJQMiN2U%3D";</script><script type="text/javascript" charset="utf-8" src="//u-x.jd.com/static/js/auto.js"></script>
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/671_Lua%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="read-more-btn">装备</a>
    </div><!-- /.read-more-header -->
</div>


<div class="read-more">
    <div class="read-more-header">
        <a href="https://www.west.cn?ReferenceID=833653" target=_blank><img src="https://www.west.cn/vcp/vcp_img/free6/A/100x100_A.jpg" border=0></a>
    </div><!-- /.read-more-header -->
</div>

<div class="read-more">
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/671_Lua%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="read-more-btn">公众号</a>
    </div><!-- /.read-more-header -->
    <p><img src="/images/media/wechat_subscription.png" alt="公众号"/></p>
</div>

<div class="read-more">
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/671_Lua%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="read-more-btn">知识星球</a>
    </div><!-- /.read-more-header -->
    <p><img src="/images/media/openresty.png" alt="知识星球"/></p>
</div>
        <section id="disqus_thread" class="animated fadeInUp">            

            <div id="container"></div>
            <!--
            <link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
            <script src="https://jjeejj.github.io/js/gitment.js"></script>
            <link rel="stylesheet" href="/assets/css/gitment.css">
            <script src="/assets/js/gitment.js"></script>
            <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
            <script src="https://billts.site/js/gitment.js"></script>
            -->

            <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
            <script src="/assets/js/gitment.js"></script>


            <script>
              const myTheme = {
              render(state, instance) {
                const container = document.createElement('div')
                container.lang = "en-US"
                container.className = 'gitment-container gitment-root-container'
                container.appendChild(instance.renderHeader(state, instance))
                container.appendChild(instance.renderEditor(state, instance))
                container.appendChild(instance.renderComments(state, instance))
                container.appendChild(instance.renderFooter(state, instance))
                return container
              },
            }
            
            var gitment = new Gitment({
                owner: 'shengnoah',
                repo: 'candylab',
                oauth: {
                    client_id: 'a189c4862b8c5026fb74',
                    client_secret: '1fe138982bac2f6ba74a18e4f312b6832e6bea4c',
                },
                theme: myTheme,
            });
            gitment.render('container');
            </script>
            <!--
            <div id="container"></div>
            <link rel="stylesheet" href="https://dn-coding-net-public-file.qbox.me/Coding-Comments/v0.0.3/default.css">
            <script src="https://dn-coding-net-public-file.qbox.me/Coding-Comments/v0.0.3/gitment.min.js"></script>
            <script>
                var gitment = new Gitment({
                    owner: "shengyang",
                    repo: "moonscript_comments",
                    oauth: {
                        client_id: "9461c58665db4c248dd9f36b2280cc98",
                        client_secret: "00760f885aafa0dbb7789b365468177305293c95",
                    },
                });
                document.getElementById('container').appendChild(gitment.render())
            </script>
            -->
        </section>





<script type="text/javascript">
    sharing();
</script>

<script type="text/javascript" >
    $(document).ready(function () {
        $(".term").on("click", function (event) {
            var searchInput = $("#search-input");
            searchInput.val($(this).text());
            searchInput.trigger("change keyup");
            searchInput.keyup();
            searchInput.change();
        })
    })
</script>


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>




<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '18349-1575875948454-349',
        name: '糖果的实验室',
        qrcode: '/images/media/wechat_subscription.png',
        keyword: 'lua',
    });
</script>






      
      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://0.0.0.0:8081/tags#lua文章" title="Pages tagged lua文章" class="tag"><span class="term">lua文章</span></a></span>
        
        <span class="author vcard"><span class="fn">糖果</span></span>
        <div class="social-share">

<!--
  <ul class="socialcount socialcount-small inline-list">
    <li class="twitter">test</li>
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://0.0.0.0:8081/topic/672_%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3Lua%E4%B8%AD%E7%9A%84table/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://0.0.0.0:8081/topic/672_%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3Lua%E4%B8%AD%E7%9A%84table/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://0.0.0.0:8081/topic/672_%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3Lua%E4%B8%AD%E7%9A%84table/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
    </ul>

 -->

</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="https://lua.ren" class="read-more-btn">关于</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3>糖果</h3>
    <div class="author-container">
      <img class="author-img" src="http://0.0.0.0:8081/images/avatar.jpg" alt="糖果" />
      <div class="author-bio">LUA教程</div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://github.com/shengnoah/luaren" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
        
      </ul>
      
        <a aria-label="Follow @shengnoah on GitHub" data-style="mega" href="https://github.com/shengnoah" class="github-button">Follow @shengnoah</a>
      
      <br>
      
    </div>
  </div>
</div>

    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://0.0.0.0:8081/topic/671_Lua%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="read-more-btn">更多</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://0.0.0.0:8081/2016-01-01-994_Lua%E4%B8%AD.%E5%92%8C-%E8%8A%B1%E7%94%9F%E8%82%89%E6%B3%A5/" title=""></a></h3>
      <p>在lua开发中我们经常会混淆这两者之间的区别，下面通过一个示例来解释：12345678910111213141516171819202122Class = {}Class.__index = Class function (x,y)    local cls = {}   ...&hellip; <a href="http://0.0.0.0:8081/2016-01-01-994_Lua%E4%B8%AD.%E5%92%8C-%E8%8A%B1%E7%94%9F%E8%82%89%E6%B3%A5/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://0.0.0.0:8081/2016-01-01-987_Video-Description-A-Survey-of-Methods,-Datasets-a/" title=""></a></h4>
        <span>Published on </span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://0.0.0.0:8081/2016-01-01-902_VA_2-A-Visual-Analytics-Approach-for-_Evaluating/" title=""></a></h4>
        <span>Published on </span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->


  </article>
</div><!-- /#main -->


<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2020 糖果 </span>
<span>ICP证:<a href="http://www.beian.miit.gov.cn/">辽ICP备16003836号-2</a> </span>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
