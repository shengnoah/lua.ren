<p>读书笔记： Programming in Lua, 4th Edition.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Account</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">withdraw</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">v</span>
    <span class="k">end</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">Account</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">v</span>
<span class="k">end</span>

<span class="c1">-- 用.来调用函数的话，需要手动给self传值。</span>
<span class="c1">-- 用冒号来调用函数的话，可以省略self。</span>
<span class="n">Account</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">Account</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

<span class="n">Account</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">Account</span><span class="p">:</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<p>在上面的例子中，Account只是一个对象实例。</p>

<p>在C++中，一个类，可以生成多个对象实例。</p>

<p>在Lua中，没有类的概念，Lua是用metatable来模拟实现类的。</p>

<h2 id="classes">Classes</h2>

<p>if we have two objects A and B, all we have to do to make B a prototype for A is this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">setmetatable</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">{</span><span class="n">__index</span> <span class="o">=</span> <span class="n">B</span><span class="p">})</span>
</code></pre></div></div>

<p>After that, A looks up in B for any operation that it does not have.</p>

<p>Let us go back to our example of a bank account. To create other accounts with behavior similar to Account,
we arrange for these new objects to inherit their operations from Account, using the __index
metamethod.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">mt</span> <span class="o">=</span> <span class="p">{</span><span class="n">__index</span> <span class="o">=</span> <span class="n">Account</span><span class="p">}</span>
<span class="k">function</span> <span class="nc">Account</span><span class="p">.</span><span class="nf">new</span> <span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span> <span class="ow">or</span> <span class="p">{}</span> <span class="c1">-- create table if user does not provide one</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>
<span class="k">end</span>
</code></pre></div></div>

<p>After this code, what happens when we create a new account and call a method on it, like this?</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">Account</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">a</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span>
</code></pre></div></div>

<p>When we create the new account, a, it will have mt as its metatable. When we call
a:deposit(100.00), we are actually calling a.deposit(a, 100.00); the colon is only syntactic
sugar. However, Lua cannot find a “deposit” entry in the table a; hence, Lua looks into the __index
entry of the metatable. The situation now is more or less like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">getmetatable</span><span class="p">(</span><span class="n">a</span><span class="p">).</span><span class="n">__index</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span>
</code></pre></div></div>

<p>The metatable of a is mt, and mt.__index is Account. Therefore, the previous expression evaluates
to this one:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Account</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">)</span>
</code></pre></div></div>

<p>That is, Lua calls the original deposit function, but passing a as the self parameter. So, the new account
a inherited the function deposit from Account. By the same mechanism, it inherits all fields from
Account.</p>

<p>We can make two small improvements on this scheme. The first one is that we do not need to create a new
table for the metatable role; instead, we can use the Account table itself for that purpose. The second
one is that we can use the colon syntax for the new method, too. With these two changes, method new
becomes like this:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nf">Account</span><span class="p">:</span><span class="n">new</span> <span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">self</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">self</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, when we call Account:new(), the hidden parameter self gets Account as its value, we make
Account.__index also equal to Account, and set Account as the metatable for the new object. It
may seem that we do not gained much with the second change (the colon syntax); the advantage of using
self will become apparent when we introduce class inheritance, in the next section.</p>

<h2 id="inheritance-继承">Inheritance 继承</h2>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Account</span> <span class="o">=</span> <span class="p">{</span><span class="n">balance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">}</span>

<span class="k">function</span> <span class="nf">Account</span><span class="p">:</span><span class="n">new</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">self</span><span class="p">.</span><span class="n">__index</span> <span class="o">=</span> <span class="n">self</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">o</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">Account</span><span class="p">:</span><span class="n">deposit</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">+</span> <span class="n">v</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">Account</span><span class="p">:</span><span class="n">withdraw</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="k">then</span> <span class="nb">error</span><span class="s2">&#34;insufficient funds&#34;</span> <span class="k">end</span>
    <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">v</span>
<span class="k">end</span>

<span class="n">SpecialAccount</span> <span class="o">=</span> <span class="n">Account</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">SpecialAccount</span><span class="p">:</span><span class="n">new</span><span class="p">{</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">.</span><span class="mi">00</span><span class="p">}</span>

<span class="k">function</span> <span class="nf">SpecialAccount</span><span class="p">:</span><span class="n">withdraw</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">getLimit</span><span class="p">()</span> <span class="k">then</span>
        <span class="nb">error</span><span class="s2">&#34;insufficient funds&#34;</span>
    <span class="k">end</span>
    <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">balance</span> <span class="o">-</span> <span class="n">v</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">SpecialAccount</span><span class="p">:</span><span class="n">getLimit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">limit</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="https://mdgsf.github.io/images/2017/07/29_01.jpg" alt="29_01" /></p>

<p>就像一个链表一样，通过metatable一层一层向上找。</p>
