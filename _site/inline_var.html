<h1 id="使用-nginx-内置绑定变量">使用 Nginx 内置绑定变量</h1>

<p><code class="highlighter-rouge">Nginx</code>作为一个成熟、久经考验的负载均衡软件，与其提供丰富、完整的内置变量是分不开的，它极大增加了对<code class="highlighter-rouge">Nginx</code>网络行为的控制细度。这些变量大部分都是在请求进入时解析的，并把他们缓存到请求<code class="highlighter-rouge">cycle</code>中，方便下一次获取使用。首先来看看<code class="highlighter-rouge">Nginx</code>对都开放了那些<code class="highlighter-rouge">API</code>。</p>

<p>参看下表：</p>

<table>
  <thead>
    <tr>
      <th>名称</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>$arg_name</td>
      <td>请求中的name参数</td>
    </tr>
    <tr>
      <td>$args</td>
      <td>请求中的参数</td>
    </tr>
    <tr>
      <td>$binary_remote_addr</td>
      <td>远程地址的二进制表示</td>
    </tr>
    <tr>
      <td>$body_bytes_sent</td>
      <td>已发送的消息体字节数</td>
    </tr>
    <tr>
      <td>$content_length</td>
      <td>HTTP请求信息里的”Content-Length”</td>
    </tr>
    <tr>
      <td>$content_type</td>
      <td>请求信息里的”Content-Type”</td>
    </tr>
    <tr>
      <td>$document_root</td>
      <td>针对当前请求的根路径设置值</td>
    </tr>
    <tr>
      <td>$document_uri</td>
      <td>与$uri相同; 比如 /test2/test.php</td>
    </tr>
    <tr>
      <td>$host</td>
      <td>请求信息中的”Host”，如果请求中没有Host行，则等于设置的服务器名</td>
    </tr>
    <tr>
      <td>$hostname</td>
      <td>机器名使用 gethostname系统调用的值</td>
    </tr>
    <tr>
      <td>$http_cookie</td>
      <td>cookie 信息</td>
    </tr>
    <tr>
      <td>$http_referer</td>
      <td>引用地址</td>
    </tr>
    <tr>
      <td>$http_user_agent</td>
      <td>客户端代理信息</td>
    </tr>
    <tr>
      <td>$http_via</td>
      <td>最后一个访问服务器的Ip地址。</td>
    </tr>
    <tr>
      <td>$http_x_forwarded_for</td>
      <td>相当于网络访问路径</td>
    </tr>
    <tr>
      <td>$is_args</td>
      <td>如果请求行带有参数，返回“?”，否则返回空字符串</td>
    </tr>
    <tr>
      <td>$limit_rate</td>
      <td>对连接速率的限制</td>
    </tr>
    <tr>
      <td>$nginx_version</td>
      <td>当前运行的nginx版本号</td>
    </tr>
    <tr>
      <td>$pid</td>
      <td>worker进程的PID</td>
    </tr>
    <tr>
      <td>$query_string</td>
      <td>与$args相同</td>
    </tr>
    <tr>
      <td>$realpath_root</td>
      <td>按root指令或alias指令算出的当前请求的绝对路径。其中的符号链接都会解析成真是文件路径</td>
    </tr>
    <tr>
      <td>$remote_addr</td>
      <td>客户端IP地址</td>
    </tr>
    <tr>
      <td>$remote_port</td>
      <td>客户端端口号</td>
    </tr>
    <tr>
      <td>$remote_user</td>
      <td>客户端用户名，认证用</td>
    </tr>
    <tr>
      <td>$request</td>
      <td>用户请求</td>
    </tr>
    <tr>
      <td>$request_body</td>
      <td>这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义</td>
    </tr>
    <tr>
      <td>$request_body_file</td>
      <td>客户端请求主体信息的临时文件名</td>
    </tr>
    <tr>
      <td>$request_completion</td>
      <td>如果请求成功，设为”OK”；如果请求未完成或者不是一系列请求中最后一部分则设为空</td>
    </tr>
    <tr>
      <td>$request_filename</td>
      <td>当前请求的文件路径名，比如/opt/nginx/www/test.php</td>
    </tr>
    <tr>
      <td>$request_method</td>
      <td>请求的方法，比如”GET”、”POST”等</td>
    </tr>
    <tr>
      <td>$request_uri</td>
      <td>请求的URI，带参数</td>
    </tr>
    <tr>
      <td>$scheme</td>
      <td>所用的协议，比如http或者是https</td>
    </tr>
    <tr>
      <td>$server_addr</td>
      <td>服务器地址，如果没有用listen指明服务器地址，使用这个变量将发起一次系统调用以取得地址(造成资源浪费)</td>
    </tr>
    <tr>
      <td>$server_name</td>
      <td>请求到达的服务器名</td>
    </tr>
    <tr>
      <td>$server_port</td>
      <td>请求到达的服务器端口号</td>
    </tr>
    <tr>
      <td>$server_protocol</td>
      <td>请求的协议版本，”HTTP/1.0”或”HTTP/1.1”</td>
    </tr>
    <tr>
      <td>$uri</td>
      <td>请求的URI，可能和最初的值有不同，比如经过重定向之类的</td>
    </tr>
  </tbody>
</table>

<p>其实这还不是全部，<code class="highlighter-rouge">Nginx</code>在不停迭代更新是一个原因，还有一个是有些变量太冷门，借助它们，会有很多玩法。</p>

<p>首先，在<code class="highlighter-rouge">OpenResty</code>中如何引用这些变量呢？参考 <a href="https://github.com/openresty/lua-nginx-module#ngxvarvariable">ngx.var.VARIABLE</a> 小节。</p>

<p>利用这些内置变量，来做一个简单的数学求和运算例子：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">server</span> <span class="p">{</span>
        <span class="kn">listen</span>    <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

        <span class="kn">location</span> <span class="n">/sum</span> <span class="p">{</span>
            <span class="c1">#处理业务</span>
           <span class="kn">content_by_lua_block</span> <span class="p">{</span>
                <span class="kn">local</span> <span class="s">a</span> <span class="p">=</span> <span class="s">tonumber(ngx.var.arg_a)</span> <span class="s">or</span> <span class="mi">0</span>
                <span class="s">local</span> <span class="s">b</span> <span class="p">=</span> <span class="s">tonumber(ngx.var.arg_b)</span> <span class="s">or</span> <span class="mi">0</span>
                <span class="s">ngx.say("sum:</span> <span class="s">",</span> <span class="s">a</span> <span class="s">+</span> <span class="s">b</span> <span class="s">)</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>验证一下：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~  curl <span class="s1">'http://127.0.0.1/sum?a=11&amp;b=12'</span>
<span class="nb">sum</span>: 23
</code></pre></div></div>

<p>也许你笑了，这个<code class="highlighter-rouge">API</code>太简单没有实际意义。我们做个简易防火墙，看看如何开始玩耍。</p>

<p>参看下面示例代码：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">server</span> <span class="p">{</span>
        <span class="kn">listen</span>    <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

        <span class="kn">location</span> <span class="n">/sum</span> <span class="p">{</span>
            <span class="c1"># 使用access阶段完成准入阶段处理</span>
            <span class="kn">access_by_lua_block</span> <span class="p">{</span>
                <span class="kn">local</span> <span class="s">black_ips</span> <span class="p">=</span> <span class="p">{</span><span class="kn">["127.0.0.1"]=true</span><span class="err">}</span>

                <span class="s">local</span> <span class="s">ip</span> <span class="p">=</span> <span class="s">ngx.var.remote_addr</span>
                <span class="s">if</span> <span class="s">true</span> <span class="p">==</span> <span class="s">black_ips[ip]</span> <span class="s">then</span>
                    <span class="s">ngx.exit(ngx.HTTP_FORBIDDEN)</span>
                <span class="s">end</span>
            <span class="err">}</span><span class="p">;</span>

            <span class="c1">#处理业务</span>
           <span class="kn">content_by_lua_block</span> <span class="p">{</span>
                <span class="kn">local</span> <span class="s">a</span> <span class="p">=</span> <span class="s">tonumber(ngx.var.arg_a)</span> <span class="s">or</span> <span class="mi">0</span>
                <span class="s">local</span> <span class="s">b</span> <span class="p">=</span> <span class="s">tonumber(ngx.var.arg_b)</span> <span class="s">or</span> <span class="mi">0</span>
                <span class="s">ngx.say("sum:",</span> <span class="s">a</span> <span class="s">+</span> <span class="s">b</span> <span class="s">)</span>
            <span class="err">}</span>
        <span class="err">}</span>
    <span class="err">}</span>
</code></pre></div></div>

<p>运行测试：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~  curl <span class="s1">'192.168.1.104/sum?a=11&amp;b=12'</span>
<span class="nb">sum</span>:23
➜  ~
➜  ~
➜  ~  curl <span class="s1">'127.0.0.1/sum?a=11&amp;b=12'</span>
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body <span class="nv">bgcolor</span><span class="o">=</span><span class="s2">"white"</span><span class="o">&gt;</span>
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.9.3.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>通过测试结果看到，提取了终端的<code class="highlighter-rouge">IP</code>地址后进行限制。扩充一下，就可以支持 IP 地址段，如果再与系统<code class="highlighter-rouge">iptables</code>进行配合，那么就足以达到软防火墙的目的。</p>

<p>目前为止，所有的例子都是对<code class="highlighter-rouge">Nginx</code>内置变量的获取，是否可以对其进行设置呢？其实大多数内容都是不允许写入的，例如刚刚的终端<code class="highlighter-rouge">IP</code>地址，在请求中是不允许对其进行更新的。对于可写的变量中的<code class="highlighter-rouge">limit_rate</code>，值得一提，它能完成传输速率限制，并且它的影响是单个请求级别。</p>

<p>参看下面示例：</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">location</span> <span class="n">/download</span> <span class="p">{</span>
            <span class="kn">access_by_lua_block</span> <span class="p">{</span>
                <span class="kn">ngx.var.limit_rate</span> <span class="p">=</span> <span class="mi">1000</span>
            <span class="err">}</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>下载测试：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~  wget <span class="s1">'127.0.0.1/download/1.cab'</span>
<span class="nt">--2015-09-13</span> 13:59:51--  http://127.0.0.1/download/1.cab
Connecting to 127.0.0.1... connected.
HTTP request sent, awaiting response... 200 OK
Length: 135802 <span class="o">(</span>133K<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: <span class="s1">'1.cab'</span>

1.cab                6%[<span class="o">===&gt;</span>             <span class="o">]</span>   8.00K  1.01KB/s   eta 1m 53s
</code></pre></div></div>
