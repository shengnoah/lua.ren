<p>比如，我们有两个分数：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fraction_a</span> <span class="o">=</span> <span class="p">{</span><span class="n">numerator</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">denominator</span><span class="o">=</span><span class="mi">3</span><span class="p">}</span>
<span class="n">fraction_b</span> <span class="o">=</span> <span class="p">{</span><span class="n">numerator</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">denominator</span><span class="o">=</span><span class="mi">7</span><span class="p">}</span>
</code></pre></div></div>

<p>我们想实现分数间的相加：2/3 + 4/7，我们如果要执行： fraction_a + fraction_b，会报错的。</p>

<p>所以，我们可以动用MetaTable，如下所示：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fraction_op</span><span class="o">=</span><span class="p">{}</span>
<span class="k">function</span> <span class="nc">fraction_op</span><span class="p">.</span><span class="nf">__add</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">f1</span><span class="p">.</span><span class="n">numerator</span> <span class="o">*</span> <span class="n">f2</span><span class="p">.</span><span class="n">denominator</span> <span class="o">+</span> <span class="n">f2</span><span class="p">.</span><span class="n">numerator</span> <span class="o">*</span> <span class="n">f1</span><span class="p">.</span><span class="n">denominator</span>
    <span class="n">ret</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">f1</span><span class="p">.</span><span class="n">denominator</span> <span class="o">*</span> <span class="n">f2</span><span class="p">.</span><span class="n">denominator</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span>
</code></pre></div></div>

<p>为之前定义的两个table设置MetaTable：（其中的setmetatble是库函数）</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">setmetatable</span><span class="p">(</span><span class="n">fraction_a</span><span class="p">,</span> <span class="n">fraction_op</span><span class="p">)</span>
<span class="nb">setmetatable</span><span class="p">(</span><span class="n">fraction_b</span><span class="p">,</span> <span class="n">fraction_op</span><span class="p">)</span>
</code></pre></div></div>

<p>于是你就可以这样干了：（调用的是fraction_op.__add()函数）</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fraction_s</span> <span class="o">=</span> <span class="n">fraction_a</span> <span class="o">+</span> <span class="n">fraction_b</span>
</code></pre></div></div>

<p>至于__add这是MetaMethod，这是Lua内建约定的，其它的还有如下的MetaMethod：</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="n">__sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
<span class="n">__mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
<span class="n">__div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
<span class="n">__mod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
<span class="n">__pow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                     <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">^</span> <span class="n">b</span>
<span class="n">__unm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>                        <span class="err">对应表达式</span> <span class="o">-</span><span class="n">a</span>
<span class="n">__concat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                  <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">..</span> <span class="n">b</span>
<span class="n">__len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>                        <span class="err">对应表达式</span> <span class="o">#</span><span class="n">a</span>
<span class="n">__eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                      <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
<span class="n">__lt</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                      <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span>
<span class="n">__le</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                      <span class="err">对应表达式</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span>
<span class="n">__index</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>                   <span class="err">对应表达式</span> <span class="n">a</span><span class="p">.</span><span class="n">b</span>
<span class="n">__newindex</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>             <span class="err">对应表达式</span> <span class="n">a</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
<span class="n">__call</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>                  <span class="err">对应表达式</span> <span class="n">a</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">Set</span><span class="p">.</span><span class="n">mt</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">-- metatable for sets</span>

<span class="k">function</span> <span class="nc">Set</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">set</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">setmetatable</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">Set</span><span class="p">.</span><span class="n">mt</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">set</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">set</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">Set</span><span class="p">.</span><span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">getmetatable</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">~=</span> <span class="n">Set</span><span class="p">.</span><span class="n">mt</span> <span class="ow">or</span>
        <span class="nb">getmetatable</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">~=</span> <span class="n">Set</span><span class="p">.</span><span class="n">mt</span> <span class="k">then</span>
        <span class="nb">error</span><span class="p">(</span><span class="s2">&#34;Attempt to &#39;add&#39; a set with a not-set value&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">res</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">Set</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">res</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">Set</span><span class="p">.</span><span class="nf">tostring</span><span class="p">(</span><span class="n">set</span><span class="p">)</span>
    <span class="n">set</span> <span class="o">=</span> <span class="n">set</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&#34;{&#34;</span>
    <span class="kd">local</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
    <span class="k">for</span> <span class="n">e</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">..</span> <span class="n">sep</span> <span class="o">..</span> <span class="n">e</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s2">&#34;, &#34;</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">..</span> <span class="s2">&#34;}&#34;</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nc">Set</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Set</span><span class="p">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="k">end</span>

<span class="c1">-- 相加</span>
<span class="n">Set</span><span class="p">.</span><span class="n">mt</span><span class="p">.</span><span class="n">__add</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">union</span>

<span class="c1">-- 相乘，交集</span>
<span class="n">Set</span><span class="p">.</span><span class="n">mt</span><span class="p">.</span><span class="n">__mul</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">intersection</span>


<span class="n">s1</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">})</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">getmetatable</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">getmetatable</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span>

<span class="n">Set</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="n">Set</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">s2</span>
<span class="n">Set</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">})</span>
<span class="c1">-- s = s + 8    -- table加上一个数字</span>

<span class="n">Set</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">s1</span> <span class="o">*</span> <span class="n">s2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;--------------&#34;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
<span class="c1">-- print会自动调用__tostring，我们在这里修改了__tostring</span>
<span class="n">Set</span><span class="p">.</span><span class="n">mt</span><span class="p">.</span><span class="n">__tostring</span> <span class="o">=</span> <span class="n">Set</span><span class="p">.</span><span class="n">tostring</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

</code></pre></div></div>

<p>参考链接：</p>

<p><a href="http://coolshell.cn/articles/10739.html" target="_blank" rel="noopener noreferrer">http://coolshell.cn/articles/10739.html</a></p>

<p><a href="http://book.luaer.cn/" target="_blank" rel="noopener noreferrer">http://book.luaer.cn/</a></p>
